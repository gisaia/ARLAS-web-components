/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Component, Input, Output, ElementRef, ViewEncapsulation } from '@angular/core';
import { Subject, fromEvent } from 'rxjs';
import { debounceTime, takeUntil } from 'rxjs/operators';
import { OneSelectionDonut, MultiSelectionDonut, DonutParams } from 'arlas-d3';
import * as donutJsonSchema from './donut.schema.json';
import { ArlasColorService } from '../../services/color.generator.service';
import { TranslateService } from '@ngx-translate/core';
import { NUMBER_FORMAT_CHAR } from '../componentsUtils';
import * as i0 from "@angular/core";
import * as i1 from "../../services/color.generator.service";
import * as i2 from "@ngx-translate/core";
import * as i3 from "@angular/common";
export class DonutComponent {
    constructor(el, colorService, translate) {
        this.el = el;
        this.colorService = colorService;
        this.translate = translate;
        /**
         * @Input : Angular
         * @description Sets the opacity of non-hovered or non-selected nodes.
         */
        this.opacity = 0.4;
        /**
         * @Input : Angular
         * @description List of selected nodes.
         */
        this.selectedArcsList = new Array();
        /**
         * @Input : Angular
         * @description Whether the donut is multi-selectable.
         */
        this.multiselectable = true;
        /**
         * @Input : Angular
         * @description Knowing that saturation scale is [0, 1], `colorsSaturationWeight` is a
         * factor (between 0 and 1) that tightens this scale to [(1-colorsSaturationWeight), 1].
         * Therefore colors saturation of donuts arcs will be within this tightened scale..
         */
        this.colorsSaturationWeight = 1 / 2;
        /**
         * @Input : Angular
         * @description Unit that a node of the donut represents
         */
        this.unit = '';
        /**
         * @Output : Angular
         * @description Emits the list of selected nodes and the paths to their ultimate parent
         */
        this.selectedNodesEvent = new Subject();
        /**
         * @Output : Angular
         * @description Emits the hovered node and the path to it's parents.
         * The key of the map is the node's name and the value is its color on the donut
         */
        this.hoveredNodesEvent = new Subject();
        /**
         * @Output : Angular
         * @description Emits the information about the hovered node and its parents.
         */
        this.hoveredNodeTooltipEvent = new Subject();
        this._onDestroy$ = new Subject();
        fromEvent(window, 'resize')
            .pipe(debounceTime(500), takeUntil(this._onDestroy$))
            .subscribe((event) => {
            this.donut.resize(this.el.nativeElement.childNodes[0]);
        });
        this.colorService.changekeysToColors$
            .pipe(takeUntil(this._onDestroy$))
            .subscribe(() => {
            this.donut.donutParams.keysToColors = this.colorService.colorGenerator.keysToColors;
            this.donut.donutParams.donutNodeColorizer = this.colorService;
            this.donut.resize(this.el.nativeElement.childNodes[0]);
        });
    }
    ngOnDestroy() {
        this._onDestroy$.next(true);
        this._onDestroy$.complete();
    }
    ngOnChanges(changes) {
        if (this.donut === undefined) {
            if (this.multiselectable) {
                this.donut = new MultiSelectionDonut();
            }
            else {
                this.donut = new OneSelectionDonut();
            }
            this.setDonutParameters();
        }
        if (changes.donutData && this.donutData !== undefined && this.donutData !== null && this.donut !== undefined
            && this.donut.donutParams !== undefined) {
            this.donut.dataChange(this.donutData);
        }
        if (changes.selectedArcsList && this.selectedArcsList !== undefined && this.selectedArcsList !== null && this.donut !== undefined
            && this.donut.donutParams !== undefined && this.donut.donutParams.donutNodes !== undefined) {
            this.donut.onSelectionChange(this.selectedArcsList);
        }
    }
    /**
     * @returns Json schema of the donut component for configuration
     */
    static getDonutJsonSchema() {
        return donutJsonSchema;
    }
    setDonutParameters() {
        if (!this.unit) {
            this.unit = '';
        }
        this.donut.donutParams = new DonutParams();
        this.donut.donutParams.id = this.id;
        this.donut.donutParams.customizedCssClass = this.customizedCssClass;
        this.donut.donutParams.donutData = this.donutData;
        this.donut.donutParams.hoveredNodesEvent = this.hoveredNodesEvent;
        this.donut.donutParams.tooltipEvent = this.hoveredNodeTooltipEvent;
        this.donut.donutParams.multiselectable = this.multiselectable;
        this.donut.donutParams.opacity = this.opacity;
        this.donut.donutParams.selectedArcsList = this.selectedArcsList;
        this.donut.donutParams.selectedNodesEvent = this.selectedNodesEvent;
        this.donut.donutParams.donutContainer = this.el.nativeElement.childNodes[0];
        this.donut.donutParams.svgElement = this.el.nativeElement.childNodes[0].childNodes[0];
        this.donut.donutParams.keysToColors = this.keysToColors;
        this.donut.donutParams.colorsSaturationWeight = this.colorsSaturationWeight;
        this.donut.donutParams.donutNodeColorizer = this.colorService;
        this.donut.donutParams.numberFormatChar = this.translate.instant(NUMBER_FORMAT_CHAR);
        this.donut.donutParams.diameter = this.diameter;
        this.donut.donutParams.containerWidth = this.containerWidth;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: DonutComponent, deps: [{ token: i0.ElementRef }, { token: i1.ArlasColorService }, { token: i2.TranslateService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.2.13", type: DonutComponent, selector: "arlas-donut", inputs: { donutData: "donutData", opacity: "opacity", customizedCssClass: "customizedCssClass", selectedArcsList: "selectedArcsList", multiselectable: "multiselectable", id: "id", keysToColors: "keysToColors", colorsSaturationWeight: "colorsSaturationWeight", diameter: "diameter", containerWidth: "containerWidth", unit: "unit" }, outputs: { selectedNodesEvent: "selectedNodesEvent", hoveredNodesEvent: "hoveredNodesEvent", hoveredNodeTooltipEvent: "hoveredNodeTooltipEvent" }, usesOnChanges: true, ngImport: i0, template: "<div id=\"{{id}}\" class=\"donut__container\" [ngClass]=\"customizedCssClass\">\n  <svg id=\"svgix\"></svg>\n</div>\n", styles: ["@charset \"UTF-8\";.donut__container{width:100%;height:100%;position:relative;display:flex;justify-content:center}.donut__tooltip{position:absolute;font-size:.8em;color:#f85e5e;background-color:#fff;border-radius:2px;padding:0 5px;z-index:1000}.donut__arc{fill-rule:evenodd;stroke:#fff;stroke-width:.4px}.donut__arc:hover{cursor:pointer}\n"], dependencies: [{ kind: "directive", type: i3.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }], encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: DonutComponent, decorators: [{
            type: Component,
            args: [{ selector: 'arlas-donut', encapsulation: ViewEncapsulation.None, template: "<div id=\"{{id}}\" class=\"donut__container\" [ngClass]=\"customizedCssClass\">\n  <svg id=\"svgix\"></svg>\n</div>\n", styles: ["@charset \"UTF-8\";.donut__container{width:100%;height:100%;position:relative;display:flex;justify-content:center}.donut__tooltip{position:absolute;font-size:.8em;color:#f85e5e;background-color:#fff;border-radius:2px;padding:0 5px;z-index:1000}.donut__arc{fill-rule:evenodd;stroke:#fff;stroke-width:.4px}.donut__arc:hover{cursor:pointer}\n"] }]
        }], ctorParameters: () => [{ type: i0.ElementRef }, { type: i1.ArlasColorService }, { type: i2.TranslateService }], propDecorators: { donutData: [{
                type: Input
            }], opacity: [{
                type: Input
            }], customizedCssClass: [{
                type: Input
            }], selectedArcsList: [{
                type: Input
            }], multiselectable: [{
                type: Input
            }], id: [{
                type: Input
            }], keysToColors: [{
                type: Input
            }], colorsSaturationWeight: [{
                type: Input
            }], diameter: [{
                type: Input
            }], containerWidth: [{
                type: Input
            }], unit: [{
                type: Input
            }], selectedNodesEvent: [{
                type: Output
            }], hoveredNodesEvent: [{
                type: Output
            }], hoveredNodeTooltipEvent: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9udXQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtY29tcG9uZW50cy9zcmMvbGliL2NvbXBvbmVudHMvZG9udXQvZG9udXQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtY29tcG9uZW50cy9zcmMvbGliL2NvbXBvbmVudHMvZG9udXQvZG9udXQuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxFQUNMLFNBQVMsRUFBYSxLQUFLLEVBQUUsTUFBTSxFQUFtQyxVQUFVLEVBQUUsaUJBQWlCLEVBRXBHLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFpQixpQkFBaUIsRUFBRSxtQkFBbUIsRUFBRSxXQUFXLEVBQTJDLE1BQU0sVUFBVSxDQUFDO0FBQ3ZJLE9BQU8sS0FBSyxlQUFlLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7Ozs7O0FBUXhELE1BQU0sT0FBTyxjQUFjO0lBNEZ6QixZQUNVLEVBQWMsRUFDZCxZQUErQixFQUMvQixTQUEyQjtRQUYzQixPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQ2QsaUJBQVksR0FBWixZQUFZLENBQW1CO1FBQy9CLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBeEZyQzs7O1dBR0c7UUFDYSxZQUFPLEdB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QU1VLE9BQU87c0JBQXRCLEtBQUs7Z0JBTVUsa0JBQWtCO3NCQUFqQyxLQUFLO2dCQU1VLGdCQUFnQjtzQkFBL0IsS0FBSztnQkFNVSxlQUFlO3NCQUE5QixLQUFLO2dCQU1VLEVBQUU7c0JBQWpCLEtBQUs7Z0JBTVUsWUFBWTtzQkFBM0IsS0FBSztnQkFRVSxzQkFBc0I7c0JBQXJDLEtBQUs7Z0JBTVUsUUFBUTtzQkFBdkIsS0FBSztnQkFNVSxjQUFjO3NCQUE3QixLQUFLO2dCQU1VLElBQUk7c0JBQW5CLEtBQUs7Z0JBTVcsa0JBQWtCO3NCQUFsQyxNQUFNO2dCQU9VLGlCQUFpQjtzQkFBakMsTUFBTTtnQkFNVSx1QkFBdUI7c0JBQXZDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHtcbiAgQ29tcG9uZW50LCBPbkNoYW5nZXMsIElucHV0LCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIFZpZXdDb250YWluZXJSZWYsIEVsZW1lbnRSZWYsIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBPbkRlc3Ryb3lcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWJzdHJhY3REb251dCwgT25lU2VsZWN0aW9uRG9udXQsIE11bHRpU2VsZWN0aW9uRG9udXQsIERvbnV0UGFyYW1zLCBUcmVlTm9kZSwgU2ltcGxlTm9kZSwgQVJMQVNEb251dFRvb2x0aXAgfSBmcm9tICdhcmxhcy1kMyc7XG5pbXBvcnQgKiBhcyBkb251dEpzb25TY2hlbWEgZnJvbSAnLi9kb251dC5zY2hlbWEuanNvbic7XG5pbXBvcnQgeyBBcmxhc0NvbG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2NvbG9yLmdlbmVyYXRvci5zZXJ2aWNlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IE5VTUJFUl9GT1JNQVRfQ0hBUiB9IGZyb20gJy4uL2NvbXBvbmVudHNVdGlscyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2FybGFzLWRvbnV0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2RvbnV0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZG9udXQuY29tcG9uZW50LnNjc3MnXSxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBEb251dENvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIERhdGEgdHJlZSB0byBwbG90IGluIHRoZSBkb251dC5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBkb251dERhdGE6IFRyZWVOb2RlO1xuXG4gIC8qKlxuICAgKiBASW5wdXQgOiBBbmd1bGFyXG4gICAqIEBkZXNjcmlwdGlvbiBTZXRzIHRoZSBvcGFjaXR5IG9mIG5vbi1ob3ZlcmVkIG9yIG5vbi1zZWxlY3RlZCBub2Rlcy5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBvcGFjaXR5ID0gMC40O1xuXG4gIC8qKlxuICAgKiBASW5wdXQgOiBBbmd1bGFyXG4gICAqIEBkZXNjcmlwdGlvbiBDc3MgY2xhc3MgbmFtZSB0byB1c2UgdG8gY3VzdG9taXplIGEgc3BlY2lmaWMgcG93ZXJiYXIncyBzdHlsZS5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBjdXN0b21pemVkQ3NzQ2xhc3M7XG5cbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIExpc3Qgb2Ygc2VsZWN0ZWQgbm9kZXMuXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgc2VsZWN0ZWRBcmNzTGlzdDogQXJyYXk8QXJyYXk8U2ltcGxlTm9kZT4+ID0gbmV3IEFycmF5PEFycmF5PFNpbXBsZU5vZGU+PigpO1xuXG4gIC8qKlxuICAgKiBASW5wdXQgOiBBbmd1bGFyXG4gICAqIEBkZXNjcmlwdGlvbiBXaGV0aGVyIHRoZSBkb251dCBpcyBtdWx0aS1zZWxlY3RhYmxlLlxuICAgKi9cbiAgQElucHV0KCkgcHVibGljIG11bHRpc2VsZWN0YWJsZSA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIGlkIG9mIHRoZSBkb251dFxuICAgKi9cbiAgQElucHV0KCkgcHVibGljIGlkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIExpc3Qgb2YgW2tleSwgY29sb3JdIGNvdXBsZXMgdGhhdCBhc3NvY2lhdGVzIGEgaGV4IGNvbG9yIHRvIGVhY2gga2V5XG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMga2V5c1RvQ29sb3JzOiBBcnJheTxbc3RyaW5nLCBzdHJpbmddPjtcblxuICAvKipcbiAgICogQElucHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gS25vd2luZyB0aGF0IHNhdHVyYXRpb24gc2NhbGUgaXMgWzAsIDFdLCBgY29sb3JzU2F0dXJhdGlvbldlaWdodGAgaXMgYVxuICAgKiBmYWN0b3IgKGJldHdlZW4gMCBhbmQgMSkgdGhhdCB0aWdodGVucyB0aGlzIHNjYWxlIHRvIFsoMS1jb2xvcnNTYXR1cmF0aW9uV2VpZ2h0KSwgMV0uXG4gICAqIFRoZXJlZm9yZSBjb2xvcnMgc2F0dXJhdGlvbiBvZiBkb251dHMgYXJjcyB3aWxsIGJlIHdpdGhpbiB0aGlzIHRpZ2h0ZW5lZCBzY2FsZS4uXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgY29sb3JzU2F0dXJhdGlvbldlaWdodCA9IDEgLyAyIDtcblxuICAvKipcbiAgICogQElucHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gRGlhbWV0ZXIgb2YgdGhlIGRvbnV0LiBJZiBpdCdzIG5vdCBzZXQsIHRoZSBkb251dCB0YWtlIHRoZSBNYXgod2lkdGgsaGVpZ2h0KSBvZiB0aGUgZGl2IGNvbnRhaW5pbmcgdGhlIHN2Zy5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBkaWFtZXRlcjogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBASW5wdXQgOiBBbmd1bGFyXG4gICAqIEBkZXNjcmlwdGlvbiBXaWR0aCBvZiB0aGUgc3ZnIGNvbnRhaW5pbmcgdGhlIGRvbnV0LiBJZiBpdCdzIG5vdCBzZXQsIHRoZSBjb250YWluZXIgd2lkdGggdGFrZXMgdGhlIGRvbnV0J3MgZGlhbWV0ZXIuXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgY29udGFpbmVyV2lkdGg6IG51bWJlcjtcblxuICAvKipcbiAgICogQElucHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gVW5pdCB0aGF0IGEgbm9kZSBvZiB0aGUgZG9udXQgcmVwcmVzZW50c1xuICAgKi9cbiAgQElucHV0KCkgcHVibGljIHVuaXQgPSAnJztcblxuICAvKipcbiAgICogQE91dHB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIEVtaXRzIHRoZSBsaXN0IG9mIHNlbGVjdGVkIG5vZGVzIGFuZCB0aGUgcGF0aHMgdG8gdGhlaXIgdWx0aW1hdGUgcGFyZW50XG4gICAqL1xuICBAT3V0cHV0KCkgcHVibGljIHNlbGVjdGVkTm9kZXNFdmVudDogU3ViamVjdDxBcnJheTxBcnJheTxTaW1wbGVOb2RlPj4+ID0gbmV3IFN1YmplY3Q8QXJyYXk8QXJyYXk8U2ltcGxlTm9kZT4+PigpO1xuXG4gIC8qKlxuICAgKiBAT3V0cHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gRW1pdHMgdGhlIGhvdmVyZWQgbm9kZSBhbmQgdGhlIHBhdGggdG8gaXQncyBwYXJlbnRzLlxuICAgKiBUaGUga2V5IG9mIHRoZSBtYXAgaXMgdGhlIG5vZGUncyBuYW1lIGFuZCB0aGUgdmFsdWUgaXMgaXRzIGNvbG9yIG9uIHRoZSBkb251dFxuICAgKi9cbiAgQE91dHB1dCgpIHB1YmxpYyBob3ZlcmVkTm9kZXNFdmVudDogU3ViamVjdDxNYXA8c3RyaW5nLCBzdHJpbmc+PiA9IG5ldyBTdWJqZWN0PE1hcDxzdHJpbmcsIHN0cmluZz4+KCk7XG5cbiAgLyoqXG4gICAqIEBPdXRwdXQgOiBBbmd1bGFyXG4gICAqIEBkZXNjcmlwdGlvbiBFbWl0cyB0aGUgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGhvdmVyZWQgbm9kZSBhbmQgaXRzIHBhcmVudHMuXG4gICAqL1xuICBAT3V0cHV0KCkgcHVibGljIGhvdmVyZWROb2RlVG9vbHRpcEV2ZW50OiBTdWJqZWN0PEFSTEFTRG9udXRUb29sdGlwPiA9IG5ldyBTdWJqZWN0PEFSTEFTRG9udXRUb29sdGlwPigpO1xuXG4gIHB1YmxpYyBkb251dDogQWJzdHJhY3REb251dDtcblxuICBwcml2YXRlIF9vbkRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIGNvbG9yU2VydmljZTogQXJsYXNDb2xvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgZnJvbUV2ZW50KHdpbmRvdywgJ3Jlc2l6ZScpXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUoNTAwKSwgdGFrZVVudGlsKHRoaXMuX29uRGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoZXZlbnQ6IEV2ZW50KSA9PiB7XG4gICAgICAgIHRoaXMuZG9udXQucmVzaXplKHRoaXMuZWwubmF0aXZlRWxlbWVudC5jaGlsZE5vZGVzWzBdKTtcbiAgICAgIH0pO1xuICAgIHRoaXMuY29sb3JTZXJ2aWNlLmNoYW5nZWtleXNUb0NvbG9ycyRcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLl9vbkRlc3Ryb3kkKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLmRvbnV0LmRvbnV0UGFyYW1zLmtleXNUb0NvbG9ycyA9IHRoaXMuY29sb3JTZXJ2aWNlLmNvbG9yR2VuZXJhdG9yLmtleXNUb0NvbG9ycztcbiAgICAgICAgdGhpcy5kb251dC5kb251dFBhcmFtcy5kb251dE5vZGVDb2xvcml6ZXIgPSB0aGlzLmNvbG9yU2VydmljZTtcbiAgICAgICAgdGhpcy5kb251dC5yZXNpemUodGhpcy5lbC5uYXRpdmVFbGVtZW50LmNoaWxkTm9kZXNbMF0pO1xuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fb25EZXN0cm95JC5uZXh0KHRydWUpO1xuICAgIHRoaXMuX29uRGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZG9udXQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKHRoaXMubXVsdGlzZWxlY3RhYmxlKSB7XG4gICAgICAgIHRoaXMuZG9udXQgPSBuZXcgTXVsdGlTZWxlY3Rpb25Eb251dCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5kb251dCA9IG5ldyBPbmVTZWxlY3Rpb25Eb251dCgpO1xuICAgICAgfVxuICAgICAgdGhpcy5zZXREb251dFBhcmFtZXRlcnMoKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5kb251dERhdGEgJiYgdGhpcy5kb251dERhdGEgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmRvbnV0RGF0YSAhPT0gbnVsbCAmJiB0aGlzLmRvbnV0ICE9PSB1bmRlZmluZWRcbiAgICAgICYmIHRoaXMuZG9udXQuZG9udXRQYXJhbXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5kb251dC5kYXRhQ2hhbmdlKHRoaXMuZG9udXREYXRhKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlcy5zZWxlY3RlZEFyY3NMaXN0ICYmIHRoaXMuc2VsZWN0ZWRBcmNzTGlzdCAhPT0gdW5kZWZpbmVkICYmIHRoaXMuc2VsZWN0ZWRBcmNzTGlzdCAhPT0gbnVsbCAmJiB0aGlzLmRvbnV0ICE9PSB1bmRlZmluZWRcbiAgICAgICYmIHRoaXMuZG9udXQuZG9udXRQYXJhbXMgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmRvbnV0LmRvbnV0UGFyYW1zLmRvbnV0Tm9kZXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy5kb251dC5vblNlbGVjdGlvbkNoYW5nZSh0aGlzLnNlbGVjdGVkQXJjc0xpc3QpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyBKc29uIHNjaGVtYSBvZiB0aGUgZG9udXQgY29tcG9uZW50IGZvciBjb25maWd1cmF0aW9uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldERvbnV0SnNvblNjaGVtYSgpOiBPYmplY3Qge1xuICAgIHJldHVybiBkb251dEpzb25TY2hlbWE7XG4gIH1cblxuICBwcml2YXRlIHNldERvbnV0UGFyYW1ldGVycygpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMudW5pdCkge1xuICAgICAgdGhpcy51bml0ID0gJyc7XG4gICAgfVxuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMgPSBuZXcgRG9udXRQYXJhbXMoKTtcbiAgICB0aGlzLmRvbnV0LmRvbnV0UGFyYW1zLmlkID0gdGhpcy5pZDtcbiAgICB0aGlzLmRvbnV0LmRvbnV0UGFyYW1zLmN1c3RvbWl6ZWRDc3NDbGFzcyA9IHRoaXMuY3VzdG9taXplZENzc0NsYXNzO1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMuZG9udXREYXRhID0gdGhpcy5kb251dERhdGE7XG4gICAgdGhpcy5kb251dC5kb251dFBhcmFtcy5ob3ZlcmVkTm9kZXNFdmVudCA9IHRoaXMuaG92ZXJlZE5vZGVzRXZlbnQ7XG4gICAgdGhpcy5kb251dC5kb251dFBhcmFtcy50b29sdGlwRXZlbnQgPSB0aGlzLmhvdmVyZWROb2RlVG9vbHRpcEV2ZW50O1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMubXVsdGlzZWxlY3RhYmxlID0gdGhpcy5tdWx0aXNlbGVjdGFibGU7XG4gICAgdGhpcy5kb251dC5kb251dFBhcmFtcy5vcGFjaXR5ID0gdGhpcy5vcGFjaXR5O1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMuc2VsZWN0ZWRBcmNzTGlzdCA9IHRoaXMuc2VsZWN0ZWRBcmNzTGlzdDtcbiAgICB0aGlzLmRvbnV0LmRvbnV0UGFyYW1zLnNlbGVjdGVkTm9kZXNFdmVudCA9IHRoaXMuc2VsZWN0ZWROb2Rlc0V2ZW50O1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMuZG9udXRDb250YWluZXIgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuY2hpbGROb2Rlc1swXTtcbiAgICB0aGlzLmRvbnV0LmRvbnV0UGFyYW1zLnN2Z0VsZW1lbnQgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdO1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMua2V5c1RvQ29sb3JzID0gdGhpcy5rZXlzVG9Db2xvcnM7XG4gICAgdGhpcy5kb251dC5kb251dFBhcmFtcy5jb2xvcnNTYXR1cmF0aW9uV2VpZ2h0ID0gdGhpcy5jb2xvcnNTYXR1cmF0aW9uV2VpZ2h0O1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMuZG9udXROb2RlQ29sb3JpemVyID0gdGhpcy5jb2xvclNlcnZpY2U7XG4gICAgdGhpcy5kb251dC5kb251dFBhcmFtcy5udW1iZXJGb3JtYXRDaGFyID0gdGhpcy50cmFuc2xhdGUuaW5zdGFudChOVU1CRVJfRk9STUFUX0NIQVIpO1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMuZGlhbWV0ZXIgPSB0aGlzLmRpYW1ldGVyO1xuICAgIHRoaXMuZG9udXQuZG9udXRQYXJhbXMuY29udGFpbmVyV2lkdGggPSB0aGlzLmNvbnRhaW5lcldpZHRoO1xuICB9XG59XG4iLCI8ZGl2IGlkPVwie3tpZH19XCIgY2xhc3M9XCJkb251dF9fY29udGFpbmVyXCIgW25nQ2xhc3NdPVwiY3VzdG9taXplZENzc0NsYXNzXCI+XG4gIDxzdmcgaWQ9XCJzdmdpeFwiPjwvc3ZnPlxuPC9kaXY+XG4iXX0=