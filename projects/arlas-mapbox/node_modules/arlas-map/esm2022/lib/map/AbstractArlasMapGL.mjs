/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { fromEvent, map } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { ArlasLngLat, ArlasLngLatBounds } from './model/map';
import { marker } from '@colsen1991/ngx-translate-extract-marker';
import bbox from '@turf/bbox';
export const GEOJSON_SOURCE_TYPE = 'geojson';
export const CROSS_LAYER_PREFIX = 'arlas_cross';
export const ZOOM_IN = marker('Zoom in');
export const ZOOM_OUT = marker('Zoom out');
export const RESET_BEARING = marker('Reset bearing to north');
export const LAYER_SWITCHER_TOOLTIP = marker('Manage layers');
/**
 * The aim of this class is to handle all core interaction we have
 * with a map provider.
 * The aim is also to separate the Arlas map from the Angular framework.
 * It will be instantiated in the map.component and will be responsible for initializing the map and all map behavior.
 */
export class AbstractArlasMapGL {
    constructor(config) {
        this.config = config;
        this.POLYGON_LABEL_SOURCE = 'polygon_label';
        this._eventSubscription = [];
        this.evented = new EventTarget();
        this.config = config;
        this._offset = config.offset;
        this._margePanForLoad = config.margePanForLoad;
        this._margePanForTest = config.margePanForTest;
        this._displayCurrentCoordinates = config.displayCurrentCoordinates ?? false;
        this._wrapLatLng = config.wrapLatLng ?? true;
        this._controls = config.controls;
        this._fitBoundsPadding = config.fitBoundsPadding ?? 10;
        this._maxWidthScale = config.maxWidthScale;
        this._unitScale = config.unitScale;
        this.init(config);
    }
    init(config) {
        try {
            this._initMapProvider(config);
            this._initControls();
            this._initOnLoad();
            this._initMapMoveEvents();
        }
        catch (e) {
            console.log(e);
        }
    }
    _initOnLoad() {
        this.onLoad(() => {
            this.evented.dispatchEvent(new Event('beforeOnLoadInit'));
            this._updateBounds();
            this._updateZoom();
            this.getMapProvider().fitBounds(this.getBounds());
        });
    }
    onCustomEvent(event, loadFn) {
        this.evented.addEventListener(event, loadFn);
    }
    _initMapMoveEvents() {
        this._zoomStart$ = fromEvent(this.getMapProvider(), 'zoomstart')
            .pipe(debounceTime(750));
        this._dragStart$ = fromEvent(this.getMapProvider(), 'dragstart')
            .pipe(debounceTime(750));
        this._dragEnd$ = fromEvent(this.getMapProvider(), 'dragend')
            .pipe(debounceTime(750));
        this._moveEnd$ = fromEvent(this.getMapProvider(), 'moveend')
            .pipe(debounceTime(750));
        this._updateOnZoomStart();
        this._updateOnDragStart();
        this._updateOnDragEnd();
        this._updateOnMoveEnd();
    }
    _updateBounds() {
        this._west = this.getWestBounds();
        this._south = this.getSouthBounds();
        this._east = this.getEastBounds();
        this._north = this.getNorthBounds();
    }
    _updateZoom(e) {
        this.zoom = this.getZoom();
    }
    _updateCurrentLngLat(e) {
        const lngLat = e.lngLat;
        if (this._displayCurrentCoordinates) {
            const displayedLngLat = this._wrapLatLng ? lngLat.wrap() : lngLat;
            this.currentLng = String(Math.round(displayedLngLat.lng * 100000) / 100000);
            this.currentLat = String(Math.round(displayedLngLat.lat * 100000) / 100000);
        }
    }
    _updateDragEnd(e) {
        if (e.originalEvent) {
            this._dragEndX = e.originalEvent.clientX;
            this._dragEndY = e.originalEvent.clientY;
        }
    }
    _updateDragStart(e) {
        this._dragStartX = e.originalEvent.clientX;
        this._dragStartY = e.originalEvent.clientY;
    }
    _updateEndLngLat(e) {
        this.endLngLat = e.lngLat;
    }
    _updateMoveRatio(e) {
        this._xMoveRatio = Math.abs(this._dragEndX - this._dragStartX) / e.target._canvas.clientWidth;
        this._yMoveRatio = Math.abs(this._dragEndY - this._dragStartY) / e.target._canvas.clientHeight;
    }
    _updateStartLngLat(e) {
        this.startLngLat = e.lngLat;
    }
    _updateZoomStart() {
        this._zoomStart = this.getZoom();
    }
    _updateOnZoomStart() {
        const sub = this._zoomStart$.subscribe(_ => this._updateZoomStart());
        this._eventSubscription.push(sub);
    }
    _updateOnDragStart() {
        const sub = this._dragStart$.subscribe(e => this._updateDragStart(e));
        this._eventSubscription.push(sub);
    }
    _updateOnDragEnd() {
        const sub = this._dragEnd$
            .subscribe(e => {
            this._updateDragEnd(e);
            this._updateMoveRatio(e);
        });
        this._eventSubscription.push(sub);
    }
    _updateOnMoveEnd() {
        const sub = this._moveEnd$
            .subscribe(_ => {
            this._updateBounds();
            this._updateZoom();
        });
        this._eventSubscription.push(sub);
    }
    onMoveEnd(visualisationsSets, cb) {
        return this._moveEnd$
            .pipe(map(_ => {
            this._updateBounds();
            this._updateZoom();
            if (cb) {
                cb();
            }
            return this._getMoveEnd(visualisationsSets);
        }));
    }
    setLayoutProperty(layer, name, value, options) {
        this.getMapProvider().setLayoutProperty(layer, name, value, options);
        return this;
    }
    unsubscribeEvents() {
        this._eventSubscription.forEach(s => s.unsubscribe());
    }
    getMaxZoom() {
        return this.getMapProvider().getMaxZoom();
    }
    getMinZoom() {
        return this.getMapProvider().getMinZoom();
    }
    getPitch() {
        return this.getMapProvider().getPitch();
    }
    /** Gets bounds of the given geometry */
    geometryToBounds(geometry, paddingPercentage) {
        const boundingBox = bbox(geometry);
        let west = boundingBox[0];
        let south = boundingBox[1];
        let east = boundingBox[2];
        let north = boundingBox[3];
        if (paddingPercentage !== undefined) {
            let width = east - west;
            let height = north - south;
            /** if there is one hit, then west=east ===> we consider a width of 0.05°*/
            if (width === 0) {
                width = 0.05;
            }
            /** if there is one hit, then north=south ===> we consider a height of 0.05°*/
            if (height === 0) {
                height = 0.05;
            }
            west = west - paddingPercentage * width;
            south = Math.max(-90, south - paddingPercentage * height);
            east = east + paddingPercentage * width;
            north = Math.min(90, north + paddingPercentage * height);
        }
        const bounds = new ArlasLngLatBounds(new ArlasLngLat(west, south), new ArlasLngLat(east, north));
        return bounds;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWJzdHJhY3RBcmxhc01hcEdMLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvbWFwL0Fic3RyYWN0QXJsYXNNYXBHTC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBNEIsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQWdCLE1BQU0sYUFBYSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNsRSxPQUFPLElBQUksTUFBTSxZQUFZLENBQUM7QUEyQzlCLE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLFNBQVMsQ0FBQztBQUU3QyxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxhQUFhLENBQUM7QUFDaEQsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QyxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUM5RCxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7QUFFOUQ7Ozs7O0dBS0c7QUFDSCxNQUFNLE9BQWdCLGtCQUFrQjtJQWdEdEMsWUFBZ0MsTUFBc0I7UUFBdEIsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUEzQnRDLHlCQUFvQixHQUFHLGVBQWUsQ0FBQztRQXVCN0MsdUJBQWtCLEdBQW1CLEVBQUUsQ0FBQztRQUV4QyxZQUFPLEdBQUcsSUFBSSxXQUFXLEVB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LElBQUksR0FBRyxJQUFJLENBQUM7WUFDeEIsSUFBSSxNQUFNLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUMzQiwyRUFBMkU7WUFDM0UsSUFBSSxLQUFLLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ2hCLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDZixDQUFDO1lBQ0QsOEVBQThFO1lBQzlFLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNqQixNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ2hCLENBQUM7WUFDRCxJQUFJLEdBQUcsSUFBSSxHQUFHLGlCQUFpQixHQUFHLEtBQUssQ0FBQztZQUN4QyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEdBQUcsaUJBQWlCLEdBQUcsTUFBTSxDQUFDLENBQUM7WUFDMUQsSUFBSSxHQUFHLElBQUksR0FBRyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7WUFDeEMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEtBQUssR0FBRyxpQkFBaUIsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUMzRCxDQUFDO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxpQkFBaUIsQ0FDbEMsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUM1QixJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQzdCLENBQUM7UUFDRixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgZnJvbUV2ZW50LCBtYXAsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udHJvbFBvc2l0aW9uLCBDb250cm9sc09wdGlvbiwgRHJhd0NvbnRyb2xzT3B0aW9uIH0gZnJvbSAnLi9tb2RlbC9jb250cm9scyc7XG5pbXBvcnQgeyBNYXBFeHRlbnQgfSBmcm9tICcuL21vZGVsL2V4dGVudCc7XG5pbXBvcnQgeyBBcmxhc0xuZ0xhdCwgQXJsYXNMbmdMYXRCb3VuZHMsIE9uTW92ZVJlc3VsdCB9IGZyb20gJy4vbW9kZWwvbWFwJztcbmltcG9ydCB7IG1hcmtlciB9IGZyb20gJ0Bjb2xzZW4xOTkxL25neC10cmFuc2xhdGUtZXh0cmFjdC1tYXJrZXInO1xuaW1wb3J0IGJib3ggZnJvbSAnQHR1cmYvYmJveCc7XG5cblxuLyoqIENvbmYgKi9cbmV4cG9ydCBpbnRlcmZhY2UgTWFwQ29uZmlnPFQ+IHtcbiAgZGlzcGxheUN1cnJlbnRDb29yZGluYXRlczogYm9vbGVhbjtcbiAgZml0Qm91bmRzUGFkZGluZzogbnVtYmVyO1xuICBtYXJnZVBhbkZvckxvYWQ6IG51bWJlcjtcbiAgbWFyZ2VQYW5Gb3JUZXN0OiBudW1iZXI7XG4gIHdyYXBMYXRMbmc6IGJvb2xlYW47XG4gIG9mZnNldDogQXJsYXNNYXBPZmZzZXQ7XG4gIG1hcFByb3ZpZGVyT3B0aW9ucz86IFQ7XG4gIG1heFdpZHRoU2NhbGU/OiBudW1iZXI7XG4gIHVuaXRTY2FsZT86IHN0cmluZztcbiAgY29udHJvbHM/OiBDb250cm9sc09wdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcmxhc01hcE9wdGlvbiB7XG4gIGNvbnRhaW5lcjogc3RyaW5nO1xuICBzdHlsZTogYW55O1xuICBjZW50ZXI6IFtudW1iZXIsIG51bWJlcl07XG4gIHpvb206IG51bWJlcjtcbiAgbWF4Wm9vbTogbnVtYmVyO1xuICBtaW5ab29tOiBudW1iZXI7XG4gIHJlbmRlcldvcmxkQ29waWVzOiBib29sZWFuO1xuICBwcmVzZXJ2ZURyYXdpbmdCdWZmZXI6IGJvb2xlYW47XG4gIGxvY2FsZToge1xuICAgICdOYXZpZ2F0aW9uQ29udHJvbC5ab29tSW4nPzogc3RyaW5nO1xuICAgICdOYXZpZ2F0aW9uQ29udHJvbC5ab29tT3V0Jz86IHN0cmluZztcbiAgICAnTmF2aWdhdGlvbkNvbnRyb2wuUmVzZXRCZWFyaW5nJz86IHN0cmluZztcbiAgfTtcbiAgcGl0Y2hXaXRoUm90YXRlOiBib29sZWFuO1xuICB0cmFuc2Zvcm1SZXF1ZXN0OiB1bmtub3duO1xuICBhdHRyaWJ1dGlvbkNvbnRyb2w6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXJsYXNNYXBPZmZzZXQge1xuICBub3J0aDogbnVtYmVyO1xuICBlYXN0OiBudW1iZXI7XG4gIHNvdXRoOiBudW1iZXI7XG4gIHdlc3Q6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNvbnN0IEdFT0pTT05fU09VUkNFX1RZUEUgPSAnZ2VvanNvbic7XG5cbmV4cG9ydCBjb25zdCBDUk9TU19MQVlFUl9QUkVGSVggPSAnYXJsYXNfY3Jvc3MnO1xuZXhwb3J0IGNvbnN0IFpPT01fSU4gPSBtYXJrZXIoJ1pvb20gaW4nKTtcbmV4cG9ydCBjb25zdCBaT09NX09VVCA9IG1hcmtlcignWm9vbSBvdXQnKTtcbmV4cG9ydCBjb25zdCBSRVNFVF9CRUFSSU5HID0gbWFya2VyKCdSZXNldCBiZWFyaW5nIHRvIG5vcnRoJyk7XG5leHBvcnQgY29uc3QgTEFZRVJfU1dJVENIRVJfVE9PTFRJUCA9IG1hcmtlcignTWFuYWdlIGxheWVycycpO1xuXG4vKipcbiAqIFRoZSBhaW0gb2YgdGhpcyBjbGFzcyBpcyB0byBoYW5kbGUgYWxsIGNvcmUgaW50ZXJhY3Rpb24gd2UgaGF2ZVxuICogd2l0aCBhIG1hcCBwcm92aWRlci5cbiAqIFRoZSBhaW0gaXMgYWxzbyB0byBzZXBhcmF0ZSB0aGUgQXJsYXMgbWFwIGZyb20gdGhlIEFuZ3VsYXIgZnJhbWV3b3JrLlxuICogSXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQgaW4gdGhlIG1hcC5jb21wb25lbnQgYW5kIHdpbGwgYmUgcmVzcG9uc2libGUgZm9yIGluaXRpYWxpemluZyB0aGUgbWFwIGFuZCBhbGwgbWFwIGJlaGF2aW9yLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQWJzdHJhY3RBcmxhc01hcEdMIHtcbiAgLyoqXG4gICAqICBwcm9wcyBhbmQgbWV0aG9kcyB3aXRoIHVua25vd24gdHlwZSB3aWxsIGJlIHNwZWNpZmljIHRvIHRoZSBtYXAgcHJvdmlkZXJcbiAgICogIHdlIHVzZS5cbiAgICogIGV4OiBlbmRMbmdMYXQgd2lsbCBoYXZlIGEgdHlwZSBNYXBsaWJyZS5Qb2ludGxpa2UvIE1hcGJveC5Qb2ludFxuICAgKi9cblxuICBwdWJsaWMgYWJzdHJhY3Qgc3RhcnRMbmdMYXQ6IEFybGFzTG5nTGF0O1xuICBwdWJsaWMgYWJzdHJhY3QgZW5kTG5nTGF0OiBBcmxhc0xuZ0xhdDtcbiAgcHVibGljIGFic3RyYWN0IG1vdmVMbmdMYXQ6IEFybGFzTG5nTGF0O1xuICBwcm90ZWN0ZWQgX29mZnNldDogQXJsYXNNYXBPZmZzZXQ7XG4gIHByb3RlY3RlZCBfbWFyZ2VQYW5Gb3JMb2FkOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfbWFyZ2VQYW5Gb3JUZXN0OiBudW1iZXI7XG4gIHByb3RlY3RlZCBfZml0Qm91bmRzUGFkZGluZzogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX2Rpc3BsYXlDdXJyZW50Q29vcmRpbmF0ZXM6IGJvb2xlYW47XG4gIHByb3RlY3RlZCBfd3JhcExhdExuZzogYm9vbGVhbjtcbiAgcHJvdGVjdGVkIF9jb250cm9sczogQ29udHJvbHNPcHRpb247XG4gIHByb3RlY3RlZCBfbWF4V2lkdGhTY2FsZT86IG51bWJlcjtcbiAgcHJvdGVjdGVkIF91bml0U2NhbGU/OiBzdHJpbmc7XG4gIHB1YmxpYyBjdXJyZW50TGF0OiBzdHJpbmc7XG4gIHB1YmxpYyBjdXJyZW50TG5nOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBQT0xZR09OX0xBQkVMX1NPVVJDRSA9ICdwb2x5Z29uX2xhYmVsJztcblxuICBwcm90ZWN0ZWQgX25vcnRoOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfZWFzdDogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX3dlc3Q6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9zb3V0aDogbnVtYmVyO1xuICBwdWJsaWMgem9vbTogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX3pvb21TdGFydDogbnVtYmVyO1xuXG4gIHByb3RlY3RlZCBfZHJhZ1N0YXJ0WDogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX2RyYWdTdGFydFk6IG51bWJlcjtcblxuICBwcm90ZWN0ZWQgX2RyYWdFbmRYOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfZHJhZ0VuZFk6IG51bWJlcjtcblxuICBwcm90ZWN0ZWQgX3hNb3ZlUmF0aW86IG51bWJlcjtcbiAgcHJvdGVjdGVkIF95TW92ZVJhdGlvOiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIF9tb3ZlRW5kJDogT2JzZXJ2YWJsZTxhbnk+O1xuICBwcm90ZWN0ZWQgX3pvb21TdGFydCQ6IE9ic2VydmFibGU8YW55PjtcbiAgcHJvdGVjdGVkIF9kcmFnU3RhcnQkOiBPYnNlcnZhYmxlPGFueT47XG4gIHByb3RlY3RlZCBfZHJhZ0VuZCQ6IE9ic2VydmFibGU8YW55PjtcblxuICBwcm90ZWN0ZWQgX2V2ZW50U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gIHByb3RlY3RlZCBldmVudGVkID0gbmV3IEV2ZW50VGFyZ2V0KCk7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBjb25maWc6IE1hcENvbmZpZzxhbnk+KSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5fb2Zmc2V0ID0gY29uZmlnLm9mZnNldDtcbiAgICB0aGlzLl9tYXJnZVBhbkZvckxvYWQgPSBjb25maWcubWFyZ2VQYW5Gb3JMb2FkO1xuICAgIHRoaXMuX21hcmdlUGFuRm9yVGVzdCA9IGNvbmZpZy5tYXJnZVBhbkZvclRlc3Q7XG4gICAgdGhpcy5fZGlzcGxheUN1cnJlbnRDb29yZGluYXRlcyA9IGNvbmZpZy5kaXNwbGF5Q3VycmVudENvb3JkaW5hdGVzID8/IGZhbHNlO1xuICAgIHRoaXMuX3dyYXBMYXRMbmcgPSBjb25maWcud3JhcExhdExuZyA/PyB0cnVlO1xuICAgIHRoaXMuX2NvbnRyb2xzID0gY29uZmlnLmNvbnRyb2xzO1xuICAgIHRoaXMuX2ZpdEJvdW5kc1BhZGRpbmcgPSBjb25maWcuZml0Qm91bmRzUGFkZGluZyA/PyAxMDtcbiAgICB0aGlzLl9tYXhXaWR0aFNjYWxlID0gY29uZmlnLm1heFdpZHRoU2NhbGU7XG4gICAgdGhpcy5fdW5pdFNjYWxlID0gY29uZmlnLnVuaXRTY2FsZTtcbiAgICB0aGlzLmluaXQoY29uZmlnKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBpbml0KGNvbmZpZzogTWFwQ29uZmlnPGFueT4pOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5faW5pdE1hcFByb3ZpZGVyKGNvbmZpZyk7XG4gICAgICB0aGlzLl9pbml0Q29udHJvbHMoKTtcbiAgICAgIHRoaXMuX2luaXRPbkxvYWQoKTtcbiAgICAgIHRoaXMuX2luaXRNYXBNb3ZlRXZlbnRzKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIF9pbml0T25Mb2FkKCkge1xuICAgIHRoaXMub25Mb2FkKCgpID0+IHtcbiAgICAgIHRoaXMuZXZlbnRlZC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgnYmVmb3JlT25Mb2FkSW5pdCcpKTtcbiAgICAgIHRoaXMuX3VwZGF0ZUJvdW5kcygpO1xuICAgICAgdGhpcy5fdXBkYXRlWm9vbSgpO1xuICAgICAgdGhpcy5nZXRNYXBQcm92aWRlcigpLmZpdEJvdW5kcyh0aGlzLmdldEJvdW5kcygpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBvbkN1c3RvbUV2ZW50KGV2ZW50OiBzdHJpbmcsIGxvYWRGbjogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMuZXZlbnRlZC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsb2FkRm4pO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9pbml0TWFwTW92ZUV2ZW50cygpIHtcbiAgICB0aGlzLl96b29tU3RhcnQkID0gZnJvbUV2ZW50KHRoaXMuZ2V0TWFwUHJvdmlkZXIoKSwgJ3pvb21zdGFydCcpXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUoNzUwKSk7XG5cbiAgICB0aGlzLl9kcmFnU3RhcnQkID0gZnJvbUV2ZW50KHRoaXMuZ2V0TWFwUHJvdmlkZXIoKSwgJ2RyYWdzdGFydCcpXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUoNzUwKSk7XG5cbiAgICB0aGlzLl9kcmFnRW5kJCA9IGZyb21FdmVudCh0aGlzLmdldE1hcFByb3ZpZGVyKCksICdkcmFnZW5kJylcbiAgICAgIC5waXBlKGRlYm91bmNlVGltZSg3NTApKTtcblxuICAgIHRoaXMuX21vdmVFbmQkID0gZnJvbUV2ZW50KHRoaXMuZ2V0TWFwUHJvdmlkZXIoKSwgJ21vdmVlbmQnKVxuICAgICAgLnBpcGUoZGVib3VuY2VUaW1lKDc1MCkpO1xuXG4gICAgdGhpcy5fdXBkYXRlT25ab29tU3RhcnQoKTtcbiAgICB0aGlzLl91cGRhdGVPbkRyYWdTdGFydCgpO1xuICAgIHRoaXMuX3VwZGF0ZU9uRHJhZ0VuZCgpO1xuICAgIHRoaXMuX3VwZGF0ZU9uTW92ZUVuZCgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVCb3VuZHMoKTogdm9pZCB7XG4gICAgdGhpcy5fd2VzdCA9IHRoaXMuZ2V0V2VzdEJvdW5kcygpO1xuICAgIHRoaXMuX3NvdXRoID0gdGhpcy5nZXRTb3V0aEJvdW5kcygpO1xuICAgIHRoaXMuX2Vhc3QgPSB0aGlzLmdldEVhc3RCb3VuZHMoKTtcbiAgICB0aGlzLl9ub3J0aCA9IHRoaXMuZ2V0Tm9ydGhCb3VuZHMoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlWm9vbShlPzogYW55KTogdm9pZCB7XG4gICAgdGhpcy56b29tID0gdGhpcy5nZXRab29tKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZUN1cnJlbnRMbmdMYXQoZTogYW55KTogdm9pZCB7XG4gICAgY29uc3QgbG5nTGF0ID0gZS5sbmdMYXQ7XG4gICAgaWYgKHRoaXMuX2Rpc3BsYXlDdXJyZW50Q29vcmRpbmF0ZXMpIHtcbiAgICAgIGNvbnN0IGRpc3BsYXllZExuZ0xhdCA9IHRoaXMuX3dyYXBMYXRMbmcgPyBsbmdMYXQud3JhcCgpIDogbG5nTGF0O1xuICAgICAgdGhpcy5jdXJyZW50TG5nID0gU3RyaW5nKE1hdGgucm91bmQoZGlzcGxheWVkTG5nTGF0LmxuZyAqIDEwMDAwMCkgLyAxMDAwMDApO1xuICAgICAgdGhpcy5jdXJyZW50TGF0ID0gU3RyaW5nKE1hdGgucm91bmQoZGlzcGxheWVkTG5nTGF0LmxhdCAqIDEwMDAwMCkgLyAxMDAwMDApO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlRHJhZ0VuZChlOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoZS5vcmlnaW5hbEV2ZW50KSB7XG4gICAgICB0aGlzLl9kcmFnRW5kWCA9IGUub3JpZ2luYWxFdmVudC5jbGllbnRYO1xuICAgICAgdGhpcy5fZHJhZ0VuZFkgPSBlLm9yaWdpbmFsRXZlbnQuY2xpZW50WTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZURyYWdTdGFydChlOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLl9kcmFnU3RhcnRYID0gZS5vcmlnaW5hbEV2ZW50LmNsaWVudFg7XG4gICAgdGhpcy5fZHJhZ1N0YXJ0WSA9IGUub3JpZ2luYWxFdmVudC5jbGllbnRZO1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVFbmRMbmdMYXQoZTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5lbmRMbmdMYXQgPSBlLmxuZ0xhdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlTW92ZVJhdGlvKGU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuX3hNb3ZlUmF0aW8gPSBNYXRoLmFicyh0aGlzLl9kcmFnRW5kWCAtIHRoaXMuX2RyYWdTdGFydFgpIC8gZS50YXJnZXQuX2NhbnZhcy5jbGllbnRXaWR0aDtcbiAgICB0aGlzLl95TW92ZVJhdGlvID0gTWF0aC5hYnModGhpcy5fZHJhZ0VuZFkgLSB0aGlzLl9kcmFnU3RhcnRZKSAvIGUudGFyZ2V0Ll9jYW52YXMuY2xpZW50SGVpZ2h0O1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVTdGFydExuZ0xhdChlOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXJ0TG5nTGF0ID0gZS5sbmdMYXQ7XG4gIH1cblxuXG4gIHByb3RlY3RlZCBfdXBkYXRlWm9vbVN0YXJ0KCk6IHZvaWQge1xuICAgIHRoaXMuX3pvb21TdGFydCA9IHRoaXMuZ2V0Wm9vbSgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVPblpvb21TdGFydCgpIHtcbiAgICBjb25zdCBzdWIgPSB0aGlzLl96b29tU3RhcnQkLnN1YnNjcmliZShfID0+IHRoaXMuX3VwZGF0ZVpvb21TdGFydCgpKTtcbiAgICB0aGlzLl9ldmVudFN1YnNjcmlwdGlvbi5wdXNoKHN1Yik7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZU9uRHJhZ1N0YXJ0KCkge1xuICAgIGNvbnN0IHN1YiA9IHRoaXMuX2RyYWdTdGFydCQuc3Vic2NyaWJlKGUgPT4gdGhpcy5fdXBkYXRlRHJhZ1N0YXJ0KGUpKTtcbiAgICB0aGlzLl9ldmVudFN1YnNjcmlwdGlvbi5wdXNoKHN1Yik7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZU9uRHJhZ0VuZCgpIHtcbiAgICBjb25zdCBzdWIgPSB0aGlzLl9kcmFnRW5kJFxuICAgICAgLnN1YnNjcmliZShlID0+IHtcbiAgICAgICAgdGhpcy5fdXBkYXRlRHJhZ0VuZChlKTtcbiAgICAgICAgdGhpcy5fdXBkYXRlTW92ZVJhdGlvKGUpO1xuICAgICAgfSk7XG4gICAgdGhpcy5fZXZlbnRTdWJzY3JpcHRpb24ucHVzaChzdWIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVPbk1vdmVFbmQoKSB7XG4gICAgY29uc3Qgc3ViID0gdGhpcy5fbW92ZUVuZCRcbiAgICAgIC5zdWJzY3JpYmUoXyA9PiB7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUJvdW5kcygpO1xuICAgICAgICB0aGlzLl91cGRhdGVab29tKCk7XG4gICAgICB9KTtcbiAgICB0aGlzLl9ldmVudFN1YnNjcmlwdGlvbi5wdXNoKHN1Yik7XG4gIH1cblxuICBwdWJsaWMgb25Nb3ZlRW5kKHZpc3VhbGlzYXRpb25zU2V0czoge1xuICAgIHZpc3VhbGlzYXRpb25zOiBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj47XG4gICAgc3RhdHVzOiBNYXA8c3RyaW5nLCBib29sZWFuPjtcbiAgfSwgY2I/OiAoKSA9PiB2b2lkKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vdmVFbmQkXG4gICAgICAucGlwZShtYXAoXyA9PiB7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUJvdW5kcygpO1xuICAgICAgICB0aGlzLl91cGRhdGVab29tKCk7XG4gICAgICAgIGlmIChjYikge1xuICAgICAgICAgIGNiKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldE1vdmVFbmQodmlzdWFsaXNhdGlvbnNTZXRzKTtcbiAgICAgIH0pKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRMYXlvdXRQcm9wZXJ0eShsYXllcjogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIG9wdGlvbnM/OiBhbnkpIHtcbiAgICB0aGlzLmdldE1hcFByb3ZpZGVyKCkuc2V0TGF5b3V0UHJvcGVydHkobGF5ZXIsIG5hbWUsIHZhbHVlLCBvcHRpb25zKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyB1bnN1YnNjcmliZUV2ZW50cygpIHtcbiAgICB0aGlzLl9ldmVudFN1YnNjcmlwdGlvbi5mb3JFYWNoKHMgPT4gcy51bnN1YnNjcmliZSgpKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRNYXhab29tKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TWFwUHJvdmlkZXIoKS5nZXRNYXhab29tKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0TWluWm9vbSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmdldE1hcFByb3ZpZGVyKCkuZ2V0TWluWm9vbSgpO1xuICB9XG5cbiAgcHVibGljIGdldFBpdGNoKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TWFwUHJvdmlkZXIoKS5nZXRQaXRjaCgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IF9pbml0TWFwUHJvdmlkZXIoQmFzZU1hcEdsQ29uZmlnKTogdm9pZDtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IF9pbml0Q29udHJvbHMoKTogdm9pZDtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IF9nZXRNb3ZlRW5kKHZpc3VhbGlzYXRpb25zU2V0czoge1xuICAgIHZpc3VhbGlzYXRpb25zOiBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj47XG4gICAgc3RhdHVzOiBNYXA8c3RyaW5nLCBib29sZWFuPjtcbiAgfSk6IE9uTW92ZVJlc3VsdDtcblxuICBwdWJsaWMgYWJzdHJhY3QgYWRkQ29udHJvbChjb250cm9sOiBhbnksIHBvc2l0aW9uPzogQ29udHJvbFBvc2l0aW9uLCBldmVudE92ZXJyaWRlPzoge1xuICAgIGV2ZW50OiBzdHJpbmc7IGZuOiAoZT8pID0+IHZvaWQ7XG4gIH0pO1xuICBwdWJsaWMgYWJzdHJhY3QgY2FsY09mZnNldFBvaW50KCk6IGFueTtcbiAgcHVibGljIGFic3RyYWN0IGRpc2FibGVEcmFnUGFuKCk6IHZvaWQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBlbmFibGVEcmFnUGFuKCk6IHZvaWQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBmaXRCb3VuZHMoYm91bmRzOiBBcmxhc0xuZ0xhdEJvdW5kcyB8IG51bWJlcltdLCBvcHRpb25zPzogdW5rbm93biwgdW5rbm93bj86IHVua25vd24pOiB0aGlzO1xuICBwdWJsaWMgYWJzdHJhY3QgZml0VG9QYWRkZWRCb3VuZHMoYm91bmRzOiBBcmxhc0xuZ0xhdEJvdW5kcyB8IG51bWJlcltdKTtcbiAgcHVibGljIGFic3RyYWN0IGdldEJvdW5kcygpOiB1bmtub3duO1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0Q2FudmFzQ29udGFpbmVyKCk6IEhUTUxFbGVtZW50O1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0RWFzdEJvdW5kcygpOiBudW1iZXI7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRNYXBFeHRlbmQoKTogTWFwRXh0ZW50O1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0TWFwUHJvdmlkZXIoKTogYW55O1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0TWF4Qm91bmRzKCk6IHVua25vd247XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXROb3J0aEJvdW5kcygpOiBudW1iZXI7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXROb3J0aEVhc3RCb3VuZHMoKTogQXJsYXNMbmdMYXQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRTb3V0aEJvdW5kcygpOiBudW1iZXI7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRTb3V0aFdlc3RCb3VuZHMoKTogQXJsYXNMbmdMYXQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRXZXN0Qm91bmRzKCk6IG51bWJlcjtcbiAgcHVibGljIGFic3RyYWN0IGdldFpvb20oKTogbnVtYmVyO1xuICBwdWJsaWMgYWJzdHJhY3QgaW5pdERyYXdDb250cm9scyhjb25maWc6IERyYXdDb250cm9sc09wdGlvbik6IHZvaWQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBvbih0eXBlOiBzdHJpbmcsIGxpc3RlbmVyOiAoZXY6IGFueSkgPT4gdm9pZCk6IHRoaXM7XG4gIHB1YmxpYyBhYnN0cmFjdCBvbkxvYWQoZm46ICgpID0+IHZvaWQpOiB2b2lkO1xuICBwdWJsaWMgYWJzdHJhY3QgcXVlcnlSZW5kZXJlZEZlYXR1cmVzKHBvaW50T3JCb3g/OiB1bmtub3duLCBvcHRpb25zPzogeyBsYXllcnM/OiBzdHJpbmdbXTsgZmlsdGVyPzogYW55W107IH0pOiBhbnlbXTtcbiAgcHVibGljIGFic3RyYWN0IHJlc2l6ZShldmVudERhdGE/OiB1bmtub3duKTogdGhpcztcbiAgcHVibGljIGFic3RyYWN0IHNldENlbnRlcihjZW50ZXI6IHVua25vd24sIHVua25vd24/OiB1bmtub3duKTogdGhpcztcbiAgcHVibGljIGFic3RyYWN0IHNldE1heEJvdW5kcyh1bmtub3duPzogdW5rbm93bik6IHRoaXM7XG4gIHB1YmxpYyBhYnN0cmFjdCBzZXRGaWx0ZXIobGF5ZXI6IHN0cmluZywgZmlsdGVyPzogYm9vbGVhbiB8IGFueVtdLCBvcHRpb25zPzogdW5rbm93bik6IHRoaXM7XG4gIHB1YmxpYyBhYnN0cmFjdCBwYWRkZWRCb3VuZHMobnBhZDogbnVtYmVyLCBzcGFkOiBudW1iZXIsIGVwYWQ6IG51bWJlcixcbiAgICB3cGFkOiBudW1iZXIsIG1hcDogYW55LCBTVzogQXJsYXNMbmdMYXQsIE5FOiBBcmxhc0xuZ0xhdCk6IEFybGFzTG5nTGF0W107XG5cblxuICAvKiogR2V0cyBib3VuZHMgb2YgdGhlIGdpdmVuIGdlb21ldHJ5ICovXG4gIHB1YmxpYyBnZW9tZXRyeVRvQm91bmRzKGdlb21ldHJ5OiBhbnksIHBhZGRpbmdQZXJjZW50YWdlPzogbnVtYmVyKTogQXJsYXNMbmdMYXRCb3VuZHMge1xuICAgIGNvbnN0IGJvdW5kaW5nQm94OiBhbnkgPSBiYm94KGdlb21ldHJ5KTtcbiAgICBsZXQgd2VzdCA9IGJvdW5kaW5nQm94WzBdO1xuICAgIGxldCBzb3V0aCA9IGJvdW5kaW5nQm94WzFdO1xuICAgIGxldCBlYXN0ID0gYm91bmRpbmdCb3hbMl07XG4gICAgbGV0IG5vcnRoID0gYm91bmRpbmdCb3hbM107XG4gICAgaWYgKHBhZGRpbmdQZXJjZW50YWdlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB3aWR0aCA9IGVhc3QgLSB3ZXN0O1xuICAgICAgbGV0IGhlaWdodCA9IG5vcnRoIC0gc291dGg7XG4gICAgICAvKiogaWYgdGhlcmUgaXMgb25lIGhpdCwgdGhlbiB3ZXN0PWVhc3QgPT09PiB3ZSBjb25zaWRlciBhIHdpZHRoIG9mIDAuMDXCsCovXG4gICAgICBpZiAod2lkdGggPT09IDApIHtcbiAgICAgICAgd2lkdGggPSAwLjA1O1xuICAgICAgfVxuICAgICAgLyoqIGlmIHRoZXJlIGlzIG9uZSBoaXQsIHRoZW4gbm9ydGg9c291dGggPT09PiB3ZSBjb25zaWRlciBhIGhlaWdodCBvZiAwLjA1wrAqL1xuICAgICAgaWYgKGhlaWdodCA9PT0gMCkge1xuICAgICAgICBoZWlnaHQgPSAwLjA1O1xuICAgICAgfVxuICAgICAgd2VzdCA9IHdlc3QgLSBwYWRkaW5nUGVyY2VudGFnZSAqIHdpZHRoO1xuICAgICAgc291dGggPSBNYXRoLm1heCgtOTAsIHNvdXRoIC0gcGFkZGluZ1BlcmNlbnRhZ2UgKiBoZWlnaHQpO1xuICAgICAgZWFzdCA9IGVhc3QgKyBwYWRkaW5nUGVyY2VudGFnZSAqIHdpZHRoO1xuICAgICAgbm9ydGggPSBNYXRoLm1pbig5MCwgbm9ydGggKyBwYWRkaW5nUGVyY2VudGFnZSAqIGhlaWdodCk7XG4gICAgfVxuICAgIGNvbnN0IGJvdW5kcyA9IG5ldyBBcmxhc0xuZ0xhdEJvdW5kcyhcbiAgICAgIG5ldyBBcmxhc0xuZ0xhdCh3ZXN0LCBzb3V0aCksXG4gICAgICBuZXcgQXJsYXNMbmdMYXQoZWFzdCwgbm9ydGgpXG4gICAgKTtcbiAgICByZXR1cm4gYm91bmRzO1xuICB9XG5cbn1cblxuIl19