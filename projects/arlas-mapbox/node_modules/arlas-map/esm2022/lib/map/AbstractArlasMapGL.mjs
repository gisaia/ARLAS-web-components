/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { fromEvent, map } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { ArlasLngLat, ArlasLngLatBounds } from './model/map';
import { marker } from '@colsen1991/ngx-translate-extract-marker';
import bbox from '@turf/bbox';
export const GEOJSON_SOURCE_TYPE = 'geojson';
export const CROSS_LAYER_PREFIX = 'arlas_cross';
export const ZOOM_IN = marker('Zoom in');
export const ZOOM_OUT = marker('Zoom out');
export const RESET_BEARING = marker('Reset bearing to north');
export const LAYER_SWITCHER_TOOLTIP = marker('Manage layers');
/**
 * The aim of this class is to handle all core interaction we have
 * with a map provider.
 * The aim is also to separate the Arlas map from the Angular framework.
 * It will be instantiated in the map.component and will be responsible for initializing the map and all map behavior.
 */
export class AbstractArlasMapGL {
    constructor(config) {
        this.config = config;
        this.POLYGON_LABEL_SOURCE = 'polygon_label';
        this._eventSubscription = [];
        this.evented = new EventTarget();
        this.config = config;
        this._offset = config.offset;
        this._margePanForLoad = config.margePanForLoad;
        this._margePanForTest = config.margePanForTest;
        this._displayCurrentCoordinates = config.displayCurrentCoordinates ?? false;
        this._wrapLatLng = config.wrapLatLng ?? true;
        this._controls = config.controls;
        this._fitBoundsPadding = config.fitBoundsPadding ?? 10;
        this._maxWidthScale = config.maxWidthScale;
        this._unitScale = config.unitScale;
        this.init(config);
    }
    init(config) {
        try {
            this._initMapProvider(config);
            this._initControls();
            this._initOnLoad();
            this._initMapMoveEvents();
        }
        catch (e) {
            console.log(e);
        }
    }
    _initOnLoad() {
        this.onLoad(() => {
            this.evented.dispatchEvent(new Event('beforeOnLoadInit'));
            this._updateBounds();
            this._updateZoom();
            this.getMapProvider().fitBounds(this.getBounds());
        });
    }
    onCustomEvent(event, loadFn) {
        this.evented.addEventListener(event, loadFn);
    }
    _initMapMoveEvents() {
        this._zoomStart$ = fromEvent(this.getMapProvider(), 'zoomstart')
            .pipe(debounceTime(750));
        this._dragStart$ = fromEvent(this.getMapProvider(), 'dragstart')
            .pipe(debounceTime(750));
        this._dragEnd$ = fromEvent(this.getMapProvider(), 'dragend')
            .pipe(debounceTime(750));
        this._moveEnd$ = fromEvent(this.getMapProvider(), 'moveend')
            .pipe(debounceTime(750));
        this._updateOnZoomStart();
        this._updateOnDragStart();
        this._updateOnDragEnd();
        this._updateOnMoveEnd();
    }
    _updateBounds() {
        this._west = this.getWestBounds();
        this._south = this.getSouthBounds();
        this._east = this.getEastBounds();
        this._north = this.getNorthBounds();
    }
    _updateZoom(e) {
        this.zoom = this.getZoom();
    }
    _updateCurrentLngLat(e) {
        const lngLat = e.lngLat;
        if (this._displayCurrentCoordinates) {
            const displayedLngLat = this._wrapLatLng ? lngLat.wrap() : lngLat;
            this.currentLng = String(Math.round(displayedLngLat.lng * 100000) / 100000);
            this.currentLat = String(Math.round(displayedLngLat.lat * 100000) / 100000);
        }
    }
    _updateDragEnd(e) {
        if (e.originalEvent) {
            this._dragEndX = e.originalEvent.clientX;
            this._dragEndY = e.originalEvent.clientY;
        }
    }
    _updateDragStart(e) {
        this._dragStartX = e.originalEvent.clientX;
        this._dragStartY = e.originalEvent.clientY;
    }
    _updateEndLngLat(e) {
        this.endLngLat = e.lngLat;
    }
    _updateMoveRatio(e) {
        this._xMoveRatio = Math.abs(this._dragEndX - this._dragStartX) / e.target._canvas.clientWidth;
        this._yMoveRatio = Math.abs(this._dragEndY - this._dragStartY) / e.target._canvas.clientHeight;
    }
    _updateStartLngLat(e) {
        this.startLngLat = e.lngLat;
    }
    _updateZoomStart() {
        this._zoomStart = this.getZoom();
    }
    _updateOnZoomStart() {
        const sub = this._zoomStart$.subscribe(_ => this._updateZoomStart());
        this._eventSubscription.push(sub);
    }
    _updateOnDragStart() {
        const sub = this._dragStart$.subscribe(e => this._updateDragStart(e));
        this._eventSubscription.push(sub);
    }
    _updateOnDragEnd() {
        const sub = this._dragEnd$
            .subscribe(e => {
            this._updateDragEnd(e);
            this._updateMoveRatio(e);
        });
        this._eventSubscription.push(sub);
    }
    _updateOnMoveEnd() {
        const sub = this._moveEnd$
            .subscribe(_ => {
            this._updateBounds();
            this._updateZoom();
        });
        this._eventSubscription.push(sub);
    }
    onMoveEnd(visualisationsSets, cb) {
        return this._moveEnd$
            .pipe(map(_ => {
            this._updateBounds();
            this._updateZoom();
            if (cb) {
                cb();
            }
            return this._getMoveEnd(visualisationsSets);
        }));
    }
    setLayoutProperty(layer, name, value, options) {
        this.getMapProvider().setLayoutProperty(layer, name, value, options);
        return this;
    }
    unsubscribeEvents() {
        this._eventSubscription.forEach(s => s.unsubscribe());
    }
    getMaxZoom() {
        return this.getMapProvider().getMaxZoom();
    }
    getMinZoom() {
        return this.getMapProvider().getMinZoom();
    }
    getPitch() {
        return this.getMapProvider().getPitch();
    }
    /** Gets bounds of the given geometry */
    geometryToBounds(geometry, paddingPercentage) {
        const boundingBox = bbox(geometry);
        let west = boundingBox[0];
        let south = boundingBox[1];
        let east = boundingBox[2];
        let north = boundingBox[3];
        if (paddingPercentage !== undefined) {
            let width = east - west;
            let height = north - south;
            /** if there is one hit, then west=east ===> we consider a width of 0.05°*/
            if (width === 0) {
                width = 0.05;
            }
            /** if there is one hit, then north=south ===> we consider a height of 0.05°*/
            if (height === 0) {
                height = 0.05;
            }
            west = west - paddingPercentage * width;
            south = Math.max(-90, south - paddingPercentage * height);
            east = east + paddingPercentage * width;
            north = Math.min(90, north + paddingPercentage * height);
        }
        const bounds = new ArlasLngLatBounds(new ArlasLngLat(west, south), new ArlasLngLat(east, north));
        return bounds;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWJzdHJhY3RBcmxhc01hcEdMLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvbWFwL0Fic3RyYWN0QXJsYXNNYXBHTC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBNEIsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQWdCLE1BQU0sYUFBYSxDQUFDO0FBQzNFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNsRSxPQUFPLElBQUksTUFBTSxZQUFZLENBQUM7QUF3QjlCLE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLFNBQVMsQ0FBQztBQUU3QyxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxhQUFhLENBQUM7QUFDaEQsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN6QyxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUM5RCxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7QUFFOUQ7Ozs7O0dBS0c7QUFDSCxNQUFNLE9BQWdCLGtCQUFrQjtJQWdEdEMsWUFBZ0MsTUFBc0I7UUFBdEIsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUEzQnRDLHlCQUFvQixHQUFHLGVBQWUsQ0FBQztRQXVCN0MsdUJBQWtCLEdBQW1CLEVBQUUsQ0FBQztRQUV4QyxZQUFPLEdBQUcsSUFBSSxXQUFXLEVB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LElBQUksR0FBRyxJQUFJLENBQUM7WUFDeEIsSUFBSSxNQUFNLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUMzQiwyRUFBMkU7WUFDM0UsSUFBSSxLQUFLLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ2hCLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDZixDQUFDO1lBQ0QsOEVBQThFO1lBQzlFLElBQUksTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNqQixNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ2hCLENBQUM7WUFDRCxJQUFJLEdBQUcsSUFBSSxHQUFHLGlCQUFpQixHQUFHLEtBQUssQ0FBQztZQUN4QyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEdBQUcsaUJBQWlCLEdBQUcsTUFBTSxDQUFDLENBQUM7WUFDMUQsSUFBSSxHQUFHLElBQUksR0FBRyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7WUFDeEMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEtBQUssR0FBRyxpQkFBaUIsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUMzRCxDQUFDO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxpQkFBaUIsQ0FDbEMsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUM1QixJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQzdCLENBQUM7UUFDRixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgZnJvbUV2ZW50LCBtYXAsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ29udHJvbFBvc2l0aW9uLCBDb250cm9sc09wdGlvbiwgRHJhd0NvbnRyb2xzT3B0aW9uIH0gZnJvbSAnLi9tb2RlbC9jb250cm9scyc7XG5pbXBvcnQgeyBNYXBFeHRlbnQgfSBmcm9tICcuL21vZGVsL2V4dGVudCc7XG5pbXBvcnQgeyBBcmxhc0xuZ0xhdCwgQXJsYXNMbmdMYXRCb3VuZHMsIE9uTW92ZVJlc3VsdCB9IGZyb20gJy4vbW9kZWwvbWFwJztcbmltcG9ydCB7IG1hcmtlciB9IGZyb20gJ0Bjb2xzZW4xOTkxL25neC10cmFuc2xhdGUtZXh0cmFjdC1tYXJrZXInO1xuaW1wb3J0IGJib3ggZnJvbSAnQHR1cmYvYmJveCc7XG5cblxuLyoqIENvbmYgKi9cbmV4cG9ydCBpbnRlcmZhY2UgTWFwQ29uZmlnPFQ+IHtcbiAgZGlzcGxheUN1cnJlbnRDb29yZGluYXRlczogYm9vbGVhbjtcbiAgZml0Qm91bmRzUGFkZGluZzogbnVtYmVyO1xuICBtYXJnZVBhbkZvckxvYWQ6IG51bWJlcjtcbiAgbWFyZ2VQYW5Gb3JUZXN0OiBudW1iZXI7XG4gIHdyYXBMYXRMbmc6IGJvb2xlYW47XG4gIG9mZnNldDogQXJsYXNNYXBPZmZzZXQ7XG4gIG1hcFByb3ZpZGVyT3B0aW9ucz86IFQ7XG4gIG1heFdpZHRoU2NhbGU/OiBudW1iZXI7XG4gIHVuaXRTY2FsZT86IHN0cmluZztcbiAgY29udHJvbHM/OiBDb250cm9sc09wdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcmxhc01hcE9mZnNldCB7XG4gIG5vcnRoOiBudW1iZXI7XG4gIGVhc3Q6IG51bWJlcjtcbiAgc291dGg6IG51bWJlcjtcbiAgd2VzdDogbnVtYmVyO1xufVxuXG5leHBvcnQgY29uc3QgR0VPSlNPTl9TT1VSQ0VfVFlQRSA9ICdnZW9qc29uJztcblxuZXhwb3J0IGNvbnN0IENST1NTX0xBWUVSX1BSRUZJWCA9ICdhcmxhc19jcm9zcyc7XG5leHBvcnQgY29uc3QgWk9PTV9JTiA9IG1hcmtlcignWm9vbSBpbicpO1xuZXhwb3J0IGNvbnN0IFpPT01fT1VUID0gbWFya2VyKCdab29tIG91dCcpO1xuZXhwb3J0IGNvbnN0IFJFU0VUX0JFQVJJTkcgPSBtYXJrZXIoJ1Jlc2V0IGJlYXJpbmcgdG8gbm9ydGgnKTtcbmV4cG9ydCBjb25zdCBMQVlFUl9TV0lUQ0hFUl9UT09MVElQID0gbWFya2VyKCdNYW5hZ2UgbGF5ZXJzJyk7XG5cbi8qKlxuICogVGhlIGFpbSBvZiB0aGlzIGNsYXNzIGlzIHRvIGhhbmRsZSBhbGwgY29yZSBpbnRlcmFjdGlvbiB3ZSBoYXZlXG4gKiB3aXRoIGEgbWFwIHByb3ZpZGVyLlxuICogVGhlIGFpbSBpcyBhbHNvIHRvIHNlcGFyYXRlIHRoZSBBcmxhcyBtYXAgZnJvbSB0aGUgQW5ndWxhciBmcmFtZXdvcmsuXG4gKiBJdCB3aWxsIGJlIGluc3RhbnRpYXRlZCBpbiB0aGUgbWFwLmNvbXBvbmVudCBhbmQgd2lsbCBiZSByZXNwb25zaWJsZSBmb3IgaW5pdGlhbGl6aW5nIHRoZSBtYXAgYW5kIGFsbCBtYXAgYmVoYXZpb3IuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBYnN0cmFjdEFybGFzTWFwR0wge1xuICAvKipcbiAgICogIHByb3BzIGFuZCBtZXRob2RzIHdpdGggdW5rbm93biB0eXBlIHdpbGwgYmUgc3BlY2lmaWMgdG8gdGhlIG1hcCBwcm92aWRlclxuICAgKiAgd2UgdXNlLlxuICAgKiAgZXg6IGVuZExuZ0xhdCB3aWxsIGhhdmUgYSB0eXBlIE1hcGxpYnJlLlBvaW50bGlrZS8gTWFwYm94LlBvaW50XG4gICAqL1xuXG4gIHB1YmxpYyBhYnN0cmFjdCBzdGFydExuZ0xhdDogQXJsYXNMbmdMYXQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBlbmRMbmdMYXQ6IEFybGFzTG5nTGF0O1xuICBwdWJsaWMgYWJzdHJhY3QgbW92ZUxuZ0xhdDogQXJsYXNMbmdMYXQ7XG4gIHByb3RlY3RlZCBfb2Zmc2V0OiBBcmxhc01hcE9mZnNldDtcbiAgcHJvdGVjdGVkIF9tYXJnZVBhbkZvckxvYWQ6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9tYXJnZVBhbkZvclRlc3Q6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9maXRCb3VuZHNQYWRkaW5nOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfZGlzcGxheUN1cnJlbnRDb29yZGluYXRlczogYm9vbGVhbjtcbiAgcHJvdGVjdGVkIF93cmFwTGF0TG5nOiBib29sZWFuO1xuICBwcm90ZWN0ZWQgX2NvbnRyb2xzOiBDb250cm9sc09wdGlvbjtcbiAgcHJvdGVjdGVkIF9tYXhXaWR0aFNjYWxlPzogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX3VuaXRTY2FsZT86IHN0cmluZztcbiAgcHVibGljIGN1cnJlbnRMYXQ6IHN0cmluZztcbiAgcHVibGljIGN1cnJlbnRMbmc6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IFBPTFlHT05fTEFCRUxfU09VUkNFID0gJ3BvbHlnb25fbGFiZWwnO1xuXG4gIHByb3RlY3RlZCBfbm9ydGg6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9lYXN0OiBudW1iZXI7XG4gIHByb3RlY3RlZCBfd2VzdDogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX3NvdXRoOiBudW1iZXI7XG4gIHB1YmxpYyB6b29tOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfem9vbVN0YXJ0OiBudW1iZXI7XG5cbiAgcHJvdGVjdGVkIF9kcmFnU3RhcnRYOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfZHJhZ1N0YXJ0WTogbnVtYmVyO1xuXG4gIHByb3RlY3RlZCBfZHJhZ0VuZFg6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF9kcmFnRW5kWTogbnVtYmVyO1xuXG4gIHByb3RlY3RlZCBfeE1vdmVSYXRpbzogbnVtYmVyO1xuICBwcm90ZWN0ZWQgX3lNb3ZlUmF0aW86IG51bWJlcjtcblxuICBwcm90ZWN0ZWQgX21vdmVFbmQkOiBPYnNlcnZhYmxlPGFueT47XG4gIHByb3RlY3RlZCBfem9vbVN0YXJ0JDogT2JzZXJ2YWJsZTxhbnk+O1xuICBwcm90ZWN0ZWQgX2RyYWdTdGFydCQ6IE9ic2VydmFibGU8YW55PjtcbiAgcHJvdGVjdGVkIF9kcmFnRW5kJDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gIHByb3RlY3RlZCBfZXZlbnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgcHJvdGVjdGVkIGV2ZW50ZWQgPSBuZXcgRXZlbnRUYXJnZXQoKTtcblxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJvdGVjdGVkIGNvbmZpZzogTWFwQ29uZmlnPGFueT4pIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLl9vZmZzZXQgPSBjb25maWcub2Zmc2V0O1xuICAgIHRoaXMuX21hcmdlUGFuRm9yTG9hZCA9IGNvbmZpZy5tYXJnZVBhbkZvckxvYWQ7XG4gICAgdGhpcy5fbWFyZ2VQYW5Gb3JUZXN0ID0gY29uZmlnLm1hcmdlUGFuRm9yVGVzdDtcbiAgICB0aGlzLl9kaXNwbGF5Q3VycmVudENvb3JkaW5hdGVzID0gY29uZmlnLmRpc3BsYXlDdXJyZW50Q29vcmRpbmF0ZXMgPz8gZmFsc2U7XG4gICAgdGhpcy5fd3JhcExhdExuZyA9IGNvbmZpZy53cmFwTGF0TG5nID8/IHRydWU7XG4gICAgdGhpcy5fY29udHJvbHMgPSBjb25maWcuY29udHJvbHM7XG4gICAgdGhpcy5fZml0Qm91bmRzUGFkZGluZyA9IGNvbmZpZy5maXRCb3VuZHNQYWRkaW5nID8/IDEwO1xuICAgIHRoaXMuX21heFdpZHRoU2NhbGUgPSBjb25maWcubWF4V2lkdGhTY2FsZTtcbiAgICB0aGlzLl91bml0U2NhbGUgPSBjb25maWcudW5pdFNjYWxlO1xuICAgIHRoaXMuaW5pdChjb25maWcpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluaXQoY29uZmlnOiBNYXBDb25maWc8YW55Pik6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl9pbml0TWFwUHJvdmlkZXIoY29uZmlnKTtcbiAgICAgIHRoaXMuX2luaXRDb250cm9scygpO1xuICAgICAgdGhpcy5faW5pdE9uTG9hZCgpO1xuICAgICAgdGhpcy5faW5pdE1hcE1vdmVFdmVudHMoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX2luaXRPbkxvYWQoKSB7XG4gICAgdGhpcy5vbkxvYWQoKCkgPT4ge1xuICAgICAgdGhpcy5ldmVudGVkLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdiZWZvcmVPbkxvYWRJbml0JykpO1xuICAgICAgdGhpcy5fdXBkYXRlQm91bmRzKCk7XG4gICAgICB0aGlzLl91cGRhdGVab29tKCk7XG4gICAgICB0aGlzLmdldE1hcFByb3ZpZGVyKCkuZml0Qm91bmRzKHRoaXMuZ2V0Qm91bmRzKCkpO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG9uQ3VzdG9tRXZlbnQoZXZlbnQ6IHN0cmluZywgbG9hZEZuOiAoKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5ldmVudGVkLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGxvYWRGbik7XG4gIH1cblxuICBwcm90ZWN0ZWQgX2luaXRNYXBNb3ZlRXZlbnRzKCkge1xuICAgIHRoaXMuX3pvb21TdGFydCQgPSBmcm9tRXZlbnQodGhpcy5nZXRNYXBQcm92aWRlcigpLCAnem9vbXN0YXJ0JylcbiAgICAgIC5waXBlKGRlYm91bmNlVGltZSg3NTApKTtcblxuICAgIHRoaXMuX2RyYWdTdGFydCQgPSBmcm9tRXZlbnQodGhpcy5nZXRNYXBQcm92aWRlcigpLCAnZHJhZ3N0YXJ0JylcbiAgICAgIC5waXBlKGRlYm91bmNlVGltZSg3NTApKTtcblxuICAgIHRoaXMuX2RyYWdFbmQkID0gZnJvbUV2ZW50KHRoaXMuZ2V0TWFwUHJvdmlkZXIoKSwgJ2RyYWdlbmQnKVxuICAgICAgLnBpcGUoZGVib3VuY2VUaW1lKDc1MCkpO1xuXG4gICAgdGhpcy5fbW92ZUVuZCQgPSBmcm9tRXZlbnQodGhpcy5nZXRNYXBQcm92aWRlcigpLCAnbW92ZWVuZCcpXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUoNzUwKSk7XG5cbiAgICB0aGlzLl91cGRhdGVPblpvb21TdGFydCgpO1xuICAgIHRoaXMuX3VwZGF0ZU9uRHJhZ1N0YXJ0KCk7XG4gICAgdGhpcy5fdXBkYXRlT25EcmFnRW5kKCk7XG4gICAgdGhpcy5fdXBkYXRlT25Nb3ZlRW5kKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZUJvdW5kcygpOiB2b2lkIHtcbiAgICB0aGlzLl93ZXN0ID0gdGhpcy5nZXRXZXN0Qm91bmRzKCk7XG4gICAgdGhpcy5fc291dGggPSB0aGlzLmdldFNvdXRoQm91bmRzKCk7XG4gICAgdGhpcy5fZWFzdCA9IHRoaXMuZ2V0RWFzdEJvdW5kcygpO1xuICAgIHRoaXMuX25vcnRoID0gdGhpcy5nZXROb3J0aEJvdW5kcygpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVab29tKGU/OiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnpvb20gPSB0aGlzLmdldFpvb20oKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlQ3VycmVudExuZ0xhdChlOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBsbmdMYXQgPSBlLmxuZ0xhdDtcbiAgICBpZiAodGhpcy5fZGlzcGxheUN1cnJlbnRDb29yZGluYXRlcykge1xuICAgICAgY29uc3QgZGlzcGxheWVkTG5nTGF0ID0gdGhpcy5fd3JhcExhdExuZyA/IGxuZ0xhdC53cmFwKCkgOiBsbmdMYXQ7XG4gICAgICB0aGlzLmN1cnJlbnRMbmcgPSBTdHJpbmcoTWF0aC5yb3VuZChkaXNwbGF5ZWRMbmdMYXQubG5nICogMTAwMDAwKSAvIDEwMDAwMCk7XG4gICAgICB0aGlzLmN1cnJlbnRMYXQgPSBTdHJpbmcoTWF0aC5yb3VuZChkaXNwbGF5ZWRMbmdMYXQubGF0ICogMTAwMDAwKSAvIDEwMDAwMCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVEcmFnRW5kKGU6IGFueSk6IHZvaWQge1xuICAgIGlmIChlLm9yaWdpbmFsRXZlbnQpIHtcbiAgICAgIHRoaXMuX2RyYWdFbmRYID0gZS5vcmlnaW5hbEV2ZW50LmNsaWVudFg7XG4gICAgICB0aGlzLl9kcmFnRW5kWSA9IGUub3JpZ2luYWxFdmVudC5jbGllbnRZO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlRHJhZ1N0YXJ0KGU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuX2RyYWdTdGFydFggPSBlLm9yaWdpbmFsRXZlbnQuY2xpZW50WDtcbiAgICB0aGlzLl9kcmFnU3RhcnRZID0gZS5vcmlnaW5hbEV2ZW50LmNsaWVudFk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZUVuZExuZ0xhdChlOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmVuZExuZ0xhdCA9IGUubG5nTGF0O1xuICB9XG5cbiAgcHJvdGVjdGVkIF91cGRhdGVNb3ZlUmF0aW8oZTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5feE1vdmVSYXRpbyA9IE1hdGguYWJzKHRoaXMuX2RyYWdFbmRYIC0gdGhpcy5fZHJhZ1N0YXJ0WCkgLyBlLnRhcmdldC5fY2FudmFzLmNsaWVudFdpZHRoO1xuICAgIHRoaXMuX3lNb3ZlUmF0aW8gPSBNYXRoLmFicyh0aGlzLl9kcmFnRW5kWSAtIHRoaXMuX2RyYWdTdGFydFkpIC8gZS50YXJnZXQuX2NhbnZhcy5jbGllbnRIZWlnaHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZVN0YXJ0TG5nTGF0KGU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuc3RhcnRMbmdMYXQgPSBlLmxuZ0xhdDtcbiAgfVxuXG5cbiAgcHJvdGVjdGVkIF91cGRhdGVab29tU3RhcnQoKTogdm9pZCB7XG4gICAgdGhpcy5fem9vbVN0YXJ0ID0gdGhpcy5nZXRab29tKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZU9uWm9vbVN0YXJ0KCkge1xuICAgIGNvbnN0IHN1YiA9IHRoaXMuX3pvb21TdGFydCQuc3Vic2NyaWJlKF8gPT4gdGhpcy5fdXBkYXRlWm9vbVN0YXJ0KCkpO1xuICAgIHRoaXMuX2V2ZW50U3Vic2NyaXB0aW9uLnB1c2goc3ViKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlT25EcmFnU3RhcnQoKSB7XG4gICAgY29uc3Qgc3ViID0gdGhpcy5fZHJhZ1N0YXJ0JC5zdWJzY3JpYmUoZSA9PiB0aGlzLl91cGRhdGVEcmFnU3RhcnQoZSkpO1xuICAgIHRoaXMuX2V2ZW50U3Vic2NyaXB0aW9uLnB1c2goc3ViKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfdXBkYXRlT25EcmFnRW5kKCkge1xuICAgIGNvbnN0IHN1YiA9IHRoaXMuX2RyYWdFbmQkXG4gICAgICAuc3Vic2NyaWJlKGUgPT4ge1xuICAgICAgICB0aGlzLl91cGRhdGVEcmFnRW5kKGUpO1xuICAgICAgICB0aGlzLl91cGRhdGVNb3ZlUmF0aW8oZSk7XG4gICAgICB9KTtcbiAgICB0aGlzLl9ldmVudFN1YnNjcmlwdGlvbi5wdXNoKHN1Yik7XG4gIH1cblxuICBwcm90ZWN0ZWQgX3VwZGF0ZU9uTW92ZUVuZCgpIHtcbiAgICBjb25zdCBzdWIgPSB0aGlzLl9tb3ZlRW5kJFxuICAgICAgLnN1YnNjcmliZShfID0+IHtcbiAgICAgICAgdGhpcy5fdXBkYXRlQm91bmRzKCk7XG4gICAgICAgIHRoaXMuX3VwZGF0ZVpvb20oKTtcbiAgICAgIH0pO1xuICAgIHRoaXMuX2V2ZW50U3Vic2NyaXB0aW9uLnB1c2goc3ViKTtcbiAgfVxuXG4gIHB1YmxpYyBvbk1vdmVFbmQodmlzdWFsaXNhdGlvbnNTZXRzOiB7XG4gICAgdmlzdWFsaXNhdGlvbnM6IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PjtcbiAgICBzdGF0dXM6IE1hcDxzdHJpbmcsIGJvb2xlYW4+O1xuICB9LCBjYj86ICgpID0+IHZvaWQpIHtcbiAgICByZXR1cm4gdGhpcy5fbW92ZUVuZCRcbiAgICAgIC5waXBlKG1hcChfID0+IHtcbiAgICAgICAgdGhpcy5fdXBkYXRlQm91bmRzKCk7XG4gICAgICAgIHRoaXMuX3VwZGF0ZVpvb20oKTtcbiAgICAgICAgaWYgKGNiKSB7XG4gICAgICAgICAgY2IoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0TW92ZUVuZCh2aXN1YWxpc2F0aW9uc1NldHMpO1xuICAgICAgfSkpO1xuICB9XG5cbiAgcHVibGljIHNldExheW91dFByb3BlcnR5KGxheWVyOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgb3B0aW9ucz86IGFueSkge1xuICAgIHRoaXMuZ2V0TWFwUHJvdmlkZXIoKS5zZXRMYXlvdXRQcm9wZXJ0eShsYXllciwgbmFtZSwgdmFsdWUsIG9wdGlvbnMpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHVuc3Vic2NyaWJlRXZlbnRzKCkge1xuICAgIHRoaXMuX2V2ZW50U3Vic2NyaXB0aW9uLmZvckVhY2gocyA9PiBzLnVuc3Vic2NyaWJlKCkpO1xuICB9XG5cbiAgcHVibGljIGdldE1heFpvb20oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5nZXRNYXBQcm92aWRlcigpLmdldE1heFpvb20oKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRNaW5ab29tKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TWFwUHJvdmlkZXIoKS5nZXRNaW5ab29tKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0UGl0Y2goKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5nZXRNYXBQcm92aWRlcigpLmdldFBpdGNoKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2luaXRNYXBQcm92aWRlcihCYXNlTWFwR2xDb25maWcpOiB2b2lkO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2luaXRDb250cm9scygpOiB2b2lkO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgX2dldE1vdmVFbmQodmlzdWFsaXNhdGlvbnNTZXRzOiB7XG4gICAgdmlzdWFsaXNhdGlvbnM6IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PjtcbiAgICBzdGF0dXM6IE1hcDxzdHJpbmcsIGJvb2xlYW4+O1xuICB9KTogT25Nb3ZlUmVzdWx0O1xuXG4gIHB1YmxpYyBhYnN0cmFjdCBhZGRDb250cm9sKGNvbnRyb2w6IGFueSwgcG9zaXRpb24/OiBDb250cm9sUG9zaXRpb24sIGV2ZW50T3ZlcnJpZGU/OiB7XG4gICAgZXZlbnQ6IHN0cmluZzsgZm46IChlPykgPT4gdm9pZDtcbiAgfSk7XG4gIHB1YmxpYyBhYnN0cmFjdCBjYWxjT2Zmc2V0UG9pbnQoKTogYW55O1xuICBwdWJsaWMgYWJzdHJhY3QgZGlzYWJsZURyYWdQYW4oKTogdm9pZDtcbiAgcHVibGljIGFic3RyYWN0IGVuYWJsZURyYWdQYW4oKTogdm9pZDtcbiAgcHVibGljIGFic3RyYWN0IGZpdEJvdW5kcyhib3VuZHM6IEFybGFzTG5nTGF0Qm91bmRzIHwgbnVtYmVyW10sIG9wdGlvbnM/OiB1bmtub3duLCB1bmtub3duPzogdW5rbm93bik6IHRoaXM7XG4gIHB1YmxpYyBhYnN0cmFjdCBmaXRUb1BhZGRlZEJvdW5kcyhib3VuZHM6IEFybGFzTG5nTGF0Qm91bmRzIHwgbnVtYmVyW10pO1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0Qm91bmRzKCk6IHVua25vd247XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRDYW52YXNDb250YWluZXIoKTogSFRNTEVsZW1lbnQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRFYXN0Qm91bmRzKCk6IG51bWJlcjtcbiAgcHVibGljIGFic3RyYWN0IGdldE1hcEV4dGVuZCgpOiBNYXBFeHRlbnQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRNYXBQcm92aWRlcigpOiBhbnk7XG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRNYXhCb3VuZHMoKTogdW5rbm93bjtcbiAgcHVibGljIGFic3RyYWN0IGdldE5vcnRoQm91bmRzKCk6IG51bWJlcjtcbiAgcHVibGljIGFic3RyYWN0IGdldE5vcnRoRWFzdEJvdW5kcygpOiBBcmxhc0xuZ0xhdDtcbiAgcHVibGljIGFic3RyYWN0IGdldFNvdXRoQm91bmRzKCk6IG51bWJlcjtcbiAgcHVibGljIGFic3RyYWN0IGdldFNvdXRoV2VzdEJvdW5kcygpOiBBcmxhc0xuZ0xhdDtcbiAgcHVibGljIGFic3RyYWN0IGdldFdlc3RCb3VuZHMoKTogbnVtYmVyO1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0Wm9vbSgpOiBudW1iZXI7XG4gIHB1YmxpYyBhYnN0cmFjdCBpbml0RHJhd0NvbnRyb2xzKGNvbmZpZzogRHJhd0NvbnRyb2xzT3B0aW9uKTogdm9pZDtcbiAgcHVibGljIGFic3RyYWN0IG9uKHR5cGU6IHN0cmluZywgbGlzdGVuZXI6IChldjogYW55KSA9PiB2b2lkKTogdGhpcztcbiAgcHVibGljIGFic3RyYWN0IG9uTG9hZChmbjogKCkgPT4gdm9pZCk6IHZvaWQ7XG4gIHB1YmxpYyBhYnN0cmFjdCBxdWVyeVJlbmRlcmVkRmVhdHVyZXMocG9pbnRPckJveD86IHVua25vd24sIG9wdGlvbnM/OiB7IGxheWVycz86IHN0cmluZ1tdOyBmaWx0ZXI/OiBhbnlbXTsgfSk6IGFueVtdO1xuICBwdWJsaWMgYWJzdHJhY3QgcmVzaXplKGV2ZW50RGF0YT86IHVua25vd24pOiB0aGlzO1xuICBwdWJsaWMgYWJzdHJhY3Qgc2V0Q2VudGVyKGNlbnRlcjogdW5rbm93biwgdW5rbm93bj86IHVua25vd24pOiB0aGlzO1xuICBwdWJsaWMgYWJzdHJhY3Qgc2V0TWF4Qm91bmRzKHVua25vd24/OiB1bmtub3duKTogdGhpcztcbiAgcHVibGljIGFic3RyYWN0IHNldEZpbHRlcihsYXllcjogc3RyaW5nLCBmaWx0ZXI/OiBib29sZWFuIHwgYW55W10sIG9wdGlvbnM/OiB1bmtub3duKTogdGhpcztcbiAgcHVibGljIGFic3RyYWN0IHBhZGRlZEJvdW5kcyhucGFkOiBudW1iZXIsIHNwYWQ6IG51bWJlciwgZXBhZDogbnVtYmVyLFxuICAgIHdwYWQ6IG51bWJlciwgbWFwOiBhbnksIFNXOiBBcmxhc0xuZ0xhdCwgTkU6IEFybGFzTG5nTGF0KTogQXJsYXNMbmdMYXRbXTtcblxuXG4gIC8qKiBHZXRzIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gZ2VvbWV0cnkgKi9cbiAgcHVibGljIGdlb21ldHJ5VG9Cb3VuZHMoZ2VvbWV0cnk6IGFueSwgcGFkZGluZ1BlcmNlbnRhZ2U/OiBudW1iZXIpOiBBcmxhc0xuZ0xhdEJvdW5kcyB7XG4gICAgY29uc3QgYm91bmRpbmdCb3g6IGFueSA9IGJib3goZ2VvbWV0cnkpO1xuICAgIGxldCB3ZXN0ID0gYm91bmRpbmdCb3hbMF07XG4gICAgbGV0IHNvdXRoID0gYm91bmRpbmdCb3hbMV07XG4gICAgbGV0IGVhc3QgPSBib3VuZGluZ0JveFsyXTtcbiAgICBsZXQgbm9ydGggPSBib3VuZGluZ0JveFszXTtcbiAgICBpZiAocGFkZGluZ1BlcmNlbnRhZ2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IHdpZHRoID0gZWFzdCAtIHdlc3Q7XG4gICAgICBsZXQgaGVpZ2h0ID0gbm9ydGggLSBzb3V0aDtcbiAgICAgIC8qKiBpZiB0aGVyZSBpcyBvbmUgaGl0LCB0aGVuIHdlc3Q9ZWFzdCA9PT0+IHdlIGNvbnNpZGVyIGEgd2lkdGggb2YgMC4wNcKwKi9cbiAgICAgIGlmICh3aWR0aCA9PT0gMCkge1xuICAgICAgICB3aWR0aCA9IDAuMDU7XG4gICAgICB9XG4gICAgICAvKiogaWYgdGhlcmUgaXMgb25lIGhpdCwgdGhlbiBub3J0aD1zb3V0aCA9PT0+IHdlIGNvbnNpZGVyIGEgaGVpZ2h0IG9mIDAuMDXCsCovXG4gICAgICBpZiAoaGVpZ2h0ID09PSAwKSB7XG4gICAgICAgIGhlaWdodCA9IDAuMDU7XG4gICAgICB9XG4gICAgICB3ZXN0ID0gd2VzdCAtIHBhZGRpbmdQZXJjZW50YWdlICogd2lkdGg7XG4gICAgICBzb3V0aCA9IE1hdGgubWF4KC05MCwgc291dGggLSBwYWRkaW5nUGVyY2VudGFnZSAqIGhlaWdodCk7XG4gICAgICBlYXN0ID0gZWFzdCArIHBhZGRpbmdQZXJjZW50YWdlICogd2lkdGg7XG4gICAgICBub3J0aCA9IE1hdGgubWluKDkwLCBub3J0aCArIHBhZGRpbmdQZXJjZW50YWdlICogaGVpZ2h0KTtcbiAgICB9XG4gICAgY29uc3QgYm91bmRzID0gbmV3IEFybGFzTG5nTGF0Qm91bmRzKFxuICAgICAgbmV3IEFybGFzTG5nTGF0KHdlc3QsIHNvdXRoKSxcbiAgICAgIG5ldyBBcmxhc0xuZ0xhdChlYXN0LCBub3J0aClcbiAgICApO1xuICAgIHJldHVybiBib3VuZHM7XG4gIH1cblxufVxuXG4iXX0=