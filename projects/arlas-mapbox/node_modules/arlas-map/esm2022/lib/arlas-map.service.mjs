/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Injectable } from '@angular/core';
import { ArlasMapFrameworkService } from './arlas-map-framework.service';
import { ExternalEvent } from './map/model/layers';
import * as i0 from "@angular/core";
import * as i1 from "./arlas-map-framework.service";
/**
 * This service propose a set of method to execute the ArlasMapComponent logic.
 * Do not confuse with ArlasMapFrameworkService that is more dedicated to a framework logic.
 */
/** L: a layer class/interface.
 *  S: a source class/interface.
 *  M: a Map configuration class/interface.
 */
export class AbstractArlasMapService {
    constructor(mapFrameworkService) {
        this.mapFrameworkService = mapFrameworkService;
        /** @description List of arlas data sources declared in configuration */
        this.dataSources = [];
        /**
         * @description Object to describe visualisation sets
         * - visulisations: a map of <visualisation name, set of layers identifiers>;
         * - status: a map of <visualisation name, visibility status>
         */
        this.visualisationsSets = {
            visualisations: new Map(),
            status: new Map()
        };
    }
    updateLabelSources(labelSourceId, data, map) {
        if (labelSourceId) {
            const source = this.mapFrameworkService.getSource(labelSourceId, map);
            this.mapFrameworkService.setDataToGeojsonSource(source, data);
        }
    }
    /**
     * @description Inits a map of visulisation sets from the configuration.
     * @param visualisationSetsConfig Visualisation set configuration.
     */
    initVisualisationSet(visualisationSetsConfig) {
        if (visualisationSetsConfig) {
            visualisationSetsConfig.forEach(visu => {
                this.visualisationsSets.visualisations.set(visu.name, new Set(visu.layers));
                this.visualisationsSets.status.set(visu.name, visu.enabled);
            });
        }
    }
    initMapLayers(mapLayers, map) {
        if (mapLayers) {
            this.setLayersMap(mapLayers);
        }
    }
    addArlasDataLayers(visualisationSetsConfig, mapLayers, map) {
        this.initMapLayers(mapLayers, map);
        this.initVisualisationSet(visualisationSetsConfig);
        for (let i = visualisationSetsConfig.length - 1; i >= 0; i--) {
            const visualisation = visualisationSetsConfig[i];
            if (visualisation.layers) {
                for (let j = visualisation.layers.length - 1; j >= 0; j--) {
                    const l = visualisation.layers[j];
                    const layer = this.layersMap.get(l);
                    this.addArlasDataLayer(map, layer, this.layersMap);
                }
            }
        }
        this._addExternalEventLayers(mapLayers, map);
        this.visualisationsSets.status.forEach((visible, vs) => {
            this.visualisationsSets.visualisations.get(vs).forEach(l => {
                this.mapFrameworkService.setLayerVisibility(l, visible, map);
            });
        });
        this.reorderLayers(visualisationSetsConfig, map);
    }
    _addExternalEventLayers(mapLayers, map) {
        if (mapLayers.externalEventLayers) {
            mapLayers.layers
                .filter(layer => mapLayers.externalEventLayers.map(e => e.id).indexOf(layer.id) >= 0)
                .forEach(l => {
                this.mapFrameworkService.addLayer(map, l);
            });
        }
    }
    reorderLayers(visualisationSetsConfig, map) {
        // parses the visulisation list from bottom in order to put the fist ones first
        for (let i = visualisationSetsConfig.length - 1; i >= 0; i--) {
            const visualisation = visualisationSetsConfig[i];
            if (!!visualisation.layers && visualisation.enabled) {
                for (let j = visualisation.layers.length - 1; j >= 0; j--) {
                    const l = visualisation.layers[j];
                    this.moveArlasDataLayer(map, l, this.layersMap);
                }
            }
        }
        this.reorderDrawLayers(map);
    }
    selectFeatures(mapLayers, map, elementToSelect) {
        if (elementToSelect) {
            const ids = elementToSelect.length > 0 ?
                elementToSelect.reduce((memo, element) => {
                    memo.push(element.idValue);
                    return memo;
                }, []) : [];
            const numericalIds = ids.filter(id => !isNaN(+id)).map(id => +id);
            const visibilityFilter = ids.length > 0 ? ['in', ['get', elementToSelect[0].idFieldName], ['literal', ids.concat(numericalIds)]] : [];
            this.filterLayers(mapLayers, map, (elementToSelect.length > 0), visibilityFilter, ExternalEvent.select);
        }
    }
    highlightFeature(mapLayers, map, featureToHightLight) {
        if (featureToHightLight?.elementidentifier) {
            const ids = [featureToHightLight.elementidentifier.idValue];
            if (!isNaN(+featureToHightLight.elementidentifier.idValue)) {
                ids.push(+featureToHightLight.elementidentifier.idValue);
            }
            const visibilityFilter = ['in', ['get', featureToHightLight.elementidentifier.idFieldName],
                ['literal', ids]];
            this.filterLayers(mapLayers, map, !featureToHightLight.isleaving, visibilityFilter, ExternalEvent.hover);
        }
    }
    selectFeaturesByCollection(mapLayers, map, features, collection) {
        const ids = features.map(f => f.idValue);
        const numericalIds = ids.filter(id => !isNaN(+id)).map(id => +id);
        const visibilityFilter = ids.length > 0 ? ['in', ['get', features[0].idFieldName], ['literal', ids.concat(numericalIds)]] : [];
        this.filterLayers(mapLayers, map, (features.length > 0), visibilityFilter, ExternalEvent.select, collection);
    }
    updateLayoutVisibility(visualisationName, visualisationSetsConfig, map) {
        const visuStatus = !this.visualisationsSets.status.get(visualisationName);
        visualisationSetsConfig.find(v => v.name === visualisationName).enabled = visuStatus;
        if (!visuStatus) {
            const layersSet = new Set(this.visualisationsSets.visualisations.get(visualisationName));
            this.visualisationsSets.visualisations.forEach((ls, v) => {
                if (v !== visualisationName) {
                    ls.forEach(ll => {
                        if (layersSet?.has(ll)) {
                            layersSet.delete(ll);
                        }
                    });
                }
            });
            layersSet.forEach(ll => {
                this.mapFrameworkService.setLayerVisibility(ll, false, map);
            });
        }
        this.visualisationsSets.status.set(visualisationName, visuStatus);
        const layers = new Set();
        this.visualisationsSets.visualisations.forEach((ls, v) => {
            if (this.visualisationsSets.status.get(v)) {
                ls.forEach(l => {
                    layers.add(l);
                    this.mapFrameworkService.setLayerVisibility(l, true, map);
                });
            }
        });
        return layers;
    }
    updateVisibility(visibilityStatus, visualisationSetsConfig, map) {
        visibilityStatus.forEach((visibilityStatus, l) => {
            let layerInVisualisations = false;
            if (!visibilityStatus) {
                visualisationSetsConfig.forEach(v => {
                    const ls = new Set(v.layers);
                    if (!layerInVisualisations) {
                        layerInVisualisations = ls.has(l);
                    }
                });
                if (layerInVisualisations) {
                    this.mapFrameworkService.setLayerVisibility(l, false, map);
                }
            }
            else {
                let oneVisualisationEnabled = false;
                visualisationSetsConfig.forEach(v => {
                    const ls = new Set(v.layers);
                    if (!layerInVisualisations) {
                        layerInVisualisations = ls.has(l);
                    }
                    if (ls.has(l) && v.enabled) {
                        oneVisualisationEnabled = true;
                        this.mapFrameworkService.setLayerVisibility(l, true, map);
                    }
                });
                if (!oneVisualisationEnabled && layerInVisualisations) {
                    this.mapFrameworkService.setLayerVisibility(l, false, map);
                }
            }
        });
    }
    findVisualisationSetLayer(visuName, visualisationSetsConfig) {
        return visualisationSetsConfig.find(v => v.name === visuName).layers;
    }
    setVisualisationSetLayers(visuName, layers, visualisationSetsConfig) {
        const f = visualisationSetsConfig.find(v => v.name === visuName);
        if (f) {
            f.layers = layers;
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: AbstractArlasMapService, deps: [{ token: i1.ArlasMapFrameworkService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: AbstractArlasMapService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: AbstractArlasMapService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [{ type: i1.ArlasMapFrameworkService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJsYXMtbWFwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hcmxhcy1tYXAvc3JjL2xpYi9hcmxhcy1tYXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBS3pFLE9BQU8sRUFBa0IsYUFBYSxFQUFhLE1BQU0sb0JBQW9CLENBQUM7OztBQUc5RTs7O0dBR0c7QUFJSDs7O0dBR0c7QUFDSCxNQUFNLE9BQWdCLHVCQUF1QjtJQWtCM0MsWUFBMEIsbUJBQXNEO1FBQXRELHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBbUM7UUFqQmhGLHdFQUF3RTtRQUNqRSxnQkFBVyxHQUFRLEVBQUUsQ0FBQztRQUc3Qjs7OztXQUlHO1FBQ0ksdUJBQWtCLEdBR3JCO1lBQ0EsY0FBYyxFQUFFLElBQUksR0FBRyxFQUFFO1lBQ3pCLE1BQU0sRUFBRSxJQUFJLEdBQUcsRUFBRTtTQUNsQixDQUFDO0lBRWdGLENBQUM7SUFnQjlFLGtCQUFrQixDQUFDLGFBQXFCLEVBQUUsSUFBeUMsRUFBRSxHQUF1QjtRQUNqSCxJQUFJLGFBQWEsRUFBRSxDQUFDO1lBQ2xCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3RFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDaEUsQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSSxvQkFBb0IsQ0FBQyx1QkFBaUQ7UUFDM0UsSUFBSSx1QkFBdUIsRUFBRSxDQUFDO1lBQzVCLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxJ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Q0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNOLENBQUMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3BCLENBQUM7SUFDSCxDQUFDOytHQTNPbUIsdUJBQXVCO21IQUF2Qix1QkFBdUIsY0FOL0IsTUFBTTs7NEZBTUUsdUJBQXVCO2tCQVA1QyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byBHaXNhw69hIHVuZGVyIG9uZSBvciBtb3JlIGNvbnRyaWJ1dG9yXG4gKiBsaWNlbnNlIGFncmVlbWVudHMuIFNlZSB0aGUgTk9USUNFLnR4dCBmaWxlIGRpc3RyaWJ1dGVkIHdpdGhcbiAqIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiByZWdhcmRpbmcgY29weXJpZ2h0XG4gKiBvd25lcnNoaXAuIEdpc2HDr2EgbGljZW5zZXMgdGhpcyBmaWxlIHRvIHlvdSB1bmRlclxuICogdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heVxuICogbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBcmxhc01hcEZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL2FybGFzLW1hcC1mcmFtZXdvcmsuc2VydmljZSc7XG5pbXBvcnQgeyBGZWF0dXJlQ29sbGVjdGlvbiB9IGZyb20gJ0B0dXJmL2hlbHBlcnMnO1xuaW1wb3J0IHsgQWJzdHJhY3RBcmxhc01hcEdMIH0gZnJvbSAnLi9tYXAvQWJzdHJhY3RBcmxhc01hcEdMJztcbmltcG9ydCB7IEFybGFzTWFwU291cmNlIH0gZnJvbSAnLi9tYXAvbW9kZWwvc291cmNlcyc7XG5pbXBvcnQgeyBWaXN1YWxpc2F0aW9uU2V0Q29uZmlnIH0gZnJvbSAnLi9tYXAvbW9kZWwvdmlzdWFsaXNhdGlvbnNldHMnO1xuaW1wb3J0IHsgQXJsYXNEYXRhTGF5ZXIsIEV4dGVybmFsRXZlbnQsIE1hcExheWVycyB9IGZyb20gJy4vbWFwL21vZGVsL2xheWVycyc7XG5pbXBvcnQgeyBFbGVtZW50SWRlbnRpZmllciB9IGZyb20gJ2FybGFzLXdlYi1jb21wb25lbnRzJztcblxuLyoqXG4gKiBUaGlzIHNlcnZpY2UgcHJvcG9zZSBhIHNldCBvZiBtZXRob2QgdG8gZXhlY3V0ZSB0aGUgQXJsYXNNYXBDb21wb25lbnQgbG9naWMuXG4gKiBEbyBub3QgY29uZnVzZSB3aXRoIEFybGFzTWFwRnJhbWV3b3JrU2VydmljZSB0aGF0IGlzIG1vcmUgZGVkaWNhdGVkIHRvIGEgZnJhbWV3b3JrIGxvZ2ljLlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbi8qKiBMOiBhIGxheWVyIGNsYXNzL2ludGVyZmFjZS5cbiAqICBTOiBhIHNvdXJjZSBjbGFzcy9pbnRlcmZhY2UuXG4gKiAgTTogYSBNYXAgY29uZmlndXJhdGlvbiBjbGFzcy9pbnRlcmZhY2UuXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBYnN0cmFjdEFybGFzTWFwU2VydmljZTxMLCBTLCBNPiB7XG4gIC8qKiBAZGVzY3JpcHRpb24gTGlzdCBvZiBhcmxhcyBkYXRhIHNvdXJjZXMgZGVjbGFyZWQgaW4gY29uZmlndXJhdGlvbiAqL1xuICBwdWJsaWMgZGF0YVNvdXJjZXM6IFNbXSA9IFtdO1xuICAvKiogQGRlc2NyaXB0aW9uIE1hcCBvZiBBUkxBUyBkYXRhIGxheWVycyBhbmQgdGhlaXIgaWRzICh0aGUgaWRzIGJlaW5nIHRoZSBrZXkgb2YgdGhlIG1hcCkuICAqL1xuICBwdWJsaWMgbGF5ZXJzTWFwOiBNYXA8c3RyaW5nLCBBcmxhc0RhdGFMYXllcj47XG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb24gT2JqZWN0IHRvIGRlc2NyaWJlIHZpc3VhbGlzYXRpb24gc2V0c1xuICAgKiAtIHZpc3VsaXNhdGlvbnM6IGEgbWFwIG9mIDx2aXN1YWxpc2F0aW9uIG5hbWUsIHNldCBvZiBsYXllcnMgaWRlbnRpZmllcnM+O1xuICAgKiAtIHN0YXR1czogYSBtYXAgb2YgPHZpc3VhbGlzYXRpb24gbmFtZSwgdmlzaWJpbGl0eSBzdGF0dXM+XG4gICAqL1xuICBwdWJsaWMgdmlzdWFsaXNhdGlvbnNTZXRzOiB7XG4gICAgdmlzdWFsaXNhdGlvbnM6IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PjtcbiAgICBzdGF0dXM6IE1hcDxzdHJpbmcsIGJvb2xlYW4+O1xuICB9ID0ge1xuICAgICAgdmlzdWFsaXNhdGlvbnM6IG5ldyBNYXAoKSxcbiAgICAgIHN0YXR1czogbmV3IE1hcCgpXG4gICAgfTtcblxuICBwdWJsaWMgY29uc3RydWN0b3IocHVibGljIG1hcEZyYW1ld29ya1NlcnZpY2U6IEFybGFzTWFwRnJhbWV3b3JrU2VydmljZTxMLCBTLCBNPikgeyB9XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbiBEZWNsYXJlcyB0aGUgYXJsYXMgZGF0YSBzb3VyY2VzIHByb3ZpZGVkIGluIGNvbmZpZ3VyYXRpb24uXG4gICAqIEBwYXJhbSBkYXRhU291cmNlc0lkcyBJZGVudGlmaWVycyBvZiBhcmxhcyBkYXRhIHNvdXJjZXMuXG4gICAqIEBwYXJhbSBkYXRhIEEgZmVhdHVyZSBjb2xsZWN0aW9uLlxuICAgKiBAcGFyYW0gbWFwIE1hcCBpbnN0YW5jZS5cbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCBkZWNsYXJlQXJsYXNEYXRhU291cmNlcyhkYXRhU291cmNlc0lkczogU2V0PHN0cmluZz4sIGRhdGE6IEZlYXR1cmVDb2xsZWN0aW9uPEdlb0pTT04uR2VvbWV0cnk+LCBtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCk6IHZvaWQ7XG5cbiAgcHVibGljIGFic3RyYWN0IGRlY2xhcmVMYWJlbFNvdXJjZXMobGFiZWxTb3VyY2VJZDogc3RyaW5nLCBkYXRhOiBGZWF0dXJlQ29sbGVjdGlvbjxHZW9KU09OLkdlb21ldHJ5PiwgbWFwOiBBYnN0cmFjdEFybGFzTWFwR0wpOiB2b2lkO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCBkZWNsYXJlQmFzZW1hcFNvdXJjZXMoYmFzZW1hcFNvdXJjZXM6IEFycmF5PEFybGFzTWFwU291cmNlPGFueT4+LCBtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCk6IHZvaWQ7XG5cbiAgcHVibGljIGFic3RyYWN0IHNldExheWVyc01hcChtYXBMYXllcnM6IE1hcExheWVyczxBcmxhc0RhdGFMYXllcj4sIGxheWVycz86IEFycmF5PEFybGFzRGF0YUxheWVyPik7XG5cbiAgcHVibGljIHVwZGF0ZUxhYmVsU291cmNlcyhsYWJlbFNvdXJjZUlkOiBzdHJpbmcsIGRhdGE6IEZlYXR1cmVDb2xsZWN0aW9uPEdlb0pTT04uR2VvbWV0cnk+LCBtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCkge1xuICAgIGlmIChsYWJlbFNvdXJjZUlkKSB7XG4gICAgICBjb25zdCBzb3VyY2UgPSB0aGlzLm1hcEZyYW1ld29ya1NlcnZpY2UuZ2V0U291cmNlKGxhYmVsU291cmNlSWQsIG1hcCk7XG4gICAgICB0aGlzLm1hcEZyYW1ld29ya1NlcnZpY2Uuc2V0RGF0YVRvR2VvanNvblNvdXJjZShzb3VyY2UsIGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVzY3JpcHRpb24gSW5pdHMgYSBtYXAgb2YgdmlzdWxpc2F0aW9uIHNldHMgZnJvbSB0aGUgY29uZmlndXJhdGlvbi5cbiAgICogQHBhcmFtIHZpc3VhbGlzYXRpb25TZXRzQ29uZmlnIFZpc3VhbGlzYXRpb24gc2V0IGNvbmZpZ3VyYXRpb24uXG4gICAqL1xuICBwdWJsaWMgaW5pdFZpc3VhbGlzYXRpb25TZXQodmlzdWFsaXNhdGlvblNldHNDb25maWc6IFZpc3VhbGlzYXRpb25TZXRDb25maWdbXSkge1xuICAgIGlmICh2aXN1YWxpc2F0aW9uU2V0c0NvbmZpZykge1xuICAgICAgdmlzdWFsaXNhdGlvblNldHNDb25maWcuZm9yRWFjaCh2aXN1ID0+IHtcbiAgICAgICAgdGhpcy52aXN1YWxpc2F0aW9uc1NldHMudmlzdWFsaXNhdGlvbnMuc2V0KHZpc3UubmFtZSwgbmV3IFNldCh2aXN1LmxheWVycykpO1xuICAgICAgICB0aGlzLnZpc3VhbGlzYXRpb25zU2V0cy5zdGF0dXMuc2V0KHZpc3UubmFtZSwgdmlzdS5lbmFibGVkKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpbml0TWFwTGF5ZXJzKG1hcExheWVyczogTWFwTGF5ZXJzPEFybGFzRGF0YUxheWVyPiwgbWFwOiBBYnN0cmFjdEFybGFzTWFwR0wpIHtcbiAgICBpZiAobWFwTGF5ZXJzKSB7XG4gICAgICB0aGlzLnNldExheWVyc01hcChtYXBMYXllcnMpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhYnN0cmFjdCBtb3ZlQXJsYXNEYXRhTGF5ZXIobWFwOiBBYnN0cmFjdEFybGFzTWFwR0wsIGxheWVyOiBhbnksIGxheWVyc01hcDogTWFwPHN0cmluZywgQXJsYXNEYXRhTGF5ZXI+LCBiZWZvcmVJZD86IHN0cmluZyk7XG5cbiAgLyoqXG4gICAqIEFkZCBhIGxheWVyIHRvIHRoZSBtYXAgaW5zdGFuY2UuIFRoaXMgbWV0aG9kIGhhbmRsZXMgYW55IHNwZWNpZmljIHRyZWF0bWVudCB3aGVuIGFkZGluZyBBUkxBUyBkYXRhLlxuICAgKiBGb3IgaW5zdGFuY2UsIGluIG1hcGJveCBhbmQgbWFwbGlicmUgaW1wbGVtZW50YXRpb24sIGFkZGluZyBhIGZpbGwgbGF5ZXIgbmVlZHMgdG8gYWRkIHN5c3RlbWF0aWNhbGx5IHRoZSBzdHJva2UgbGF5ZXIuXG4gICAqIEBwYXJhbSBtYXAgTWFwIGluc3RhbmNlLlxuICAgKiBAcGFyYW0gbGF5ZXIgQSBsYXllci4gSXQgY291bGQgYmUgYSBsYXllciBpZGVudGlmaWVyIE9SIGEgbGF5ZXIgb2JqZWN0IChpdCB3aWxsIGRlcGVuZCBvbiB0aGUgZnJhbXdvcmsgaW1wbGVtZW50YXRpb24pLlxuICAgKiBAcGFyYW0gbGF5ZXJzTWFwIE1hcCBvZiBBUkxBUyBkYXRhIGxheWVycyBhbmQgdGhlaXIgaWRzICh0aGUgaWRzIGJlaW5nIHRoZSBrZXkgb2YgdGhlIG1hcCkuXG4gICAqIEBwYXJhbSBiZWZvcmVJZCBJZGVudGlmaWVyIG9mIGFuIGFscmVhZHkgYWRkZWQgbGF5ZXIuIFRoZSBsYXllcnMgb2YgbGF5ZXJzTWFwIGFyZSBhZGRlZCB1bmRlciB0aGlzICdiZWZvcmVJZCcgbGF5ZXIuXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgYWRkQXJsYXNEYXRhTGF5ZXIobWFwOiBBYnN0cmFjdEFybGFzTWFwR0wsIGxheWVyOiBBcmxhc0RhdGFMYXllciB8IHN0cmluZyxcbiAgICBsYXllcnNNYXA6IE1hcDxzdHJpbmcsIEFybGFzRGF0YUxheWVyPiwgYmVmb3JlSWQ/OiBzdHJpbmcpO1xuXG4gIHB1YmxpYyBhZGRBcmxhc0RhdGFMYXllcnModmlzdWFsaXNhdGlvblNldHNDb25maWc6IFZpc3VhbGlzYXRpb25TZXRDb25maWdbXSwgbWFwTGF5ZXJzOiBNYXBMYXllcnM8QXJsYXNEYXRhTGF5ZXI+LCBtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCkge1xuICAgIHRoaXMuaW5pdE1hcExheWVycyhtYXBMYXllcnMsIG1hcCk7XG4gICAgdGhpcy5pbml0VmlzdWFsaXNhdGlvblNldCh2aXN1YWxpc2F0aW9uU2V0c0NvbmZpZyk7XG4gICAgZm9yIChsZXQgaSA9IHZpc3VhbGlzYXRpb25TZXRzQ29uZmlnLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCB2aXN1YWxpc2F0aW9uOiBWaXN1YWxpc2F0aW9uU2V0Q29uZmlnID0gdmlzdWFsaXNhdGlvblNldHNDb25maWdbaV07XG4gICAgICBpZiAodmlzdWFsaXNhdGlvbi5sYXllcnMpIHtcbiAgICAgICAgZm9yIChsZXQgaiA9IHZpc3VhbGlzYXRpb24ubGF5ZXJzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKSB7XG4gICAgICAgICAgY29uc3QgbCA9IHZpc3VhbGlzYXRpb24ubGF5ZXJzW2pdO1xuICAgICAgICAgIGNvbnN0IGxheWVyID0gdGhpcy5sYXllcnNNYXAuZ2V0KGwpO1xuICAgICAgICAgIHRoaXMuYWRkQXJsYXNEYXRhTGF5ZXIobWFwLCBsYXllciwgdGhpcy5sYXllcnNNYXApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX2FkZEV4dGVybmFsRXZlbnRMYXllcnMobWFwTGF5ZXJzLCBtYXApO1xuICAgIHRoaXMudmlzdWFsaXNhdGlvbnNTZXRzLnN0YXR1cy5mb3JFYWNoKCh2aXNpYmxlLCB2cykgPT4ge1xuICAgICAgdGhpcy52aXN1YWxpc2F0aW9uc1NldHMudmlzdWFsaXNhdGlvbnMuZ2V0KHZzKS5mb3JFYWNoKGwgPT4ge1xuICAgICAgICB0aGlzLm1hcEZyYW1ld29ya1NlcnZpY2Uuc2V0TGF5ZXJWaXNpYmlsaXR5KGwsIHZpc2libGUsIG1hcCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICB0aGlzLnJlb3JkZXJMYXllcnModmlzdWFsaXNhdGlvblNldHNDb25maWcsIG1hcCk7XG4gIH1cblxuICBwcml2YXRlIF9hZGRFeHRlcm5hbEV2ZW50TGF5ZXJzKG1hcExheWVyczogTWFwTGF5ZXJzPEFybGFzRGF0YUxheWVyPiwgbWFwOiBBYnN0cmFjdEFybGFzTWFwR0wpIHtcbiAgICBpZiAobWFwTGF5ZXJzLmV4dGVybmFsRXZlbnRMYXllcnMpIHtcbiAgICAgIG1hcExheWVycy5sYXllcnNcbiAgICAgICAgLmZpbHRlcihsYXllciA9PiBtYXBMYXllcnMuZXh0ZXJuYWxFdmVudExheWVycy5tYXAoZSA9PiBlLmlkKS5pbmRleE9mKGxheWVyLmlkKSA+PSAwKVxuICAgICAgICAuZm9yRWFjaChsID0+IHtcbiAgICAgICAgICB0aGlzLm1hcEZyYW1ld29ya1NlcnZpY2UuYWRkTGF5ZXIobWFwLCBsIGFzIEwpO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuXG4gIHB1YmxpYyByZW9yZGVyTGF5ZXJzKHZpc3VhbGlzYXRpb25TZXRzQ29uZmlnOiBWaXN1YWxpc2F0aW9uU2V0Q29uZmlnW10sIG1hcDogQWJzdHJhY3RBcmxhc01hcEdMKSB7XG4gICAgLy8gcGFyc2VzIHRoZSB2aXN1bGlzYXRpb24gbGlzdCBmcm9tIGJvdHRvbSBpbiBvcmRlciB0byBwdXQgdGhlIGZpc3Qgb25lcyBmaXJzdFxuICAgIGZvciAobGV0IGkgPSB2aXN1YWxpc2F0aW9uU2V0c0NvbmZpZy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgdmlzdWFsaXNhdGlvbjogVmlzdWFsaXNhdGlvblNldENvbmZpZyA9IHZpc3VhbGlzYXRpb25TZXRzQ29uZmlnW2ldO1xuICAgICAgaWYgKCEhdmlzdWFsaXNhdGlvbi5sYXllcnMgJiYgdmlzdWFsaXNhdGlvbi5lbmFibGVkKSB7XG4gICAgICAgIGZvciAobGV0IGogPSB2aXN1YWxpc2F0aW9uLmxheWVycy5sZW5ndGggLSAxOyBqID49IDA7IGotLSkge1xuICAgICAgICAgIGNvbnN0IGwgPSB2aXN1YWxpc2F0aW9uLmxheWVyc1tqXTtcbiAgICAgICAgICB0aGlzLm1vdmVBcmxhc0RhdGFMYXllcihtYXAsIGwsIHRoaXMubGF5ZXJzTWFwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnJlb3JkZXJEcmF3TGF5ZXJzKG1hcCk7XG5cbiAgfVxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCByZW9yZGVyRHJhd0xheWVycyhtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCk7XG5cblxuICBwdWJsaWMgYWJzdHJhY3QgZmlsdGVyTGF5ZXJzKG1hcExheWVyczogTWFwTGF5ZXJzPEFybGFzRGF0YUxheWVyPiwgbWFwOiBBYnN0cmFjdEFybGFzTWFwR0wsXG4gICAgdmlzaWJpbGl0eUNvbmRpdGlvbjogYm9vbGVhbiwgdmlzaWJpbGl0eUZpbHRlcjogQXJyYXk8YW55PiwgdmlzaWJpbGl0eUV2ZW50OiBFeHRlcm5hbEV2ZW50LFxuICAgIGNvbGxlY3Rpb24/OiBzdHJpbmcpOiB2b2lkO1xuXG4gIHB1YmxpYyBzZWxlY3RGZWF0dXJlcyhtYXBMYXllcnM6IE1hcExheWVyczxBcmxhc0RhdGFMYXllcj4sIG1hcDogQWJzdHJhY3RBcmxhc01hcEdMLCBlbGVtZW50VG9TZWxlY3Q6IEFycmF5PEVsZW1lbnRJZGVudGlmaWVyPikge1xuICAgIGlmIChlbGVtZW50VG9TZWxlY3QpIHtcbiAgICAgIGNvbnN0IGlkcyA9IGVsZW1lbnRUb1NlbGVjdC5sZW5ndGggPiAwID9cbiAgICAgICAgZWxlbWVudFRvU2VsZWN0LnJlZHVjZSgobWVtbywgZWxlbWVudCkgPT4ge1xuICAgICAgICAgIG1lbW8ucHVzaChlbGVtZW50LmlkVmFsdWUpO1xuICAgICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgICB9LCBbXSkgOiBbXTtcbiAgICAgIGNvbnN0IG51bWVyaWNhbElkcyA9IGlkcy5maWx0ZXIoaWQgPT4gIWlzTmFOKCtpZCkpLm1hcChpZCA9PiAraWQpO1xuICAgICAgY29uc3QgdmlzaWJpbGl0eUZpbHRlciA9IGlkcy5sZW5ndGggPiAwID8gWydpbicsIFsnZ2V0JywgZWxlbWVudFRvU2VsZWN0WzBdLmlkRmllbGROYW1lXSwgWydsaXRlcmFsJywgaWRzLmNvbmNhdChudW1lcmljYWxJZHMpXV0gOiBbXTtcbiAgICAgIHRoaXMuZmlsdGVyTGF5ZXJzKG1hcExheWVycywgbWFwLCAoZWxlbWVudFRvU2VsZWN0Lmxlbmd0aCA+IDApLCB2aXNpYmlsaXR5RmlsdGVyLCBFeHRlcm5hbEV2ZW50LnNlbGVjdCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhpZ2hsaWdodEZlYXR1cmUobWFwTGF5ZXJzOiBNYXBMYXllcnM8QXJsYXNEYXRhTGF5ZXI+LCBtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCxcbiAgICBmZWF0dXJlVG9IaWdodExpZ2h0OiB7IGlzbGVhdmluZzogYm9vbGVhbjsgZWxlbWVudGlkZW50aWZpZXI6IEVsZW1lbnRJZGVudGlmaWVyOyB9KSB7XG4gICAgaWYgKGZlYXR1cmVUb0hpZ2h0TGlnaHQ/LmVsZW1lbnRpZGVudGlmaWVyKSB7XG4gICAgICBjb25zdCBpZHM6IEFycmF5PG51bWJlciB8IHN0cmluZz4gPSBbZmVhdHVyZVRvSGlnaHRMaWdodC5lbGVtZW50aWRlbnRpZmllci5pZFZhbHVlXTtcbiAgICAgIGlmICghaXNOYU4oK2ZlYXR1cmVUb0hpZ2h0TGlnaHQuZWxlbWVudGlkZW50aWZpZXIuaWRWYWx1ZSkpIHtcbiAgICAgICAgaWRzLnB1c2goK2ZlYXR1cmVUb0hpZ2h0TGlnaHQuZWxlbWVudGlkZW50aWZpZXIuaWRWYWx1ZSk7XG4gICAgICB9XG4gICAgICBjb25zdCB2aXNpYmlsaXR5RmlsdGVyID0gWydpbicsIFsnZ2V0JywgZmVhdHVyZVRvSGlnaHRMaWdodC5lbGVtZW50aWRlbnRpZmllci5pZEZpZWxkTmFtZV0sXG4gICAgICAgIFsnbGl0ZXJhbCcsIGlkc11dO1xuICAgICAgdGhpcy5maWx0ZXJMYXllcnMobWFwTGF5ZXJzLCBtYXAsICFmZWF0dXJlVG9IaWdodExpZ2h0LmlzbGVhdmluZywgdmlzaWJpbGl0eUZpbHRlciwgRXh0ZXJuYWxFdmVudC5ob3Zlcik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlbGVjdEZlYXR1cmVzQnlDb2xsZWN0aW9uKG1hcExheWVyczogTWFwTGF5ZXJzPEFybGFzRGF0YUxheWVyPiwgbWFwOiBBYnN0cmFjdEFybGFzTWFwR0wsXG4gICAgZmVhdHVyZXM6IEFycmF5PEVsZW1lbnRJZGVudGlmaWVyPiwgY29sbGVjdGlvbjogc3RyaW5nKSB7XG4gICAgY29uc3QgaWRzOiBBcnJheTxudW1iZXIgfCBzdHJpbmc+ID0gZmVhdHVyZXMubWFwKGYgPT4gZi5pZFZhbHVlKTtcbiAgICBjb25zdCBudW1lcmljYWxJZHMgPSBpZHMuZmlsdGVyKGlkID0+ICFpc05hTigraWQpKS5tYXAoaWQgPT4gK2lkKTtcbiAgICBjb25zdCB2aXNpYmlsaXR5RmlsdGVyID0gaWRzLmxlbmd0aCA+IDAgPyBbJ2luJywgWydnZXQnLCBmZWF0dXJlc1swXS5pZEZpZWxkTmFtZV0sIFsnbGl0ZXJhbCcsIGlkcy5jb25jYXQobnVtZXJpY2FsSWRzKV1dIDogW107XG4gICAgdGhpcy5maWx0ZXJMYXllcnMobWFwTGF5ZXJzLCBtYXAsIChmZWF0dXJlcy5sZW5ndGggPiAwKSwgdmlzaWJpbGl0eUZpbHRlciwgRXh0ZXJuYWxFdmVudC5zZWxlY3QsIGNvbGxlY3Rpb24pO1xuICB9XG5cblxuICBwdWJsaWMgdXBkYXRlTGF5b3V0VmlzaWJpbGl0eSh2aXN1YWxpc2F0aW9uTmFtZTogc3RyaW5nLCB2aXN1YWxpc2F0aW9uU2V0c0NvbmZpZzogVmlzdWFsaXNhdGlvblNldENvbmZpZ1tdLCBtYXA6IEFic3RyYWN0QXJsYXNNYXBHTCkge1xuICAgIGNvbnN0IHZpc3VTdGF0dXMgPSAhdGhpcy52aXN1YWxpc2F0aW9uc1NldHMuc3RhdHVzLmdldCh2aXN1YWxpc2F0aW9uTmFtZSk7XG4gICAgdmlzdWFsaXNhdGlvblNldHNDb25maWcuZmluZCh2ID0+IHYubmFtZSA9PT0gdmlzdWFsaXNhdGlvbk5hbWUpLmVuYWJsZWQgPSB2aXN1U3RhdHVzO1xuICAgIGlmICghdmlzdVN0YXR1cykge1xuICAgICAgY29uc3QgbGF5ZXJzU2V0ID0gbmV3IFNldCh0aGlzLnZpc3VhbGlzYXRpb25zU2V0cy52aXN1YWxpc2F0aW9ucy5nZXQodmlzdWFsaXNhdGlvbk5hbWUpKTtcbiAgICAgIHRoaXMudmlzdWFsaXNhdGlvbnNTZXRzLnZpc3VhbGlzYXRpb25zLmZvckVhY2goKGxzLCB2KSA9PiB7XG4gICAgICAgIGlmICh2ICE9PSB2aXN1YWxpc2F0aW9uTmFtZSkge1xuICAgICAgICAgIGxzLmZvckVhY2gobGwgPT4ge1xuICAgICAgICAgICAgaWYgKGxheWVyc1NldD8uaGFzKGxsKSkge1xuICAgICAgICAgICAgICBsYXllcnNTZXQuZGVsZXRlKGxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBsYXllcnNTZXQuZm9yRWFjaChsbCA9PiB7XG4gICAgICAgIHRoaXMubWFwRnJhbWV3b3JrU2VydmljZS5zZXRMYXllclZpc2liaWxpdHkobGwsIGZhbHNlLCBtYXApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMudmlzdWFsaXNhdGlvbnNTZXRzLnN0YXR1cy5zZXQodmlzdWFsaXNhdGlvbk5hbWUsIHZpc3VTdGF0dXMpO1xuICAgIGNvbnN0IGxheWVycyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgIHRoaXMudmlzdWFsaXNhdGlvbnNTZXRzLnZpc3VhbGlzYXRpb25zLmZvckVhY2goKGxzLCB2KSA9PiB7XG4gICAgICBpZiAodGhpcy52aXN1YWxpc2F0aW9uc1NldHMuc3RhdHVzLmdldCh2KSkge1xuICAgICAgICBscy5mb3JFYWNoKGwgPT4ge1xuICAgICAgICAgIGxheWVycy5hZGQobCk7XG4gICAgICAgICAgdGhpcy5tYXBGcmFtZXdvcmtTZXJ2aWNlLnNldExheWVyVmlzaWJpbGl0eShsLCB0cnVlLCBtYXApO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gbGF5ZXJzO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZVZpc2liaWxpdHkodmlzaWJpbGl0eVN0YXR1czogTWFwPHN0cmluZywgYm9vbGVhbj4sIHZpc3VhbGlzYXRpb25TZXRzQ29uZmlnOiBWaXN1YWxpc2F0aW9uU2V0Q29uZmlnW10sIG1hcDogQWJzdHJhY3RBcmxhc01hcEdMKSB7XG4gICAgdmlzaWJpbGl0eVN0YXR1cy5mb3JFYWNoKCh2aXNpYmlsaXR5U3RhdHVzLCBsKSA9PiB7XG4gICAgICBsZXQgbGF5ZXJJblZpc3VhbGlzYXRpb25zID0gZmFsc2U7XG4gICAgICBpZiAoIXZpc2liaWxpdHlTdGF0dXMpIHtcbiAgICAgICAgdmlzdWFsaXNhdGlvblNldHNDb25maWcuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICBjb25zdCBscyA9IG5ldyBTZXQodi5sYXllcnMpO1xuICAgICAgICAgIGlmICghbGF5ZXJJblZpc3VhbGlzYXRpb25zKSB7XG4gICAgICAgICAgICBsYXllckluVmlzdWFsaXNhdGlvbnMgPSBscy5oYXMobCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGxheWVySW5WaXN1YWxpc2F0aW9ucykge1xuICAgICAgICAgIHRoaXMubWFwRnJhbWV3b3JrU2VydmljZS5zZXRMYXllclZpc2liaWxpdHkobCwgZmFsc2UsIG1hcCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBvbmVWaXN1YWxpc2F0aW9uRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICB2aXN1YWxpc2F0aW9uU2V0c0NvbmZpZy5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgIGNvbnN0IGxzID0gbmV3IFNldCh2LmxheWVycyk7XG4gICAgICAgICAgaWYgKCFsYXllckluVmlzdWFsaXNhdGlvbnMpIHtcbiAgICAgICAgICAgIGxheWVySW5WaXN1YWxpc2F0aW9ucyA9IGxzLmhhcyhsKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGxzLmhhcyhsKSAmJiB2LmVuYWJsZWQpIHtcbiAgICAgICAgICAgIG9uZVZpc3VhbGlzYXRpb25FbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMubWFwRnJhbWV3b3JrU2VydmljZS5zZXRMYXllclZpc2liaWxpdHkobCwgdHJ1ZSwgbWFwKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIW9uZVZpc3VhbGlzYXRpb25FbmFibGVkICYmIGxheWVySW5WaXN1YWxpc2F0aW9ucykge1xuICAgICAgICAgIHRoaXMubWFwRnJhbWV3b3JrU2VydmljZS5zZXRMYXllclZpc2liaWxpdHkobCwgZmFsc2UsIG1hcCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG5cbiAgcHVibGljIGZpbmRWaXN1YWxpc2F0aW9uU2V0TGF5ZXIodmlzdU5hbWU6IHN0cmluZywgdmlzdWFsaXNhdGlvblNldHNDb25maWc6IFZpc3VhbGlzYXRpb25TZXRDb25maWdbXSkge1xuICAgIHJldHVybiB2aXN1YWxpc2F0aW9uU2V0c0NvbmZpZy5maW5kKHYgPT4gdi5uYW1lID09PSB2aXN1TmFtZSkubGF5ZXJzO1xuICB9XG4gIHB1YmxpYyBzZXRWaXN1YWxpc2F0aW9uU2V0TGF5ZXJzKHZpc3VOYW1lOiBzdHJpbmcsIGxheWVyczogc3RyaW5nW10sIHZpc3VhbGlzYXRpb25TZXRzQ29uZmlnOiBWaXN1YWxpc2F0aW9uU2V0Q29uZmlnW10pIHtcbiAgICBjb25zdCBmID0gdmlzdWFsaXNhdGlvblNldHNDb25maWcuZmluZCh2ID0+IHYubmFtZSA9PT0gdmlzdU5hbWUpO1xuICAgIGlmIChmKSB7XG4gICAgICBmLmxheWVycyA9IGxheWVycztcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYWJzdHJhY3QgdXBkYXRlTWFwU3R5bGUobWFwOiBBYnN0cmFjdEFybGFzTWFwR0wsIGw6IGFueSwgaWRzOiBBcnJheTxzdHJpbmcgfCBudW1iZXI+LCBzb3VyY2VOYW1lOiBzdHJpbmcpOiB2b2lkO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRWaXNpYmxlSWRzRmlsdGVyKG1hcDogQWJzdHJhY3RBcmxhc01hcEdMLCBsYXllcjogYW55LCBpZHM6IEFycmF5PHN0cmluZyB8IG51bWJlcj4pO1xufVxuIl19