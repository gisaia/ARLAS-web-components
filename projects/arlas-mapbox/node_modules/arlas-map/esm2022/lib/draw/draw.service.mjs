/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Injectable } from '@angular/core';
import { marker } from '@colsen1991/ngx-translate-extract-marker';
import area from '@turf/area';
import bbox from '@turf/bbox';
import { lineString } from '@turf/helpers';
import length from '@turf/length';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class MapboxAoiDrawService {
    constructor() {
        this.ids = new Set();
        this.editAoiSource = new Subject();
        this.editAoi$ = this.editAoiSource.asObservable();
        this.drawBboxSource = new Subject();
        this.drawBbox$ = this.drawBboxSource.asObservable();
        /** Set to true when the user is drawing a bbox. */
        this.isDrawingBbox = false;
        /** Set to true when the user is drawing a circle. */
        this.isDrawingCircle = false;
        /** Set to true when the user is drawing a strip. */
        this.isDrawingStrip = false;
        /** Set to true when the user is drawing a polygon. */
        this.isDrawingPolygon = false;
        /** Set to true when the user is in simple draw mode. */
        this.isInSimpleDrawMode = false;
        /** Set to true when the drawn geometry is selected. */
        this.isDrawSelected = false;
        this.isReady = false;
    }
    isDrawing() {
        return this.isDrawingBbox || this.isDrawingCircle || this.isDrawingPolygon || this.isDrawingStrip;
    }
    drawBbox(fCorner, sCorner) {
        const west = Math.min(fCorner.lng, sCorner.lng);
        const east = Math.max(fCorner.lng, sCorner.lng);
        const south = Math.min(fCorner.lat, sCorner.lat);
        const north = Math.max(fCorner.lat, sCorner.lat);
        this.drawBboxSource.next({
            west,
            east,
            south,
            north
        });
    }
    setDraw(mapboxDraw) {
        this.mapDraw = mapboxDraw;
        this.isReady = true;
        this.onSelectionChange();
        this.onRender();
        this.onDelete();
        this.onStop();
    }
    /**
     * Add new features to the mapboxdraw object.
     * @param fc Featurecollection to be added to mapboxdraw object.
     * @param deleteOld if true, the mapboxdraw object is purged first, before adding the new given feature collection.
     */
    addFeatures(fc, deleteOld = false) {
        if (deleteOld) {
            this.mapDraw.deleteAll();
        }
        this.registeringMode = true;
        this.mapDraw.add(fc);
    }
    /** Deletes all the features from Mapboxdraw object */
    deleteAll() {
        this.registeringMode = true;
        this.mapDraw.deleteAll();
    }
    /** Deletes all the features from Mapboxdraw object that have not been saved */
    deleteUnregisteredFeatures() {
        this.mapDraw.delete(this.getUnregistredFeatures().map(f => f.id.toString()));
    }
    /** Returns the area of the given feature */
    calculateArea(feature) {
        if (this.isArea(feature)) {
            return area(feature);
        }
        return 0;
    }
    /** Returns the width x height of the given feature's envelope */
    calculateEnvelopeDimension(feature) {
        if (this.isLine(feature)) {
            const [minX, minY, maxX, maxY] = bbox(feature);
            const verticalLine = lineString([[minX, minY], [minX, maxY]]);
            const horizontalLine = lineString([[minX, minY], [maxX, minY]]);
            return [length(horizontalLine), length(verticalLine)];
        }
        return [0, 0];
    }
    /** on selection of a drawn polygon, we get its corresponding id. */
    onSelectionChange() {
        this.mapDraw.on('draw.selectionchange', (e) => {
            const features = e.features;
            if (this.hasFeatures(features)) {
                this.editionId = features[0].id;
            }
            else {
                this.endDimensionsEmission();
            }
        });
    }
    hasFeatures(features) {
        return !!features && features.length > 0;
    }
    /** Triggered on deletion of feature(s).
     * - Removes the deleted feature(s) from this service's register.
     * - Stops emitting Aoi dimension info.
     * */
    onDelete() {
        this.mapDraw.on('draw.delete', (e) => {
            e.features.forEach(f => this.unregister(f.id));
            this.endDimensionsEmission();
        });
    }
    onStop() {
        this.mapDraw.on('draw.onStop', (e) => {
            this.register(this.editionId);
            this.endDimensionsEmission();
        });
    }
    /**
     * This event is triggered :
     * - after draw.update
     * - after draw.delete
     * - on adding/deleting features from mapboxdraw object.
     */
    onRender() {
        this.mapDraw.on('draw.render', (e) => {
            if (this.mapDraw) {
                this.registerAll();
                const unregisteredFeatures = this.getUnregistredFeatures();
                if (unregisteredFeatures && (unregisteredFeatures.length === 1 || unregisteredFeatures.length === 2)) {
                    const index = unregisteredFeatures.length - 1;
                    this.editionId = unregisteredFeatures[index].id + '';
                }
                if (this.editionId) {
                    const feature = this.getFeature(this.editionId, this.mapDraw);
                    this.emitDimensions(feature);
                }
            }
        });
    }
    emitStartBBox() {
        this.editAoiSource.next({
            area: 0,
            areaMessage: marker('Start draging to draw a bbox.'),
            envelope: {
                width: 0,
                height: 0
            },
            show: true
        });
    }
    /** Emits dimension info of the given feature.*/
    emitDimensions(feature) {
        const a = this.calculateArea(feature);
        const wh = this.calculateEnvelopeDimension(feature);
        this.editAoiSource.next({
            area: a,
            areaMessage: a > 0 ? '' : marker('Draw at least 2 points.'),
            envelope: {
                width: wh[0],
                height: wh[1]
            },
            show: true
        });
    }
    /** Stops emitting Aoi dimension info */
    endDimensionsEmission() {
        this.editionId = undefined;
        this.editAoiSource.next({
            area: 0,
            envelope: {
                width: 0,
                height: 0
            },
            show: false
        });
    }
    /** Mapbox lacks a method to get the identifier of a new feature that is being drawn and not yet created
     * this method detects this feature on 'draw.render' event.
    */
    getUnregistredFeatures() {
        return this.mapDraw.getAllFeatures().filter(f => !this.ids.has(f.id.toString()));
    }
    /** registers the identifiers of each drawn polygon in this service. */
    registerAll() {
        if (this.registeringMode) {
            this.ids.clear();
            const fc = this.mapDraw.getAll();
            if (!!fc && !!fc.features) {
                this.ids = new Set(fc.features.map(f => f.id.toString()));
            }
            this.registeringMode = false;
        }
    }
    /** Unregisters the given feature id in this service. */
    unregister(id) {
        this.ids.delete(id);
    }
    /** Registers the given feature id in this service. */
    register(id) {
        this.ids.add(id);
    }
    /** Gets the given feature from MapboxDraw object. */
    getFeature(featureId, mapDraw) {
        return mapDraw.get(featureId);
    }
    /** Checks if the given feature has enough coordinates to represent an area (polygon) */
    isArea(feature) {
        const isGeometryDefined = !!feature && !!feature.geometry;
        const areCoordinatesDefined = isGeometryDefined && !!feature.geometry.coordinates;
        if (areCoordinatesDefined) {
            const coordinates = feature.geometry.coordinates;
            const isArea = coordinates.length === 1 && coordinates[0].length > 3;
            return isArea;
        }
        return false;
    }
    /** Checks if the given feature has enough coordinates to represent a line */
    isLine(feature) {
        const isGeometryDefined = !!feature && !!feature.geometry;
        const areCoordinatesDefined = isGeometryDefined && !!feature.geometry.coordinates;
        if (areCoordinatesDefined) {
            const coordinates = feature.geometry.coordinates;
            const isLine = coordinates.length === 1 && coordinates[0].length > 1;
            return isLine;
        }
        return false;
    }
    /**
     * Chck if its a valid circle
     * @param feature
     */
    isValidCircle(feature) {
        const coordinates = feature.geometry.coordinates;
        return this.isCircle(feature) && coordinates && coordinates[0] !== null && coordinates[0][0] !== null && feature.properties.center;
    }
    isValidPolygon(feature) {
        const coordinates = feature.geometry.coordinates;
        return this.isPolygon(feature) && coordinates && coordinates[0] !== null && coordinates[0][0] !== null;
    }
    isPolygon(feature) {
        return feature.geometry.type === 'Polygon' && !this.isCircle(feature);
    }
    isCircle(feature) {
        return feature.properties?.isCircle;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: MapboxAoiDrawService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: MapboxAoiDrawService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: MapboxAoiDrawService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhdy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvZHJhdy9kcmF3LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDbEUsT0FBTyxJQUFJLE1BQU0sWUFBWSxDQUFDO0FBQzlCLE9BQU8sSUFBSSxNQUFNLFlBQVksQ0FBQztBQUM5QixPQUFPLEVBQThCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLE1BQU0sTUFBTSxjQUFjLENBQUM7QUFDbEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFLL0IsTUFBTSxPQUFPLG9CQUFvQjtJQTBCL0I7UUF0QlEsUUFBRyxHQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRTdCLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQWlCLENBQUM7UUFDOUMsYUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFNUMsbUJBQWMsR0FBRyxJQUFJLE9BQU8sRUFBbUIsQ0FBQztRQUNqRCxjQUFTLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUV0RCxtREFBbUQ7UUFDNUMsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUFDN0IscURBQXFEO1FBQzlDLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBQy9CLG9EQUFvRDtRQUM3QyxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUM5QixzREFBc0Q7UUFDL0MscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQ2hDLHdEQUF3RDtRQUNqRCx1QkFBa0IsR0FBRyxLQUFLLENBQUM7UUFDbEMsdURBQXVE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LFFBQVEsQ0FBQyxXQUFXLENBQUM7UUFDakQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDckksQ0FBQztJQUVNLGNBQWMsQ0FBQyxPQUFPO1FBQzNCLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO1FBQ2pELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDO0lBQ3pHLENBQUM7SUFFTSxTQUFTLENBQUMsT0FBTztRQUN0QixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVNLFFBQVEsQ0FBQyxPQUFPO1FBQ3JCLE9BQU8sT0FBTyxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUM7SUFDdEMsQ0FBQzsrR0FqUlUsb0JBQW9CO21IQUFwQixvQkFBb0I7OzRGQUFwQixvQkFBb0I7a0JBRGhDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbWFya2VyIH0gZnJvbSAnQGNvbHNlbjE5OTEvbmd4LXRyYW5zbGF0ZS1leHRyYWN0LW1hcmtlcic7XG5pbXBvcnQgYXJlYSBmcm9tICdAdHVyZi9hcmVhJztcbmltcG9ydCBiYm94IGZyb20gJ0B0dXJmL2Jib3gnO1xuaW1wb3J0IHsgRmVhdHVyZSwgRmVhdHVyZUNvbGxlY3Rpb24sIGxpbmVTdHJpbmcgfSBmcm9tICdAdHVyZi9oZWxwZXJzJztcbmltcG9ydCBsZW5ndGggZnJvbSAnQHR1cmYvbGVuZ3RoJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFic3RyYWN0RHJhdyB9IGZyb20gJy4vQWJzdHJhY3REcmF3JztcbmltcG9ydCB7IEFvaURpbWVuc2lvbnMsIEJib3hEcmF3Q29tbWFuZCwgQ29ybmVyIH0gZnJvbSAnLi9kcmF3Lm1vZGVscyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNYXBib3hBb2lEcmF3U2VydmljZSB7XG4gIHByaXZhdGUgbWFwRHJhdzogQWJzdHJhY3REcmF3O1xuICBwcml2YXRlIGVkaXRpb25JZDogc3RyaW5nO1xuICBwcml2YXRlIHJlZ2lzdGVyaW5nTW9kZTogYm9vbGVhbjtcbiAgcHJpdmF0ZSBpZHM6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpO1xuXG4gIHByaXZhdGUgZWRpdEFvaVNvdXJjZSA9IG5ldyBTdWJqZWN0PEFvaURpbWVuc2lvbnM+KCk7XG4gIHB1YmxpYyBlZGl0QW9pJCA9IHRoaXMuZWRpdEFvaVNvdXJjZS5hc09ic2VydmFibGUoKTtcblxuICBwcml2YXRlIGRyYXdCYm94U291cmNlID0gbmV3IFN1YmplY3Q8QmJveERyYXdDb21tYW5kPigpO1xuICBwdWJsaWMgZHJhd0Jib3gkID0gdGhpcy5kcmF3QmJveFNvdXJjZS5hc09ic2VydmFibGUoKTtcblxuICAvKiogU2V0IHRvIHRydWUgd2hlbiB0aGUgdXNlciBpcyBkcmF3aW5nIGEgYmJveC4gKi9cbiAgcHVibGljIGlzRHJhd2luZ0Jib3ggPSBmYWxzZTtcbiAgLyoqIFNldCB0byB0cnVlIHdoZW4gdGhlIHVzZXIgaXMgZHJhd2luZyBhIGNpcmNsZS4gKi9cbiAgcHVibGljIGlzRHJhd2luZ0NpcmNsZSA9IGZhbHNlO1xuICAvKiogU2V0IHRvIHRydWUgd2hlbiB0aGUgdXNlciBpcyBkcmF3aW5nIGEgc3RyaXAuICovXG4gIHB1YmxpYyBpc0RyYXdpbmdTdHJpcCA9IGZhbHNlO1xuICAvKiogU2V0IHRvIHRydWUgd2hlbiB0aGUgdXNlciBpcyBkcmF3aW5nIGEgcG9seWdvbi4gKi9cbiAgcHVibGljIGlzRHJhd2luZ1BvbHlnb24gPSBmYWxzZTtcbiAgLyoqIFNldCB0byB0cnVlIHdoZW4gdGhlIHVzZXIgaXMgaW4gc2ltcGxlIGRyYXcgbW9kZS4gKi9cbiAgcHVibGljIGlzSW5TaW1wbGVEcmF3TW9kZSA9IGZhbHNlO1xuICAvKiogU2V0IHRvIHRydWUgd2hlbiB0aGUgZHJhd24gZ2VvbWV0cnkgaXMgc2VsZWN0ZWQuICovXG4gIHB1YmxpYyBpc0RyYXdTZWxlY3RlZCA9IGZhbHNlO1xuICBwdWJsaWMgaXNSZWFkeSA9IGZhbHNlO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gIHB1YmxpYyBpc0RyYXdpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNEcmF3aW5nQmJveCB8fCB0aGlzLmlzRHJhd2luZ0NpcmNsZSB8fCB0aGlzLmlzRHJhd2luZ1BvbHlnb24gfHwgdGhpcy5pc0RyYXdpbmdTdHJpcDtcbiAgfVxuXG4gIHB1YmxpYyBkcmF3QmJveChmQ29ybmVyOiBDb3JuZXIsIHNDb3JuZXI6IENvcm5lcikge1xuICAgIGNvbnN0IHdlc3QgPSBNYXRoLm1pbihmQ29ybmVyLmxuZywgc0Nvcm5lci5sbmcpO1xuICAgIGNvbnN0IGVhc3QgPSBNYXRoLm1heChmQ29ybmVyLmxuZywgc0Nvcm5lci5sbmcpO1xuICAgIGNvbnN0IHNvdXRoID0gTWF0aC5taW4oZkNvcm5lci5sYXQsIHNDb3JuZXIubGF0KTtcbiAgICBjb25zdCBub3J0aCA9IE1hdGgubWF4KGZDb3JuZXIubGF0LCBzQ29ybmVyLmxhdCk7XG4gICAgdGhpcy5kcmF3QmJveFNvdXJjZS5uZXh0KHtcbiAgICAgIHdlc3QsXG4gICAgICBlYXN0LFxuICAgICAgc291dGgsXG4gICAgICBub3J0aFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNldERyYXcobWFwYm94RHJhdzogQWJzdHJhY3REcmF3KSB7XG4gICAgdGhpcy5tYXBEcmF3ID0gbWFwYm94RHJhdztcbiAgICB0aGlzLmlzUmVhZHkgPSB0cnVlO1xuICAgIHRoaXMub25TZWxlY3Rpb25DaGFuZ2UoKTtcbiAgICB0aGlzLm9uUmVuZGVyKCk7XG4gICAgdGhpcy5vbkRlbGV0ZSgpO1xuICAgIHRoaXMub25TdG9wKCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIG5ldyBmZWF0dXJlcyB0byB0aGUgbWFwYm94ZHJhdyBvYmplY3QuXG4gICAqIEBwYXJhbSBmYyBGZWF0dXJlY29sbGVjdGlvbiB0byBiZSBhZGRlZCB0byBtYXBib3hkcmF3IG9iamVjdC5cbiAgICogQHBhcmFtIGRlbGV0ZU9sZCBpZiB0cnVlLCB0aGUgbWFwYm94ZHJhdyBvYmplY3QgaXMgcHVyZ2VkIGZpcnN0LCBiZWZvcmUgYWRkaW5nIHRoZSBuZXcgZ2l2ZW4gZmVhdHVyZSBjb2xsZWN0aW9uLlxuICAgKi9cbiAgcHVibGljIGFkZEZlYXR1cmVzKGZjOiBGZWF0dXJlQ29sbGVjdGlvbjxHZW9KU09OLkdlb21ldHJ5PiwgZGVsZXRlT2xkID0gZmFsc2UpIHtcbiAgICBpZiAoZGVsZXRlT2xkKSB7XG4gICAgICB0aGlzLm1hcERyYXcuZGVsZXRlQWxsKCk7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0ZXJpbmdNb2RlID0gdHJ1ZTtcbiAgICB0aGlzLm1hcERyYXcuYWRkKGZjKTtcbiAgfVxuXG4gIC8qKiBEZWxldGVzIGFsbCB0aGUgZmVhdHVyZXMgZnJvbSBNYXBib3hkcmF3IG9iamVjdCAqL1xuICBwdWJsaWMgZGVsZXRlQWxsKCkge1xuICAgIHRoaXMucmVnaXN0ZXJpbmdNb2RlID0gdHJ1ZTtcbiAgICB0aGlzLm1hcERyYXcuZGVsZXRlQWxsKCk7XG4gIH1cblxuICAvKiogRGVsZXRlcyBhbGwgdGhlIGZlYXR1cmVzIGZyb20gTWFwYm94ZHJhdyBvYmplY3QgdGhhdCBoYXZlIG5vdCBiZWVuIHNhdmVkICovXG4gIHB1YmxpYyBkZWxldGVVbnJlZ2lzdGVyZWRGZWF0dXJlcygpIHtcbiAgICB0aGlzLm1hcERyYXcuZGVsZXRlKHRoaXMuZ2V0VW5yZWdpc3RyZWRGZWF0dXJlcygpLm1hcChmID0+IGYuaWQudG9TdHJpbmcoKSkpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgdGhlIGFyZWEgb2YgdGhlIGdpdmVuIGZlYXR1cmUgKi9cbiAgcHVibGljIGNhbGN1bGF0ZUFyZWEoZmVhdHVyZTogRmVhdHVyZSk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMuaXNBcmVhKGZlYXR1cmUpKSB7XG4gICAgICByZXR1cm4gYXJlYShmZWF0dXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG4gIH1cblxuICAvKiogUmV0dXJucyB0aGUgd2lkdGggeCBoZWlnaHQgb2YgdGhlIGdpdmVuIGZlYXR1cmUncyBlbnZlbG9wZSAqL1xuICBwdWJsaWMgY2FsY3VsYXRlRW52ZWxvcGVEaW1lbnNpb24oZmVhdHVyZTogRmVhdHVyZSk6IFtudW1iZXIsIG51bWJlcl0ge1xuICAgIGlmICh0aGlzLmlzTGluZShmZWF0dXJlKSkge1xuICAgICAgY29uc3QgW21pblgsIG1pblksIG1heFgsIG1heFldID0gYmJveChmZWF0dXJlKTtcbiAgICAgIGNvbnN0IHZlcnRpY2FsTGluZSA9IGxpbmVTdHJpbmcoW1ttaW5YLCBtaW5ZXSwgW21pblgsIG1heFldXSk7XG4gICAgICBjb25zdCBob3Jpem9udGFsTGluZSA9IGxpbmVTdHJpbmcoW1ttaW5YLCBtaW5ZXSwgW21heFgsIG1pblldXSk7XG4gICAgICByZXR1cm4gW2xlbmd0aChob3Jpem9udGFsTGluZSksIGxlbmd0aCh2ZXJ0aWNhbExpbmUpXTtcbiAgICB9XG4gICAgcmV0dXJuIFswLCAwXTtcbiAgfVxuXG4gIC8qKiBvbiBzZWxlY3Rpb24gb2YgYSBkcmF3biBwb2x5Z29uLCB3ZSBnZXQgaXRzIGNvcnJlc3BvbmRpbmcgaWQuICovXG4gIHByaXZhdGUgb25TZWxlY3Rpb25DaGFuZ2UoKSB7XG4gICAgdGhpcy5tYXBEcmF3Lm9uKCdkcmF3LnNlbGVjdGlvbmNoYW5nZScsIChlKSA9PiB7XG4gICAgICBjb25zdCBmZWF0dXJlcyA9IGUuZmVhdHVyZXM7XG4gICAgICBpZiAodGhpcy5oYXNGZWF0dXJlcyhmZWF0dXJlcykpIHtcbiAgICAgICAgdGhpcy5lZGl0aW9uSWQgPSBmZWF0dXJlc1swXS5pZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW5kRGltZW5zaW9uc0VtaXNzaW9uKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGhhc0ZlYXR1cmVzKGZlYXR1cmVzOiBhbnlbXSkge1xuICAgIHJldHVybiAhIWZlYXR1cmVzICYmIGZlYXR1cmVzLmxlbmd0aCA+IDA7XG4gIH1cblxuICAvKiogVHJpZ2dlcmVkIG9uIGRlbGV0aW9uIG9mIGZlYXR1cmUocykuXG4gICAqIC0gUmVtb3ZlcyB0aGUgZGVsZXRlZCBmZWF0dXJlKHMpIGZyb20gdGhpcyBzZXJ2aWNlJ3MgcmVnaXN0ZXIuXG4gICAqIC0gU3RvcHMgZW1pdHRpbmcgQW9pIGRpbWVuc2lvbiBpbmZvLlxuICAgKiAqL1xuICBwcml2YXRlIG9uRGVsZXRlKCkge1xuICAgIHRoaXMubWFwRHJhdy5vbignZHJhdy5kZWxldGUnLCAoZSkgPT4ge1xuICAgICAgZS5mZWF0dXJlcy5mb3JFYWNoKGYgPT4gdGhpcy51bnJlZ2lzdGVyKGYuaWQpKTtcbiAgICAgIHRoaXMuZW5kRGltZW5zaW9uc0VtaXNzaW9uKCk7XG4gICAgfSk7XG4gIH1cblxuXG4gIHByaXZhdGUgb25TdG9wKCkge1xuICAgIHRoaXMubWFwRHJhdy5vbignZHJhdy5vblN0b3AnLCAoZSkgPT4ge1xuICAgICAgdGhpcy5yZWdpc3Rlcih0aGlzLmVkaXRpb25JZCk7XG4gICAgICB0aGlzLmVuZERpbWVuc2lvbnNFbWlzc2lvbigpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZXZlbnQgaXMgdHJpZ2dlcmVkIDpcbiAgICogLSBhZnRlciBkcmF3LnVwZGF0ZVxuICAgKiAtIGFmdGVyIGRyYXcuZGVsZXRlXG4gICAqIC0gb24gYWRkaW5nL2RlbGV0aW5nIGZlYXR1cmVzIGZyb20gbWFwYm94ZHJhdyBvYmplY3QuXG4gICAqL1xuICBwcml2YXRlIG9uUmVuZGVyKCkge1xuICAgIHRoaXMubWFwRHJhdy5vbignZHJhdy5yZW5kZXInLCAoZSkgPT4ge1xuICAgICAgaWYgKHRoaXMubWFwRHJhdykge1xuICAgICAgICB0aGlzLnJlZ2lzdGVyQWxsKCk7XG4gICAgICAgIGNvbnN0IHVucmVnaXN0ZXJlZEZlYXR1cmVzID0gdGhpcy5nZXRVbnJlZ2lzdHJlZEZlYXR1cmVzKCk7XG4gICAgICAgIGlmICh1bnJlZ2lzdGVyZWRGZWF0dXJlcyAmJiAodW5yZWdpc3RlcmVkRmVhdHVyZXMubGVuZ3RoID09PSAxIHx8IHVucmVnaXN0ZXJlZEZlYXR1cmVzLmxlbmd0aCA9PT0gMikpIHtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IHVucmVnaXN0ZXJlZEZlYXR1cmVzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgdGhpcy5lZGl0aW9uSWQgPSB1bnJlZ2lzdGVyZWRGZWF0dXJlc1tpbmRleF0uaWQgKyAnJztcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5lZGl0aW9uSWQpIHtcbiAgICAgICAgICBjb25zdCBmZWF0dXJlID0gdGhpcy5nZXRGZWF0dXJlKHRoaXMuZWRpdGlvbklkLCB0aGlzLm1hcERyYXcpO1xuICAgICAgICAgIHRoaXMuZW1pdERpbWVuc2lvbnMoZmVhdHVyZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBlbWl0U3RhcnRCQm94KCkge1xuICAgIHRoaXMuZWRpdEFvaVNvdXJjZS5uZXh0KHtcbiAgICAgIGFyZWE6IDAsXG4gICAgICBhcmVhTWVzc2FnZTogbWFya2VyKCdTdGFydCBkcmFnaW5nIHRvIGRyYXcgYSBiYm94LicpLFxuICAgICAgZW52ZWxvcGU6IHtcbiAgICAgICAgd2lkdGg6IDAsXG4gICAgICAgIGhlaWdodDogMFxuICAgICAgfSxcbiAgICAgIHNob3c6IHRydWVcbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBFbWl0cyBkaW1lbnNpb24gaW5mbyBvZiB0aGUgZ2l2ZW4gZmVhdHVyZS4qL1xuICBwdWJsaWMgZW1pdERpbWVuc2lvbnMoZmVhdHVyZTogRmVhdHVyZSkge1xuICAgIGNvbnN0IGEgPSB0aGlzLmNhbGN1bGF0ZUFyZWEoZmVhdHVyZSk7XG4gICAgY29uc3Qgd2ggPSB0aGlzLmNhbGN1bGF0ZUVudmVsb3BlRGltZW5zaW9uKGZlYXR1cmUpO1xuICAgIHRoaXMuZWRpdEFvaVNvdXJjZS5uZXh0KHtcbiAgICAgIGFyZWE6IGEsXG4gICAgICBhcmVhTWVzc2FnZTogYSA+IDAgPyAnJyA6IG1hcmtlcignRHJhdyBhdCBsZWFzdCAyIHBvaW50cy4nKSxcbiAgICAgIGVudmVsb3BlOiB7XG4gICAgICAgIHdpZHRoOiB3aFswXSxcbiAgICAgICAgaGVpZ2h0OiB3aFsxXVxuICAgICAgfSxcbiAgICAgIHNob3c6IHRydWVcbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBTdG9wcyBlbWl0dGluZyBBb2kgZGltZW5zaW9uIGluZm8gKi9cbiAgcHVibGljIGVuZERpbWVuc2lvbnNFbWlzc2lvbigpIHtcbiAgICB0aGlzLmVkaXRpb25JZCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmVkaXRBb2lTb3VyY2UubmV4dCh7XG4gICAgICBhcmVhOiAwLFxuICAgICAgZW52ZWxvcGU6IHtcbiAgICAgICAgd2lkdGg6IDAsXG4gICAgICAgIGhlaWdodDogMFxuICAgICAgfSxcbiAgICAgIHNob3c6IGZhbHNlXG4gICAgfSk7XG4gIH1cblxuICAvKiogTWFwYm94IGxhY2tzIGEgbWV0aG9kIHRvIGdldCB0aGUgaWRlbnRpZmllciBvZiBhIG5ldyBmZWF0dXJlIHRoYXQgaXMgYmVpbmcgZHJhd24gYW5kIG5vdCB5ZXQgY3JlYXRlZFxuICAgKiB0aGlzIG1ldGhvZCBkZXRlY3RzIHRoaXMgZmVhdHVyZSBvbiAnZHJhdy5yZW5kZXInIGV2ZW50LlxuICAqL1xuICBwcml2YXRlIGdldFVucmVnaXN0cmVkRmVhdHVyZXMoKTogRmVhdHVyZVtdIHtcbiAgICByZXR1cm4gKHRoaXMubWFwRHJhdy5nZXRBbGxGZWF0dXJlcygpIGFzIEZlYXR1cmVbXSkuZmlsdGVyKGYgPT4gIXRoaXMuaWRzLmhhcyhmLmlkLnRvU3RyaW5nKCkpKTtcbiAgfVxuXG4gIC8qKiByZWdpc3RlcnMgdGhlIGlkZW50aWZpZXJzIG9mIGVhY2ggZHJhd24gcG9seWdvbiBpbiB0aGlzIHNlcnZpY2UuICovXG4gIHByaXZhdGUgcmVnaXN0ZXJBbGwoKSB7XG4gICAgaWYgKHRoaXMucmVnaXN0ZXJpbmdNb2RlKSB7XG4gICAgICB0aGlzLmlkcy5jbGVhcigpO1xuICAgICAgY29uc3QgZmMgPSB0aGlzLm1hcERyYXcuZ2V0QWxsKCk7XG4gICAgICBpZiAoISFmYyAmJiAhIWZjLmZlYXR1cmVzKSB7XG4gICAgICAgIHRoaXMuaWRzID0gbmV3IFNldChmYy5mZWF0dXJlcy5tYXAoZiA9PiBmLmlkLnRvU3RyaW5nKCkpKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVnaXN0ZXJpbmdNb2RlID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqIFVucmVnaXN0ZXJzIHRoZSBnaXZlbiBmZWF0dXJlIGlkIGluIHRoaXMgc2VydmljZS4gKi9cbiAgcHJpdmF0ZSB1bnJlZ2lzdGVyKGlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLmlkcy5kZWxldGUoaWQpO1xuICB9XG5cbiAgLyoqIFJlZ2lzdGVycyB0aGUgZ2l2ZW4gZmVhdHVyZSBpZCBpbiB0aGlzIHNlcnZpY2UuICovXG4gIHByaXZhdGUgcmVnaXN0ZXIoaWQ6IHN0cmluZykge1xuICAgIHRoaXMuaWRzLmFkZChpZCk7XG4gIH1cblxuICAvKiogR2V0cyB0aGUgZ2l2ZW4gZmVhdHVyZSBmcm9tIE1hcGJveERyYXcgb2JqZWN0LiAqL1xuICBwcml2YXRlIGdldEZlYXR1cmUoZmVhdHVyZUlkOiBzdHJpbmcsIG1hcERyYXc6IEFic3RyYWN0RHJhdyk6IEZlYXR1cmUge1xuICAgIHJldHVybiBtYXBEcmF3LmdldChmZWF0dXJlSWQpIGFzIEZlYXR1cmU7XG4gIH1cblxuICAvKiogQ2hlY2tzIGlmIHRoZSBnaXZlbiBmZWF0dXJlIGhhcyBlbm91Z2ggY29vcmRpbmF0ZXMgdG8gcmVwcmVzZW50IGFuIGFyZWEgKHBvbHlnb24pICovXG4gIHByaXZhdGUgaXNBcmVhKGZlYXR1cmUpIHtcbiAgICBjb25zdCBpc0dlb21ldHJ5RGVmaW5lZCA9ICEhZmVhdHVyZSAmJiAhIWZlYXR1cmUuZ2VvbWV0cnk7XG4gICAgY29uc3QgYXJlQ29vcmRpbmF0ZXNEZWZpbmVkID0gaXNHZW9tZXRyeURlZmluZWQgJiYgISFmZWF0dXJlLmdlb21ldHJ5LmNvb3JkaW5hdGVzO1xuICAgIGlmIChhcmVDb29yZGluYXRlc0RlZmluZWQpIHtcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gZmVhdHVyZS5nZW9tZXRyeS5jb29yZGluYXRlcztcbiAgICAgIGNvbnN0IGlzQXJlYSA9IGNvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMSAmJiBjb29yZGluYXRlc1swXS5sZW5ndGggPiAzO1xuICAgICAgcmV0dXJuIGlzQXJlYTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gZmVhdHVyZSBoYXMgZW5vdWdoIGNvb3JkaW5hdGVzIHRvIHJlcHJlc2VudCBhIGxpbmUgKi9cbiAgcHJpdmF0ZSBpc0xpbmUoZmVhdHVyZSkge1xuICAgIGNvbnN0IGlzR2VvbWV0cnlEZWZpbmVkID0gISFmZWF0dXJlICYmICEhZmVhdHVyZS5nZW9tZXRyeTtcbiAgICBjb25zdCBhcmVDb29yZGluYXRlc0RlZmluZWQgPSBpc0dlb21ldHJ5RGVmaW5lZCAmJiAhIWZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXM7XG4gICAgaWYgKGFyZUNvb3JkaW5hdGVzRGVmaW5lZCkge1xuICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBmZWF0dXJlLmdlb21ldHJ5LmNvb3JkaW5hdGVzO1xuICAgICAgY29uc3QgaXNMaW5lID0gY29vcmRpbmF0ZXMubGVuZ3RoID09PSAxICYmIGNvb3JkaW5hdGVzWzBdLmxlbmd0aCA+IDE7XG4gICAgICByZXR1cm4gaXNMaW5lO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQ2hjayBpZiBpdHMgYSB2YWxpZCBjaXJjbGVcbiAgICogQHBhcmFtIGZlYXR1cmVcbiAgICovXG4gIHB1YmxpYyBpc1ZhbGlkQ2lyY2xlKGZlYXR1cmUpOiBib29sZWFuIHtcbiAgICBjb25zdCBjb29yZGluYXRlcyA9IGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXM7XG4gICAgcmV0dXJuIHRoaXMuaXNDaXJjbGUoZmVhdHVyZSkgJiYgY29vcmRpbmF0ZXMgJiYgY29vcmRpbmF0ZXNbMF0gIT09IG51bGwgJiYgY29vcmRpbmF0ZXNbMF1bMF0gIT09IG51bGwgJiYgZmVhdHVyZS5wcm9wZXJ0aWVzLmNlbnRlcjtcbiAgfVxuXG4gIHB1YmxpYyBpc1ZhbGlkUG9seWdvbihmZWF0dXJlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgY29vcmRpbmF0ZXMgPSBmZWF0dXJlLmdlb21ldHJ5LmNvb3JkaW5hdGVzO1xuICAgIHJldHVybiB0aGlzLmlzUG9seWdvbihmZWF0dXJlKSAmJiBjb29yZGluYXRlcyAmJiBjb29yZGluYXRlc1swXSAhPT0gbnVsbCAmJiBjb29yZGluYXRlc1swXVswXSAhPT0gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyBpc1BvbHlnb24oZmVhdHVyZSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBmZWF0dXJlLmdlb21ldHJ5LnR5cGUgPT09ICdQb2x5Z29uJyAmJiAhdGhpcy5pc0NpcmNsZShmZWF0dXJlKTtcbiAgfVxuXG4gIHB1YmxpYyBpc0NpcmNsZShmZWF0dXJlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZlYXR1cmUucHJvcGVydGllcz8uaXNDaXJjbGU7XG4gIH1cbn1cbiJdfQ==