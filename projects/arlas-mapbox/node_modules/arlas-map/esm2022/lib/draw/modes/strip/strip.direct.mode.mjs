/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import MapboxDraw from '@mapbox/mapbox-gl-draw';
import center from '@turf/center';
import distance from '@turf/distance';
import { point } from '@turf/helpers';
import midpoint from '@turf/midpoint';
import rhumbDestination from '@turf/rhumb-destination';
import rhumbBearing from '@turf/rhumb-bearing';
import transformRotate from '@turf/transform-rotate';
import { buildStrip, computeStripProperties } from './strip.mode';
export const stripDirectSelectMode = {};
stripDirectSelectMode.onSetup = function (opts) {
    const featureId = opts.featureId;
    const halfSwath = opts.halfSwath;
    const maxLength = opts.maxLength;
    const feature = this.getFeature(featureId);
    if (!featureId) {
        throw new Error('You must provide a valid featureId to enter strip_direct mode');
    }
    if (!halfSwath) {
        throw new Error('You must provide a valid halfSwath to enter strip_direct mode');
    }
    if (!maxLength) {
        throw new Error('You must provide a valid maxLength to enter strip_direct mode');
    }
    if (feature.type !== MapboxDraw.constants.geojsonTypes.POLYGON) {
        throw new TypeError('strip_direct mode can only handle polygons');
    }
    if (feature.coordinates === undefined
        || feature.coordinates.length !== 1
        || feature.coordinates[0].length <= 2) {
        throw new TypeError('strip_direct mode can only handle polygons');
    }
    const state = {
        featureId,
        feature,
        halfSwath,
        maxLength,
        resizePointRadius: opts.resizePointRadius !== undefined ? opts.resizePointRadius : 1,
        rotationPointRadius: opts.rotationPointRadius !== undefined ? opts.rotationPointRadius : 1.0,
        canSelectFeatures: opts.canSelectFeatures !== undefined ? opts.canSelectFeatures : true,
        dragMoveLocation: opts.startPos || null,
        dragMoving: false,
        canDragMove: false,
        selectedCoordPaths: opts.coordPath ? [opts.coordPath] : []
    };
    this.setSelectedCoordinates(this.pathsToCoordinates(featureId, state.selectedCoordPaths));
    this.setSelected(featureId);
    MapboxDraw.lib.doubleClickZoom.disable(this);
    this.setActionableState({
        combineFeatures: false,
        uncombineFeatures: false,
        trash: true
    });
    this.addFeature(feature);
    return state;
};
stripDirectSelectMode.fireOnStop = function () {
    this.map.fire('draw.onStop', 'draw end');
};
stripDirectSelectMode.toDisplayFeatures = function (state, geojson, push) {
    if (state.featureId === geojson.properties.id) {
        geojson.properties.active = MapboxDraw.constants.activeStates.ACTIVE;
        push(geojson);
        const suppPoints = MapboxDraw.lib.createSupplementaryPoints(geojson, {
            map: this.map,
            midpoints: false,
            selectedPaths: state.selectedCoordPaths
        });
        const actionsPoints = this.createActionPoints(state, geojson, suppPoints);
        actionsPoints.forEach(push);
    }
    else {
        geojson.properties.active = MapboxDraw.constants.activeStates.INACTIVE;
        push(geojson);
    }
    this.setActionableState({
        combineFeatures: false,
        uncombineFeatures: false,
        trash: true
    });
};
stripDirectSelectMode.onStop = function () {
    MapboxDraw.lib.doubleClickZoom.enable(this);
    this.clearSelectedCoordinates();
    this.fireOnStop();
};
stripDirectSelectMode.pathsToCoordinates = function (featureId, paths) {
    return paths.map(coord_path => ({ feature_id: featureId, coord_path }));
};
stripDirectSelectMode._createActionPoint = function (actionWidgets, featureId, v1, v2, rotCenter, radiusScale, type) {
    const cR0 = midpoint(v1, v2).geometry.coordinates;
    const heading = rhumbBearing(rotCenter, cR0);
    const distance0 = distance(rotCenter, cR0);
    const distance1 = radiusScale * distance0;
    const cR1 = rhumbDestination(rotCenter, distance1, heading, {}).geometry.coordinates;
    actionWidgets.push({
        type: MapboxDraw.constants.geojsonTypes.FEATURE,
        properties: {
            meta: MapboxDraw.constants.meta.MIDPOINT,
            actionType: type,
            parent: featureId,
            lng: cR1[0],
            lat: cR1[1],
            coord_path: v1.properties.coord_path,
            coord_path_coords: cR0,
            heading: heading,
        },
        geometry: {
            type: MapboxDraw.constants.geojsonTypes.POINT,
            coordinates: cR1
        }
    });
};
stripDirectSelectMode.createActionPoints = function (state, geojson, suppPoints) {
    const { type, coordinates } = geojson.geometry;
    const featureId = geojson.properties && geojson.properties.id;
    const actionWidgets = [];
    if (type !== MapboxDraw.constants.geojsonTypes.POLYGON) {
        return;
    }
    const corners = suppPoints.slice(0);
    corners[corners.length] = corners[0];
    let v1 = null;
    const rotCenter = this.computeCenter(state, geojson);
    corners.forEach((v2) => {
        if (v1 != null && (v1.properties.coord_path === '0.2')) {
            this._createActionPoint(actionWidgets, featureId, v1, v2, rotCenter, state.rotationPointRadius, 'resize');
        }
        if (v1 != null && (v1.properties.coord_path === '0.0')) {
            this._createActionPoint(actionWidgets, featureId, v1, v2, rotCenter, state.rotationPointRadius, 'origin');
        }
        if (v1 != null && (v1.properties.coord_path === '0.3')) {
            this._createActionPoint(actionWidgets, featureId, v1, v2, rotCenter, state.rotationPointRadius, 'rotation');
        }
        v1 = v2;
    });
    state.actionWidgets = actionWidgets;
    return actionWidgets;
};
stripDirectSelectMode.startDragging = function (state, e) {
    this.map.dragPan.disable();
    state.canDragMove = true;
    state.dragMoveLocation = e.lngLat;
};
stripDirectSelectMode.stopDragging = function (state) {
    this.map.dragPan.enable();
    state.dragMoving = false;
    state.canDragMove = false;
    state.dragMoveLocation = null;
};
const isMidPoint = MapboxDraw.lib.CommonSelectors.isOfMetaType(MapboxDraw.constants.meta.MIDPOINT);
stripDirectSelectMode.onTouchStart = stripDirectSelectMode.onMouseDown = function (state, e) {
    if (isMidPoint(e)) {
        return this.onActivatePoint(state, e);
    }
    if (MapboxDraw.lib.CommonSelectors.isActiveFeature(e)) {
        return this.onFeature(state, e);
    }
};
const stripDirectMode = {
    Resize: 1,
    Rotate: 2
};
stripDirectSelectMode.onActivatePoint = function (state, e) {
    this.computeAxes(state, state.feature.toGeoJSON());
    this.startDragging(state, e);
    const about = e.featureTarget.properties;
    state.selectedCoordPaths = [about.coord_path];
    if (e.featureTarget.properties.actionType === 'rotation') {
        state.stripDirectMode = stripDirectMode.Rotate;
    }
    else if (e.featureTarget.properties.actionType === 'resize') {
        state.stripDirectMode = stripDirectMode.Resize;
    }
};
stripDirectSelectMode.onFeature = function (state, e) {
    state.selectedCoordPaths = [];
    this.startDragging(state, e);
};
stripDirectSelectMode.coordinateIndex = function (coordPaths) {
    if (coordPaths.length >= 1) {
        const parts = coordPaths[0].split('.');
        return parseInt(parts[parts.length - 1], 10);
    }
    else {
        return 0;
    }
};
stripDirectSelectMode.computeCenter = function (state, polygon) {
    const center0 = center(polygon);
    return center0;
};
stripDirectSelectMode.computeAxes = function (state, polygon) {
    const center = this.computeCenter(state, polygon);
    const corners = polygon.geometry.coordinates[0].slice(0);
    const n = corners.length - 1;
    const iHalf = Math.floor(n / 2);
    const rotateCenters = [];
    const headings = [];
    for (let i1 = 0; i1 < n; i1++) {
        let i0 = i1 - 1;
        if (i0 < 0) {
            i0 += n;
        }
        const c0 = corners[i0];
        const c1 = corners[i1];
        const rotPoint = midpoint(point(c0), point(c1));
        rotateCenters[i1] = center.geometry.coordinates;
        headings[i1] = rhumbBearing(center, rotPoint);
    }
    state.rotation = {
        feature0: polygon, // initial feature state
        centers: rotateCenters,
        headings: headings, // rotation start heading for each point
    };
};
stripDirectSelectMode.onDrag = function (state, e) {
    if (state.canDragMove !== true) {
        return;
    }
    state.dragMoving = true;
    e.originalEvent.stopPropagation();
    const delta = {
        lng: e.lngLat.lng - state.dragMoveLocation.lng,
        lat: e.lngLat.lat - state.dragMoveLocation.lat
    };
    if (state.selectedCoordPaths.length > 0 && state.stripDirectMode) {
        switch (state.stripDirectMode) {
            case stripDirectMode.Rotate:
                this.dragRotatePoint(state, e, delta);
                break;
            case stripDirectMode.Resize:
                this.dragResizePoint(state, e, delta);
                break;
        }
    }
    else {
        this.dragFeature(state, e, delta);
    }
    state.dragMoveLocation = e.lngLat;
};
stripDirectSelectMode.dragRotatePoint = function (state, e, delta) {
    if (state.rotation === undefined || state.rotation == null) {
        console.error('state.rotation required');
        return;
    }
    const m1 = point([e.lngLat.lng, e.lngLat.lat]);
    const n = state.rotation.centers.length;
    const cIdx = (this.coordinateIndex(state.selectedCoordPaths) + 1) % n;
    const cCenter = state.rotation.centers[cIdx];
    const cp = point(cCenter);
    const heading1 = rhumbBearing(cp, m1);
    const heading0 = state.rotation.headings[cIdx];
    const rotateAngle = heading1 - heading0; // in degrees
    const rotatedFeature = transformRotate(state.rotation.feature0, rotateAngle, {
        pivot: cp,
        mutate: false,
    });
    state.start = undefined;
    state.feature.incomingCoords(rotatedFeature.geometry.coordinates);
    Object.assign(state.feature.properties, computeStripProperties(state.feature.coordinates[0]));
    this.fireUpdate();
};
stripDirectSelectMode.dragResizePoint = function (state, e, delta) {
    const end = [e.lngLat.lng, e.lngLat.lat];
    let start;
    if (!state.selectedResizePaths) {
        state.selectedResizePaths = state.selectedCoordPaths[0];
    }
    if (!state.start || state.selectedResizePaths !== state.selectedCoordPaths[0]) {
        if (state.selectedCoordPaths[0] === '0.0') {
            start = state.actionWidgets.find(a => a.properties.coord_path === '0.2').properties.coord_path_coords;
        }
        else {
            start = state.actionWidgets.find(a => a.properties.coord_path === '0.0').properties.coord_path_coords;
        }
        state.start = start;
    }
    const dist = distance(point(state.start), point(end), { units: 'kilometers' });
    const newPolygon = buildStrip(state.start, end, state.halfSwath);
    if (dist <= state.maxLength) {
        state.feature.setCoordinates(newPolygon.geometry.coordinates);
        Object.assign(state.feature.properties, computeStripProperties(state.feature.coordinates[0]));
        this.fireUpdate();
    }
};
stripDirectSelectMode.dragFeature = function (state, e, delta) {
    MapboxDraw.lib.moveFeatures(this.getSelected(), delta);
    state.dragMoveLocation = e.lngLat;
    state.start = undefined;
    Object.assign(state.feature.properties, computeStripProperties(state.feature.coordinates[0]));
    this.fireUpdate();
};
stripDirectSelectMode.fireUpdate = function () {
    this.map.fire(MapboxDraw.constants.events.UPDATE, {
        action: MapboxDraw.constants.updateActions.CHANGE_COORDINATES,
        features: this.getSelected().map(f => f.toGeoJSON())
    });
};
stripDirectSelectMode.onMouseOut = function (state) {
    // As soon as you mouse leaves the canvas, update the feature
    if (state.dragMoving) {
        this.fireUpdate();
    }
};
stripDirectSelectMode.onTouchEnd = stripDirectSelectMode.onMouseUp = function (state) {
    if (state.dragMoving) {
        this.fireUpdate();
    }
    this.stopDragging(state);
};
stripDirectSelectMode.clickActiveFeature = function (state) {
    state.selectedCoordPaths = [];
    this.clearSelectedCoordinates();
    state.feature.changed();
};
stripDirectSelectMode.onClick = function (state, e) {
    if (MapboxDraw.lib.CommonSelectors.noTarget(e)) {
        return this.clickNoTarget(state, e);
    }
    if (MapboxDraw.lib.CommonSelectors.isActiveFeature(e)) {
        return this.clickActiveFeature(state, e);
    }
    if (MapboxDraw.lib.CommonSelectors.isInactiveFeature(e)) {
        return this.clickInactive(state, e);
    }
    this.stopDragging(state);
};
stripDirectSelectMode.clickNoTarget = function (state, e) {
    if (state.canSelectFeatures) {
        this.changeMode(MapboxDraw.constants.modes.SIMPLE_SELECT);
    }
};
stripDirectSelectMode.clickInactive = function (state, e) {
    if (state.canSelectFeatures) {
        this.changeMode(MapboxDraw.constants.modes.SIMPLE_SELECT, {
            featureIds: [e.featureTarget.properties.id]
        });
    }
};
stripDirectSelectMode.onTrash = function () {
    this.deleteFeature(this.getSelectedIds());
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXAuZGlyZWN0Lm1vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hcmxhcy1tYXAvc3JjL2xpYi9kcmF3L21vZGVzL3N0cmlwL3N0cmlwLmRpcmVjdC5tb2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUVILE9BQU8sVUFBVSxNQUFNLHdCQUF3QixDQUFDO0FBQ2hELE9BQU8sTUFBTSxNQUFNLGNBQWMsQ0FBQztBQUNsQyxPQUFPLFFBQVEsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RDLE9BQU8sUUFBUSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sZ0JBQWdCLE1BQU0seUJBQXlCLENBQUM7QUFFdkQsT0FBTyxZQUFZLE1BQU0scUJBQXFCLENBQUM7QUFDL0MsT0FBTyxlQUFlLE1BQU0sd0JBQXdCLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUVsRSxNQUFNLENBQUMsTUFBTSxxQkFBcUIsR0FBUSxFQUFFLENBQUM7QUFHN0MscUJBQXFCLENBQUMsT0FBTyxHQUFHLFVBQVUsSUFBSTtJQUMxQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ2pDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDakMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUNqQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTNDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNiLE1BQU0sSUFBSSxLQUFLLENBQUMsK0RBQStELENBQUMsQ0FBQztJQUNyRixDQUFDO0lBQ0QsSUFBSSxDQUFDLFNBQVMsRUFB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QUFDO1FBQ3BELE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBQ0QsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3RELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUNELElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDN0IsQ0FBQyxDQUFDO0FBRUYscUJBQXFCLENBQUMsYUFBYSxHQUFHLFVBQVUsS0FBSyxFQUFFLENBQUM7SUFDcEQsSUFBSSxLQUFLLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzlELENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRixxQkFBcUIsQ0FBQyxhQUFhLEdBQUcsVUFBVSxLQUFLLEVBQUUsQ0FBQztJQUNwRCxJQUFJLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFO1lBQ3RELFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztTQUM5QyxDQUFDLENBQUM7SUFDUCxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRUYscUJBQXFCLENBQUMsT0FBTyxHQUFHO0lBQzVCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7QUFDOUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIEdpc2HDr2EgdW5kZXIgb25lIG9yIG1vcmUgY29udHJpYnV0b3JcbiAqIGxpY2Vuc2UgYWdyZWVtZW50cy4gU2VlIHRoZSBOT1RJQ0UudHh0IGZpbGUgZGlzdHJpYnV0ZWQgd2l0aFxuICogdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBjb3B5cmlnaHRcbiAqIG93bmVyc2hpcC4gR2lzYcOvYSBsaWNlbnNlcyB0aGlzIGZpbGUgdG8geW91IHVuZGVyXG4gKiB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5XG4gKiBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCBNYXBib3hEcmF3IGZyb20gJ0BtYXBib3gvbWFwYm94LWdsLWRyYXcnO1xuaW1wb3J0IGNlbnRlciBmcm9tICdAdHVyZi9jZW50ZXInO1xuaW1wb3J0IGRpc3RhbmNlIGZyb20gJ0B0dXJmL2Rpc3RhbmNlJztcbmltcG9ydCB7IHBvaW50IH0gZnJvbSAnQHR1cmYvaGVscGVycyc7XG5pbXBvcnQgbWlkcG9pbnQgZnJvbSAnQHR1cmYvbWlkcG9pbnQnO1xuaW1wb3J0IHJodW1iRGVzdGluYXRpb24gZnJvbSAnQHR1cmYvcmh1bWItZGVzdGluYXRpb24nO1xuXG5pbXBvcnQgcmh1bWJCZWFyaW5nIGZyb20gJ0B0dXJmL3JodW1iLWJlYXJpbmcnO1xuaW1wb3J0IHRyYW5zZm9ybVJvdGF0ZSBmcm9tICdAdHVyZi90cmFuc2Zvcm0tcm90YXRlJztcbmltcG9ydCB7IGJ1aWxkU3RyaXAsIGNvbXB1dGVTdHJpcFByb3BlcnRpZXMgfSBmcm9tICcuL3N0cmlwLm1vZGUnO1xuXG5leHBvcnQgY29uc3Qgc3RyaXBEaXJlY3RTZWxlY3RNb2RlOiBhbnkgPSB7fTtcblxuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUub25TZXR1cCA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gICAgY29uc3QgZmVhdHVyZUlkID0gb3B0cy5mZWF0dXJlSWQ7XG4gICAgY29uc3QgaGFsZlN3YXRoID0gb3B0cy5oYWxmU3dhdGg7XG4gICAgY29uc3QgbWF4TGVuZ3RoID0gb3B0cy5tYXhMZW5ndGg7XG4gICAgY29uc3QgZmVhdHVyZSA9IHRoaXMuZ2V0RmVhdHVyZShmZWF0dXJlSWQpO1xuXG4gICAgaWYgKCFmZWF0dXJlSWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBwcm92aWRlIGEgdmFsaWQgZmVhdHVyZUlkIHRvIGVudGVyIHN0cmlwX2RpcmVjdCBtb2RlJyk7XG4gICAgfVxuICAgIGlmICghaGFsZlN3YXRoKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignWW91IG11c3QgcHJvdmlkZSBhIHZhbGlkIGhhbGZTd2F0aCB0byBlbnRlciBzdHJpcF9kaXJlY3QgbW9kZScpO1xuICAgIH1cbiAgICBpZiAoIW1heExlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IHByb3ZpZGUgYSB2YWxpZCBtYXhMZW5ndGggdG8gZW50ZXIgc3RyaXBfZGlyZWN0IG1vZGUnKTtcbiAgICB9XG5cbiAgICBpZiAoZmVhdHVyZS50eXBlICE9PSBNYXBib3hEcmF3LmNvbnN0YW50cy5nZW9qc29uVHlwZXMuUE9MWUdPTikge1xuICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdzdHJpcF9kaXJlY3QgbW9kZSBjYW4gb25seSBoYW5kbGUgcG9seWdvbnMnKTtcbiAgICB9XG4gICAgaWYgKGZlYXR1cmUuY29vcmRpbmF0ZXMgPT09IHVuZGVmaW5lZFxuICAgICAgICB8fCBmZWF0dXJlLmNvb3JkaW5hdGVzLmxlbmd0aCAhPT0gMVxuICAgICAgICB8fCBmZWF0dXJlLmNvb3JkaW5hdGVzWzBdLmxlbmd0aCA8PSAyKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3N0cmlwX2RpcmVjdCBtb2RlIGNhbiBvbmx5IGhhbmRsZSBwb2x5Z29ucycpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXRlID0ge1xuICAgICAgICBmZWF0dXJlSWQsXG4gICAgICAgIGZlYXR1cmUsXG4gICAgICAgIGhhbGZTd2F0aCxcbiAgICAgICAgbWF4TGVuZ3RoLFxuICAgICAgICByZXNpemVQb2ludFJhZGl1czogb3B0cy5yZXNpemVQb2ludFJhZGl1cyAhPT0gdW5kZWZpbmVkID8gb3B0cy5yZXNpemVQb2ludFJhZGl1cyA6IDEsXG4gICAgICAgIHJvdGF0aW9uUG9pbnRSYWRpdXM6IG9wdHMucm90YXRpb25Qb2ludFJhZGl1cyAhPT0gdW5kZWZpbmVkID8gb3B0cy5yb3RhdGlvblBvaW50UmFkaXVzIDogMS4wLFxuICAgICAgICBjYW5TZWxlY3RGZWF0dXJlczogb3B0cy5jYW5TZWxlY3RGZWF0dXJlcyAhPT0gdW5kZWZpbmVkID8gb3B0cy5jYW5TZWxlY3RGZWF0dXJlcyA6IHRydWUsXG4gICAgICAgIGRyYWdNb3ZlTG9jYXRpb246IG9wdHMuc3RhcnRQb3MgfHwgbnVsbCxcbiAgICAgICAgZHJhZ01vdmluZzogZmFsc2UsXG4gICAgICAgIGNhbkRyYWdNb3ZlOiBmYWxzZSxcbiAgICAgICAgc2VsZWN0ZWRDb29yZFBhdGhzOiBvcHRzLmNvb3JkUGF0aCA/IFtvcHRzLmNvb3JkUGF0aF0gOiBbXVxuICAgIH07XG5cbiAgICB0aGlzLnNldFNlbGVjdGVkQ29vcmRpbmF0ZXModGhpcy5wYXRoc1RvQ29vcmRpbmF0ZXMoZmVhdHVyZUlkLCBzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHMpKTtcbiAgICB0aGlzLnNldFNlbGVjdGVkKGZlYXR1cmVJZCk7XG4gICAgTWFwYm94RHJhdy5saWIuZG91YmxlQ2xpY2tab29tLmRpc2FibGUodGhpcyk7XG4gICAgdGhpcy5zZXRBY3Rpb25hYmxlU3RhdGUoe1xuICAgICAgICBjb21iaW5lRmVhdHVyZXM6IGZhbHNlLFxuICAgICAgICB1bmNvbWJpbmVGZWF0dXJlczogZmFsc2UsXG4gICAgICAgIHRyYXNoOiB0cnVlXG4gICAgfSk7XG4gICAgdGhpcy5hZGRGZWF0dXJlKGZlYXR1cmUpO1xuXG4gICAgcmV0dXJuIHN0YXRlO1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLmZpcmVPblN0b3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5tYXAuZmlyZSgnZHJhdy5vblN0b3AnLCAnZHJhdyBlbmQnKTtcbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS50b0Rpc3BsYXlGZWF0dXJlcyA9IGZ1bmN0aW9uIChzdGF0ZSwgZ2VvanNvbiwgcHVzaCkge1xuICAgIGlmIChzdGF0ZS5mZWF0dXJlSWQgPT09IGdlb2pzb24ucHJvcGVydGllcy5pZCkge1xuICAgICAgICBnZW9qc29uLnByb3BlcnRpZXMuYWN0aXZlID0gTWFwYm94RHJhdy5jb25zdGFudHMuYWN0aXZlU3RhdGVzLkFDVElWRTtcbiAgICAgICAgcHVzaChnZW9qc29uKTtcbiAgICAgICAgY29uc3Qgc3VwcFBvaW50cyA9IE1hcGJveERyYXcubGliLmNyZWF0ZVN1cHBsZW1lbnRhcnlQb2ludHMoZ2VvanNvbiwge1xuICAgICAgICAgICAgbWFwOiB0aGlzLm1hcCxcbiAgICAgICAgICAgIG1pZHBvaW50czogZmFsc2UsXG4gICAgICAgICAgICBzZWxlY3RlZFBhdGhzOiBzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHNcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGFjdGlvbnNQb2ludHMgPSB0aGlzLmNyZWF0ZUFjdGlvblBvaW50cyhzdGF0ZSwgZ2VvanNvbiwgc3VwcFBvaW50cyk7XG4gICAgICAgIGFjdGlvbnNQb2ludHMuZm9yRWFjaChwdXNoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBnZW9qc29uLnByb3BlcnRpZXMuYWN0aXZlID0gTWFwYm94RHJhdy5jb25zdGFudHMuYWN0aXZlU3RhdGVzLklOQUNUSVZFO1xuICAgICAgICBwdXNoKGdlb2pzb24pO1xuICAgIH1cblxuICAgIHRoaXMuc2V0QWN0aW9uYWJsZVN0YXRlKHtcbiAgICAgICAgY29tYmluZUZlYXR1cmVzOiBmYWxzZSxcbiAgICAgICAgdW5jb21iaW5lRmVhdHVyZXM6IGZhbHNlLFxuICAgICAgICB0cmFzaDogdHJ1ZVxuICAgIH0pO1xuXG59O1xuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUub25TdG9wID0gZnVuY3Rpb24gKCkge1xuICAgIE1hcGJveERyYXcubGliLmRvdWJsZUNsaWNrWm9vbS5lbmFibGUodGhpcyk7XG4gICAgdGhpcy5jbGVhclNlbGVjdGVkQ29vcmRpbmF0ZXMoKTtcbiAgICB0aGlzLmZpcmVPblN0b3AoKTtcbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5wYXRoc1RvQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbiAoZmVhdHVyZUlkLCBwYXRocykge1xuICAgIHJldHVybiBwYXRocy5tYXAoY29vcmRfcGF0aCA9PiAoeyBmZWF0dXJlX2lkOiBmZWF0dXJlSWQsIGNvb3JkX3BhdGggfSkpO1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLl9jcmVhdGVBY3Rpb25Qb2ludCA9IGZ1bmN0aW9uIChhY3Rpb25XaWRnZXRzLCBmZWF0dXJlSWQsIHYxLCB2Miwgcm90Q2VudGVyLCByYWRpdXNTY2FsZSwgdHlwZSkge1xuICAgIGNvbnN0IGNSMCA9IG1pZHBvaW50KHYxLCB2MikuZ2VvbWV0cnkuY29vcmRpbmF0ZXM7XG4gICAgY29uc3QgaGVhZGluZyA9IHJodW1iQmVhcmluZyhyb3RDZW50ZXIsIGNSMCk7XG4gICAgY29uc3QgZGlzdGFuY2UwID0gZGlzdGFuY2Uocm90Q2VudGVyLCBjUjApO1xuICAgIGNvbnN0IGRpc3RhbmNlMSA9IHJhZGl1c1NjYWxlICogZGlzdGFuY2UwO1xuICAgIGNvbnN0IGNSMSA9IHJodW1iRGVzdGluYXRpb24ocm90Q2VudGVyLCBkaXN0YW5jZTEsIGhlYWRpbmcsIHt9KS5nZW9tZXRyeS5jb29yZGluYXRlcztcblxuICAgIGFjdGlvbldpZGdldHMucHVzaCh7XG4gICAgICAgIHR5cGU6IE1hcGJveERyYXcuY29uc3RhbnRzLmdlb2pzb25UeXBlcy5GRUFUVVJFLFxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBtZXRhOiBNYXBib3hEcmF3LmNvbnN0YW50cy5tZXRhLk1JRFBPSU5ULFxuICAgICAgICAgICAgYWN0aW9uVHlwZTogdHlwZSxcbiAgICAgICAgICAgIHBhcmVudDogZmVhdHVyZUlkLFxuICAgICAgICAgICAgbG5nOiBjUjFbMF0sXG4gICAgICAgICAgICBsYXQ6IGNSMVsxXSxcbiAgICAgICAgICAgIGNvb3JkX3BhdGg6IHYxLnByb3BlcnRpZXMuY29vcmRfcGF0aCxcbiAgICAgICAgICAgIGNvb3JkX3BhdGhfY29vcmRzOiBjUjAsXG4gICAgICAgICAgICBoZWFkaW5nOiBoZWFkaW5nLFxuICAgICAgICB9LFxuICAgICAgICBnZW9tZXRyeToge1xuICAgICAgICAgICAgdHlwZTogTWFwYm94RHJhdy5jb25zdGFudHMuZ2VvanNvblR5cGVzLlBPSU5ULFxuICAgICAgICAgICAgY29vcmRpbmF0ZXM6IGNSMVxuICAgICAgICB9XG4gICAgfVxuICAgICk7XG59O1xuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUuY3JlYXRlQWN0aW9uUG9pbnRzID0gZnVuY3Rpb24gKHN0YXRlLCBnZW9qc29uLCBzdXBwUG9pbnRzKSB7XG4gICAgY29uc3QgeyB0eXBlLCBjb29yZGluYXRlcyB9ID0gZ2VvanNvbi5nZW9tZXRyeTtcbiAgICBjb25zdCBmZWF0dXJlSWQgPSBnZW9qc29uLnByb3BlcnRpZXMgJiYgZ2VvanNvbi5wcm9wZXJ0aWVzLmlkO1xuICAgIGNvbnN0IGFjdGlvbldpZGdldHMgPSBbXTtcbiAgICBpZiAodHlwZSAhPT0gTWFwYm94RHJhdy5jb25zdGFudHMuZ2VvanNvblR5cGVzLlBPTFlHT04pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBjb3JuZXJzID0gc3VwcFBvaW50cy5zbGljZSgwKTtcbiAgICBjb3JuZXJzW2Nvcm5lcnMubGVuZ3RoXSA9IGNvcm5lcnNbMF07XG4gICAgbGV0IHYxID0gbnVsbDtcbiAgICBjb25zdCByb3RDZW50ZXIgPSB0aGlzLmNvbXB1dGVDZW50ZXIoc3RhdGUsIGdlb2pzb24pO1xuICAgIGNvcm5lcnMuZm9yRWFjaCgodjIpID0+IHtcbiAgICAgICAgaWYgKHYxICE9IG51bGwgJiYgKHYxLnByb3BlcnRpZXMuY29vcmRfcGF0aCA9PT0gJzAuMicpKSB7XG4gICAgICAgICAgICB0aGlzLl9jcmVhdGVBY3Rpb25Qb2ludChhY3Rpb25XaWRnZXRzLCBmZWF0dXJlSWQsIHYxLCB2Miwgcm90Q2VudGVyLCBzdGF0ZS5yb3RhdGlvblBvaW50UmFkaXVzLCAncmVzaXplJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHYxICE9IG51bGwgJiYgKHYxLnByb3BlcnRpZXMuY29vcmRfcGF0aCA9PT0gJzAuMCcpKSB7XG4gICAgICAgICAgICB0aGlzLl9jcmVhdGVBY3Rpb25Qb2ludChhY3Rpb25XaWRnZXRzLCBmZWF0dXJlSWQsIHYxLCB2Miwgcm90Q2VudGVyLCBzdGF0ZS5yb3RhdGlvblBvaW50UmFkaXVzLCAnb3JpZ2luJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHYxICE9IG51bGwgJiYgKHYxLnByb3BlcnRpZXMuY29vcmRfcGF0aCA9PT0gJzAuMycpKSB7XG4gICAgICAgICAgICB0aGlzLl9jcmVhdGVBY3Rpb25Qb2ludChhY3Rpb25XaWRnZXRzLCBmZWF0dXJlSWQsIHYxLCB2Miwgcm90Q2VudGVyLCBzdGF0ZS5yb3RhdGlvblBvaW50UmFkaXVzLCAncm90YXRpb24nKTtcbiAgICAgICAgfVxuICAgICAgICB2MSA9IHYyO1xuICAgIH0pO1xuICAgIHN0YXRlLmFjdGlvbldpZGdldHMgPSBhY3Rpb25XaWRnZXRzO1xuICAgIHJldHVybiBhY3Rpb25XaWRnZXRzO1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLnN0YXJ0RHJhZ2dpbmcgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICB0aGlzLm1hcC5kcmFnUGFuLmRpc2FibGUoKTtcbiAgICBzdGF0ZS5jYW5EcmFnTW92ZSA9IHRydWU7XG4gICAgc3RhdGUuZHJhZ01vdmVMb2NhdGlvbiA9IGUubG5nTGF0O1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLnN0b3BEcmFnZ2luZyA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIHRoaXMubWFwLmRyYWdQYW4uZW5hYmxlKCk7XG4gICAgc3RhdGUuZHJhZ01vdmluZyA9IGZhbHNlO1xuICAgIHN0YXRlLmNhbkRyYWdNb3ZlID0gZmFsc2U7XG4gICAgc3RhdGUuZHJhZ01vdmVMb2NhdGlvbiA9IG51bGw7XG59O1xuXG5jb25zdCBpc01pZFBvaW50ID0gTWFwYm94RHJhdy5saWIuQ29tbW9uU2VsZWN0b3JzLmlzT2ZNZXRhVHlwZShNYXBib3hEcmF3LmNvbnN0YW50cy5tZXRhLk1JRFBPSU5UKTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLm9uVG91Y2hTdGFydCA9IHN0cmlwRGlyZWN0U2VsZWN0TW9kZS5vbk1vdXNlRG93biA9IGZ1bmN0aW9uIChzdGF0ZSwgZSkge1xuICAgIGlmIChpc01pZFBvaW50KGUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uQWN0aXZhdGVQb2ludChzdGF0ZSwgZSk7XG4gICAgfVxuICAgIGlmIChNYXBib3hEcmF3LmxpYi5Db21tb25TZWxlY3RvcnMuaXNBY3RpdmVGZWF0dXJlKGUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uRmVhdHVyZShzdGF0ZSwgZSk7XG4gICAgfVxufTtcblxuY29uc3Qgc3RyaXBEaXJlY3RNb2RlID0ge1xuICAgIFJlc2l6ZTogMSxcbiAgICBSb3RhdGU6IDJcbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5vbkFjdGl2YXRlUG9pbnQgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICB0aGlzLmNvbXB1dGVBeGVzKHN0YXRlLCBzdGF0ZS5mZWF0dXJlLnRvR2VvSlNPTigpKTtcbiAgICB0aGlzLnN0YXJ0RHJhZ2dpbmcoc3RhdGUsIGUpO1xuICAgIGNvbnN0IGFib3V0ID0gZS5mZWF0dXJlVGFyZ2V0LnByb3BlcnRpZXM7XG4gICAgc3RhdGUuc2VsZWN0ZWRDb29yZFBhdGhzID0gW2Fib3V0LmNvb3JkX3BhdGhdO1xuICAgIGlmIChlLmZlYXR1cmVUYXJnZXQucHJvcGVydGllcy5hY3Rpb25UeXBlID09PSAncm90YXRpb24nKSB7XG4gICAgICAgIHN0YXRlLnN0cmlwRGlyZWN0TW9kZSA9IHN0cmlwRGlyZWN0TW9kZS5Sb3RhdGU7XG4gICAgfSBlbHNlIGlmIChlLmZlYXR1cmVUYXJnZXQucHJvcGVydGllcy5hY3Rpb25UeXBlID09PSAncmVzaXplJykge1xuICAgICAgICBzdGF0ZS5zdHJpcERpcmVjdE1vZGUgPSBzdHJpcERpcmVjdE1vZGUuUmVzaXplO1xuICAgIH1cbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5vbkZlYXR1cmUgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICBzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHMgPSBbXTtcbiAgICB0aGlzLnN0YXJ0RHJhZ2dpbmcoc3RhdGUsIGUpO1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLmNvb3JkaW5hdGVJbmRleCA9IGZ1bmN0aW9uIChjb29yZFBhdGhzKSB7XG4gICAgaWYgKGNvb3JkUGF0aHMubGVuZ3RoID49IDEpIHtcbiAgICAgICAgY29uc3QgcGFydHMgPSBjb29yZFBhdGhzWzBdLnNwbGl0KCcuJyk7XG4gICAgICAgIHJldHVybiBwYXJzZUludChwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXSwgMTApO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5jb21wdXRlQ2VudGVyID0gZnVuY3Rpb24gKHN0YXRlLCBwb2x5Z29uKSB7XG4gICAgY29uc3QgY2VudGVyMCA9IGNlbnRlcihwb2x5Z29uKTtcbiAgICByZXR1cm4gY2VudGVyMDtcbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5jb21wdXRlQXhlcyA9IGZ1bmN0aW9uIChzdGF0ZSwgcG9seWdvbikge1xuICAgIGNvbnN0IGNlbnRlciA9IHRoaXMuY29tcHV0ZUNlbnRlcihzdGF0ZSwgcG9seWdvbik7XG4gICAgY29uc3QgY29ybmVycyA9IHBvbHlnb24uZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMF0uc2xpY2UoMCk7XG4gICAgY29uc3QgbiA9IGNvcm5lcnMubGVuZ3RoIC0gMTtcbiAgICBjb25zdCBpSGFsZiA9IE1hdGguZmxvb3IobiAvIDIpO1xuICAgIGNvbnN0IHJvdGF0ZUNlbnRlcnMgPSBbXTtcbiAgICBjb25zdCBoZWFkaW5ncyA9IFtdO1xuICAgIGZvciAobGV0IGkxID0gMDsgaTEgPCBuOyBpMSsrKSB7XG4gICAgICAgIGxldCBpMCA9IGkxIC0gMTtcbiAgICAgICAgaWYgKGkwIDwgMCkge1xuICAgICAgICAgICAgaTAgKz0gbjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjMCA9IGNvcm5lcnNbaTBdO1xuICAgICAgICBjb25zdCBjMSA9IGNvcm5lcnNbaTFdO1xuICAgICAgICBjb25zdCByb3RQb2ludCA9IG1pZHBvaW50KHBvaW50KGMwKSwgcG9pbnQoYzEpKTtcbiAgICAgICAgcm90YXRlQ2VudGVyc1tpMV0gPSBjZW50ZXIuZ2VvbWV0cnkuY29vcmRpbmF0ZXM7XG4gICAgICAgIGhlYWRpbmdzW2kxXSA9IHJodW1iQmVhcmluZyhjZW50ZXIsIHJvdFBvaW50KTtcbiAgICB9XG4gICAgc3RhdGUucm90YXRpb24gPSB7XG4gICAgICAgIGZlYXR1cmUwOiBwb2x5Z29uLCAgLy8gaW5pdGlhbCBmZWF0dXJlIHN0YXRlXG4gICAgICAgIGNlbnRlcnM6IHJvdGF0ZUNlbnRlcnMsXG4gICAgICAgIGhlYWRpbmdzOiBoZWFkaW5ncywgLy8gcm90YXRpb24gc3RhcnQgaGVhZGluZyBmb3IgZWFjaCBwb2ludFxuICAgIH07XG59O1xuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUub25EcmFnID0gZnVuY3Rpb24gKHN0YXRlLCBlKSB7XG4gICAgaWYgKHN0YXRlLmNhbkRyYWdNb3ZlICE9PSB0cnVlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc3RhdGUuZHJhZ01vdmluZyA9IHRydWU7XG4gICAgZS5vcmlnaW5hbEV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgY29uc3QgZGVsdGEgPSB7XG4gICAgICAgIGxuZzogZS5sbmdMYXQubG5nIC0gc3RhdGUuZHJhZ01vdmVMb2NhdGlvbi5sbmcsXG4gICAgICAgIGxhdDogZS5sbmdMYXQubGF0IC0gc3RhdGUuZHJhZ01vdmVMb2NhdGlvbi5sYXRcbiAgICB9O1xuICAgIGlmIChzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHMubGVuZ3RoID4gMCAmJiBzdGF0ZS5zdHJpcERpcmVjdE1vZGUpIHtcbiAgICAgICAgc3dpdGNoIChzdGF0ZS5zdHJpcERpcmVjdE1vZGUpIHtcbiAgICAgICAgICAgIGNhc2Ugc3RyaXBEaXJlY3RNb2RlLlJvdGF0ZTpcbiAgICAgICAgICAgICAgICB0aGlzLmRyYWdSb3RhdGVQb2ludChzdGF0ZSwgZSwgZGVsdGEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBzdHJpcERpcmVjdE1vZGUuUmVzaXplOlxuICAgICAgICAgICAgICAgIHRoaXMuZHJhZ1Jlc2l6ZVBvaW50KHN0YXRlLCBlLCBkZWx0YSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRyYWdGZWF0dXJlKHN0YXRlLCBlLCBkZWx0YSk7XG4gICAgfVxuXG5cbiAgICBzdGF0ZS5kcmFnTW92ZUxvY2F0aW9uID0gZS5sbmdMYXQ7XG59O1xuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUuZHJhZ1JvdGF0ZVBvaW50ID0gZnVuY3Rpb24gKHN0YXRlLCBlLCBkZWx0YSkge1xuICAgIGlmIChzdGF0ZS5yb3RhdGlvbiA9PT0gdW5kZWZpbmVkIHx8IHN0YXRlLnJvdGF0aW9uID09IG51bGwpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignc3RhdGUucm90YXRpb24gcmVxdWlyZWQnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBtMSA9IHBvaW50KFtlLmxuZ0xhdC5sbmcsIGUubG5nTGF0LmxhdF0pO1xuICAgIGNvbnN0IG4gPSBzdGF0ZS5yb3RhdGlvbi5jZW50ZXJzLmxlbmd0aDtcbiAgICBjb25zdCBjSWR4ID0gKHRoaXMuY29vcmRpbmF0ZUluZGV4KHN0YXRlLnNlbGVjdGVkQ29vcmRQYXRocykgKyAxKSAlIG47XG4gICAgY29uc3QgY0NlbnRlciA9IHN0YXRlLnJvdGF0aW9uLmNlbnRlcnNbY0lkeF07XG4gICAgY29uc3QgY3AgPSBwb2ludChjQ2VudGVyKTtcbiAgICBjb25zdCBoZWFkaW5nMSA9IHJodW1iQmVhcmluZyhjcCwgbTEpO1xuICAgIGNvbnN0IGhlYWRpbmcwID0gc3RhdGUucm90YXRpb24uaGVhZGluZ3NbY0lkeF07XG4gICAgY29uc3Qgcm90YXRlQW5nbGUgPSBoZWFkaW5nMSAtIGhlYWRpbmcwOyAvLyBpbiBkZWdyZWVzXG4gICAgY29uc3Qgcm90YXRlZEZlYXR1cmUgPSB0cmFuc2Zvcm1Sb3RhdGUoc3RhdGUucm90YXRpb24uZmVhdHVyZTAsXG4gICAgICAgIHJvdGF0ZUFuZ2xlLFxuICAgICAgICB7XG4gICAgICAgICAgICBwaXZvdDogY3AsXG4gICAgICAgICAgICBtdXRhdGU6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICBzdGF0ZS5zdGFydCA9IHVuZGVmaW5lZDtcbiAgICBzdGF0ZS5mZWF0dXJlLmluY29taW5nQ29vcmRzKHJvdGF0ZWRGZWF0dXJlLmdlb21ldHJ5LmNvb3JkaW5hdGVzKTtcbiAgICBPYmplY3QuYXNzaWduKHN0YXRlLmZlYXR1cmUucHJvcGVydGllcywgY29tcHV0ZVN0cmlwUHJvcGVydGllcyhzdGF0ZS5mZWF0dXJlLmNvb3JkaW5hdGVzWzBdKSk7XG4gICAgdGhpcy5maXJlVXBkYXRlKCk7XG59O1xuXG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5kcmFnUmVzaXplUG9pbnQgPSBmdW5jdGlvbiAoc3RhdGUsIGUsIGRlbHRhKSB7XG4gICAgY29uc3QgZW5kID0gW2UubG5nTGF0LmxuZywgZS5sbmdMYXQubGF0XTtcbiAgICBsZXQgc3RhcnQ7XG4gICAgaWYgKCFzdGF0ZS5zZWxlY3RlZFJlc2l6ZVBhdGhzKSB7XG4gICAgICAgIHN0YXRlLnNlbGVjdGVkUmVzaXplUGF0aHMgPSBzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHNbMF07XG4gICAgfVxuICAgIGlmICghc3RhdGUuc3RhcnQgfHwgc3RhdGUuc2VsZWN0ZWRSZXNpemVQYXRocyAhPT0gc3RhdGUuc2VsZWN0ZWRDb29yZFBhdGhzWzBdKSB7XG4gICAgICAgIGlmIChzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHNbMF0gPT09ICcwLjAnKSB7XG4gICAgICAgICAgICBzdGFydCA9IHN0YXRlLmFjdGlvbldpZGdldHMuZmluZChhID0+IGEucHJvcGVydGllcy5jb29yZF9wYXRoID09PSAnMC4yJykucHJvcGVydGllcy5jb29yZF9wYXRoX2Nvb3JkcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN0YXJ0ID0gc3RhdGUuYWN0aW9uV2lkZ2V0cy5maW5kKGEgPT4gYS5wcm9wZXJ0aWVzLmNvb3JkX3BhdGggPT09ICcwLjAnKS5wcm9wZXJ0aWVzLmNvb3JkX3BhdGhfY29vcmRzO1xuICAgICAgICB9XG4gICAgICAgIHN0YXRlLnN0YXJ0ID0gc3RhcnQ7XG4gICAgfVxuICAgIGNvbnN0IGRpc3QgPSBkaXN0YW5jZShwb2ludChzdGF0ZS5zdGFydCksIHBvaW50KGVuZCksIHsgdW5pdHM6ICdraWxvbWV0ZXJzJyB9KTtcbiAgICBjb25zdCBuZXdQb2x5Z29uID0gYnVpbGRTdHJpcChzdGF0ZS5zdGFydCwgZW5kLCBzdGF0ZS5oYWxmU3dhdGgpO1xuICAgIGlmIChkaXN0IDw9IHN0YXRlLm1heExlbmd0aCkge1xuICAgICAgICBzdGF0ZS5mZWF0dXJlLnNldENvb3JkaW5hdGVzKG5ld1BvbHlnb24uZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuICAgICAgICBPYmplY3QuYXNzaWduKHN0YXRlLmZlYXR1cmUucHJvcGVydGllcywgY29tcHV0ZVN0cmlwUHJvcGVydGllcyhzdGF0ZS5mZWF0dXJlLmNvb3JkaW5hdGVzWzBdKSk7XG4gICAgICAgIHRoaXMuZmlyZVVwZGF0ZSgpO1xuICAgIH1cbn07XG5cblxuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUuZHJhZ0ZlYXR1cmUgPSBmdW5jdGlvbiAoc3RhdGUsIGUsIGRlbHRhKSB7XG4gICAgTWFwYm94RHJhdy5saWIubW92ZUZlYXR1cmVzKHRoaXMuZ2V0U2VsZWN0ZWQoKSwgZGVsdGEpO1xuICAgIHN0YXRlLmRyYWdNb3ZlTG9jYXRpb24gPSBlLmxuZ0xhdDtcbiAgICBzdGF0ZS5zdGFydCA9IHVuZGVmaW5lZDtcbiAgICBPYmplY3QuYXNzaWduKHN0YXRlLmZlYXR1cmUucHJvcGVydGllcywgY29tcHV0ZVN0cmlwUHJvcGVydGllcyhzdGF0ZS5mZWF0dXJlLmNvb3JkaW5hdGVzWzBdKSk7XG4gICAgdGhpcy5maXJlVXBkYXRlKCk7XG59O1xuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUuZmlyZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm1hcC5maXJlKE1hcGJveERyYXcuY29uc3RhbnRzLmV2ZW50cy5VUERBVEUsIHtcbiAgICAgICAgYWN0aW9uOiBNYXBib3hEcmF3LmNvbnN0YW50cy51cGRhdGVBY3Rpb25zLkNIQU5HRV9DT09SRElOQVRFUyxcbiAgICAgICAgZmVhdHVyZXM6IHRoaXMuZ2V0U2VsZWN0ZWQoKS5tYXAoZiA9PiBmLnRvR2VvSlNPTigpKVxuICAgIH0pO1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLm9uTW91c2VPdXQgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICAvLyBBcyBzb29uIGFzIHlvdSBtb3VzZSBsZWF2ZXMgdGhlIGNhbnZhcywgdXBkYXRlIHRoZSBmZWF0dXJlXG4gICAgaWYgKHN0YXRlLmRyYWdNb3ZpbmcpIHtcbiAgICAgICAgdGhpcy5maXJlVXBkYXRlKCk7XG4gICAgfVxufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLm9uVG91Y2hFbmQgPSBzdHJpcERpcmVjdFNlbGVjdE1vZGUub25Nb3VzZVVwID0gZnVuY3Rpb24gKHN0YXRlKSB7XG4gICAgaWYgKHN0YXRlLmRyYWdNb3ZpbmcpIHtcbiAgICAgICAgdGhpcy5maXJlVXBkYXRlKCk7XG4gICAgfVxuICAgIHRoaXMuc3RvcERyYWdnaW5nKHN0YXRlKTtcbn07XG5cbnN0cmlwRGlyZWN0U2VsZWN0TW9kZS5jbGlja0FjdGl2ZUZlYXR1cmUgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgICBzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHMgPSBbXTtcbiAgICB0aGlzLmNsZWFyU2VsZWN0ZWRDb29yZGluYXRlcygpO1xuICAgIHN0YXRlLmZlYXR1cmUuY2hhbmdlZCgpO1xufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLm9uQ2xpY2sgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICBpZiAoTWFwYm94RHJhdy5saWIuQ29tbW9uU2VsZWN0b3JzLm5vVGFyZ2V0KGUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNsaWNrTm9UYXJnZXQoc3RhdGUsIGUpO1xuICAgIH1cbiAgICBpZiAoTWFwYm94RHJhdy5saWIuQ29tbW9uU2VsZWN0b3JzLmlzQWN0aXZlRmVhdHVyZShlKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jbGlja0FjdGl2ZUZlYXR1cmUoc3RhdGUsIGUpO1xuICAgIH1cbiAgICBpZiAoTWFwYm94RHJhdy5saWIuQ29tbW9uU2VsZWN0b3JzLmlzSW5hY3RpdmVGZWF0dXJlKGUpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNsaWNrSW5hY3RpdmUoc3RhdGUsIGUpO1xuICAgIH1cbiAgICB0aGlzLnN0b3BEcmFnZ2luZyhzdGF0ZSk7XG59O1xuXG5zdHJpcERpcmVjdFNlbGVjdE1vZGUuY2xpY2tOb1RhcmdldCA9IGZ1bmN0aW9uIChzdGF0ZSwgZSkge1xuICAgIGlmIChzdGF0ZS5jYW5TZWxlY3RGZWF0dXJlcykge1xuICAgICAgICB0aGlzLmNoYW5nZU1vZGUoTWFwYm94RHJhdy5jb25zdGFudHMubW9kZXMuU0lNUExFX1NFTEVDVCk7XG4gICAgfVxufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLmNsaWNrSW5hY3RpdmUgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICBpZiAoc3RhdGUuY2FuU2VsZWN0RmVhdHVyZXMpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VNb2RlKE1hcGJveERyYXcuY29uc3RhbnRzLm1vZGVzLlNJTVBMRV9TRUxFQ1QsIHtcbiAgICAgICAgICAgIGZlYXR1cmVJZHM6IFtlLmZlYXR1cmVUYXJnZXQucHJvcGVydGllcy5pZF1cbiAgICAgICAgfSk7XG4gICAgfVxufTtcblxuc3RyaXBEaXJlY3RTZWxlY3RNb2RlLm9uVHJhc2ggPSBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5kZWxldGVGZWF0dXJlKHRoaXMuZ2V0U2VsZWN0ZWRJZHMoKSk7XG59O1xuIl19