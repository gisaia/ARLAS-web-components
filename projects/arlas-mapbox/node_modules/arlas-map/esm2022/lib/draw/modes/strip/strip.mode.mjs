/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import MapboxDraw from '@mapbox/mapbox-gl-draw';
import distance from '@turf/distance';
import { bearingToAzimuth, point, polygon } from '@turf/helpers';
import length from '@turf/length';
import midpoint from '@turf/midpoint';
import rhumbBearing from '@turf/rhumb-bearing';
import rhumbDestination from '@turf/rhumb-destination';
import transformRotate from '@turf/transform-rotate';
import transformTranslate from '@turf/transform-translate';
import { displayFeatures, updateCoordinates } from '../utils';
export const stripMode = { ...MapboxDraw.modes.draw_line_string };
export function rotateStrip(start, end, state, currentMaxBearing = 0, options = {}) {
    const properties = options.properties ? options.properties : {};
    const startPoint = point(start);
    const endPoint = point(end);
    const bearing = rhumbBearing(startPoint, endPoint);
    const rotatedPoly = transformRotate(state.strip, bearing - currentMaxBearing, { pivot: start });
    state.currentMaxBearing = bearing;
    return polygon(rotatedPoly.coordinates, properties);
}
export function buildStrip(start, end, halfSwath, options = {}) {
    const properties = options.properties ? options.properties : {};
    // main
    const coordinates = [];
    const startPoint = point(start);
    const endPoint = point(end);
    // build polygone
    const bearing = rhumbBearing(startPoint, endPoint);
    const corner1 = rhumbDestination(startPoint, halfSwath, bearing - 90);
    const corner2 = rhumbDestination(startPoint, halfSwath, bearing + 90);
    const corner3 = rhumbDestination(endPoint, halfSwath, bearing + 90);
    const corner4 = rhumbDestination(endPoint, halfSwath, bearing - 90);
    coordinates.push(corner1.geometry.coordinates);
    coordinates.push(corner2.geometry.coordinates);
    coordinates.push(corner3.geometry.coordinates);
    coordinates.push(corner4.geometry.coordinates);
    coordinates.push(coordinates[0]);
    properties.start = start;
    properties.end = end;
    return polygon([coordinates], properties);
}
export function computeStripProperties(coordinates) {
    const properties = new Map();
    // Compute bearing
    const bearingAngle = rhumbBearing(point(coordinates[0]), point(coordinates[3]));
    properties['bearingAngle'] = bearingToAzimuth(bearingAngle);
    // Compute origin
    properties['origin'] = midpoint(point(coordinates[0]), point(coordinates[1])).geometry.coordinates;
    // Compute length
    properties['length'] = distance(point(coordinates[1]), point(coordinates[2]), { units: 'kilometers' });
    return properties;
}
const doubleClickZoom = {
    enable: (ctx) => {
        setTimeout(() => {
            // First check we've got a map and some context.
            if (!ctx.map?.doubleClickZoom ||
                !ctx._ctx?.store?.getInitialConfigValue) {
                return;
            }
            // Now check initial state wasn't false (we leave it disabled if so)
            if (!ctx._ctx.store.getInitialConfigValue('doubleClickZoom')) {
                return;
            }
            ctx.map.doubleClickZoom.enable();
        }, 0);
    },
};
stripMode.onSetup = function (opts) {
    const halfSwath = opts.halfSwath;
    const maxLength = opts.maxLength;
    if (!halfSwath) {
        throw new Error('You must provide a valid halfSwath to enter strip_direct mode');
    }
    if (!maxLength) {
        throw new Error('You must provide a valid maxLength to enter strip_direct mode');
    }
    const props = MapboxDraw.modes.draw_line_string.onSetup.call(this, opts);
    const polygon = this.newFeature({
        type: MapboxDraw.constants.geojsonTypes.FEATURE,
        properties: {
            meta: 'strip',
            isCircle: false,
            isStrip: true,
            halfSwath: opts.halfSwath,
            maxLength: opts.maxLength,
            bearingAngle: 0
        },
        geometry: {
            type: MapboxDraw.constants.geojsonTypes.POLYGON,
            coordinates: [[]],
        },
    });
    this.addFeature(polygon);
    return {
        ...props,
        strip: polygon,
        halfSwath,
        maxLength,
        meta: 'strip'
    };
};
stripMode.fireOnStop = function () {
    this.map.fire('draw.onStop', 'draw end');
};
stripMode.clickAnywhere = function (state, e) {
    // this ends the drawing after the user creates a second point, triggering this.onStop
    if (state.currentVertexPosition === 1) {
        state.line.addCoordinate(0, e.lngLat.lng, e.lngLat.lat);
        return this.changeMode('simple_select', {
            featureIds: [state.line.id]
        });
    }
    this.updateUIClasses({ mouse: MapboxDraw.constants.cursors.ADD });
    state.line.updateCoordinate(state.currentVertexPosition, e.lngLat.lng, e.lngLat.lat);
    updateCoordinates(state, e);
    return null;
};
stripMode.onMouseMove = function (state, e) {
    if (state.currentVertexPosition === 1) {
        MapboxDraw.modes.draw_line_string.onMouseMove.call(this, state, e);
        const geojson = state.line.toGeoJSON();
        const stripLength = length(geojson, { units: 'kilometers' });
        const start = geojson.geometry.coordinates[0];
        const end = [e.lngLat.lng, e.lngLat.lat];
        const startPoint = point(start);
        const endPoint = point(end);
        const bearing = rhumbBearing(startPoint, endPoint);
        if (stripLength > state.maxLength && state.isStripDrew === undefined) {
            const translateDistance = -(stripLength - state.maxLength);
            const translatedPoint = transformTranslate(endPoint, translateDistance, bearing);
            const stripFeature = buildStrip(start, translatedPoint.geometry.coordinates, state.halfSwath);
            stripFeature.properties.parent = state.line.id;
            stripFeature.properties.meta = 'strip';
            state.strip.setCoordinates(stripFeature.geometry.coordinates);
            state.currentMaxBearing = bearing;
            state.isStripDrew = true;
            Object.assign(state.strip.properties, computeStripProperties(stripFeature.geometry.coordinates[0]));
        }
        else if (stripLength <= state.maxLength || state.isStripDrew === undefined) {
            const stripFeature = buildStrip(start, end, state.halfSwath);
            stripFeature.properties.parent = state.line.id;
            stripFeature.properties.meta = 'strip';
            state.strip.setCoordinates(stripFeature.geometry.coordinates);
            state.currentMaxBearing = bearing;
            state.isStripDrew = true;
            Object.assign(state.strip.properties, computeStripProperties(stripFeature.geometry.coordinates[0]));
        }
        else if (state.isStripDrew && stripLength > state.maxLength) {
            const stripFeature = rotateStrip(start, end, state, state.currentMaxBearing);
            stripFeature.properties.parent = state.line.id;
            stripFeature.properties.meta = 'strip';
            state.strip.setCoordinates(stripFeature.geometry.coordinates);
            Object.assign(state.strip.properties, computeStripProperties(stripFeature.geometry.coordinates[0]));
        }
    }
};
// creates the final geojson point feature with a radius property
// triggers draw.create
stripMode.onStop = function (state) {
    doubleClickZoom.enable(this);
    this.activateUIButton();
    // check to see if we've deleted this feature
    if (this.getFeature(state.line.id) === undefined) {
        return;
    }
    // remove last added coordinate
    state.line.removeCoordinate('0');
    if (state.line.isValid()) {
        this.deleteFeature([state.line.id], { silent: true });
        this.map.fire('draw.create', {
            features: [state.strip.toGeoJSON()],
        });
    }
    else {
        this.deleteFeature([state.line.id], { silent: true });
        this.changeMode('simple_select', {}, { silent: true });
    }
    this.fireOnStop();
};
stripMode.toDisplayFeatures = function (state, geojson, display) {
    displayFeatures(state, geojson, display);
    if (geojson.geometry.coordinates.length >= 2 && geojson.geometry.coordinates[1]) {
        // create custom feature for the current pointer position
        const currentVertex = {
            type: 'Feature',
            properties: {
                meta: 'currentPosition',
                parent: state.line.id,
            },
            geometry: {
                type: 'Point',
                coordinates: geojson.geometry.coordinates[1],
            },
        };
        display(currentVertex);
    }
    return null;
};
export default stripMode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXAubW9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FybGFzLW1hcC9zcmMvbGliL2RyYXcvbW9kZXMvc3RyaXAvc3RyaXAubW9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFFSCxPQUFPLFVBQVUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRCxPQUFPLFFBQVEsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRSxPQUFPLE1BQU0sTUFBTSxjQUFjLENBQUM7QUFDbEMsT0FBTyxRQUFRLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxZQUFZLE1BQU0scUJBQXFCLENBQUM7QUFDL0MsT0FBTyxnQkFBZ0IsTUFBTSx5QkFBeUIsQ0FBQztBQUN2RCxPQUFPLGVBQWUsTUFBTSx3QkFBd0IsQ0FBQztBQUNyRCxPQUFPLGtCQUFrQixNQUFNLDJCQUEyQixDQUFDO0FBQzNELE9BQU8sRUFBRSxlQUFlLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFOUQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLEVBQUUsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7QUFFbEUsTUFBTSxVQUFVLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsR0FBRyxDQUFDLEVBQUUsVUFBZSxFQUFFO0lBQ25GLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNoRSxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsTUFBTSxRQUFRLEdBQUcs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QUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUNELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUM7QUFFRixTQUFTLENBQUMsaUJBQWlCLEdBQUcsVUFBVSxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU87SUFDM0QsZUFBZSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFFekMsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDOUUseURBQXlEO1FBQ3pELE1BQU0sYUFBYSxHQUFHO1lBQ2xCLElBQUksRUFBRSxTQUFTO1lBQ2YsVUFBVSxFQUFFO2dCQUNSLElBQUksRUFBRSxpQkFBaUI7Z0JBQ3ZCLE1BQU0sRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7YUFDeEI7WUFDRCxRQUFRLEVBQUU7Z0JBQ04sSUFBSSxFQUFFLE9BQU87Z0JBQ2IsV0FBVyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQzthQUMvQztTQUNKLENBQUM7UUFDRixPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUMsQ0FBQztBQUVGLGVBQWUsU0FBUyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIEdpc2HDr2EgdW5kZXIgb25lIG9yIG1vcmUgY29udHJpYnV0b3JcbiAqIGxpY2Vuc2UgYWdyZWVtZW50cy4gU2VlIHRoZSBOT1RJQ0UudHh0IGZpbGUgZGlzdHJpYnV0ZWQgd2l0aFxuICogdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBjb3B5cmlnaHRcbiAqIG93bmVyc2hpcC4gR2lzYcOvYSBsaWNlbnNlcyB0aGlzIGZpbGUgdG8geW91IHVuZGVyXG4gKiB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5XG4gKiBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCBNYXBib3hEcmF3IGZyb20gJ0BtYXBib3gvbWFwYm94LWdsLWRyYXcnO1xuaW1wb3J0IGRpc3RhbmNlIGZyb20gJ0B0dXJmL2Rpc3RhbmNlJztcbmltcG9ydCB7IGJlYXJpbmdUb0F6aW11dGgsIHBvaW50LCBwb2x5Z29uIH0gZnJvbSAnQHR1cmYvaGVscGVycyc7XG5pbXBvcnQgbGVuZ3RoIGZyb20gJ0B0dXJmL2xlbmd0aCc7XG5pbXBvcnQgbWlkcG9pbnQgZnJvbSAnQHR1cmYvbWlkcG9pbnQnO1xuaW1wb3J0IHJodW1iQmVhcmluZyBmcm9tICdAdHVyZi9yaHVtYi1iZWFyaW5nJztcbmltcG9ydCByaHVtYkRlc3RpbmF0aW9uIGZyb20gJ0B0dXJmL3JodW1iLWRlc3RpbmF0aW9uJztcbmltcG9ydCB0cmFuc2Zvcm1Sb3RhdGUgZnJvbSAnQHR1cmYvdHJhbnNmb3JtLXJvdGF0ZSc7XG5pbXBvcnQgdHJhbnNmb3JtVHJhbnNsYXRlIGZyb20gJ0B0dXJmL3RyYW5zZm9ybS10cmFuc2xhdGUnO1xuaW1wb3J0IHsgZGlzcGxheUZlYXR1cmVzLCB1cGRhdGVDb29yZGluYXRlcyB9IGZyb20gJy4uL3V0aWxzJztcblxuZXhwb3J0IGNvbnN0IHN0cmlwTW9kZSA9IHsgLi4uTWFwYm94RHJhdy5tb2Rlcy5kcmF3X2xpbmVfc3RyaW5nIH07XG5cbmV4cG9ydCBmdW5jdGlvbiByb3RhdGVTdHJpcChzdGFydCwgZW5kLCBzdGF0ZSwgY3VycmVudE1heEJlYXJpbmcgPSAwLCBvcHRpb25zOiBhbnkgPSB7fSkge1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBvcHRpb25zLnByb3BlcnRpZXMgPyBvcHRpb25zLnByb3BlcnRpZXMgOiB7fTtcbiAgICBjb25zdCBzdGFydFBvaW50ID0gcG9pbnQoc3RhcnQpO1xuICAgIGNvbnN0IGVuZFBvaW50ID0gcG9pbnQoZW5kKTtcbiAgICBjb25zdCBiZWFyaW5nID0gcmh1bWJCZWFyaW5nKHN0YXJ0UG9pbnQsIGVuZFBvaW50KTtcbiAgICBjb25zdCByb3RhdGVkUG9seSA9IHRyYW5zZm9ybVJvdGF0ZShzdGF0ZS5zdHJpcCwgYmVhcmluZyAtIGN1cnJlbnRNYXhCZWFyaW5nLCB7IHBpdm90OiBzdGFydCB9KTtcbiAgICBzdGF0ZS5jdXJyZW50TWF4QmVhcmluZyA9IGJlYXJpbmc7XG4gICAgcmV0dXJuIHBvbHlnb24ocm90YXRlZFBvbHkuY29vcmRpbmF0ZXMsIHByb3BlcnRpZXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTdHJpcChzdGFydCwgZW5kLCBoYWxmU3dhdGgsIG9wdGlvbnM6IGFueSA9IHt9KSB7XG4gICAgY29uc3QgcHJvcGVydGllcyA9IG9wdGlvbnMucHJvcGVydGllcyA/IG9wdGlvbnMucHJvcGVydGllcyA6IHt9O1xuICAgIC8vIG1haW5cbiAgICBjb25zdCBjb29yZGluYXRlcyA9IFtdO1xuICAgIGNvbnN0IHN0YXJ0UG9pbnQgPSBwb2ludChzdGFydCk7XG4gICAgY29uc3QgZW5kUG9pbnQgPSBwb2ludChlbmQpO1xuICAgIC8vIGJ1aWxkIHBvbHlnb25lXG4gICAgY29uc3QgYmVhcmluZyA9IHJodW1iQmVhcmluZyhzdGFydFBvaW50LCBlbmRQb2ludCk7XG4gICAgY29uc3QgY29ybmVyMSA9IHJodW1iRGVzdGluYXRpb24oc3RhcnRQb2ludCwgaGFsZlN3YXRoLCBiZWFyaW5nIC0gOTApO1xuICAgIGNvbnN0IGNvcm5lcjIgPSByaHVtYkRlc3RpbmF0aW9uKHN0YXJ0UG9pbnQsIGhhbGZTd2F0aCwgYmVhcmluZyArIDkwKTtcbiAgICBjb25zdCBjb3JuZXIzID0gcmh1bWJEZXN0aW5hdGlvbihlbmRQb2ludCwgaGFsZlN3YXRoLCBiZWFyaW5nICsgOTApO1xuICAgIGNvbnN0IGNvcm5lcjQgPSByaHVtYkRlc3RpbmF0aW9uKGVuZFBvaW50LCBoYWxmU3dhdGgsIGJlYXJpbmcgLSA5MCk7XG4gICAgY29vcmRpbmF0ZXMucHVzaChjb3JuZXIxLmdlb21ldHJ5LmNvb3JkaW5hdGVzKTtcbiAgICBjb29yZGluYXRlcy5wdXNoKGNvcm5lcjIuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuICAgIGNvb3JkaW5hdGVzLnB1c2goY29ybmVyMy5nZW9tZXRyeS5jb29yZGluYXRlcyk7XG4gICAgY29vcmRpbmF0ZXMucHVzaChjb3JuZXI0Lmdlb21ldHJ5LmNvb3JkaW5hdGVzKTtcbiAgICBjb29yZGluYXRlcy5wdXNoKGNvb3JkaW5hdGVzWzBdKTtcbiAgICBwcm9wZXJ0aWVzLnN0YXJ0ID0gc3RhcnQ7XG4gICAgcHJvcGVydGllcy5lbmQgPSBlbmQ7XG4gICAgcmV0dXJuIHBvbHlnb24oW2Nvb3JkaW5hdGVzXSwgcHJvcGVydGllcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlU3RyaXBQcm9wZXJ0aWVzKGNvb3JkaW5hdGVzKSB7XG4gICAgY29uc3QgcHJvcGVydGllcyA9IG5ldyBNYXAoKTtcblxuICAgIC8vIENvbXB1dGUgYmVhcmluZ1xuICAgIGNvbnN0IGJlYXJpbmdBbmdsZSA9IHJodW1iQmVhcmluZyhwb2ludChjb29yZGluYXRlc1swXSksIHBvaW50KGNvb3JkaW5hdGVzWzNdKSk7XG4gICAgcHJvcGVydGllc1snYmVhcmluZ0FuZ2xlJ10gPSBiZWFyaW5nVG9BemltdXRoKGJlYXJpbmdBbmdsZSk7XG5cbiAgICAvLyBDb21wdXRlIG9yaWdpblxuICAgIHByb3BlcnRpZXNbJ29yaWdpbiddID0gbWlkcG9pbnQocG9pbnQoY29vcmRpbmF0ZXNbMF0pLCBwb2ludChjb29yZGluYXRlc1sxXSkpLmdlb21ldHJ5LmNvb3JkaW5hdGVzO1xuXG4gICAgLy8gQ29tcHV0ZSBsZW5ndGhcbiAgICBwcm9wZXJ0aWVzWydsZW5ndGgnXSA9IGRpc3RhbmNlKHBvaW50KGNvb3JkaW5hdGVzWzFdKSwgcG9pbnQoY29vcmRpbmF0ZXNbMl0pLCB7IHVuaXRzOiAna2lsb21ldGVycycgfSk7XG5cbiAgICByZXR1cm4gcHJvcGVydGllcztcbn1cblxuY29uc3QgZG91YmxlQ2xpY2tab29tID0ge1xuICAgIGVuYWJsZTogKGN0eCkgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIC8vIEZpcnN0IGNoZWNrIHdlJ3ZlIGdvdCBhIG1hcCBhbmQgc29tZSBjb250ZXh0LlxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICFjdHgubWFwPy5kb3VibGVDbGlja1pvb20gfHxcbiAgICAgICAgICAgICAgICAhY3R4Ll9jdHg/LnN0b3JlPy5nZXRJbml0aWFsQ29uZmlnVmFsdWVcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIE5vdyBjaGVjayBpbml0aWFsIHN0YXRlIHdhc24ndCBmYWxzZSAod2UgbGVhdmUgaXQgZGlzYWJsZWQgaWYgc28pXG4gICAgICAgICAgICBpZiAoIWN0eC5fY3R4LnN0b3JlLmdldEluaXRpYWxDb25maWdWYWx1ZSgnZG91YmxlQ2xpY2tab29tJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjdHgubWFwLmRvdWJsZUNsaWNrWm9vbS5lbmFibGUoKTtcbiAgICAgICAgfSwgMCk7XG4gICAgfSxcbn07XG5zdHJpcE1vZGUub25TZXR1cCA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gICAgY29uc3QgaGFsZlN3YXRoID0gb3B0cy5oYWxmU3dhdGg7XG4gICAgY29uc3QgbWF4TGVuZ3RoID0gb3B0cy5tYXhMZW5ndGg7XG5cbiAgICBpZiAoIWhhbGZTd2F0aCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IHByb3ZpZGUgYSB2YWxpZCBoYWxmU3dhdGggdG8gZW50ZXIgc3RyaXBfZGlyZWN0IG1vZGUnKTtcbiAgICB9XG4gICAgaWYgKCFtYXhMZW5ndGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBwcm92aWRlIGEgdmFsaWQgbWF4TGVuZ3RoIHRvIGVudGVyIHN0cmlwX2RpcmVjdCBtb2RlJyk7XG4gICAgfVxuICAgIGNvbnN0IHByb3BzID0gTWFwYm94RHJhdy5tb2Rlcy5kcmF3X2xpbmVfc3RyaW5nLm9uU2V0dXAuY2FsbCh0aGlzLCBvcHRzKTtcbiAgICBjb25zdCBwb2x5Z29uID0gdGhpcy5uZXdGZWF0dXJlKHtcbiAgICAgICAgdHlwZTogTWFwYm94RHJhdy5jb25zdGFudHMuZ2VvanNvblR5cGVzLkZFQVRVUkUsXG4gICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIG1ldGE6ICdzdHJpcCcsXG4gICAgICAgICAgICBpc0NpcmNsZTogZmFsc2UsXG4gICAgICAgICAgICBpc1N0cmlwOiB0cnVlLFxuICAgICAgICAgICAgaGFsZlN3YXRoOiBvcHRzLmhhbGZTd2F0aCxcbiAgICAgICAgICAgIG1heExlbmd0aDogb3B0cy5tYXhMZW5ndGgsXG4gICAgICAgICAgICBiZWFyaW5nQW5nbGU6IDBcblxuICAgICAgICB9LFxuICAgICAgICBnZW9tZXRyeToge1xuICAgICAgICAgICAgdHlwZTogTWFwYm94RHJhdy5jb25zdGFudHMuZ2VvanNvblR5cGVzLlBPTFlHT04sXG4gICAgICAgICAgICBjb29yZGluYXRlczogW1tdXSxcbiAgICAgICAgfSxcbiAgICB9KTtcbiAgICB0aGlzLmFkZEZlYXR1cmUocG9seWdvbik7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgc3RyaXA6IHBvbHlnb24sXG4gICAgICAgIGhhbGZTd2F0aCxcbiAgICAgICAgbWF4TGVuZ3RoLFxuICAgICAgICBtZXRhOiAnc3RyaXAnXG4gICAgfTtcbn07XG5cbnN0cmlwTW9kZS5maXJlT25TdG9wID0gZnVuY3Rpb24gKCkge1xuICAgIHRoaXMubWFwLmZpcmUoJ2RyYXcub25TdG9wJywgJ2RyYXcgZW5kJyk7XG59O1xuXG5zdHJpcE1vZGUuY2xpY2tBbnl3aGVyZSA9IGZ1bmN0aW9uIChzdGF0ZSwgZSkge1xuICAgIC8vIHRoaXMgZW5kcyB0aGUgZHJhd2luZyBhZnRlciB0aGUgdXNlciBjcmVhdGVzIGEgc2Vjb25kIHBvaW50LCB0cmlnZ2VyaW5nIHRoaXMub25TdG9wXG4gICAgaWYgKHN0YXRlLmN1cnJlbnRWZXJ0ZXhQb3NpdGlvbiA9PT0gMSkge1xuICAgICAgICBzdGF0ZS5saW5lLmFkZENvb3JkaW5hdGUoMCwgZS5sbmdMYXQubG5nLCBlLmxuZ0xhdC5sYXQpO1xuICAgICAgICByZXR1cm4gdGhpcy5jaGFuZ2VNb2RlKCdzaW1wbGVfc2VsZWN0Jywge1xuICAgICAgICAgICAgZmVhdHVyZUlkczogW3N0YXRlLmxpbmUuaWRdXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZVVJQ2xhc3Nlcyh7IG1vdXNlOiBNYXBib3hEcmF3LmNvbnN0YW50cy5jdXJzb3JzLkFERCB9KTtcbiAgICBzdGF0ZS5saW5lLnVwZGF0ZUNvb3JkaW5hdGUoXG4gICAgICAgIHN0YXRlLmN1cnJlbnRWZXJ0ZXhQb3NpdGlvbixcbiAgICAgICAgZS5sbmdMYXQubG5nLFxuICAgICAgICBlLmxuZ0xhdC5sYXRcbiAgICApO1xuICAgIHVwZGF0ZUNvb3JkaW5hdGVzKHN0YXRlLCBlKTtcbiAgICByZXR1cm4gbnVsbDtcbn07XG5cbnN0cmlwTW9kZS5vbk1vdXNlTW92ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgZSkge1xuICAgIGlmIChzdGF0ZS5jdXJyZW50VmVydGV4UG9zaXRpb24gPT09IDEpIHtcbiAgICAgICAgTWFwYm94RHJhdy5tb2Rlcy5kcmF3X2xpbmVfc3RyaW5nLm9uTW91c2VNb3ZlLmNhbGwodGhpcywgc3RhdGUsIGUpO1xuICAgICAgICBjb25zdCBnZW9qc29uID0gc3RhdGUubGluZS50b0dlb0pTT04oKTtcbiAgICAgICAgY29uc3Qgc3RyaXBMZW5ndGggPSBsZW5ndGgoZ2VvanNvbiwgeyB1bml0czogJ2tpbG9tZXRlcnMnIH0pO1xuICAgICAgICBjb25zdCBzdGFydCA9IGdlb2pzb24uZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMF07XG4gICAgICAgIGNvbnN0IGVuZCA9IFtlLmxuZ0xhdC5sbmcsIGUubG5nTGF0LmxhdF07XG4gICAgICAgIGNvbnN0IHN0YXJ0UG9pbnQgPSBwb2ludChzdGFydCk7XG4gICAgICAgIGNvbnN0IGVuZFBvaW50ID0gcG9pbnQoZW5kKTtcbiAgICAgICAgY29uc3QgYmVhcmluZyA9IHJodW1iQmVhcmluZyhzdGFydFBvaW50LCBlbmRQb2ludCk7XG4gICAgICAgIGlmIChzdHJpcExlbmd0aCA+IHN0YXRlLm1heExlbmd0aCAmJiBzdGF0ZS5pc1N0cmlwRHJldyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCB0cmFuc2xhdGVEaXN0YW5jZSA9IC0oc3RyaXBMZW5ndGggLSBzdGF0ZS5tYXhMZW5ndGgpO1xuICAgICAgICAgICAgY29uc3QgdHJhbnNsYXRlZFBvaW50ID0gdHJhbnNmb3JtVHJhbnNsYXRlKGVuZFBvaW50LCB0cmFuc2xhdGVEaXN0YW5jZSwgYmVhcmluZyk7XG4gICAgICAgICAgICBjb25zdCBzdHJpcEZlYXR1cmUgPSBidWlsZFN0cmlwKHN0YXJ0LCB0cmFuc2xhdGVkUG9pbnQuZ2VvbWV0cnkuY29vcmRpbmF0ZXMsIHN0YXRlLmhhbGZTd2F0aCk7XG4gICAgICAgICAgICBzdHJpcEZlYXR1cmUucHJvcGVydGllcy5wYXJlbnQgPSBzdGF0ZS5saW5lLmlkO1xuICAgICAgICAgICAgc3RyaXBGZWF0dXJlLnByb3BlcnRpZXMubWV0YSA9ICdzdHJpcCc7XG4gICAgICAgICAgICBzdGF0ZS5zdHJpcC5zZXRDb29yZGluYXRlcyhzdHJpcEZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuICAgICAgICAgICAgc3RhdGUuY3VycmVudE1heEJlYXJpbmcgPSBiZWFyaW5nO1xuICAgICAgICAgICAgc3RhdGUuaXNTdHJpcERyZXcgPSB0cnVlO1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihzdGF0ZS5zdHJpcC5wcm9wZXJ0aWVzLCBjb21wdXRlU3RyaXBQcm9wZXJ0aWVzKHN0cmlwRmVhdHVyZS5nZW9tZXRyeS5jb29yZGluYXRlc1swXSkpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0cmlwTGVuZ3RoIDw9IHN0YXRlLm1heExlbmd0aCB8fCBzdGF0ZS5pc1N0cmlwRHJldyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCBzdHJpcEZlYXR1cmUgPSBidWlsZFN0cmlwKHN0YXJ0LCBlbmQsIHN0YXRlLmhhbGZTd2F0aCk7XG4gICAgICAgICAgICBzdHJpcEZlYXR1cmUucHJvcGVydGllcy5wYXJlbnQgPSBzdGF0ZS5saW5lLmlkO1xuICAgICAgICAgICAgc3RyaXBGZWF0dXJlLnByb3BlcnRpZXMubWV0YSA9ICdzdHJpcCc7XG4gICAgICAgICAgICBzdGF0ZS5zdHJpcC5zZXRDb29yZGluYXRlcyhzdHJpcEZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuICAgICAgICAgICAgc3RhdGUuY3VycmVudE1heEJlYXJpbmcgPSBiZWFyaW5nO1xuICAgICAgICAgICAgc3RhdGUuaXNTdHJpcERyZXcgPSB0cnVlO1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihzdGF0ZS5zdHJpcC5wcm9wZXJ0aWVzLCBjb21wdXRlU3RyaXBQcm9wZXJ0aWVzKHN0cmlwRmVhdHVyZS5nZW9tZXRyeS5jb29yZGluYXRlc1swXSkpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLmlzU3RyaXBEcmV3ICYmIHN0cmlwTGVuZ3RoID4gc3RhdGUubWF4TGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBzdHJpcEZlYXR1cmUgPSByb3RhdGVTdHJpcChzdGFydCwgZW5kLCBzdGF0ZSwgc3RhdGUuY3VycmVudE1heEJlYXJpbmcpO1xuICAgICAgICAgICAgc3RyaXBGZWF0dXJlLnByb3BlcnRpZXMucGFyZW50ID0gc3RhdGUubGluZS5pZDtcbiAgICAgICAgICAgIHN0cmlwRmVhdHVyZS5wcm9wZXJ0aWVzLm1ldGEgPSAnc3RyaXAnO1xuICAgICAgICAgICAgc3RhdGUuc3RyaXAuc2V0Q29vcmRpbmF0ZXMoc3RyaXBGZWF0dXJlLmdlb21ldHJ5LmNvb3JkaW5hdGVzKTtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oc3RhdGUuc3RyaXAucHJvcGVydGllcywgY29tcHV0ZVN0cmlwUHJvcGVydGllcyhzdHJpcEZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMF0pKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbi8vIGNyZWF0ZXMgdGhlIGZpbmFsIGdlb2pzb24gcG9pbnQgZmVhdHVyZSB3aXRoIGEgcmFkaXVzIHByb3BlcnR5XG4vLyB0cmlnZ2VycyBkcmF3LmNyZWF0ZVxuc3RyaXBNb2RlLm9uU3RvcCA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIGRvdWJsZUNsaWNrWm9vbS5lbmFibGUodGhpcyk7XG5cbiAgICB0aGlzLmFjdGl2YXRlVUlCdXR0b24oKTtcblxuICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB3ZSd2ZSBkZWxldGVkIHRoaXMgZmVhdHVyZVxuICAgIGlmICh0aGlzLmdldEZlYXR1cmUoc3RhdGUubGluZS5pZCkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGxhc3QgYWRkZWQgY29vcmRpbmF0ZVxuICAgIHN0YXRlLmxpbmUucmVtb3ZlQ29vcmRpbmF0ZSgnMCcpO1xuICAgIGlmIChzdGF0ZS5saW5lLmlzVmFsaWQoKSkge1xuICAgICAgICB0aGlzLmRlbGV0ZUZlYXR1cmUoW3N0YXRlLmxpbmUuaWRdLCB7IHNpbGVudDogdHJ1ZSB9KTtcblxuICAgICAgICB0aGlzLm1hcC5maXJlKCdkcmF3LmNyZWF0ZScsIHtcbiAgICAgICAgICAgIGZlYXR1cmVzOiBbc3RhdGUuc3RyaXAudG9HZW9KU09OKCldLFxuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRlbGV0ZUZlYXR1cmUoW3N0YXRlLmxpbmUuaWRdLCB7IHNpbGVudDogdHJ1ZSB9KTtcbiAgICAgICAgdGhpcy5jaGFuZ2VNb2RlKCdzaW1wbGVfc2VsZWN0Jywge30sIHsgc2lsZW50OiB0cnVlIH0pO1xuICAgIH1cbiAgICB0aGlzLmZpcmVPblN0b3AoKTtcbn07XG5cbnN0cmlwTW9kZS50b0Rpc3BsYXlGZWF0dXJlcyA9IGZ1bmN0aW9uIChzdGF0ZSwgZ2VvanNvbiwgZGlzcGxheSkge1xuICAgIGRpc3BsYXlGZWF0dXJlcyhzdGF0ZSwgZ2VvanNvbiwgZGlzcGxheSk7XG5cbiAgICBpZiAoZ2VvanNvbi5nZW9tZXRyeS5jb29yZGluYXRlcy5sZW5ndGggPj0gMiAmJiBnZW9qc29uLmdlb21ldHJ5LmNvb3JkaW5hdGVzWzFdKSB7XG4gICAgICAgIC8vIGNyZWF0ZSBjdXN0b20gZmVhdHVyZSBmb3IgdGhlIGN1cnJlbnQgcG9pbnRlciBwb3NpdGlvblxuICAgICAgICBjb25zdCBjdXJyZW50VmVydGV4ID0ge1xuICAgICAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgIG1ldGE6ICdjdXJyZW50UG9zaXRpb24nLFxuICAgICAgICAgICAgICAgIHBhcmVudDogc3RhdGUubGluZS5pZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBnZW9tZXRyeToge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdQb2ludCcsXG4gICAgICAgICAgICAgICAgY29vcmRpbmF0ZXM6IGdlb2pzb24uZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMV0sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgICBkaXNwbGF5KGN1cnJlbnRWZXJ0ZXgpO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgc3RyaXBNb2RlO1xuIl19