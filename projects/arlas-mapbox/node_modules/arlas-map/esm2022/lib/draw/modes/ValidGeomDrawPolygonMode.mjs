/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import MapboxDraw from '@mapbox/mapbox-gl-draw';
import * as jsts from 'jsts/dist/jsts.min';
export const validGeomDrawPolygonMode = MapboxDraw.modes.draw_polygon;
const reader = new jsts.io.GeoJSONReader();
validGeomDrawPolygonMode.fireInvalidGeom = function (feature) {
    this.map.fire('draw.invalidGeometry', {
        action: 'error',
        features: [feature]
    });
};
validGeomDrawPolygonMode.fireOnClick = function () {
    this.map.fire('draw.onClick', 'point drawn');
};
validGeomDrawPolygonMode.fireOnStop = function () {
    this.map.fire('draw.onStop', 'draw end');
};
validGeomDrawPolygonMode.clickOnVertex = function (state) {
    return this.changeMode(MapboxDraw.constants.modes.STATIC, {});
};
validGeomDrawPolygonMode.onTap = validGeomDrawPolygonMode.onClick = function (state, e) {
    if (MapboxDraw.lib.CommonSelectors.isVertex(e)) {
        return this.clickOnVertex(state, e);
    }
    else {
        this.fireOnClick();
        return this.clickAnywhere(state, e);
    }
};
validGeomDrawPolygonMode.onStop = function (state) {
    this.fireOnStop();
    this.updateUIClasses({ mouse: MapboxDraw.constants.cursors.NONE });
    MapboxDraw.lib.doubleClickZoom.enable(this);
    this.activateUIButton();
    // check to see if we've deleted this feature
    if (this.getFeature(state.polygon.id) === undefined) {
        return;
    }
    // remove last added coordinate
    state.polygon.removeCoordinate(`0.${state.currentVertexPosition}`);
    if (state.polygon.isValid()) {
        const featureCoords = [...state.polygon.coordinates[0]];
        if (featureCoords[0][0] !== featureCoords[featureCoords.length - 1][0] ||
            featureCoords[0][1] !== featureCoords[featureCoords.length - 1][1]) {
            featureCoords.push(featureCoords[0]);
        }
        const currentFeature = {
            'type': 'Feature',
            'geometry': {
                'type': 'Polygon',
                'coordinates': [featureCoords]
            }
        };
        const g = reader.read(currentFeature);
        if (!g.geometry.isValid()) {
            this.fireInvalidGeom(state.polygon);
            this.deleteFeature([state.polygon.id], { silent: true });
        }
        else {
            this.map.fire(MapboxDraw.constants.events.CREATE, {
                features: [state.polygon.toGeoJSON()]
            });
        }
    }
    else {
        this.deleteFeature([state.polygon.id], { silent: true });
        this.changeMode(MapboxDraw.constants.modes.STATIC, {}, { silent: true });
    }
};
export default validGeomDrawPolygonMode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVmFsaWRHZW9tRHJhd1BvbHlnb25Nb2RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvZHJhdy9tb2Rlcy9WYWxpZEdlb21EcmF3UG9seWdvbk1vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxVQUFVLE1BQU0sd0JBQXdCLENBQUM7QUFDaEQsT0FBTyxLQUFLLElBQUksTUFBTSxvQkFBb0IsQ0FBQztBQUUzQyxNQUFNLENBQUMsTUFBTSx3QkFBd0IsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztBQUN0RSxNQUFNLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFM0Msd0JBQXdCLENBQUMsZUFBZSxHQUFHLFVBQVUsT0FBTztJQUMxRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtRQUNwQyxNQUFNLEVBQUUsT0FBTztRQUNmLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQztLQUNwQixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRix3QkFBd0IsQ0FBQyxXQUFXLEdBQUc7SUFDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBQy9DLENBQUMsQ0FBQztBQUVGLHdCQUF3QixDQUFDLFVBQVUsR0FBRztJQUNwQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDM0MsQ0FBQyxDQUFDO0FBRUYsd0JBQXdCLENBQUMsYUFBYSxHQUFHLFVBQVUsS0FBSztJQUN0RCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FB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O1NBQU0sQ0FBQztRQUNOLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDM0UsQ0FBQztBQUNILENBQUMsQ0FBQztBQUVGLGVBQWUsd0JBQXdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IE1hcGJveERyYXcgZnJvbSAnQG1hcGJveC9tYXBib3gtZ2wtZHJhdyc7XG5pbXBvcnQgKiBhcyBqc3RzIGZyb20gJ2pzdHMvZGlzdC9qc3RzLm1pbic7XG5cbmV4cG9ydCBjb25zdCB2YWxpZEdlb21EcmF3UG9seWdvbk1vZGUgPSBNYXBib3hEcmF3Lm1vZGVzLmRyYXdfcG9seWdvbjtcbmNvbnN0IHJlYWRlciA9IG5ldyBqc3RzLmlvLkdlb0pTT05SZWFkZXIoKTtcblxudmFsaWRHZW9tRHJhd1BvbHlnb25Nb2RlLmZpcmVJbnZhbGlkR2VvbSA9IGZ1bmN0aW9uIChmZWF0dXJlKSB7XG4gIHRoaXMubWFwLmZpcmUoJ2RyYXcuaW52YWxpZEdlb21ldHJ5Jywge1xuICAgIGFjdGlvbjogJ2Vycm9yJyxcbiAgICBmZWF0dXJlczogW2ZlYXR1cmVdXG4gIH0pO1xufTtcblxudmFsaWRHZW9tRHJhd1BvbHlnb25Nb2RlLmZpcmVPbkNsaWNrID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLm1hcC5maXJlKCdkcmF3Lm9uQ2xpY2snLCAncG9pbnQgZHJhd24nKTtcbn07XG5cbnZhbGlkR2VvbURyYXdQb2x5Z29uTW9kZS5maXJlT25TdG9wID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLm1hcC5maXJlKCdkcmF3Lm9uU3RvcCcsICdkcmF3IGVuZCcpO1xufTtcblxudmFsaWRHZW9tRHJhd1BvbHlnb25Nb2RlLmNsaWNrT25WZXJ0ZXggPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgcmV0dXJuIHRoaXMuY2hhbmdlTW9kZShNYXBib3hEcmF3LmNvbnN0YW50cy5tb2Rlcy5TVEFUSUMsIHt9KTtcbn07XG5cbnZhbGlkR2VvbURyYXdQb2x5Z29uTW9kZS5vblRhcCA9IHZhbGlkR2VvbURyYXdQb2x5Z29uTW9kZS5vbkNsaWNrID0gZnVuY3Rpb24gKHN0YXRlLCBlKSB7XG4gIGlmIChNYXBib3hEcmF3LmxpYi5Db21tb25TZWxlY3RvcnMuaXNWZXJ0ZXgoZSkpIHtcbiAgICByZXR1cm4gdGhpcy5jbGlja09uVmVydGV4KHN0YXRlLCBlKTtcbiAgfSBlbHNlIHtcbiAgICB0aGlzLmZpcmVPbkNsaWNrKCk7XG4gICAgcmV0dXJuIHRoaXMuY2xpY2tBbnl3aGVyZShzdGF0ZSwgZSk7XG4gIH1cbn07XG5cbnZhbGlkR2VvbURyYXdQb2x5Z29uTW9kZS5vblN0b3AgPSBmdW5jdGlvbiAoc3RhdGUpIHtcbiAgdGhpcy5maXJlT25TdG9wKCk7XG4gIHRoaXMudXBkYXRlVUlDbGFzc2VzKHsgbW91c2U6IE1hcGJveERyYXcuY29uc3RhbnRzLmN1cnNvcnMuTk9ORSB9KTtcbiAgTWFwYm94RHJhdy5saWIuZG91YmxlQ2xpY2tab29tLmVuYWJsZSh0aGlzKTtcbiAgdGhpcy5hY3RpdmF0ZVVJQnV0dG9uKCk7XG5cbiAgLy8gY2hlY2sgdG8gc2VlIGlmIHdlJ3ZlIGRlbGV0ZWQgdGhpcyBmZWF0dXJlXG4gIGlmICh0aGlzLmdldEZlYXR1cmUoc3RhdGUucG9seWdvbi5pZCkgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8vIHJlbW92ZSBsYXN0IGFkZGVkIGNvb3JkaW5hdGVcbiAgc3RhdGUucG9seWdvbi5yZW1vdmVDb29yZGluYXRlKGAwLiR7c3RhdGUuY3VycmVudFZlcnRleFBvc2l0aW9ufWApO1xuICBpZiAoc3RhdGUucG9seWdvbi5pc1ZhbGlkKCkpIHtcblxuICAgIGNvbnN0IGZlYXR1cmVDb29yZHMgPSBbLi4uc3RhdGUucG9seWdvbi5jb29yZGluYXRlc1swXV07XG4gICAgaWYgKFxuICAgICAgZmVhdHVyZUNvb3Jkc1swXVswXSAhPT0gZmVhdHVyZUNvb3Jkc1tmZWF0dXJlQ29vcmRzLmxlbmd0aCAtIDFdWzBdIHx8XG4gICAgICBmZWF0dXJlQ29vcmRzWzBdWzFdICE9PSBmZWF0dXJlQ29vcmRzW2ZlYXR1cmVDb29yZHMubGVuZ3RoIC0gMV1bMV1cbiAgICApIHtcbiAgICAgIGZlYXR1cmVDb29yZHMucHVzaChmZWF0dXJlQ29vcmRzWzBdKTtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudEZlYXR1cmUgPSB7XG4gICAgICAndHlwZSc6ICdGZWF0dXJlJyxcbiAgICAgICdnZW9tZXRyeSc6IHtcbiAgICAgICAgJ3R5cGUnOiAnUG9seWdvbicsXG4gICAgICAgICdjb29yZGluYXRlcyc6IFtmZWF0dXJlQ29vcmRzXVxuICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgZyA9IHJlYWRlci5yZWFkKGN1cnJlbnRGZWF0dXJlKTtcbiAgICBpZiAoIWcuZ2VvbWV0cnkuaXNWYWxpZCgpKSB7XG4gICAgICB0aGlzLmZpcmVJbnZhbGlkR2VvbShzdGF0ZS5wb2x5Z29uKTtcbiAgICAgIHRoaXMuZGVsZXRlRmVhdHVyZShbc3RhdGUucG9seWdvbi5pZF0sIHsgc2lsZW50OiB0cnVlIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1hcC5maXJlKE1hcGJveERyYXcuY29uc3RhbnRzLmV2ZW50cy5DUkVBVEUsIHtcbiAgICAgICAgZmVhdHVyZXM6IFtzdGF0ZS5wb2x5Z29uLnRvR2VvSlNPTigpXVxuICAgICAgfSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRoaXMuZGVsZXRlRmVhdHVyZShbc3RhdGUucG9seWdvbi5pZF0sIHsgc2lsZW50OiB0cnVlIH0pO1xuICAgIHRoaXMuY2hhbmdlTW9kZShNYXBib3hEcmF3LmNvbnN0YW50cy5tb2Rlcy5TVEFUSUMsIHt9LCB7IHNpbGVudDogdHJ1ZSB9KTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgdmFsaWRHZW9tRHJhd1BvbHlnb25Nb2RlO1xuIl19