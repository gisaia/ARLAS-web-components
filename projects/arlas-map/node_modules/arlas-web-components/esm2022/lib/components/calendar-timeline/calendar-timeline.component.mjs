/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Component, Input, ElementRef, ViewChild, Output } from '@angular/core';
import { Dimensions, Granularity, Margins, Timeline } from 'arlas-d3';
import { debounceTime, fromEvent, Subject, takeUntil } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "@angular/material/icon";
export var TranslationDirection;
(function (TranslationDirection) {
    TranslationDirection["past"] = "past";
    TranslationDirection["future"] = "future";
})(TranslationDirection || (TranslationDirection = {}));
/**
 * todo : documentation of the component
 */
export class CalendarTimelineComponent {
    constructor() {
        this.boundDates = [];
        this.data = [];
        this.selectedData = new Subject();
        this.hoveredData = new Subject();
        this.translate = new Subject();
        this._onDestroy$ = new Subject();
        fromEvent(window, 'resize')
            .pipe(debounceTime(500), takeUntil(this._onDestroy$))
            .subscribe((event) => {
            const element = this.timelineContainer.nativeElement;
            const margins = (new Margins()).setBottom(5).setTop(5).setRight(5).setLeft(5);
            this.width = element.offsetWidth;
            this.height = 90;
            const dimensions = (new Dimensions(this.width, this.height)).setMargins(margins);
            if (this.timeline) {
                this.timeline.setDimensions(dimensions);
                this.timeline.plot();
            }
        });
    }
    ngOnChanges(changes) {
        if (changes.data && this.timeline) {
            this.timeline.setData(this.data);
            if (this.timeline.boundDates && this.timeline.boundDates.length === 2) {
                this.timeline.plot(true);
            }
        }
        if (changes.boundDates && this.timeline) {
            this.timeline.setBoundDates(this.boundDates);
            this.timeline.plot();
        }
        if (changes.granularity && this.timeline) {
            this.timeline.setGranularity(this.granularity);
        }
        if (changes.climatological && this.timeline) {
            this.timeline.setClimatological(this.climatological);
        }
        if (changes.cursorPosition && this.timeline) {
            this.timeline.moveCursor(this.cursorPosition);
        }
    }
    ngAfterViewInit() {
        const element = this.timelineContainer.nativeElement;
        const svg = element.querySelector('svg');
        const margins = (new Margins()).setBottom(5).setTop(5).setRight(5).setLeft(5);
        this.width = element.offsetWidth;
        this.height = 90;
        const dimensions = (new Dimensions(this.width, this.height)).setMargins(margins);
        this.timeline = (new Timeline(svg));
        this.timeline.setDimensions(dimensions);
        this.timeline.setBoundDates(this.boundDates);
        this.timeline.hoveredData
            .pipe(takeUntil(this._onDestroy$))
            .subscribe(r => {
            this.hoveredData.next(r);
        });
        this.timeline.selectedData
            .pipe(takeUntil(this._onDestroy$))
            .subscribe(r => {
            this.selectedData.next(r);
        });
    }
    ngOnDestroy() {
        this._onDestroy$.next(true);
        this._onDestroy$.complete();
    }
    plot() {
        if (this.timeline) {
            this.timeline.plot();
        }
    }
    translateFuture() {
        this.translate.next(TranslationDirection.future);
    }
    translatePast() {
        this.translate.next(TranslationDirection.past);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CalendarTimelineComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.2.13", type: CalendarTimelineComponent, selector: "arlas-calendar-timeline", inputs: { id: "id", granularity: "granularity", climatological: "climatological", boundDates: "boundDates", data: "data", cursorPosition: "cursorPosition", hideLeftButton: "hideLeftButton", hideRightButton: "hideRightButton" }, outputs: { selectedData: "selectedData", hoveredData: "hoveredData", translate: "translate" }, viewQueries: [{ propertyName: "timelineContainer", first: true, predicate: ["timeline_container"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div id=\"{{id}}\" #calendar_timeline class=\"calendar-timeline\">\n    <div class=\"container\">\n        <div class=\"move_button past\" [class.hide_left_button]=\"hideLeftButton\" (click)=\"translatePast()\" *ngIf=\"!climatological\">\n            <mat-icon class=\"chevron\">chevron_left</mat-icon>\n        </div>\n        <div class=\"svg_container\" \n            [class.svg_container_buttons_hidden]=\"hideLeftButton && hideRightButton\"\n            [class.svg_container_one_button_hidden]=\"(hideLeftButton && !hideRightButton) || (!hideLeftButton && hideRightButton)\"\n\n             #timeline_container>\n            <svg id=\"calendar-svg\" [style.width.px]=\"width\" [style.height.px]=\"height\" ></svg>\n        </div>\n        <div class=\"move_button future\" [class.hide_right_button]=\"hideRightButton\" (click)=\"translateFuture()\" *ngIf=\"!climatological\">\n            <mat-icon class=\"chevron\">chevron_right</mat-icon>\n        </div>\n    </div>\n\n</div>", styles: ["@charset \"UTF-8\";.calendar-timeline{width:100%}.calendar-timeline .container{display:flex;width:100%;border:1px solid #b7b7b7;border-radius:4px}.calendar-timeline .container .move_button{width:15px;background-color:#b7b7b7;display:flex;flex-direction:column;align-items:center;cursor:pointer;justify-content:center}.calendar-timeline .container .move_button .past{border-top-left-radius:2px;border-bottom-left-radius:2px}.calendar-timeline .container .move_button .past .hide_left_button{display:none}.calendar-timeline .container .move_button .future{border-top-right-radius:2px;border-bottom-right-radius:2px}.calendar-timeline .container .move_button .future .hide_right_button{display:none}.calendar-timeline .container .move_button .past .chevron,.calendar-timeline .container .move_button .future .chevron{font-size:20px;width:20px;height:20px}.calendar-timeline .container .svg_container{width:calc(100% - 30px)}.calendar-timeline .container .svg_container_one_button_hidden{width:calc(100% - 15px)}.calendar-timeline .container .svg_container_buttons_hidden{width:100%}\n"], dependencies: [{ kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i2.MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: CalendarTimelineComponent, decorators: [{
            type: Component,
            args: [{ selector: 'arlas-calendar-timeline', template: "<div id=\"{{id}}\" #calendar_timeline class=\"calendar-timeline\">\n    <div class=\"container\">\n        <div class=\"move_button past\" [class.hide_left_button]=\"hideLeftButton\" (click)=\"translatePast()\" *ngIf=\"!climatological\">\n            <mat-icon class=\"chevron\">chevron_left</mat-icon>\n        </div>\n        <div class=\"svg_container\" \n            [class.svg_container_buttons_hidden]=\"hideLeftButton && hideRightButton\"\n            [class.svg_container_one_button_hidden]=\"(hideLeftButton && !hideRightButton) || (!hideLeftButton && hideRightButton)\"\n\n             #timeline_container>\n            <svg id=\"calendar-svg\" [style.width.px]=\"width\" [style.height.px]=\"height\" ></svg>\n        </div>\n        <div class=\"move_button future\" [class.hide_right_button]=\"hideRightButton\" (click)=\"translateFuture()\" *ngIf=\"!climatological\">\n            <mat-icon class=\"chevron\">chevron_right</mat-icon>\n        </div>\n    </div>\n\n</div>", styles: ["@charset \"UTF-8\";.calendar-timeline{width:100%}.calendar-timeline .container{display:flex;width:100%;border:1px solid #b7b7b7;border-radius:4px}.calendar-timeline .container .move_button{width:15px;background-color:#b7b7b7;display:flex;flex-direction:column;align-items:center;cursor:pointer;justify-content:center}.calendar-timeline .container .move_button .past{border-top-left-radius:2px;border-bottom-left-radius:2px}.calendar-timeline .container .move_button .past .hide_left_button{display:none}.calendar-timeline .container .move_button .future{border-top-right-radius:2px;border-bottom-right-radius:2px}.calendar-timeline .container .move_button .future .hide_right_button{display:none}.calendar-timeline .container .move_button .past .chevron,.calendar-timeline .container .move_button .future .chevron{font-size:20px;width:20px;height:20px}.calendar-timeline .container .svg_container{width:calc(100% - 30px)}.calendar-timeline .container .svg_container_one_button_hidden{width:calc(100% - 15px)}.calendar-timeline .container .svg_container_buttons_hidden{width:100%}\n"] }]
        }], ctorParameters: () => [], propDecorators: { id: [{
                type: Input
            }], granularity: [{
                type: Input
            }], climatological: [{
                type: Input
            }], boundDates: [{
                type: Input
            }], data: [{
                type: Input
            }], cursorPosition: [{
                type: Input
            }], hideLeftButton: [{
                type: Input
            }], hideRightButton: [{
                type: Input
            }], selectedData: [{
                type: Output
            }], hoveredData: [{
                type: Output
            }], translate: [{
                type: Output
            }], timelineContainer: [{
                type: ViewChild,
                args: ['timeline_container', { static: false }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXItdGltZWxpbmUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtY29tcG9uZW50cy9zcmMvbGliL2NvbXBvbmVudHMvY2FsZW5kYXItdGltZWxpbmUvY2FsZW5kYXItdGltZWxpbmUuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtY29tcG9uZW50cy9zcmMvbGliL2NvbXBvbmVudHMvY2FsZW5kYXItdGltZWxpbmUvY2FsZW5kYXItdGltZWxpbmUuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBaUIsTUFBTSxFQUF1QyxNQUFNLGVBQWUsQ0FBQztBQUNwSSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFpQyxNQUFNLFVBQVUsQ0FBQztBQUNyRyxPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7O0FBRW5FLE1BQU0sQ0FBTixJQUFZLG9CQUdYO0FBSEQsV0FBWSxvQkFBb0I7SUFDOUIscUNBQWEsQ0FBQTtJQUNiLHlDQUFpQixDQUFBO0FBQ25CLENBQUMsRUFIVyxvQkFBb0IsS0FBcEIsb0JBQW9CLFFBRy9CO0FBT0Q7O0dBRUc7QUFDSCxNQUFNLE9BQU8seUJBQXlCO0lBd0JwQztRQW5CZ0IsZUFBVSxHQUFXLEVBQUUsQ0FBQztRQUN4QixTQUFJLEdBQW1CLEVBQUUsQ0FBQztRQUt6QixpQkFBWSxHQUEwQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3BELGdCQUFXLEdBQTZCLElBQUksT0FBTyxFQUFFLENBQUM7UUFDdEQsY0FBUyxHQUFrQyxJQUFJ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QUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVNLElBQUk7UUFDVCxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZCLENBQUM7SUFDSCxDQUFDO0lBRU0sZUFBZTtRQUNwQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRU0sYUFBYTtRQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqRCxDQUFDOytHQXRHVSx5QkFBeUI7bUdBQXpCLHlCQUF5QixnaEJDcEN0QywwOUJBaUJNOzs0RkRtQk8seUJBQXlCO2tCQVJyQyxTQUFTOytCQUNFLHlCQUF5Qjt3REFTbkIsRUFBRTtzQkFBakIsS0FBSztnQkFDVSxXQUFXO3NCQUExQixLQUFLO2dCQUNVLGNBQWM7c0JBQTdCLEtBQUs7Z0JBQ1UsVUFBVTtzQkFBekIsS0FBSztnQkFDVSxJQUFJO3NCQUFuQixLQUFLO2dCQUNVLGNBQWM7c0JBQTdCLEtBQUs7Z0JBQ1UsY0FBYztzQkFBN0IsS0FBSztnQkFDVSxlQUFlO3NCQUE5QixLQUFLO2dCQUVXLFlBQVk7c0JBQTVCLE1BQU07Z0JBQ1UsV0FBVztzQkFBM0IsTUFBTTtnQkFDVSxTQUFTO3NCQUF6QixNQUFNO2dCQVNxRCxpQkFBaUI7c0JBQTVFLFNBQVM7dUJBQUMsb0JBQW9CLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIEdpc2HDr2EgdW5kZXIgb25lIG9yIG1vcmUgY29udHJpYnV0b3JcbiAqIGxpY2Vuc2UgYWdyZWVtZW50cy4gU2VlIHRoZSBOT1RJQ0UudHh0IGZpbGUgZGlzdHJpYnV0ZWQgd2l0aFxuICogdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBjb3B5cmlnaHRcbiAqIG93bmVyc2hpcC4gR2lzYcOvYSBsaWNlbnNlcyB0aGlzIGZpbGUgdG8geW91IHVuZGVyXG4gKiB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5XG4gKiBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIEVsZW1lbnRSZWYsIFZpZXdDaGlsZCwgQWZ0ZXJWaWV3SW5pdCwgT3V0cHV0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRGltZW5zaW9ucywgR3JhbnVsYXJpdHksIE1hcmdpbnMsIFRpbWVsaW5lLCBUaW1lbGluZURhdGEsIFRpbWVsaW5lVG9vbHRpcCB9IGZyb20gJ2FybGFzLWQzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZnJvbUV2ZW50LCBTdWJqZWN0LCB0YWtlVW50aWwgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IGVudW0gVHJhbnNsYXRpb25EaXJlY3Rpb24ge1xuICBwYXN0ID0gJ3Bhc3QnLFxuICBmdXR1cmUgPSAnZnV0dXJlJ1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdhcmxhcy1jYWxlbmRhci10aW1lbGluZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9jYWxlbmRhci10aW1lbGluZS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2NhbGVuZGFyLXRpbWVsaW5lLmNvbXBvbmVudC5zY3NzJ11cbn0pXG4vKipcbiAqIHRvZG8gOiBkb2N1bWVudGF0aW9uIG9mIHRoZSBjb21wb25lbnRcbiAqL1xuZXhwb3J0IGNsYXNzIENhbGVuZGFyVGltZWxpbmVDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG5cbiAgQElucHV0KCkgcHVibGljIGlkOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHB1YmxpYyBncmFudWxhcml0eTogR3JhbnVsYXJpdHk7XG4gIEBJbnB1dCgpIHB1YmxpYyBjbGltYXRvbG9naWNhbDogYm9vbGVhbjtcbiAgQElucHV0KCkgcHVibGljIGJvdW5kRGF0ZXM6IERhdGVbXSA9IFtdO1xuICBASW5wdXQoKSBwdWJsaWMgZGF0YTogVGltZWxpbmVEYXRhW10gPSBbXTtcbiAgQElucHV0KCkgcHVibGljIGN1cnNvclBvc2l0aW9uOiBEYXRlO1xuICBASW5wdXQoKSBwdWJsaWMgaGlkZUxlZnRCdXR0b246IGJvb2xlYW47XG4gIEBJbnB1dCgpIHB1YmxpYyBoaWRlUmlnaHRCdXR0b246IGJvb2xlYW47XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBzZWxlY3RlZERhdGE6IFN1YmplY3Q8VGltZWxpbmVEYXRhPiA9IG5ldyBTdWJqZWN0KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgaG92ZXJlZERhdGE6IFN1YmplY3Q8VGltZWxpbmVUb29sdGlwPiA9IG5ldyBTdWJqZWN0KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgdHJhbnNsYXRlOiBTdWJqZWN0PFRyYW5zbGF0aW9uRGlyZWN0aW9uPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgcHVibGljIHdpZHRoOiBudW1iZXI7XG4gIHB1YmxpYyBoZWlnaHQ6IG51bWJlcjtcblxuICBwcml2YXRlIHRpbWVsaW5lOiBUaW1lbGluZTtcblxuICBwcml2YXRlIF9vbkRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBAVmlld0NoaWxkKCd0aW1lbGluZV9jb250YWluZXInLCB7IHN0YXRpYzogZmFsc2UgfSkgcHJpdmF0ZSB0aW1lbGluZUNvbnRhaW5lcjogRWxlbWVudFJlZjtcblxuICBwdWJsaWMgY29uc3RydWN0b3IoKSB7XG4gICAgZnJvbUV2ZW50KHdpbmRvdywgJ3Jlc2l6ZScpXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUoNTAwKSwgdGFrZVVudGlsKHRoaXMuX29uRGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSgoZXZlbnQ6IEV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gdGhpcy50aW1lbGluZUNvbnRhaW5lci5uYXRpdmVFbGVtZW50O1xuICAgICAgICBjb25zdCBtYXJnaW5zID0gKG5ldyBNYXJnaW5zKCkpLnNldEJvdHRvbSg1KS5zZXRUb3AoNSkuc2V0UmlnaHQoNSkuc2V0TGVmdCg1KTtcbiAgICAgICAgdGhpcy53aWR0aCA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7XG4gICAgICAgIHRoaXMuaGVpZ2h0ID0gOTA7XG4gICAgICAgIGNvbnN0IGRpbWVuc2lvbnMgPSAobmV3IERpbWVuc2lvbnModGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpKS5zZXRNYXJnaW5zKG1hcmdpbnMpO1xuICAgICAgICBpZiAodGhpcy50aW1lbGluZSkge1xuICAgICAgICAgIHRoaXMudGltZWxpbmUuc2V0RGltZW5zaW9ucyhkaW1lbnNpb25zKTtcbiAgICAgICAgICB0aGlzLnRpbWVsaW5lLnBsb3QoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzLmRhdGEgJiYgdGhpcy50aW1lbGluZSkge1xuICAgICAgdGhpcy50aW1lbGluZS5zZXREYXRhKHRoaXMuZGF0YSk7XG4gICAgICBpZiAodGhpcy50aW1lbGluZS5ib3VuZERhdGVzICYmIHRoaXMudGltZWxpbmUuYm91bmREYXRlcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgdGhpcy50aW1lbGluZS5wbG90KHRydWUpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoY2hhbmdlcy5ib3VuZERhdGVzICYmIHRoaXMudGltZWxpbmUpIHtcbiAgICAgIHRoaXMudGltZWxpbmUuc2V0Qm91bmREYXRlcyh0aGlzLmJvdW5kRGF0ZXMpO1xuICAgICAgdGhpcy50aW1lbGluZS5wbG90KCk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmdyYW51bGFyaXR5ICYmIHRoaXMudGltZWxpbmUpIHtcbiAgICAgIHRoaXMudGltZWxpbmUuc2V0R3JhbnVsYXJpdHkodGhpcy5ncmFudWxhcml0eSk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmNsaW1hdG9sb2dpY2FsICYmIHRoaXMudGltZWxpbmUpIHtcbiAgICAgIHRoaXMudGltZWxpbmUuc2V0Q2xpbWF0b2xvZ2ljYWwodGhpcy5jbGltYXRvbG9naWNhbCk7XG4gICAgfVxuICAgIGlmIChjaGFuZ2VzLmN1cnNvclBvc2l0aW9uICYmIHRoaXMudGltZWxpbmUpIHtcbiAgICAgIHRoaXMudGltZWxpbmUubW92ZUN1cnNvcih0aGlzLmN1cnNvclBvc2l0aW9uKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxFbGVtZW50ID0gdGhpcy50aW1lbGluZUNvbnRhaW5lci5uYXRpdmVFbGVtZW50O1xuICAgIGNvbnN0IHN2ZyA9IGVsZW1lbnQucXVlcnlTZWxlY3Rvcignc3ZnJyk7XG4gICAgY29uc3QgbWFyZ2lucyA9IChuZXcgTWFyZ2lucygpKS5zZXRCb3R0b20oNSkuc2V0VG9wKDUpLnNldFJpZ2h0KDUpLnNldExlZnQoNSk7XG4gICAgdGhpcy53aWR0aCA9IGVsZW1lbnQub2Zmc2V0V2lkdGg7XG4gICAgdGhpcy5oZWlnaHQgPSA5MDtcbiAgICBjb25zdCBkaW1lbnNpb25zID0gKG5ldyBEaW1lbnNpb25zKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KSkuc2V0TWFyZ2lucyhtYXJnaW5zKTtcbiAgICB0aGlzLnRpbWVsaW5lID0gKG5ldyBUaW1lbGluZShzdmcpKTtcbiAgICB0aGlzLnRpbWVsaW5lLnNldERpbWVuc2lvbnMoZGltZW5zaW9ucyk7XG4gICAgdGhpcy50aW1lbGluZS5zZXRCb3VuZERhdGVzKHRoaXMuYm91bmREYXRlcyk7XG5cbiAgICB0aGlzLnRpbWVsaW5lLmhvdmVyZWREYXRhXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5fb25EZXN0cm95JCkpXG4gICAgICAuc3Vic2NyaWJlKHIgPT4ge1xuICAgICAgICB0aGlzLmhvdmVyZWREYXRhLm5leHQocik7XG4gICAgICB9KTtcbiAgICB0aGlzLnRpbWVsaW5lLnNlbGVjdGVkRGF0YVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuX29uRGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZShyID0+IHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZERhdGEubmV4dChyKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX29uRGVzdHJveSQubmV4dCh0cnVlKTtcbiAgICB0aGlzLl9vbkRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgcGxvdCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50aW1lbGluZSkge1xuICAgICAgdGhpcy50aW1lbGluZS5wbG90KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHRyYW5zbGF0ZUZ1dHVyZSgpOiB2b2lkIHtcbiAgICB0aGlzLnRyYW5zbGF0ZS5uZXh0KFRyYW5zbGF0aW9uRGlyZWN0aW9uLmZ1dHVyZSk7XG4gIH1cblxuICBwdWJsaWMgdHJhbnNsYXRlUGFzdCgpOiB2b2lkIHtcbiAgICB0aGlzLnRyYW5zbGF0ZS5uZXh0KFRyYW5zbGF0aW9uRGlyZWN0aW9uLnBhc3QpO1xuICB9XG59XG4iLCI8ZGl2IGlkPVwie3tpZH19XCIgI2NhbGVuZGFyX3RpbWVsaW5lIGNsYXNzPVwiY2FsZW5kYXItdGltZWxpbmVcIj5cbiAgICA8ZGl2IGNsYXNzPVwiY29udGFpbmVyXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJtb3ZlX2J1dHRvbiBwYXN0XCIgW2NsYXNzLmhpZGVfbGVmdF9idXR0b25dPVwiaGlkZUxlZnRCdXR0b25cIiAoY2xpY2spPVwidHJhbnNsYXRlUGFzdCgpXCIgKm5nSWY9XCIhY2xpbWF0b2xvZ2ljYWxcIj5cbiAgICAgICAgICAgIDxtYXQtaWNvbiBjbGFzcz1cImNoZXZyb25cIj5jaGV2cm9uX2xlZnQ8L21hdC1pY29uPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPGRpdiBjbGFzcz1cInN2Z19jb250YWluZXJcIiBcbiAgICAgICAgICAgIFtjbGFzcy5zdmdfY29udGFpbmVyX2J1dHRvbnNfaGlkZGVuXT1cImhpZGVMZWZ0QnV0dG9uICYmIGhpZGVSaWdodEJ1dHRvblwiXG4gICAgICAgICAgICBbY2xhc3Muc3ZnX2NvbnRhaW5lcl9vbmVfYnV0dG9uX2hpZGRlbl09XCIoaGlkZUxlZnRCdXR0b24gJiYgIWhpZGVSaWdodEJ1dHRvbikgfHwgKCFoaWRlTGVmdEJ1dHRvbiAmJiBoaWRlUmlnaHRCdXR0b24pXCJcblxuICAgICAgICAgICAgICN0aW1lbGluZV9jb250YWluZXI+XG4gICAgICAgICAgICA8c3ZnIGlkPVwiY2FsZW5kYXItc3ZnXCIgW3N0eWxlLndpZHRoLnB4XT1cIndpZHRoXCIgW3N0eWxlLmhlaWdodC5weF09XCJoZWlnaHRcIiA+PC9zdmc+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzPVwibW92ZV9idXR0b24gZnV0dXJlXCIgW2NsYXNzLmhpZGVfcmlnaHRfYnV0dG9uXT1cImhpZGVSaWdodEJ1dHRvblwiIChjbGljayk9XCJ0cmFuc2xhdGVGdXR1cmUoKVwiICpuZ0lmPVwiIWNsaW1hdG9sb2dpY2FsXCI+XG4gICAgICAgICAgICA8bWF0LWljb24gY2xhc3M9XCJjaGV2cm9uXCI+Y2hldnJvbl9yaWdodDwvbWF0LWljb24+XG4gICAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuXG48L2Rpdj4iXX0=