/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Component, Input, Output } from '@angular/core';
import { Item } from '../model/item';
import { ActionHandler } from '../utils/results.utils';
import { filter, Subject, take, takeUntil } from 'rxjs';
import { ResultlistNotifierService } from '../../../services/resultlist.notifier.service';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/resultlist.notifier.service";
import * as i2 from "@angular/common";
import * as i3 from "@angular/material/icon";
import * as i4 from "@angular/material/button";
import * as i5 from "@angular/material/tooltip";
import * as i6 from "@ngx-translate/core";
import * as i7 from "./result-actions.pipe";
/**
 * This component displays actions of an item.
 * - Actions are only displayed when we hover an item.
 * BUT
 * An action can be reversible. It means that this action has a reverse action.
 * - An example of reversible action:  Action => Add layer to map --///--  Reverse Action => Remove layer from map.
 * - When you click on a reversible action for the first time, the action become 'activated'.
 * - Activated actions should be displayed all the time on the resultlist (in list and grid view).
 * - When you click on an 'activated' action, the action is reversed and goes back to its initial state.
 * - Actions that are not activated are only displayed when we hover an item.
 * ALSO
 * When a reversible action has `fields` attribute. It means that this action needs the existence of the fields values in order to be executed.
 * - If one of the fields values is absent in the current item, the action will be hidden.
 */
export class ResultActionsComponent {
    constructor(notifier) {
        this.notifier = notifier;
        /** Map <itemId, Set<actionIds>> : for each item, gives the list of activated actions. */
        this.activatedActionsPerItem = new Map();
        /** This data retriever allows to fetch the actions of each items + check if an action should be hidden. */
        this.detailedDataRetriever = null;
        /** Whether to stop propagation at click/hover of the action. */
        this.stopPropagation = false;
        /** Whether to display the actions as icon buttons or text buttons. */
        this.mode = 'icon';
        /** Emits an event when the action is clicked on it. */
        this.actionOnItemEvent = new Subject();
        /** Destroy subscriptions. */
        this._onDestroy$ = new Subject();
        /** When an Item is hovered: */
        this.notifier.itemHovered$.pipe(takeUntil(this._onDestroy$)).pipe(filter((i) => i.identifier === this.item.identifier)).subscribe({
            next: (i) => {
                /** Always show non reversible actions. */
                this.actions.filter(a => !ActionHandler.isReversible(a)).forEach(a => a.show = true);
                /** We check if reversible actions has 'fields'.
                 * - If one of the fields values is absent in the current item, the action will be hidden. */
                this.actions.filter(a => ActionHandler.isReversible(a) && a.fields && a.show === undefined).forEach(a => {
                    this.detailedDataRetriever.getValues(i.identifier, a.fields).pipe(take(1)).subscribe({
                        next: (values) => a.show = values.filter(v => !v).length === 0
                    });
                });
            }
        });
    }
    ngOnInit() {
        this.setItemActions(this.item);
    }
    ngOnChanges(changes) {
        if (changes.activatedActionsPerItem) {
            this.updateActions();
        }
    }
    /**
     * An action can be reversible. It means that this action has a reverse action.
     * - When you click on a reversible action for the first time, the action become 'activated'.
     * - Activated actions should be displayed all the time on the resultlist (in list and grid view).
     * - When you click on an 'activated' action, the action is reversed and goes back to its initial state.
     */
    triggerAction(event, action) {
        if (this.stopPropagation) {
            event.stopPropagation();
        }
        this.actionOnItemEvent.next(action);
        /** activate */
        if (ActionHandler.isReversible(action) && !action.activated) {
            ActionHandler.activate(action);
        }
        else if (ActionHandler.isReversible(action) && action.activated) {
            ActionHandler.reverse(action);
        }
        /** Retrigger the pipe ActionDisplayerPipe */
        this.actions = [...this.actions];
    }
    /**
     * An action can be reversible. It means that this action has a reverse action.
     * - When you click on a reversible action for the first time, the action become 'activated'.
     * - Activated actions should be displayed all the time on the resultlist (in list and grid view).
     * - When you click on an 'activated' action, the action is reversed and goes back to its initial state.
     */
    updateActions() {
        if (this.activatedActionsPerItem) {
            const actionIds = this.activatedActionsPerItem.get(this.item.identifier);
            if (!!actionIds && !!this.actions) {
                this.actions.filter(a => ActionHandler.isReversible(a)).forEach(a => {
                    if (actionIds.has(a.id)) {
                        ActionHandler.activate(a);
                        /** Always show activated actions. */
                        a.show = true;
                    }
                    else {
                        ActionHandler.reverse(a);
                    }
                });
                /** Retrigger ActionDisplayerPipe */
                this.actions = [...this.actions];
            }
        }
    }
    /**
     * @description set the list of actions of an item
     * @param item
     */
    setItemActions(item) {
        if (item && (!item.actions || (item.actions && item.actions.length === 0))) {
            item.actions = new Array();
            this.detailedDataRetriever.getActions(item).pipe(take(1)).subscribe(actions => {
                actions.forEach(action => {
                    item.actions.push({
                        id: action.id,
                        label: action.label,
                        actionBus: action.actionBus,
                        cssClass: action.cssClass,
                        tooltip: action.tooltip,
                        reverseAction: action.reverseAction,
                        icon: action.icon,
                        fields: action.fields,
                        show: action.show
                    });
                });
                this.actions = item.actions;
                this.updateActions();
            });
        }
        else if (item && item.actions && item.actions.length > 0) {
            this.actions = item.actions;
            this.updateActions();
        }
    }
    ngOnDestroy() {
        this._onDestroy$.next(true);
        this._onDestroy$.complete();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: ResultActionsComponent, deps: [{ token: i1.ResultlistNotifierService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.2.13", type: ResultActionsComponent, selector: "arlas-result-actions", inputs: { item: "item", width: "width", activatedActionsPerItem: "activatedActionsPerItem", detailedDataRetriever: "detailedDataRetriever", stopPropagation: "stopPropagation", mode: "mode" }, outputs: { actionOnItemEvent: "actionOnItemEvent" }, usesOnChanges: true, ngImport: i0, template: "<!-- This sections is for actions that we display as icon buttons -->\n<div [style.max-width.px]=\"width\" class=\"list_actions\" *ngIf=\"mode === 'icon'; else textActions\">\n    <ng-container *ngFor=\"let action of actions\">\n        <ng-container *ngIf=\"action?.show === true\">\n            <!-- The action is activated, which means it will always be displayed.-->\n            <ng-container *ngIf=\"action?.activated\">\n                <!-- The button icon is provided by css 'background-url' attribute.-->\n                <button *ngIf=\"!action?.icon else active_icon\" (click)=\"triggerAction($event, action)\"\n                    matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\"\n                    class=\"resultitem-list__actions {{action.id}}-onhover-action {{action.cssClass}}-onhover-action\">\n                    {{action | actionDisplayer:'label' | translate}}\n                </button>\n                <ng-template #active_icon>\n                    <!-- The icon is provided by the action itself.-->\n                    <mat-icon (click)=\"triggerAction($event, action)\" class=\"icon\"\n                        matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                        {{action | actionDisplayer:'icon'}}\n                    </mat-icon>\n                </ng-template>\n            </ng-container>\n        </ng-container>\n    </ng-container>\n    <ng-container *ngFor=\"let action of actions\">\n        <ng-container *ngIf=\"action?.show === true\">\n            <!-- The action is not activated, which means it will appear only when an item is hovered.-->\n            <ng-container *ngIf=\"!action?.activated\">\n                <button *ngIf=\"!action?.icon else not_active_icon\" (click)=\"triggerAction($event, action)\"\n                    class=\"not_activated\" matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\"\n                    class=\"resultitem-list__actions {{action.id}}-onhover-action {{action.cssClass}}-onhover-action\">\n                    {{action | actionDisplayer:'label' | translate}}\n                </button>\n                <ng-template #not_active_icon>\n                    <mat-icon (click)=\"triggerAction($event, action)\" class=\"icon not_activated\"\n                        matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                        {{action | actionDisplayer:'icon'}}\n                    </mat-icon>\n                </ng-template>\n            </ng-container>\n        </ng-container>\n    </ng-container>\n\n</div>\n<!-- This sections is for actions that we display as text buttons instead of icon buttons-->\n<ng-template #textActions>\n    <ng-container *ngFor=\"let action of actions\">\n        <ng-container *ngIf=\"action?.show === true\">\n            <button mat-raised-button *ngIf=\"!action?.activated else activeButton\" class=\"text-action {{action.id}}-action {{action.cssClass}}-action\"\n                (click)=\"triggerAction($event, action)\" matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                {{action | actionDisplayer:'label' | translate}}\n            </button>\n            <ng-template #activeButton>\n                <button mat-raised-button *ngIf=\"action?.activated\" (click)=\"triggerAction($event, action)\"\n                    class=\"resultdetaileditem__actions text-action {{action.id}}-action {{action.cssClass}}-action\" matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                    {{action | actionDisplayer:'label' | translate}}\n                </button>\n            </ng-template>\n        </ng-container>\n    </ng-container>\n</ng-template>\n", styles: ["@charset \"UTF-8\";.resultitem-list__actions{min-width:0;border-radius:50%;border:none;padding:0;width:24px;height:24px;font-size:0;color:#fff;margin-left:5px;background-color:#fff;background-image:url(\"data:image/svg+xml,%3Csvg%20width%3D%2720%27%20height%3D%2720%27%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%3E%20%3Cg%3E%20%20%3Ctitle%3Ebackground%3C%2Ftitle%3E%20%20%3Crect%20fill%3D%27%23fff%27%20id%3D%27canvas_background%27%20height%3D%2722%27%20width%3D%2722%27%20y%3D%27-1%27%20x%3D%27-1%27%2F%3E%20%20%3Cg%20display%3D%27none%27%20overflow%3D%27visible%27%20y%3D%270%27%20x%3D%270%27%20height%3D%27100%25%27%20width%3D%27100%25%27%20id%3D%27canvasGrid%27%3E%20%20%20%3Crect%20fill%3D%27url(%23gridpattern)%27%20stroke-width%3D%270%27%20y%3D%270%27%20x%3D%270%27%20height%3D%27100%25%27%20width%3D%27100%25%27%2F%3E%20%20%3C%2Fg%3E%20%3C%2Fg%3E%20%3Cg%3E%20%20%3Ctitle%3ELayer%201%3C%2Ftitle%3E%20%20%3Cellipse%20stroke%3D%27%23000000%27%20ry%3D%275.779194%27%20rx%3D%275.5%27%20id%3D%27svg_1%27%20cy%3D%2710.000004%27%20cx%3D%2710%27%20stroke-width%3D%272.5%27%20fill%3D%27%23ffffff%27%2F%3E%20%3C%2Fg%3E%3C%2Fsvg%3E\");background-repeat:no-repeat;background-position:center;float:right;cursor:pointer}.resultitem-list__actions:active{border:1px solid white}.list_actions{display:flex;flex-direction:row-reverse;align-items:center;position:absolute;right:0;top:0;height:100%;width:max-content}.list_actions .not_activated{display:none}.list_actions .icon{margin-left:5px;float:right;width:24px;height:24px;font-size:20px;text-align:center;align-content:space-evenly;background-color:#fff;border-radius:50%;cursor:pointer}.list_active_actions{display:flex;flex-direction:row-reverse;align-items:center;position:absolute;right:35px;top:0;height:100%;width:max-content}.text-action{font-family:Roboto,Helvetica Neue,sans-serif;font-size:11px;margin:3px;padding:5px 10px;height:25px;line-height:0;cursor:pointer;color:#000;background-color:#fff;border:1.5px solid black;border-radius:2px}\n"], dependencies: [{ kind: "directive", type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i3.MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }, { kind: "component", type: i4.MatButton, selector: "    button[mat-button], button[mat-raised-button], button[mat-flat-button],    button[mat-stroked-button]  ", exportAs: ["matButton"] }, { kind: "directive", type: i5.MatTooltip, selector: "[matTooltip]", inputs: ["matTooltipPosition", "matTooltipPositionAtOrigin", "matTooltipDisabled", "matTooltipShowDelay", "matTooltipHideDelay", "matTooltipTouchGestures", "matTooltip", "matTooltipClass"], exportAs: ["matTooltip"] }, { kind: "pipe", type: i6.TranslatePipe, name: "translate" }, { kind: "pipe", type: i7.ActionDisplayerPipe, name: "actionDisplayer" }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: ResultActionsComponent, decorators: [{
            type: Component,
            args: [{ selector: 'arlas-result-actions', template: "<!-- This sections is for actions that we display as icon buttons -->\n<div [style.max-width.px]=\"width\" class=\"list_actions\" *ngIf=\"mode === 'icon'; else textActions\">\n    <ng-container *ngFor=\"let action of actions\">\n        <ng-container *ngIf=\"action?.show === true\">\n            <!-- The action is activated, which means it will always be displayed.-->\n            <ng-container *ngIf=\"action?.activated\">\n                <!-- The button icon is provided by css 'background-url' attribute.-->\n                <button *ngIf=\"!action?.icon else active_icon\" (click)=\"triggerAction($event, action)\"\n                    matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\"\n                    class=\"resultitem-list__actions {{action.id}}-onhover-action {{action.cssClass}}-onhover-action\">\n                    {{action | actionDisplayer:'label' | translate}}\n                </button>\n                <ng-template #active_icon>\n                    <!-- The icon is provided by the action itself.-->\n                    <mat-icon (click)=\"triggerAction($event, action)\" class=\"icon\"\n                        matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                        {{action | actionDisplayer:'icon'}}\n                    </mat-icon>\n                </ng-template>\n            </ng-container>\n        </ng-container>\n    </ng-container>\n    <ng-container *ngFor=\"let action of actions\">\n        <ng-container *ngIf=\"action?.show === true\">\n            <!-- The action is not activated, which means it will appear only when an item is hovered.-->\n            <ng-container *ngIf=\"!action?.activated\">\n                <button *ngIf=\"!action?.icon else not_active_icon\" (click)=\"triggerAction($event, action)\"\n                    class=\"not_activated\" matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\"\n                    class=\"resultitem-list__actions {{action.id}}-onhover-action {{action.cssClass}}-onhover-action\">\n                    {{action | actionDisplayer:'label' | translate}}\n                </button>\n                <ng-template #not_active_icon>\n                    <mat-icon (click)=\"triggerAction($event, action)\" class=\"icon not_activated\"\n                        matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                        {{action | actionDisplayer:'icon'}}\n                    </mat-icon>\n                </ng-template>\n            </ng-container>\n        </ng-container>\n    </ng-container>\n\n</div>\n<!-- This sections is for actions that we display as text buttons instead of icon buttons-->\n<ng-template #textActions>\n    <ng-container *ngFor=\"let action of actions\">\n        <ng-container *ngIf=\"action?.show === true\">\n            <button mat-raised-button *ngIf=\"!action?.activated else activeButton\" class=\"text-action {{action.id}}-action {{action.cssClass}}-action\"\n                (click)=\"triggerAction($event, action)\" matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                {{action | actionDisplayer:'label' | translate}}\n            </button>\n            <ng-template #activeButton>\n                <button mat-raised-button *ngIf=\"action?.activated\" (click)=\"triggerAction($event, action)\"\n                    class=\"resultdetaileditem__actions text-action {{action.id}}-action {{action.cssClass}}-action\" matTooltip=\"{{action | actionDisplayer:'tooltip' |translate}}\">\n                    {{action | actionDisplayer:'label' | translate}}\n                </button>\n            </ng-template>\n        </ng-container>\n    </ng-container>\n</ng-template>\n", styles: ["@charset \"UTF-8\";.resultitem-list__actions{min-width:0;border-radius:50%;border:none;padding:0;width:24px;height:24px;font-size:0;color:#fff;margin-left:5px;background-color:#fff;background-image:url(\"data:image/svg+xml,%3Csvg%20width%3D%2720%27%20height%3D%2720%27%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%3E%20%3Cg%3E%20%20%3Ctitle%3Ebackground%3C%2Ftitle%3E%20%20%3Crect%20fill%3D%27%23fff%27%20id%3D%27canvas_background%27%20height%3D%2722%27%20width%3D%2722%27%20y%3D%27-1%27%20x%3D%27-1%27%2F%3E%20%20%3Cg%20display%3D%27none%27%20overflow%3D%27visible%27%20y%3D%270%27%20x%3D%270%27%20height%3D%27100%25%27%20width%3D%27100%25%27%20id%3D%27canvasGrid%27%3E%20%20%20%3Crect%20fill%3D%27url(%23gridpattern)%27%20stroke-width%3D%270%27%20y%3D%270%27%20x%3D%270%27%20height%3D%27100%25%27%20width%3D%27100%25%27%2F%3E%20%20%3C%2Fg%3E%20%3C%2Fg%3E%20%3Cg%3E%20%20%3Ctitle%3ELayer%201%3C%2Ftitle%3E%20%20%3Cellipse%20stroke%3D%27%23000000%27%20ry%3D%275.779194%27%20rx%3D%275.5%27%20id%3D%27svg_1%27%20cy%3D%2710.000004%27%20cx%3D%2710%27%20stroke-width%3D%272.5%27%20fill%3D%27%23ffffff%27%2F%3E%20%3C%2Fg%3E%3C%2Fsvg%3E\");background-repeat:no-repeat;background-position:center;float:right;cursor:pointer}.resultitem-list__actions:active{border:1px solid white}.list_actions{display:flex;flex-direction:row-reverse;align-items:center;position:absolute;right:0;top:0;height:100%;width:max-content}.list_actions .not_activated{display:none}.list_actions .icon{margin-left:5px;float:right;width:24px;height:24px;font-size:20px;text-align:center;align-content:space-evenly;background-color:#fff;border-radius:50%;cursor:pointer}.list_active_actions{display:flex;flex-direction:row-reverse;align-items:center;position:absolute;right:35px;top:0;height:100%;width:max-content}.text-action{font-family:Roboto,Helvetica Neue,sans-serif;font-size:11px;margin:3px;padding:5px 10px;height:25px;line-height:0;cursor:pointer;color:#000;background-color:#fff;border:1.5px solid black;border-radius:2px}\n"] }]
        }], ctorParameters: () => [{ type: i1.ResultlistNotifierService }], propDecorators: { item: [{
                type: Input
            }], width: [{
                type: Input
            }], activatedActionsPerItem: [{
                type: Input
            }], detailedDataRetriever: [{
                type: Input
            }], stopPropagation: [{
                type: Input
            }], mode: [{
                type: Input
            }], actionOnItemEvent: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdWx0LWFjdGlvbnMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtY29tcG9uZW50cy9zcmMvbGliL2NvbXBvbmVudHMvcmVzdWx0cy9yZXN1bHQtYWN0aW9ucy9yZXN1bHQtYWN0aW9ucy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hcmxhcy1jb21wb25lbnRzL3NyYy9saWIvY29tcG9uZW50cy9yZXN1bHRzL3Jlc3VsdC1hY3Rpb25zL3Jlc3VsdC1hY3Rpb25zLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFnQyxNQUFNLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3RHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckMsT0FBTyxFQUFVLGFBQWEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFeEQsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sK0NBQStDLENBQUM7Ozs7Ozs7OztBQUcxRjs7Ozs7Ozs7Ozs7OztHQWFHO0FBTUgsTUFBTSxPQUFPLHNCQUFzQjtJQXNCakMsWUFBMkIsUUFBbUM7UUFBbkMsYUFBUSxHQUFSLFFBQVEsQ0FBMkI7UUFqQjlELHlGQUF5RjtRQUN6RSw0QkFBdUIsR0FBNkIsSUFBSSxHQUFHLEVBQXVCLENBQUM7UUFDbkcsMkdBQTJHO1FBQzNGLDBCQUFxQixHQUEwQixJQUFJLENBQUM7UUFDcEUsZ0VBQWdFO1FBQ2hELG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBQ3hDLHNFQUFzRTtRQUN0RCxTQUFJLEdBQW9CLE1BQU0s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OytHQWhJVSxzQkFBc0I7bUdBQXRCLHNCQUFzQixzVUM5Q25DLHNvSEEyREE7OzRGRGJhLHNCQUFzQjtrQkFMbEMsU0FBUzsrQkFDRSxzQkFBc0I7OEZBTWhCLElBQUk7c0JBQW5CLEtBQUs7Z0JBRVUsS0FBSztzQkFBcEIsS0FBSztnQkFFVSx1QkFBdUI7c0JBQXRDLEtBQUs7Z0JBRVUscUJBQXFCO3NCQUFwQyxLQUFLO2dCQUVVLGVBQWU7c0JBQTlCLEtBQUs7Z0JBRVUsSUFBSTtzQkFBbkIsS0FBSztnQkFHVyxpQkFBaUI7c0JBQWpDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJdGVtIH0gZnJvbSAnLi4vbW9kZWwvaXRlbSc7XG5pbXBvcnQgeyBBY3Rpb24sIEFjdGlvbkhhbmRsZXIgfSBmcm9tICcuLi91dGlscy9yZXN1bHRzLnV0aWxzJztcbmltcG9ydCB7IGZpbHRlciwgU3ViamVjdCwgdGFrZSwgdGFrZVVudGlsIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBEZXRhaWxlZERhdGFSZXRyaWV2ZXIgfSBmcm9tICcuLi91dGlscy9kZXRhaWxlZC1kYXRhLXJldHJpZXZlcic7XG5pbXBvcnQgeyBSZXN1bHRsaXN0Tm90aWZpZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvcmVzdWx0bGlzdC5ub3RpZmllci5zZXJ2aWNlJztcblxuXG4vKipcbiAqIFRoaXMgY29tcG9uZW50IGRpc3BsYXlzIGFjdGlvbnMgb2YgYW4gaXRlbS5cbiAqIC0gQWN0aW9ucyBhcmUgb25seSBkaXNwbGF5ZWQgd2hlbiB3ZSBob3ZlciBhbiBpdGVtLlxuICogQlVUXG4gKiBBbiBhY3Rpb24gY2FuIGJlIHJldmVyc2libGUuIEl0IG1lYW5zIHRoYXQgdGhpcyBhY3Rpb24gaGFzIGEgcmV2ZXJzZSBhY3Rpb24uXG4gKiAtIEFuIGV4YW1wbGUgb2YgcmV2ZXJzaWJsZSBhY3Rpb246ICBBY3Rpb24gPT4gQWRkIGxheWVyIHRvIG1hcCAtLS8vLy0tICBSZXZlcnNlIEFjdGlvbiA9PiBSZW1vdmUgbGF5ZXIgZnJvbSBtYXAuXG4gKiAtIFdoZW4geW91IGNsaWNrIG9uIGEgcmV2ZXJzaWJsZSBhY3Rpb24gZm9yIHRoZSBmaXJzdCB0aW1lLCB0aGUgYWN0aW9uIGJlY29tZSAnYWN0aXZhdGVkJy5cbiAqIC0gQWN0aXZhdGVkIGFjdGlvbnMgc2hvdWxkIGJlIGRpc3BsYXllZCBhbGwgdGhlIHRpbWUgb24gdGhlIHJlc3VsdGxpc3QgKGluIGxpc3QgYW5kIGdyaWQgdmlldykuXG4gKiAtIFdoZW4geW91IGNsaWNrIG9uIGFuICdhY3RpdmF0ZWQnIGFjdGlvbiwgdGhlIGFjdGlvbiBpcyByZXZlcnNlZCBhbmQgZ29lcyBiYWNrIHRvIGl0cyBpbml0aWFsIHN0YXRlLlxuICogLSBBY3Rpb25zIHRoYXQgYXJlIG5vdCBhY3RpdmF0ZWQgYXJlIG9ubHkgZGlzcGxheWVkIHdoZW4gd2UgaG92ZXIgYW4gaXRlbS5cbiAqIEFMU09cbiAqIFdoZW4gYSByZXZlcnNpYmxlIGFjdGlvbiBoYXMgYGZpZWxkc2AgYXR0cmlidXRlLiBJdCBtZWFucyB0aGF0IHRoaXMgYWN0aW9uIG5lZWRzIHRoZSBleGlzdGVuY2Ugb2YgdGhlIGZpZWxkcyB2YWx1ZXMgaW4gb3JkZXIgdG8gYmUgZXhlY3V0ZWQuXG4gKiAtIElmIG9uZSBvZiB0aGUgZmllbGRzIHZhbHVlcyBpcyBhYnNlbnQgaW4gdGhlIGN1cnJlbnQgaXRlbSwgdGhlIGFjdGlvbiB3aWxsIGJlIGhpZGRlbi5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYXJsYXMtcmVzdWx0LWFjdGlvbnMnLFxuICB0ZW1wbGF0ZVVybDogJy4vcmVzdWx0LWFjdGlvbnMuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9yZXN1bHQtYWN0aW9ucy5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIFJlc3VsdEFjdGlvbnNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgLyoqIFRoZSBpdGVtIHdoaWNoIGFjdGlvbnMgYXJlIG1hbmFnZWQgYnkgdGhpcyBjb21wb25lbnQuICovXG4gIEBJbnB1dCgpIHB1YmxpYyBpdGVtOiBJdGVtO1xuICAvKiogV2lkdGggb2YgdGhlIGNvbXBvbmVudC4gKi9cbiAgQElucHV0KCkgcHVibGljIHdpZHRoOiBudW1iZXI7XG4gIC8qKiBNYXAgPGl0ZW1JZCwgU2V0PGFjdGlvbklkcz4+IDogZm9yIGVhY2ggaXRlbSwgZ2l2ZXMgdGhlIGxpc3Qgb2YgYWN0aXZhdGVkIGFjdGlvbnMuICovXG4gIEBJbnB1dCgpIHB1YmxpYyBhY3RpdmF0ZWRBY3Rpb25zUGVySXRlbTogTWFwPHN0cmluZywgU2V0PHN0cmluZz4+ID0gbmV3IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PigpO1xuICAvKiogVGhpcyBkYXRhIHJldHJpZXZlciBhbGxvd3MgdG8gZmV0Y2ggdGhlIGFjdGlvbnMgb2YgZWFjaCBpdGVtcyArIGNoZWNrIGlmIGFuIGFjdGlvbiBzaG91bGQgYmUgaGlkZGVuLiAqL1xuICBASW5wdXQoKSBwdWJsaWMgZGV0YWlsZWREYXRhUmV0cmlldmVyOiBEZXRhaWxlZERhdGFSZXRyaWV2ZXIgPSBudWxsO1xuICAvKiogV2hldGhlciB0byBzdG9wIHByb3BhZ2F0aW9uIGF0IGNsaWNrL2hvdmVyIG9mIHRoZSBhY3Rpb24uICovXG4gIEBJbnB1dCgpIHB1YmxpYyBzdG9wUHJvcGFnYXRpb24gPSBmYWxzZTtcbiAgLyoqIFdoZXRoZXIgdG8gZGlzcGxheSB0aGUgYWN0aW9ucyBhcyBpY29uIGJ1dHRvbnMgb3IgdGV4dCBidXR0b25zLiAqL1xuICBASW5wdXQoKSBwdWJsaWMgbW9kZTogJ2ljb24nIHwgJ3RleHQnID0gJ2ljb24nO1xuXG4gIC8qKiBFbWl0cyBhbiBldmVudCB3aGVuIHRoZSBhY3Rpb24gaXMgY2xpY2tlZCBvbiBpdC4gKi9cbiAgQE91dHB1dCgpIHB1YmxpYyBhY3Rpb25Pbkl0ZW1FdmVudDogU3ViamVjdDxBY3Rpb24+ID0gbmV3IFN1YmplY3Q8QWN0aW9uPigpO1xuXG4gIC8qKiBEZXN0cm95IHN1YnNjcmlwdGlvbnMuICovXG4gIHByaXZhdGUgX29uRGVzdHJveSQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gIHB1YmxpYyBhY3Rpb25zOiBBY3Rpb25bXTtcblxuICBwdWJsaWMgY29uc3RydWN0b3IocHJpdmF0ZSBub3RpZmllcjogUmVzdWx0bGlzdE5vdGlmaWVyU2VydmljZSkge1xuICAgIC8qKiBXaGVuIGFuIEl0ZW0gaXMgaG92ZXJlZDogKi9cbiAgICB0aGlzLm5vdGlmaWVyLml0ZW1Ib3ZlcmVkJC5waXBlKHRha2VVbnRpbCh0aGlzLl9vbkRlc3Ryb3kkKSkucGlwZShmaWx0ZXIoKGk6IEl0ZW0pID0+IGkuaWRlbnRpZmllciA9PT0gdGhpcy5pdGVtLmlkZW50aWZpZXIpKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKGk6IEl0ZW0pID0+IHtcbiAgICAgICAgLyoqIEFsd2F5cyBzaG93IG5vbiByZXZlcnNpYmxlIGFjdGlvbnMuICovXG4gICAgICAgIHRoaXMuYWN0aW9ucy5maWx0ZXIoYSA9PiAhQWN0aW9uSGFuZGxlci5pc1JldmVyc2libGUoYSkpLmZvckVhY2goYSA9PiBhLnNob3cgPSB0cnVlKTtcbiAgICAgICAgLyoqIFdlIGNoZWNrIGlmIHJldmVyc2libGUgYWN0aW9ucyBoYXMgJ2ZpZWxkcycuXG4gICAgICAgICAqIC0gSWYgb25lIG9mIHRoZSBmaWVsZHMgdmFsdWVzIGlzIGFic2VudCBpbiB0aGUgY3VycmVudCBpdGVtLCB0aGUgYWN0aW9uIHdpbGwgYmUgaGlkZGVuLiAqL1xuICAgICAgICB0aGlzLmFjdGlvbnMuZmlsdGVyKGEgPT4gQWN0aW9uSGFuZGxlci5pc1JldmVyc2libGUoYSkgJiYgYS5maWVsZHMgJiYgYS5zaG93ID09PSB1bmRlZmluZWQpLmZvckVhY2goYSA9PiB7XG4gICAgICAgICAgdGhpcy5kZXRhaWxlZERhdGFSZXRyaWV2ZXIuZ2V0VmFsdWVzKGkuaWRlbnRpZmllciwgYS5maWVsZHMpLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKHtcbiAgICAgICAgICAgIG5leHQ6ICh2YWx1ZXM6IHN0cmluZ1tdKSA9PiBhLnNob3cgPSB2YWx1ZXMuZmlsdGVyKHYgPT4gIXYpLmxlbmd0aCA9PT0gMFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnNldEl0ZW1BY3Rpb25zKHRoaXMuaXRlbSk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmIChjaGFuZ2VzLmFjdGl2YXRlZEFjdGlvbnNQZXJJdGVtKSB7XG4gICAgICB0aGlzLnVwZGF0ZUFjdGlvbnMoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQW4gYWN0aW9uIGNhbiBiZSByZXZlcnNpYmxlLiBJdCBtZWFucyB0aGF0IHRoaXMgYWN0aW9uIGhhcyBhIHJldmVyc2UgYWN0aW9uLlxuICAgKiAtIFdoZW4geW91IGNsaWNrIG9uIGEgcmV2ZXJzaWJsZSBhY3Rpb24gZm9yIHRoZSBmaXJzdCB0aW1lLCB0aGUgYWN0aW9uIGJlY29tZSAnYWN0aXZhdGVkJy5cbiAgICogLSBBY3RpdmF0ZWQgYWN0aW9ucyBzaG91bGQgYmUgZGlzcGxheWVkIGFsbCB0aGUgdGltZSBvbiB0aGUgcmVzdWx0bGlzdCAoaW4gbGlzdCBhbmQgZ3JpZCB2aWV3KS5cbiAgICogLSBXaGVuIHlvdSBjbGljayBvbiBhbiAnYWN0aXZhdGVkJyBhY3Rpb24sIHRoZSBhY3Rpb24gaXMgcmV2ZXJzZWQgYW5kIGdvZXMgYmFjayB0byBpdHMgaW5pdGlhbCBzdGF0ZS5cbiAgICovXG4gIHB1YmxpYyB0cmlnZ2VyQWN0aW9uKGV2ZW50OiBFdmVudCwgYWN0aW9uOiBBY3Rpb24pIHtcbiAgICBpZiAodGhpcy5zdG9wUHJvcGFnYXRpb24pIHtcbiAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIH1cbiAgICB0aGlzLmFjdGlvbk9uSXRlbUV2ZW50Lm5leHQoYWN0aW9uKTtcbiAgICAvKiogYWN0aXZhdGUgKi9cbiAgICBpZiAoQWN0aW9uSGFuZGxlci5pc1JldmVyc2libGUoYWN0aW9uKSAmJiAhYWN0aW9uLmFjdGl2YXRlZCkge1xuICAgICAgQWN0aW9uSGFuZGxlci5hY3RpdmF0ZShhY3Rpb24pO1xuICAgIH0gZWxzZSBpZiAoQWN0aW9uSGFuZGxlci5pc1JldmVyc2libGUoYWN0aW9uKSAmJiBhY3Rpb24uYWN0aXZhdGVkKSB7XG4gICAgICBBY3Rpb25IYW5kbGVyLnJldmVyc2UoYWN0aW9uKTtcbiAgICB9XG4gICAgLyoqIFJldHJpZ2dlciB0aGUgcGlwZSBBY3Rpb25EaXNwbGF5ZXJQaXBlICovXG4gICAgdGhpcy5hY3Rpb25zID0gWy4uLnRoaXMuYWN0aW9uc107XG4gIH1cblxuICAvKipcbiAgICogQW4gYWN0aW9uIGNhbiBiZSByZXZlcnNpYmxlLiBJdCBtZWFucyB0aGF0IHRoaXMgYWN0aW9uIGhhcyBhIHJldmVyc2UgYWN0aW9uLlxuICAgKiAtIFdoZW4geW91IGNsaWNrIG9uIGEgcmV2ZXJzaWJsZSBhY3Rpb24gZm9yIHRoZSBmaXJzdCB0aW1lLCB0aGUgYWN0aW9uIGJlY29tZSAnYWN0aXZhdGVkJy5cbiAgICogLSBBY3RpdmF0ZWQgYWN0aW9ucyBzaG91bGQgYmUgZGlzcGxheWVkIGFsbCB0aGUgdGltZSBvbiB0aGUgcmVzdWx0bGlzdCAoaW4gbGlzdCBhbmQgZ3JpZCB2aWV3KS5cbiAgICogLSBXaGVuIHlvdSBjbGljayBvbiBhbiAnYWN0aXZhdGVkJyBhY3Rpb24sIHRoZSBhY3Rpb24gaXMgcmV2ZXJzZWQgYW5kIGdvZXMgYmFjayB0byBpdHMgaW5pdGlhbCBzdGF0ZS5cbiAgICovXG4gIHByaXZhdGUgdXBkYXRlQWN0aW9ucygpIHtcbiAgICBpZiAodGhpcy5hY3RpdmF0ZWRBY3Rpb25zUGVySXRlbSkge1xuICAgICAgY29uc3QgYWN0aW9uSWRzID0gdGhpcy5hY3RpdmF0ZWRBY3Rpb25zUGVySXRlbS5nZXQodGhpcy5pdGVtLmlkZW50aWZpZXIpO1xuICAgICAgaWYgKCEhYWN0aW9uSWRzICYmICEhdGhpcy5hY3Rpb25zKSB7XG4gICAgICAgIHRoaXMuYWN0aW9ucy5maWx0ZXIoYSA9PiBBY3Rpb25IYW5kbGVyLmlzUmV2ZXJzaWJsZShhKSkuZm9yRWFjaChhID0+IHtcbiAgICAgICAgICBpZiAoYWN0aW9uSWRzLmhhcyhhLmlkKSkge1xuICAgICAgICAgICAgQWN0aW9uSGFuZGxlci5hY3RpdmF0ZShhKTtcbiAgICAgICAgICAgIC8qKiBBbHdheXMgc2hvdyBhY3RpdmF0ZWQgYWN0aW9ucy4gKi9cbiAgICAgICAgICAgIGEuc2hvdyA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEFjdGlvbkhhbmRsZXIucmV2ZXJzZShhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICAvKiogUmV0cmlnZ2VyIEFjdGlvbkRpc3BsYXllclBpcGUgKi9cbiAgICAgICAgdGhpcy5hY3Rpb25zID0gWy4uLnRoaXMuYWN0aW9uc107XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBkZXNjcmlwdGlvbiBzZXQgdGhlIGxpc3Qgb2YgYWN0aW9ucyBvZiBhbiBpdGVtXG4gICAqIEBwYXJhbSBpdGVtXG4gICAqL1xuICBwcml2YXRlIHNldEl0ZW1BY3Rpb25zKGl0ZW06IEl0ZW0pOiB2b2lkIHtcbiAgICBpZiAoaXRlbSAmJiAoIWl0ZW0uYWN0aW9ucyB8fCAoaXRlbS5hY3Rpb25zICYmIGl0ZW0uYWN0aW9ucy5sZW5ndGggPT09IDApKSkge1xuICAgICAgaXRlbS5hY3Rpb25zID0gbmV3IEFycmF5PEFjdGlvbj4oKTtcbiAgICAgIHRoaXMuZGV0YWlsZWREYXRhUmV0cmlldmVyLmdldEFjdGlvbnMoaXRlbSkucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoYWN0aW9ucyA9PiB7XG4gICAgICAgIGFjdGlvbnMuZm9yRWFjaChhY3Rpb24gPT4ge1xuICAgICAgICAgIGl0ZW0uYWN0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgIGlkOiBhY3Rpb24uaWQsXG4gICAgICAgICAgICBsYWJlbDogYWN0aW9uLmxhYmVsLFxuICAgICAgICAgICAgYWN0aW9uQnVzOiBhY3Rpb24uYWN0aW9uQnVzLFxuICAgICAgICAgICAgY3NzQ2xhc3M6IGFjdGlvbi5jc3NDbGFzcyxcbiAgICAgICAgICAgIHRvb2x0aXA6IGFjdGlvbi50b29sdGlwLFxuICAgICAgICAgICAgcmV2ZXJzZUFjdGlvbjogYWN0aW9uLnJldmVyc2VBY3Rpb24sXG4gICAgICAgICAgICBpY29uOiBhY3Rpb24uaWNvbixcbiAgICAgICAgICAgIGZpZWxkczogYWN0aW9uLmZpZWxkcyxcbiAgICAgICAgICAgIHNob3c6IGFjdGlvbi5zaG93XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFjdGlvbnMgPSBpdGVtLmFjdGlvbnM7XG4gICAgICAgIHRoaXMudXBkYXRlQWN0aW9ucygpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChpdGVtICYmIGl0ZW0uYWN0aW9ucyAmJiBpdGVtLmFjdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5hY3Rpb25zID0gaXRlbS5hY3Rpb25zO1xuICAgICAgdGhpcy51cGRhdGVBY3Rpb25zKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX29uRGVzdHJveSQubmV4dCh0cnVlKTtcbiAgICB0aGlzLl9vbkRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cbn1cbiIsIjwhLS0gVGhpcyBzZWN0aW9ucyBpcyBmb3IgYWN0aW9ucyB0aGF0IHdlIGRpc3BsYXkgYXMgaWNvbiBidXR0b25zIC0tPlxuPGRpdiBbc3R5bGUubWF4LXdpZHRoLnB4XT1cIndpZHRoXCIgY2xhc3M9XCJsaXN0X2FjdGlvbnNcIiAqbmdJZj1cIm1vZGUgPT09ICdpY29uJzsgZWxzZSB0ZXh0QWN0aW9uc1wiPlxuICAgIDxuZy1jb250YWluZXIgKm5nRm9yPVwibGV0IGFjdGlvbiBvZiBhY3Rpb25zXCI+XG4gICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJhY3Rpb24/LnNob3cgPT09IHRydWVcIj5cbiAgICAgICAgICAgIDwhLS0gVGhlIGFjdGlvbiBpcyBhY3RpdmF0ZWQsIHdoaWNoIG1lYW5zIGl0IHdpbGwgYWx3YXlzIGJlIGRpc3BsYXllZC4tLT5cbiAgICAgICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJhY3Rpb24/LmFjdGl2YXRlZFwiPlxuICAgICAgICAgICAgICAgIDwhLS0gVGhlIGJ1dHRvbiBpY29uIGlzIHByb3ZpZGVkIGJ5IGNzcyAnYmFja2dyb3VuZC11cmwnIGF0dHJpYnV0ZS4tLT5cbiAgICAgICAgICAgICAgICA8YnV0dG9uICpuZ0lmPVwiIWFjdGlvbj8uaWNvbiBlbHNlIGFjdGl2ZV9pY29uXCIgKGNsaWNrKT1cInRyaWdnZXJBY3Rpb24oJGV2ZW50LCBhY3Rpb24pXCJcbiAgICAgICAgICAgICAgICAgICAgbWF0VG9vbHRpcD1cInt7YWN0aW9uIHwgYWN0aW9uRGlzcGxheWVyOid0b29sdGlwJyB8dHJhbnNsYXRlfX1cIlxuICAgICAgICAgICAgICAgICAgICBjbGFzcz1cInJlc3VsdGl0ZW0tbGlzdF9fYWN0aW9ucyB7e2FjdGlvbi5pZH19LW9uaG92ZXItYWN0aW9uIHt7YWN0aW9uLmNzc0NsYXNzfX0tb25ob3Zlci1hY3Rpb25cIj5cbiAgICAgICAgICAgICAgICAgICAge3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J2xhYmVsJyB8IHRyYW5zbGF0ZX19XG4gICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICAgICAgPG5nLXRlbXBsYXRlICNhY3RpdmVfaWNvbj5cbiAgICAgICAgICAgICAgICAgICAgPCEtLSBUaGUgaWNvbiBpcyBwcm92aWRlZCBieSB0aGUgYWN0aW9uIGl0c2VsZi4tLT5cbiAgICAgICAgICAgICAgICAgICAgPG1hdC1pY29uIChjbGljayk9XCJ0cmlnZ2VyQWN0aW9uKCRldmVudCwgYWN0aW9uKVwiIGNsYXNzPVwiaWNvblwiXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRUb29sdGlwPVwie3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J3Rvb2x0aXAnIHx0cmFuc2xhdGV9fVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAge3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J2ljb24nfX1cbiAgICAgICAgICAgICAgICAgICAgPC9tYXQtaWNvbj5cbiAgICAgICAgICAgICAgICA8L25nLXRlbXBsYXRlPlxuICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgICAgIDwvbmctY29udGFpbmVyPlxuICAgIDwvbmctY29udGFpbmVyPlxuICAgIDxuZy1jb250YWluZXIgKm5nRm9yPVwibGV0IGFjdGlvbiBvZiBhY3Rpb25zXCI+XG4gICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJhY3Rpb24/LnNob3cgPT09IHRydWVcIj5cbiAgICAgICAgICAgIDwhLS0gVGhlIGFjdGlvbiBpcyBub3QgYWN0aXZhdGVkLCB3aGljaCBtZWFucyBpdCB3aWxsIGFwcGVhciBvbmx5IHdoZW4gYW4gaXRlbSBpcyBob3ZlcmVkLi0tPlxuICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cIiFhY3Rpb24/LmFjdGl2YXRlZFwiPlxuICAgICAgICAgICAgICAgIDxidXR0b24gKm5nSWY9XCIhYWN0aW9uPy5pY29uIGVsc2Ugbm90X2FjdGl2ZV9pY29uXCIgKGNsaWNrKT1cInRyaWdnZXJBY3Rpb24oJGV2ZW50LCBhY3Rpb24pXCJcbiAgICAgICAgICAgICAgICAgICAgY2xhc3M9XCJub3RfYWN0aXZhdGVkXCIgbWF0VG9vbHRpcD1cInt7YWN0aW9uIHwgYWN0aW9uRGlzcGxheWVyOid0b29sdGlwJyB8dHJhbnNsYXRlfX1cIlxuICAgICAgICAgICAgICAgICAgICBjbGFzcz1cInJlc3VsdGl0ZW0tbGlzdF9fYWN0aW9ucyB7e2FjdGlvbi5pZH19LW9uaG92ZXItYWN0aW9uIHt7YWN0aW9uLmNzc0NsYXNzfX0tb25ob3Zlci1hY3Rpb25cIj5cbiAgICAgICAgICAgICAgICAgICAge3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J2xhYmVsJyB8IHRyYW5zbGF0ZX19XG4gICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICAgICAgPG5nLXRlbXBsYXRlICNub3RfYWN0aXZlX2ljb24+XG4gICAgICAgICAgICAgICAgICAgIDxtYXQtaWNvbiAoY2xpY2spPVwidHJpZ2dlckFjdGlvbigkZXZlbnQsIGFjdGlvbilcIiBjbGFzcz1cImljb24gbm90X2FjdGl2YXRlZFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRUb29sdGlwPVwie3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J3Rvb2x0aXAnIHx0cmFuc2xhdGV9fVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAge3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J2ljb24nfX1cbiAgICAgICAgICAgICAgICAgICAgPC9tYXQtaWNvbj5cbiAgICAgICAgICAgICAgICA8L25nLXRlbXBsYXRlPlxuICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgICAgIDwvbmctY29udGFpbmVyPlxuICAgIDwvbmctY29udGFpbmVyPlxuXG48L2Rpdj5cbjwhLS0gVGhpcyBzZWN0aW9ucyBpcyBmb3IgYWN0aW9ucyB0aGF0IHdlIGRpc3BsYXkgYXMgdGV4dCBidXR0b25zIGluc3RlYWQgb2YgaWNvbiBidXR0b25zLS0+XG48bmctdGVtcGxhdGUgI3RleHRBY3Rpb25zPlxuICAgIDxuZy1jb250YWluZXIgKm5nRm9yPVwibGV0IGFjdGlvbiBvZiBhY3Rpb25zXCI+XG4gICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJhY3Rpb24/LnNob3cgPT09IHRydWVcIj5cbiAgICAgICAgICAgIDxidXR0b24gbWF0LXJhaXNlZC1idXR0b24gKm5nSWY9XCIhYWN0aW9uPy5hY3RpdmF0ZWQgZWxzZSBhY3RpdmVCdXR0b25cIiBjbGFzcz1cInRleHQtYWN0aW9uIHt7YWN0aW9uLmlkfX0tYWN0aW9uIHt7YWN0aW9uLmNzc0NsYXNzfX0tYWN0aW9uXCJcbiAgICAgICAgICAgICAgICAoY2xpY2spPVwidHJpZ2dlckFjdGlvbigkZXZlbnQsIGFjdGlvbilcIiBtYXRUb29sdGlwPVwie3thY3Rpb24gfCBhY3Rpb25EaXNwbGF5ZXI6J3Rvb2x0aXAnIHx0cmFuc2xhdGV9fVwiPlxuICAgICAgICAgICAgICAgIHt7YWN0aW9uIHwgYWN0aW9uRGlzcGxheWVyOidsYWJlbCcgfCB0cmFuc2xhdGV9fVxuICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICA8bmctdGVtcGxhdGUgI2FjdGl2ZUJ1dHRvbj5cbiAgICAgICAgICAgICAgICA8YnV0dG9uIG1hdC1yYWlzZWQtYnV0dG9uICpuZ0lmPVwiYWN0aW9uPy5hY3RpdmF0ZWRcIiAoY2xpY2spPVwidHJpZ2dlckFjdGlvbigkZXZlbnQsIGFjdGlvbilcIlxuICAgICAgICAgICAgICAgICAgICBjbGFzcz1cInJlc3VsdGRldGFpbGVkaXRlbV9fYWN0aW9ucyB0ZXh0LWFjdGlvbiB7e2FjdGlvbi5pZH19LWFjdGlvbiB7e2FjdGlvbi5jc3NDbGFzc319LWFjdGlvblwiIG1hdFRvb2x0aXA9XCJ7e2FjdGlvbiB8IGFjdGlvbkRpc3BsYXllcjondG9vbHRpcCcgfHRyYW5zbGF0ZX19XCI+XG4gICAgICAgICAgICAgICAgICAgIHt7YWN0aW9uIHwgYWN0aW9uRGlzcGxheWVyOidsYWJlbCcgfCB0cmFuc2xhdGV9fVxuICAgICAgICAgICAgICAgIDwvYnV0dG9uPlxuICAgICAgICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgPC9uZy1jb250YWluZXI+XG48L25nLXRlbXBsYXRlPlxuIl19