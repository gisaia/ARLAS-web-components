/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import MapboxDraw from '@mapbox/mapbox-gl-draw';
import circle from '@turf/circle';
import length from '@turf/length';
import numeral from 'numeral';
import { displayFeatures, updateCoordinates } from '../utils';
export const radiusCircleMode = { ...MapboxDraw.modes.draw_line_string };
radiusCircleMode.fireOnStop = function () {
    this.map.fire('draw.onStop', 'draw end');
};
function getDisplayMeasurements(feature) {
    // should log both metric and standard display strings for the current drawn feature
    // metric calculation
    const drawnLength = length(feature) * 1000; // meters
    let metricUnits = 'm';
    let metricFormat = '0,0';
    let metricMeasurement;
    let standardUnits = 'feet';
    let standardFormat = '0,0';
    let standardMeasurement;
    metricMeasurement = drawnLength;
    if (drawnLength >= 1000) {
        // if over 1000 meters, upgrade metric
        metricMeasurement = drawnLength / 1000;
        metricUnits = 'km';
        metricFormat = '0.00';
    }
    standardMeasurement = drawnLength * 3.28084;
    if (standardMeasurement >= 5280) {
        // if over 5280 feet, upgrade standard
        standardMeasurement /= 5280;
        standardUnits = 'mi';
        standardFormat = '0.00';
    }
    const displayMeasurements = {
        metric: `${numeral(metricMeasurement).format(metricFormat)} ${metricUnits}`,
        standard: `${numeral(standardMeasurement).format(standardFormat)} ${standardUnits}`,
    };
    return displayMeasurements;
}
const doubleClickZoom = {
    enable: (ctx) => {
        setTimeout(() => {
            // First check we've got a map and some context.
            if (!ctx.map?.doubleClickZoom ||
                !ctx._ctx?.store?.getInitialConfigValue) {
                return;
            }
            // Now check initial state wasn't false (we leave it disabled if so)
            if (!ctx._ctx.store.getInitialConfigValue('doubleClickZoom')) {
                return;
            }
            ctx.map.doubleClickZoom.enable();
        }, 0);
    },
};
radiusCircleMode.onSetup = function (opts) {
    const props = MapboxDraw.modes.draw_line_string.onSetup.call(this, opts);
    const polygon = this.newFeature({
        type: MapboxDraw.constants.geojsonTypes.FEATURE,
        properties: {
            meta: 'radius',
            isFixedRadius: opts.isFixedRadius !== undefined ? opts.isFixedRadius : false,
            isCircle: true,
            center: opts.center !== undefined ? opts.center : []
        },
        geometry: {
            type: MapboxDraw.constants.geojsonTypes.POLYGON,
            coordinates: [[]],
        },
    });
    this.addFeature(polygon);
    return {
        ...props,
        circle: polygon,
        steps: opts.steps || 64,
        units: opts.units || 'kilometers'
    };
};
radiusCircleMode.clickAnywhere = function (state, e) {
    // this ends the drawing after the user creates a second point, triggering this.onStop
    if (state.currentVertexPosition === 1) {
        state.line.addCoordinate(0, e.lngLat.lng, e.lngLat.lat);
        return this.changeMode('simple_select', { featureIds: [state.line.id] });
    }
    this.updateUIClasses({ mouse: MapboxDraw.constants.cursors.ADD });
    state.line.updateCoordinate(state.currentVertexPosition, e.lngLat.lng, e.lngLat.lat);
    updateCoordinates(state, e);
    return null;
};
radiusCircleMode.onMouseMove = function (state, e) {
    MapboxDraw.modes.draw_line_string.onMouseMove.call(this, state, e);
    const geojson = state.line.toGeoJSON();
    const center = geojson.geometry.coordinates[0];
    const radiusInKm = length(geojson, { units: 'kilometers' });
    const options = { steps: state.steps, units: state.units };
    const circleFeature = circle(center, radiusInKm, options);
    circleFeature.properties.parent = state.line.id;
    circleFeature.properties.meta = 'radius';
    state.circle.setCoordinates(circleFeature.geometry.coordinates);
};
// creates the final geojson point feature with a radius property
// triggers draw.create
radiusCircleMode.onStop = function (state) {
    doubleClickZoom.enable(this);
    this.activateUIButton();
    // check to see if we've deleted this feature
    if (this.getFeature(state.line.id) === undefined) {
        return;
    }
    // remove last added coordinate
    state.line.removeCoordinate('0');
    if (state.line.isValid()) {
        this.deleteFeature([state.line.id], { silent: true });
        this.map.fire('draw.create', {
            features: [state.circle.toGeoJSON()],
        });
    }
    else {
        this.deleteFeature([state.line.id], { silent: true });
        this.changeMode('simple_select', {}, { silent: true });
    }
    this.fireOnStop();
};
radiusCircleMode.toDisplayFeatures = function (state, geojson, display) {
    displayFeatures(state, geojson, display);
    if (geojson.geometry.coordinates.length >= 2 && geojson.geometry.coordinates[1]) {
        const displayMeasurements = getDisplayMeasurements(geojson);
        // create custom feature for the current pointer position
        const currentVertex = {
            type: 'Feature',
            properties: {
                meta: 'currentPosition',
                radiusMetric: displayMeasurements.metric,
                radiusStandard: displayMeasurements.standard,
                parent: state.line.id,
            },
            geometry: {
                type: 'Point',
                coordinates: geojson.geometry.coordinates[1],
            },
        };
        display(currentVertex);
    }
    return null;
};
export default radiusCircleMode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFkaXVzLmNpcmNsZS5tb2RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvZHJhdy9tb2Rlcy9jaXJjbGVzL3JhZGl1cy5jaXJjbGUubW9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFFSCxPQUFPLFVBQVUsTUFBTSx3QkFBd0IsQ0FBQztBQUNoRCxPQUFPLE1BQU0sTUFBTSxjQUFjLENBQUM7QUFDbEMsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFDO0FBQ2xDLE9BQU8sT0FBTyxNQUFNLFNBQVMsQ0FBQztBQUM5QixPQUFPLEVBQUUsZUFBZSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRTlELE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLEVBQUUsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7QUFHekUsZ0JBQWdCLENBQUMsVUFBVSxHQUFHO0lBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUM7QUFHRixTQUFTLHNCQUFzQixDQUFDLE9BQU87SUFDbkMsb0ZBQW9GO0lBRXBGLHFCQUFxQjtJQUNyQixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsU0FBUztJQUVyRCxJQUFJLFdBQVcsR0FBRyxHQUFHLENBQUM7SUFDdEIsSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBQ3pCLElBQUksaUJBQWlCLENBQUM7SUFFdEIsSUFBSSxhQUFhLEdBQUcsTUFBTSxDQUFDO0lBQzNCLElBQUksY0FBYyxHQUFHLEtBQUssQ0FBQztJQUMzQixJQUFJLG1CQUFtQixDQUFDO0lBRXhCLGlCQUFpQixHQUFHLFdBQVcsQ0FBQztJQUNoQyxJ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Q0FBQyxDQUFDO2FBQy9DO1NBQ0osQ0FBQztRQUNGLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBRUYsZUFBZSxnQkFBZ0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byBHaXNhw69hIHVuZGVyIG9uZSBvciBtb3JlIGNvbnRyaWJ1dG9yXG4gKiBsaWNlbnNlIGFncmVlbWVudHMuIFNlZSB0aGUgTk9USUNFLnR4dCBmaWxlIGRpc3RyaWJ1dGVkIHdpdGhcbiAqIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiByZWdhcmRpbmcgY29weXJpZ2h0XG4gKiBvd25lcnNoaXAuIEdpc2HDr2EgbGljZW5zZXMgdGhpcyBmaWxlIHRvIHlvdSB1bmRlclxuICogdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heVxuICogbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgTWFwYm94RHJhdyBmcm9tICdAbWFwYm94L21hcGJveC1nbC1kcmF3JztcbmltcG9ydCBjaXJjbGUgZnJvbSAnQHR1cmYvY2lyY2xlJztcbmltcG9ydCBsZW5ndGggZnJvbSAnQHR1cmYvbGVuZ3RoJztcbmltcG9ydCBudW1lcmFsIGZyb20gJ251bWVyYWwnO1xuaW1wb3J0IHsgZGlzcGxheUZlYXR1cmVzLCB1cGRhdGVDb29yZGluYXRlcyB9IGZyb20gJy4uL3V0aWxzJztcblxuZXhwb3J0IGNvbnN0IHJhZGl1c0NpcmNsZU1vZGUgPSB7IC4uLk1hcGJveERyYXcubW9kZXMuZHJhd19saW5lX3N0cmluZyB9O1xuXG5cbnJhZGl1c0NpcmNsZU1vZGUuZmlyZU9uU3RvcCA9IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm1hcC5maXJlKCdkcmF3Lm9uU3RvcCcsICdkcmF3IGVuZCcpO1xufTtcblxuXG5mdW5jdGlvbiBnZXREaXNwbGF5TWVhc3VyZW1lbnRzKGZlYXR1cmUpIHtcbiAgICAvLyBzaG91bGQgbG9nIGJvdGggbWV0cmljIGFuZCBzdGFuZGFyZCBkaXNwbGF5IHN0cmluZ3MgZm9yIHRoZSBjdXJyZW50IGRyYXduIGZlYXR1cmVcblxuICAgIC8vIG1ldHJpYyBjYWxjdWxhdGlvblxuICAgIGNvbnN0IGRyYXduTGVuZ3RoID0gbGVuZ3RoKGZlYXR1cmUpICogMTAwMDsgLy8gbWV0ZXJzXG5cbiAgICBsZXQgbWV0cmljVW5pdHMgPSAnbSc7XG4gICAgbGV0IG1ldHJpY0Zvcm1hdCA9ICcwLDAnO1xuICAgIGxldCBtZXRyaWNNZWFzdXJlbWVudDtcblxuICAgIGxldCBzdGFuZGFyZFVuaXRzID0gJ2ZlZXQnO1xuICAgIGxldCBzdGFuZGFyZEZvcm1hdCA9ICcwLDAnO1xuICAgIGxldCBzdGFuZGFyZE1lYXN1cmVtZW50O1xuXG4gICAgbWV0cmljTWVhc3VyZW1lbnQgPSBkcmF3bkxlbmd0aDtcbiAgICBpZiAoZHJhd25MZW5ndGggPj0gMTAwMCkge1xuICAgICAgICAvLyBpZiBvdmVyIDEwMDAgbWV0ZXJzLCB1cGdyYWRlIG1ldHJpY1xuICAgICAgICBtZXRyaWNNZWFzdXJlbWVudCA9IGRyYXduTGVuZ3RoIC8gMTAwMDtcbiAgICAgICAgbWV0cmljVW5pdHMgPSAna20nO1xuICAgICAgICBtZXRyaWNGb3JtYXQgPSAnMC4wMCc7XG4gICAgfVxuXG4gICAgc3RhbmRhcmRNZWFzdXJlbWVudCA9IGRyYXduTGVuZ3RoICogMy4yODA4NDtcbiAgICBpZiAoc3RhbmRhcmRNZWFzdXJlbWVudCA+PSA1MjgwKSB7XG4gICAgICAgIC8vIGlmIG92ZXIgNTI4MCBmZWV0LCB1cGdyYWRlIHN0YW5kYXJkXG4gICAgICAgIHN0YW5kYXJkTWVhc3VyZW1lbnQgLz0gNTI4MDtcbiAgICAgICAgc3RhbmRhcmRVbml0cyA9ICdtaSc7XG4gICAgICAgIHN0YW5kYXJkRm9ybWF0ID0gJzAuMDAnO1xuICAgIH1cblxuICAgIGNvbnN0IGRpc3BsYXlNZWFzdXJlbWVudHMgPSB7XG4gICAgICAgIG1ldHJpYzogYCR7bnVtZXJhbChtZXRyaWNNZWFzdXJlbWVudCkuZm9ybWF0KG1ldHJpY0Zvcm1hdCl9ICR7bWV0cmljVW5pdHN9YCxcbiAgICAgICAgc3RhbmRhcmQ6IGAke251bWVyYWwoc3RhbmRhcmRNZWFzdXJlbWVudCkuZm9ybWF0KFxuICAgICAgICAgICAgc3RhbmRhcmRGb3JtYXRcbiAgICAgICAgKX0gJHtzdGFuZGFyZFVuaXRzfWAsXG4gICAgfTtcblxuICAgIHJldHVybiBkaXNwbGF5TWVhc3VyZW1lbnRzO1xufVxuXG5jb25zdCBkb3VibGVDbGlja1pvb20gPSB7XG4gICAgZW5hYmxlOiAoY3R4KSA9PiB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgLy8gRmlyc3QgY2hlY2sgd2UndmUgZ290IGEgbWFwIGFuZCBzb21lIGNvbnRleHQuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgIWN0eC5tYXA/LmRvdWJsZUNsaWNrWm9vbSB8fFxuICAgICAgICAgICAgICAgICFjdHguX2N0eD8uc3RvcmU/LmdldEluaXRpYWxDb25maWdWYWx1ZVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gTm93IGNoZWNrIGluaXRpYWwgc3RhdGUgd2Fzbid0IGZhbHNlICh3ZSBsZWF2ZSBpdCBkaXNhYmxlZCBpZiBzbylcbiAgICAgICAgICAgIGlmICghY3R4Ll9jdHguc3RvcmUuZ2V0SW5pdGlhbENvbmZpZ1ZhbHVlKCdkb3VibGVDbGlja1pvb20nKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN0eC5tYXAuZG91YmxlQ2xpY2tab29tLmVuYWJsZSgpO1xuICAgICAgICB9LCAwKTtcbiAgICB9LFxufTtcbnJhZGl1c0NpcmNsZU1vZGUub25TZXR1cCA9IGZ1bmN0aW9uIChvcHRzKSB7XG4gICAgY29uc3QgcHJvcHMgPSBNYXBib3hEcmF3Lm1vZGVzLmRyYXdfbGluZV9zdHJpbmcub25TZXR1cC5jYWxsKHRoaXMsIG9wdHMpO1xuICAgIGNvbnN0IHBvbHlnb24gPSB0aGlzLm5ld0ZlYXR1cmUoe1xuICAgICAgICB0eXBlOiBNYXBib3hEcmF3LmNvbnN0YW50cy5nZW9qc29uVHlwZXMuRkVBVFVSRSxcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgbWV0YTogJ3JhZGl1cycsXG4gICAgICAgICAgICBpc0ZpeGVkUmFkaXVzOiBvcHRzLmlzRml4ZWRSYWRpdXMgIT09IHVuZGVmaW5lZCA/IG9wdHMuaXNGaXhlZFJhZGl1cyA6IGZhbHNlLFxuICAgICAgICAgICAgaXNDaXJjbGU6IHRydWUsXG4gICAgICAgICAgICBjZW50ZXI6IG9wdHMuY2VudGVyICE9PSB1bmRlZmluZWQgPyBvcHRzLmNlbnRlciA6IFtdXG4gICAgICAgIH0sXG4gICAgICAgIGdlb21ldHJ5OiB7XG4gICAgICAgICAgICB0eXBlOiBNYXBib3hEcmF3LmNvbnN0YW50cy5nZW9qc29uVHlwZXMuUE9MWUdPTixcbiAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBbW11dLFxuICAgICAgICB9LFxuICAgIH0pO1xuICAgIHRoaXMuYWRkRmVhdHVyZShwb2x5Z29uKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIC4uLnByb3BzLFxuICAgICAgICBjaXJjbGU6cG9seWdvbixcbiAgICAgICAgc3RlcHM6IG9wdHMuc3RlcHMgfHwgNjQsXG4gICAgICAgIHVuaXRzOiBvcHRzLnVuaXRzIHx8ICdraWxvbWV0ZXJzJ1xuICAgIH07XG59O1xuXG5yYWRpdXNDaXJjbGVNb2RlLmNsaWNrQW55d2hlcmUgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICAvLyB0aGlzIGVuZHMgdGhlIGRyYXdpbmcgYWZ0ZXIgdGhlIHVzZXIgY3JlYXRlcyBhIHNlY29uZCBwb2ludCwgdHJpZ2dlcmluZyB0aGlzLm9uU3RvcFxuICAgIGlmIChzdGF0ZS5jdXJyZW50VmVydGV4UG9zaXRpb24gPT09IDEpIHtcbiAgICAgICAgc3RhdGUubGluZS5hZGRDb29yZGluYXRlKDAsIGUubG5nTGF0LmxuZywgZS5sbmdMYXQubGF0KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hhbmdlTW9kZSgnc2ltcGxlX3NlbGVjdCcsIHsgZmVhdHVyZUlkczogW3N0YXRlLmxpbmUuaWRdIH0pO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZVVJQ2xhc3Nlcyh7IG1vdXNlOiBNYXBib3hEcmF3LmNvbnN0YW50cy5jdXJzb3JzLkFERCB9KTtcbiAgICBzdGF0ZS5saW5lLnVwZGF0ZUNvb3JkaW5hdGUoXG4gICAgICAgIHN0YXRlLmN1cnJlbnRWZXJ0ZXhQb3NpdGlvbixcbiAgICAgICAgZS5sbmdMYXQubG5nLFxuICAgICAgICBlLmxuZ0xhdC5sYXRcbiAgICApO1xuICAgIHVwZGF0ZUNvb3JkaW5hdGVzKHN0YXRlLCBlKTtcbiAgICByZXR1cm4gbnVsbDtcbn07XG5cbnJhZGl1c0NpcmNsZU1vZGUub25Nb3VzZU1vdmUgPSBmdW5jdGlvbiAoc3RhdGUsIGUpIHtcbiAgICBNYXBib3hEcmF3Lm1vZGVzLmRyYXdfbGluZV9zdHJpbmcub25Nb3VzZU1vdmUuY2FsbCh0aGlzLCBzdGF0ZSwgZSk7XG4gICAgY29uc3QgZ2VvanNvbiA9IHN0YXRlLmxpbmUudG9HZW9KU09OKCk7XG4gICAgY29uc3QgY2VudGVyID0gZ2VvanNvbi5nZW9tZXRyeS5jb29yZGluYXRlc1swXTtcbiAgICBjb25zdCByYWRpdXNJbkttID0gbGVuZ3RoKGdlb2pzb24sIHsgdW5pdHM6ICdraWxvbWV0ZXJzJyB9KTtcbiAgICBjb25zdCBvcHRpb25zID0gIHtzdGVwczogc3RhdGUuc3RlcHMsIHVuaXRzOiBzdGF0ZS51bml0c307XG4gICAgY29uc3QgY2lyY2xlRmVhdHVyZSA9IGNpcmNsZShjZW50ZXIsIHJhZGl1c0luS20sIG9wdGlvbnMpO1xuICAgIGNpcmNsZUZlYXR1cmUucHJvcGVydGllcy5wYXJlbnQgPSBzdGF0ZS5saW5lLmlkO1xuICAgIChjaXJjbGVGZWF0dXJlLnByb3BlcnRpZXMgYXMgYW55KS5tZXRhID0gJ3JhZGl1cyc7XG4gICAgc3RhdGUuY2lyY2xlLnNldENvb3JkaW5hdGVzKGNpcmNsZUZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xufTtcblxuLy8gY3JlYXRlcyB0aGUgZmluYWwgZ2VvanNvbiBwb2ludCBmZWF0dXJlIHdpdGggYSByYWRpdXMgcHJvcGVydHlcbi8vIHRyaWdnZXJzIGRyYXcuY3JlYXRlXG5yYWRpdXNDaXJjbGVNb2RlLm9uU3RvcCA9IGZ1bmN0aW9uIChzdGF0ZSkge1xuICAgIGRvdWJsZUNsaWNrWm9vbS5lbmFibGUodGhpcyk7XG5cbiAgICB0aGlzLmFjdGl2YXRlVUlCdXR0b24oKTtcblxuICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB3ZSd2ZSBkZWxldGVkIHRoaXMgZmVhdHVyZVxuICAgIGlmICh0aGlzLmdldEZlYXR1cmUoc3RhdGUubGluZS5pZCkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGxhc3QgYWRkZWQgY29vcmRpbmF0ZVxuICAgIHN0YXRlLmxpbmUucmVtb3ZlQ29vcmRpbmF0ZSgnMCcpO1xuICAgIGlmIChzdGF0ZS5saW5lLmlzVmFsaWQoKSkge1xuICAgICAgICB0aGlzLmRlbGV0ZUZlYXR1cmUoW3N0YXRlLmxpbmUuaWRdLCB7IHNpbGVudDogdHJ1ZSB9KTtcblxuICAgICAgICB0aGlzLm1hcC5maXJlKCdkcmF3LmNyZWF0ZScsIHtcbiAgICAgICAgICAgIGZlYXR1cmVzOiBbc3RhdGUuY2lyY2xlLnRvR2VvSlNPTigpXSxcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5kZWxldGVGZWF0dXJlKFtzdGF0ZS5saW5lLmlkXSwgeyBzaWxlbnQ6IHRydWUgfSk7XG4gICAgICAgIHRoaXMuY2hhbmdlTW9kZSgnc2ltcGxlX3NlbGVjdCcsIHt9LCB7IHNpbGVudDogdHJ1ZSB9KTtcbiAgICB9XG4gICAgdGhpcy5maXJlT25TdG9wKCk7XG59O1xuXG5yYWRpdXNDaXJjbGVNb2RlLnRvRGlzcGxheUZlYXR1cmVzID0gZnVuY3Rpb24gKHN0YXRlLCBnZW9qc29uLCBkaXNwbGF5KSB7XG4gICAgZGlzcGxheUZlYXR1cmVzKHN0YXRlLCBnZW9qc29uLCBkaXNwbGF5KTtcblxuICAgIGlmIChnZW9qc29uLmdlb21ldHJ5LmNvb3JkaW5hdGVzLmxlbmd0aCA+PSAyICYmIGdlb2pzb24uZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMV0pIHtcbiAgICAgICAgY29uc3QgZGlzcGxheU1lYXN1cmVtZW50cyA9IGdldERpc3BsYXlNZWFzdXJlbWVudHMoZ2VvanNvbik7XG5cbiAgICAgICAgLy8gY3JlYXRlIGN1c3RvbSBmZWF0dXJlIGZvciB0aGUgY3VycmVudCBwb2ludGVyIHBvc2l0aW9uXG4gICAgICAgIGNvbnN0IGN1cnJlbnRWZXJ0ZXggPSB7XG4gICAgICAgICAgICB0eXBlOiAnRmVhdHVyZScsXG4gICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICAgICAgbWV0YTogJ2N1cnJlbnRQb3NpdGlvbicsXG4gICAgICAgICAgICAgICAgcmFkaXVzTWV0cmljOiBkaXNwbGF5TWVhc3VyZW1lbnRzLm1ldHJpYyxcbiAgICAgICAgICAgICAgICByYWRpdXNTdGFuZGFyZDogZGlzcGxheU1lYXN1cmVtZW50cy5zdGFuZGFyZCxcbiAgICAgICAgICAgICAgICBwYXJlbnQ6IHN0YXRlLmxpbmUuaWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2VvbWV0cnk6IHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnUG9pbnQnLFxuICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBnZW9qc29uLmdlb21ldHJ5LmNvb3JkaW5hdGVzWzFdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgICAgZGlzcGxheShjdXJyZW50VmVydGV4KTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IHJhZGl1c0NpcmNsZU1vZGU7XG4iXX0=