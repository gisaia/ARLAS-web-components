/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import MapboxDraw from '@mapbox/mapbox-gl-draw';
import circle from '@turf/circle';
import { point } from '@turf/helpers';
import distance from '@turf/distance';
import { createSupplementaryPointsForCircle } from './circles/utils';
export const directModeOverride = MapboxDraw.modes.direct_select;
directModeOverride.dragFeature = function (state, e, delta) {
    MapboxDraw.lib.moveFeatures(this.getSelected(), delta);
    this.getSelected()
        .filter(feature => feature.properties.isCircle)
        .map(circle => circle.properties.center)
        .forEach(center => {
        center[0] += delta.lng;
        center[1] += delta.lat;
    });
    state.dragMoveLocation = e.lngLat;
};
directModeOverride.dragVertex = function (state, e, delta) {
    if (state.feature.properties.isCircle && state.feature.properties.isFixedRadius) {
        MapboxDraw.lib.moveFeatures(this.getSelected(), delta);
        this.getSelected()
            .filter(feature => feature.properties.isCircle)
            .map(circle => circle.properties.center)
            .forEach(center => {
            center[0] += delta.lng;
            center[1] += delta.lat;
        });
        state.dragMoveLocation = e.lngLat;
    }
    else {
        if (state.feature.properties.isCircle) {
            const center = state.feature.properties.center;
            const movedVertex = [e.lngLat.lng, e.lngLat.lat];
            const radius = distance(point(center), point(movedVertex), { units: 'kilometers' });
            const circleFeature = circle(center, radius);
            state.feature.incomingCoords(circleFeature.geometry.coordinates);
            state.feature.properties.radiusInKm = radius;
        }
        else {
            const selectedCoords = state.selectedCoordPaths.map(coord_path => state.feature.getCoordinate(coord_path));
            const selectedCoordPoints = selectedCoords.map(coords => ({
                type: MapboxDraw.constants.geojsonTypes.FEATURE,
                properties: {},
                geometry: {
                    type: MapboxDraw.constants.geojsonTypes.POINT,
                    coordinates: coords
                }
            }));
            const constrainedDelta = MapboxDraw.lib.constrainFeatureMovement(selectedCoordPoints, delta);
            for (let i = 0; i < selectedCoords.length; i++) {
                const coord = selectedCoords[i];
                state.feature.updateCoordinate(state.selectedCoordPaths[i], coord[0] + constrainedDelta.lng, coord[1] + constrainedDelta.lat);
            }
        }
    }
};
directModeOverride.toDisplayFeatures = function (state, geojson, push) {
    if (state.featureId === geojson.properties.id) {
        geojson.properties.active = MapboxDraw.constants.activeStates.ACTIVE;
        push(geojson);
        const supplementaryPoints = geojson.properties.user_isCircle ? createSupplementaryPointsForCircle(geojson)
            : MapboxDraw.lib.createSupplementaryPoints(geojson, {
                map: this.map,
                midpoints: true,
                selectedPaths: state.selectedCoordPaths
            });
        supplementaryPoints.forEach(push);
    }
    else {
        geojson.properties.active = MapboxDraw.constants.activeStates.INACTIVE;
        push(geojson);
    }
    this.fireActionable(state);
};
export default directModeOverride;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlyZWN0U2VsZWN0T3ZlcnJpZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hcmxhcy1tYXAvc3JjL2xpYi9kcmF3L21vZGVzL2RpcmVjdFNlbGVjdE92ZXJyaWRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUVILE9BQU8sVUFBVSxNQUFNLHdCQUF3QixDQUFDO0FBQ2hELE9BQU8sTUFBTSxNQUFNLGNBQWMsQ0FBQztBQUNsQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RDLE9BQU8sUUFBUSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBR3JFLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDO0FBRWpFLGtCQUFrQixDQUFDLFdBQVcsR0FBRyxVQUFVLEtBQUssRUFBRSxDQUFDLEVBQUUsS0FBSztJQUN0RCxVQUFVLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdkQsSUFBSSxDQUFDLFdBQVcsRUFBRTtTQUNiLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDO1NBQzlDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1NBQ3ZDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUNkLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ1As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QUM7QUFFL0IsQ0FBQyxDQUFDO0FBRUYsZUFBZSxrQkFBa0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBMaWNlbnNlZCB0byBHaXNhw69hIHVuZGVyIG9uZSBvciBtb3JlIGNvbnRyaWJ1dG9yXG4gKiBsaWNlbnNlIGFncmVlbWVudHMuIFNlZSB0aGUgTk9USUNFLnR4dCBmaWxlIGRpc3RyaWJ1dGVkIHdpdGhcbiAqIHRoaXMgd29yayBmb3IgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiByZWdhcmRpbmcgY29weXJpZ2h0XG4gKiBvd25lcnNoaXAuIEdpc2HDr2EgbGljZW5zZXMgdGhpcyBmaWxlIHRvIHlvdSB1bmRlclxuICogdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTsgeW91IG1heVxuICogbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZyxcbiAqIHNvZnR3YXJlIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuXG4gKiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWVxuICogS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlXG4gKiBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zXG4gKiB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgTWFwYm94RHJhdyBmcm9tICdAbWFwYm94L21hcGJveC1nbC1kcmF3JztcbmltcG9ydCBjaXJjbGUgZnJvbSAnQHR1cmYvY2lyY2xlJztcbmltcG9ydCB7IHBvaW50IH0gZnJvbSAnQHR1cmYvaGVscGVycyc7XG5pbXBvcnQgZGlzdGFuY2UgZnJvbSAnQHR1cmYvZGlzdGFuY2UnO1xuaW1wb3J0IHsgY3JlYXRlU3VwcGxlbWVudGFyeVBvaW50c0ZvckNpcmNsZSB9IGZyb20gJy4vY2lyY2xlcy91dGlscyc7XG5cblxuZXhwb3J0IGNvbnN0IGRpcmVjdE1vZGVPdmVycmlkZSA9IE1hcGJveERyYXcubW9kZXMuZGlyZWN0X3NlbGVjdDtcblxuZGlyZWN0TW9kZU92ZXJyaWRlLmRyYWdGZWF0dXJlID0gZnVuY3Rpb24gKHN0YXRlLCBlLCBkZWx0YSkge1xuICAgIE1hcGJveERyYXcubGliLm1vdmVGZWF0dXJlcyh0aGlzLmdldFNlbGVjdGVkKCksIGRlbHRhKTtcbiAgICB0aGlzLmdldFNlbGVjdGVkKClcbiAgICAgICAgLmZpbHRlcihmZWF0dXJlID0+IGZlYXR1cmUucHJvcGVydGllcy5pc0NpcmNsZSlcbiAgICAgICAgLm1hcChjaXJjbGUgPT4gY2lyY2xlLnByb3BlcnRpZXMuY2VudGVyKVxuICAgICAgICAuZm9yRWFjaChjZW50ZXIgPT4ge1xuICAgICAgICAgICAgY2VudGVyWzBdICs9IGRlbHRhLmxuZztcbiAgICAgICAgICAgIGNlbnRlclsxXSArPSBkZWx0YS5sYXQ7XG4gICAgICAgIH0pO1xuICAgIHN0YXRlLmRyYWdNb3ZlTG9jYXRpb24gPSBlLmxuZ0xhdDtcbn07XG5cbmRpcmVjdE1vZGVPdmVycmlkZS5kcmFnVmVydGV4ID0gZnVuY3Rpb24gKHN0YXRlLCBlLCBkZWx0YSkge1xuICAgIGlmIChzdGF0ZS5mZWF0dXJlLnByb3BlcnRpZXMuaXNDaXJjbGUgJiYgc3RhdGUuZmVhdHVyZS5wcm9wZXJ0aWVzLmlzRml4ZWRSYWRpdXMpIHtcbiAgICAgICAgTWFwYm94RHJhdy5saWIubW92ZUZlYXR1cmVzKHRoaXMuZ2V0U2VsZWN0ZWQoKSwgZGVsdGEpO1xuICAgICAgICB0aGlzLmdldFNlbGVjdGVkKClcbiAgICAgICAgICAgIC5maWx0ZXIoZmVhdHVyZSA9PiBmZWF0dXJlLnByb3BlcnRpZXMuaXNDaXJjbGUpXG4gICAgICAgICAgICAubWFwKGNpcmNsZSA9PiBjaXJjbGUucHJvcGVydGllcy5jZW50ZXIpXG4gICAgICAgICAgICAuZm9yRWFjaChjZW50ZXIgPT4ge1xuICAgICAgICAgICAgICAgIGNlbnRlclswXSArPSBkZWx0YS5sbmc7XG4gICAgICAgICAgICAgICAgY2VudGVyWzFdICs9IGRlbHRhLmxhdDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzdGF0ZS5kcmFnTW92ZUxvY2F0aW9uID0gZS5sbmdMYXQ7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHN0YXRlLmZlYXR1cmUucHJvcGVydGllcy5pc0NpcmNsZSkge1xuICAgICAgICAgICAgY29uc3QgY2VudGVyID0gc3RhdGUuZmVhdHVyZS5wcm9wZXJ0aWVzLmNlbnRlcjtcbiAgICAgICAgICAgIGNvbnN0IG1vdmVkVmVydGV4ID0gW2UubG5nTGF0LmxuZywgZS5sbmdMYXQubGF0XTtcbiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IGRpc3RhbmNlKHBvaW50KGNlbnRlciksIHBvaW50KG1vdmVkVmVydGV4KSwgeyB1bml0czogJ2tpbG9tZXRlcnMnIH0pO1xuICAgICAgICAgICAgY29uc3QgY2lyY2xlRmVhdHVyZSA9IGNpcmNsZShjZW50ZXIsIHJhZGl1cyk7XG4gICAgICAgICAgICBzdGF0ZS5mZWF0dXJlLmluY29taW5nQ29vcmRzKGNpcmNsZUZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuICAgICAgICAgICAgc3RhdGUuZmVhdHVyZS5wcm9wZXJ0aWVzLnJhZGl1c0luS20gPSByYWRpdXM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZENvb3JkcyA9IHN0YXRlLnNlbGVjdGVkQ29vcmRQYXRocy5tYXAoY29vcmRfcGF0aCA9PiBzdGF0ZS5mZWF0dXJlLmdldENvb3JkaW5hdGUoY29vcmRfcGF0aCkpO1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRDb29yZFBvaW50cyA9IHNlbGVjdGVkQ29vcmRzLm1hcChjb29yZHMgPT4gKHtcbiAgICAgICAgICAgICAgICB0eXBlOiBNYXBib3hEcmF3LmNvbnN0YW50cy5nZW9qc29uVHlwZXMuRkVBVFVSRSxcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7fSxcbiAgICAgICAgICAgICAgICBnZW9tZXRyeToge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiBNYXBib3hEcmF3LmNvbnN0YW50cy5nZW9qc29uVHlwZXMuUE9JTlQsXG4gICAgICAgICAgICAgICAgICAgIGNvb3JkaW5hdGVzOiBjb29yZHNcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbnN0cmFpbmVkRGVsdGEgPSBNYXBib3hEcmF3LmxpYi5jb25zdHJhaW5GZWF0dXJlTW92ZW1lbnQoc2VsZWN0ZWRDb29yZFBvaW50cywgZGVsdGEpO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZENvb3Jkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvb3JkID0gc2VsZWN0ZWRDb29yZHNbaV07XG4gICAgICAgICAgICAgICAgc3RhdGUuZmVhdHVyZS51cGRhdGVDb29yZGluYXRlKHN0YXRlLnNlbGVjdGVkQ29vcmRQYXRoc1tpXSwgY29vcmRbMF0gKyBjb25zdHJhaW5lZERlbHRhLmxuZywgY29vcmRbMV0gKyBjb25zdHJhaW5lZERlbHRhLmxhdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbn07XG5cbmRpcmVjdE1vZGVPdmVycmlkZS50b0Rpc3BsYXlGZWF0dXJlcyA9IGZ1bmN0aW9uIChzdGF0ZSwgZ2VvanNvbiwgcHVzaCkge1xuICAgIGlmIChzdGF0ZS5mZWF0dXJlSWQgPT09IGdlb2pzb24ucHJvcGVydGllcy5pZCkge1xuICAgICAgICBnZW9qc29uLnByb3BlcnRpZXMuYWN0aXZlID0gTWFwYm94RHJhdy5jb25zdGFudHMuYWN0aXZlU3RhdGVzLkFDVElWRTtcbiAgICAgICAgcHVzaChnZW9qc29uKTtcbiAgICAgICAgY29uc3Qgc3VwcGxlbWVudGFyeVBvaW50cyA9IGdlb2pzb24ucHJvcGVydGllcy51c2VyX2lzQ2lyY2xlID8gY3JlYXRlU3VwcGxlbWVudGFyeVBvaW50c0ZvckNpcmNsZShnZW9qc29uKVxuICAgICAgICAgICAgOiBNYXBib3hEcmF3LmxpYi5jcmVhdGVTdXBwbGVtZW50YXJ5UG9pbnRzKGdlb2pzb24sIHtcbiAgICAgICAgICAgICAgICBtYXA6IHRoaXMubWFwLFxuICAgICAgICAgICAgICAgIG1pZHBvaW50czogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZWxlY3RlZFBhdGhzOiBzdGF0ZS5zZWxlY3RlZENvb3JkUGF0aHNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBzdXBwbGVtZW50YXJ5UG9pbnRzLmZvckVhY2gocHVzaCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZ2VvanNvbi5wcm9wZXJ0aWVzLmFjdGl2ZSA9IE1hcGJveERyYXcuY29uc3RhbnRzLmFjdGl2ZVN0YXRlcy5JTkFDVElWRTtcbiAgICAgICAgcHVzaChnZW9qc29uKTtcbiAgICB9XG4gICAgdGhpcy5maXJlQWN0aW9uYWJsZShzdGF0ZSk7XG5cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGRpcmVjdE1vZGVPdmVycmlkZTtcbiJdfQ==