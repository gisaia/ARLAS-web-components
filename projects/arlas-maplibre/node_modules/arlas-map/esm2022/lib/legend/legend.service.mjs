/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Injectable } from '@angular/core';
import { PROPERTY_SELECTOR_SOURCE } from './legend.config';
import { HEATMAP_DENSITY, IN, INTERPOLATE, MATCH, NOT_IN, OTHER } from '../map/model/filters';
import tinycolor from 'tinycolor2';
import { getMax } from './legend.component';
import { MAX_CIRLE_RADIUS, MAX_LINE_WIDTH } from './legend.tools';
import * as i0 from "@angular/core";
export class LegendService {
    getCircleLegend(paint, visibileMode, legendData, layer) {
        return undefined;
    }
    getLineLegend(paint, visibileMode, legendData, layer) {
        return undefined;
    }
    getFillLegend(paint, visibileMode, legendData, layer) {
        return undefined;
    }
    getHeatmapLegend(paint, visibileMode, legendData, layer) {
        return undefined;
    }
    getLabelLegend(paint, visibileMode, legendData, layer) {
        return undefined;
    }
    static setProvidedColorLegend(colorLegend, field, legendData, filter, translate) {
        colorLegend.title = field;
        if (!Array.isArray(field)) {
            colorLegend.type = PROPERTY_SELECTOR_SOURCE.provided;
            if (field.endsWith('_arlas__color')) {
                colorLegend.type = PROPERTY_SELECTOR_SOURCE.generated;
            }
            colorLegend.manualValues = new Map();
            if (legendData?.get(field)) {
                const keysToColors = legendData.get(field).keysColorsMap;
                const colorList = Array.from(keysToColors.keys()).map(k => [k, keysToColors.get(k)]).flat();
                for (let i = 0; i < colorList.length; i += 2) {
                    colorLegend.manualValues.set(translate ? translate.instant(colorList[i]) : colorList[i], colorList[i + 1]);
                }
                if (colorList.length === 0) {
                    colorLegend.manualValues.set('', '#eee');
                }
            }
            else {
                colorLegend.manualValues.set('', '#eee');
            }
            if (filter) {
                LegendService.filterLegend(colorLegend.manualValues, filter, (field).endsWith('_arlas__color') ? (field).slice(0, -13) : field);
            }
        }
    }
    static setMatchColorLegend(colorLegend, colorExpression, legendData, filter, translate) {
        /** color = ["match", ["get", "field"], .... ]**/
        colorLegend.type = PROPERTY_SELECTOR_SOURCE.manual;
        const colorsLength = colorExpression.length;
        let hasDefaultColor = false;
        if (colorsLength % 2 !== 0) {
            hasDefaultColor = true;
        }
        const field = colorExpression[1].length === 2 ? colorExpression[1][1] : '';
        colorLegend.title = field;
        colorLegend.manualValues = new Map();
        let keysToColors;
        if (legendData?.get(field + '_color')) {
            // If there is a legendData, use only the colors in the keysToColors
            keysToColors = legendData.get(field + '_color').keysColorsMap;
        }
        else {
            // If no legendData for this field, use all the colors of colorExpression
            keysToColors = new Map();
            for (let i = 2; i < colorExpression.length; i += 2) {
                if (hasDefaultColor && i === colorsLength - 3) {
                    keysToColors.set(colorExpression[i] + '', colorExpression[i + 1]);
                    keysToColors.set(OTHER, colorExpression[i + 2]);
                    break;
                }
                else {
                    keysToColors.set(colorExpression[i] + '', colorExpression[i + 1]);
                }
            }
        }
        for (let i = 2; i < colorExpression.length; i += 2) {
            if (hasDefaultColor && i === colorsLength - 3) {
                if (keysToColors.has(colorExpression[i] + '')) {
                    colorLegend.manualValues.set(translate ? translate.instant(colorExpression[i] + '') : colorExpression[i], colorExpression[i + 1]);
                }
                colorLegend.manualValues.set(translate ? translate.instant(OTHER) : OTHER, colorExpression[i + 2]);
                break;
            }
            else if (keysToColors.has(colorExpression[i] + '')) {
                colorLegend.manualValues.set(translate ? translate.instant(colorExpression[i] + '') : colorExpression[i], colorExpression[i + 1]);
            }
        }
        if (filter) {
            LegendService.filterLegend(colorLegend.manualValues, filter, field);
        }
    }
    static setInterpolatedColorLegend(colorLegend, colorExpression, legendData, visibleMode) {
        colorLegend.type = PROPERTY_SELECTOR_SOURCE.interpolated;
        /** color = ["interplate", ['linear'], ["get", "field"], 0, 1... ]**/
        // todo throw exception if interpolation is not linear
        const field = colorExpression[2].length === 2 ? colorExpression[2][1] : HEATMAP_DENSITY;
        colorLegend.title = field;
        colorLegend.interpolatedValues = [];
        const palette = [];
        const colors = colorExpression.slice(3);
        colors.forEach((c, i) => {
            if (i % 2 === 0) {
                palette.push({
                    proportion: c,
                    value: colors[i + 1]
                });
            }
        });
        const minimum = palette[0].proportion;
        const maximum = palette.slice(-1)[0].proportion;
        palette.forEach(c => colorLegend.interpolatedValues.push(c.value));
        const colorValues = colorExpression.filter((c, i) => i > 2 && i % 2 !== 0);
        if (legendData?.get(field) && field !== 'count') {
            colorLegend.minValue = legendData.get(field).minValue;
            colorLegend.maxValue = legendData.get(field).maxValue;
            // For heatmaps, the count is used to fetch data, so we use it for the legend
        }
        else if (field === HEATMAP_DENSITY && legendData?.get('count')) {
            colorLegend.minValue = legendData.get('count').minValue;
            colorLegend.maxValue = legendData.get('count').maxValue;
        }
        else {
            colorLegend.minValue = colorValues[0] + '';
            colorLegend.maxValue = colorValues[colorValues.length - 1] + '';
        }
        if (!visibleMode) {
            /** apply greyscale because the layer is not visible */
            colorLegend.interpolatedValues = colorLegend.interpolatedValues
                .map((c) => tinycolor(c.toString()).greyscale().lighten(20).toHexString());
            palette.forEach(p => {
                p.value = tinycolor(p.value.toString()).greyscale().lighten(20).toHexString();
            });
        }
        return palette.map(c => c.value + ' ' + (100 * (c.proportion - minimum) / (maximum - minimum)) + '%').join(',');
    }
    static filterLegend(colorLegendValues, filter, field) {
        filter.forEach((f, idx) => {
            if (idx !== 0 && idx !== filter.length - 1) {
                switch (f[0]) {
                    case IN: {
                        if (f[1][1] === field) {
                            const valuesToKeep = f[2][1];
                            colorLegendValues.forEach((val, key) => {
                                if (!(valuesToKeep.includes(key))) {
                                    colorLegendValues.delete(key);
                                }
                            });
                        }
                        break;
                    }
                    case NOT_IN: {
                        if (f[1][0] === IN && f[1][1][1] === field) {
                            const valuesToExclude = f[1][2][1];
                            valuesToExclude.forEach(value => {
                                colorLegendValues.delete(value);
                            });
                        }
                        break;
                    }
                }
            }
        });
    }
    static buildColorLegend(colorExpression, visibleMode, legendData, filter, translate) {
        const colorLegend = { visible: true };
        let colorPalette = '';
        if (typeof colorExpression === 'string') {
            colorLegend.type = PROPERTY_SELECTOR_SOURCE.fix;
            colorLegend.fixValue = colorExpression;
        }
        else if (Array.isArray(colorExpression)) {
            if (colorExpression.length === 2) {
                /** color = ["get", "field"]  ==> Generated or Provided */
                const field = colorExpression[1];
                colorLegend.title = field;
                LegendService.setProvidedColorLegend(colorLegend, field, legendData, filter, translate);
            }
            else if (colorExpression.length >= 3) {
                if (colorExpression[0] === MATCH) {
                    LegendService.setMatchColorLegend(colorLegend, colorExpression, legendData, filter, translate);
                }
                else if (colorExpression[0] === INTERPOLATE) {
                    colorPalette = LegendService.setInterpolatedColorLegend(colorLegend, colorExpression, legendData, visibleMode);
                }
            }
        }
        colorLegend.visible = visibleMode;
        return [colorLegend, colorPalette];
    }
    ;
    static buildRadiusLegend(radiusExpression, legendData) {
        const radiusLegend = {};
        const circleRadiusEvolution = new Array();
        if (Array.isArray(radiusExpression)) {
            if (radiusExpression.length >= 3) {
                // Filter out the zoom-dependent radius layers (circle-heatmap)
                if (radiusExpression[0] === INTERPOLATE && radiusExpression[2].length > 1) {
                    const field = radiusExpression[2][1];
                    radiusExpression.filter((w, i) => i >= 3).forEach((w, i) => {
                        if (i % 2 === 0) {
                            circleRadiusEvolution.push({ key: w, value: radiusExpression[i + 1 + 3] });
                        }
                    });
                    radiusLegend.title = field;
                    if (legendData?.get(field)) {
                        radiusLegend.minValue = legendData.get(field).minValue;
                        radiusLegend.maxValue = legendData.get(field).maxValue;
                    }
                    else {
                        radiusLegend.minValue = circleRadiusEvolution[0].key + '';
                        radiusLegend.maxValue = circleRadiusEvolution[circleRadiusEvolution.length - 1].key + '';
                    }
                    radiusLegend.type = PROPERTY_SELECTOR_SOURCE.interpolated;
                    const maxCircleRadius = getMax(circleRadiusEvolution);
                    if (maxCircleRadius > MAX_CIRLE_RADIUS) {
                        circleRadiusEvolution.forEach(lw => lw.value = lw.value * MAX_CIRLE_RADIUS / maxCircleRadius);
                    }
                    radiusLegend.histogram = circleRadiusEvolution;
                }
            }
        }
        return radiusLegend;
    }
    ;
    static buildWidthLegend(lineWidth, legendData) {
        /** if the line width is fix then it is not added to the legend*/
        const widthLegend = {};
        if (Array.isArray(lineWidth)) {
            if (lineWidth.length >= 3) {
                if (lineWidth[0] === INTERPOLATE) {
                    const field = lineWidth[2][1];
                    widthLegend.title = field;
                    if (legendData?.get(field)) {
                        widthLegend.minValue = legendData.get(field).minValue;
                        widthLegend.maxValue = legendData.get(field).maxValue;
                    }
                    widthLegend.type = PROPERTY_SELECTOR_SOURCE.interpolated;
                    const lineWidthEvolution = new Array();
                    lineWidth.filter((w, i) => i >= 3).forEach((w, i) => {
                        if (i % 2 === 0) {
                            lineWidthEvolution.push({ key: w, value: lineWidth[i + 1 + 3] });
                        }
                    });
                    const maxLineWidth = getMax(lineWidthEvolution);
                    if (maxLineWidth > MAX_LINE_WIDTH) {
                        lineWidthEvolution.forEach(lw => lw.value = lw.value * MAX_LINE_WIDTH / maxLineWidth);
                    }
                    widthLegend.histogram = lineWidthEvolution;
                }
            }
        }
        return widthLegend;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: LegendService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: LegendService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: LegendService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVnZW5kLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hcmxhcy1tYXAvc3JjL2xpYi9sZWdlbmQvbGVnZW5kLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQXdGLHdCQUF3QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFakosT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDOUYsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBRW5DLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBTWxFLE1BQU0sT0FBZ0IsYUFBYTtJQUUxQixlQUFlLENBQUMsS0FBVSxFQUFFLFlBQXFCLEVBQUUsVUFBbUMsRUFBRSxLQUFVO1FBQ3ZHLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTSxhQUFhLENBQUMsS0FBVSxFQUFFLFlBQXFCLEVBQUUsVUFBbUMsRUFBRSxLQUFVO1FBQ3JHLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTSxhQUFhLENBQUMsS0FBVSxFQUFFLFlBQXFCLEVBQUUsVUFBbUMsRUFBRSxLQUFVO1FBQ3JHLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxLQUFVLEVBQUUsWUFBcUIsRUFBRSxVQUFtQyxFQUFFLEtBQVU7UUFDeEcsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVNLGNBQWMsQ0FBQyxLQUFVLEVBQUUsWUFBcUIsRUFBRSxVQUFtQyxF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LEVBQUUsQ0FBQyxLQUFLLEdBQUcsY0FBYyxHQUFHLFlBQVksQ0FBQyxDQUFDO29CQUN4RixDQUFDO29CQUNELFdBQVcsQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUM7Z0JBQzdDLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUNELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7K0dBeFFtQixhQUFhO21IQUFiLGFBQWEsY0FGckIsTUFBTTs7NEZBRUUsYUFBYTtrQkFIbEMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ2lyY2xlTGVnZW5kLCBGaWxsTGVnZW5kLCBIZWF0bWFwTGVnZW5kLCBMYWJlbExlZ2VuZCwgTGVnZW5kLCBMZWdlbmREYXRhLCBMaW5lTGVnZW5kLCBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0UgfSBmcm9tICcuL2xlZ2VuZC5jb25maWcnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgSEVBVE1BUF9ERU5TSVRZLCBJTiwgSU5URVJQT0xBVEUsIE1BVENILCBOT1RfSU4sIE9USEVSIH0gZnJvbSAnLi4vbWFwL21vZGVsL2ZpbHRlcnMnO1xuaW1wb3J0IHRpbnljb2xvciBmcm9tICd0aW55Y29sb3IyJztcbmltcG9ydCB7IEhpc3RvZ3JhbURhdGEgfSBmcm9tICdhcmxhcy1kMy9oaXN0b2dyYW1zL3V0aWxzL0hpc3RvZ3JhbVV0aWxzJztcbmltcG9ydCB7IGdldE1heCB9IGZyb20gJy4vbGVnZW5kLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBNQVhfQ0lSTEVfUkFESVVTLCBNQVhfTElORV9XSURUSCB9IGZyb20gJy4vbGVnZW5kLnRvb2xzJztcblxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBMZWdlbmRTZXJ2aWNlIHtcblxuICBwdWJsaWMgZ2V0Q2lyY2xlTGVnZW5kKHBhaW50OiBhbnksIHZpc2liaWxlTW9kZTogYm9vbGVhbiwgbGVnZW5kRGF0YTogTWFwPHN0cmluZywgTGVnZW5kRGF0YT4sIGxheWVyOiBhbnkpOiBDaXJjbGVMZWdlbmQge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0TGluZUxlZ2VuZChwYWludDogYW55LCB2aXNpYmlsZU1vZGU6IGJvb2xlYW4sIGxlZ2VuZERhdGE6IE1hcDxzdHJpbmcsIExlZ2VuZERhdGE+LCBsYXllcjogYW55KTogTGluZUxlZ2VuZCB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHB1YmxpYyBnZXRGaWxsTGVnZW5kKHBhaW50OiBhbnksIHZpc2liaWxlTW9kZTogYm9vbGVhbiwgbGVnZW5kRGF0YTogTWFwPHN0cmluZywgTGVnZW5kRGF0YT4sIGxheWVyOiBhbnkpOiBGaWxsTGVnZW5kIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIGdldEhlYXRtYXBMZWdlbmQocGFpbnQ6IGFueSwgdmlzaWJpbGVNb2RlOiBib29sZWFuLCBsZWdlbmREYXRhOiBNYXA8c3RyaW5nLCBMZWdlbmREYXRhPiwgbGF5ZXI6IGFueSk6IEhlYXRtYXBMZWdlbmQge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0TGFiZWxMZWdlbmQocGFpbnQ6IGFueSwgdmlzaWJpbGVNb2RlOiBib29sZWFuLCBsZWdlbmREYXRhOiBNYXA8c3RyaW5nLCBMZWdlbmREYXRhPiwgbGF5ZXI6IGFueSk6IExhYmVsTGVnZW5kIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBzZXRQcm92aWRlZENvbG9yTGVnZW5kKGNvbG9yTGVnZW5kOiBMZWdlbmQsIGZpZWxkOiBzdHJpbmcsXG4gICAgbGVnZW5kRGF0YTogTWFwPHN0cmluZywgTGVnZW5kRGF0YT4sIGZpbHRlciwgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7XG4gICAgY29sb3JMZWdlbmQudGl0bGUgPSBmaWVsZDtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmllbGQpKSB7XG4gICAgICBjb2xvckxlZ2VuZC50eXBlID0gUFJPUEVSVFlfU0VMRUNUT1JfU09VUkNFLnByb3ZpZGVkO1xuICAgICAgaWYgKGZpZWxkLmVuZHNXaXRoKCdfYXJsYXNfX2NvbG9yJykpIHtcbiAgICAgICAgY29sb3JMZWdlbmQudHlwZSA9IFBST1BFUlRZX1NFTEVDVE9SX1NPVVJDRS5nZW5lcmF0ZWQ7XG4gICAgICB9XG4gICAgICBjb2xvckxlZ2VuZC5tYW51YWxWYWx1ZXMgPSBuZXcgTWFwKCk7XG4gICAgICBpZiAobGVnZW5kRGF0YT8uZ2V0KGZpZWxkKSkge1xuICAgICAgICBjb25zdCBrZXlzVG9Db2xvcnMgPSBsZWdlbmREYXRhLmdldChmaWVsZCkua2V5c0NvbG9yc01hcDtcbiAgICAgICAgY29uc3QgY29sb3JMaXN0ID0gQXJyYXkuZnJvbShrZXlzVG9Db2xvcnMua2V5cygpKS5tYXAoayA9PiBbaywga2V5c1RvQ29sb3JzLmdldChrKV0pLmZsYXQoKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb2xvckxpc3QubGVuZ3RoOyBpICs9IDIpIHtcbiAgICAgICAgICBjb2xvckxlZ2VuZC5tYW51YWxWYWx1ZXMuc2V0KHRyYW5zbGF0ZSA/IHRyYW5zbGF0ZS5pbnN0YW50KGNvbG9yTGlzdFtpXSkgOiBjb2xvckxpc3RbaV0sIGNvbG9yTGlzdFtpICsgMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjb2xvckxpc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgY29sb3JMZWdlbmQubWFudWFsVmFsdWVzLnNldCgnJywgJyNlZWUnKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29sb3JMZWdlbmQubWFudWFsVmFsdWVzLnNldCgnJywgJyNlZWUnKTtcbiAgICAgIH1cbiAgICAgIGlmIChmaWx0ZXIpIHtcbiAgICAgICAgTGVnZW5kU2VydmljZS5maWx0ZXJMZWdlbmQoY29sb3JMZWdlbmQubWFudWFsVmFsdWVzLCBmaWx0ZXIsXG4gICAgICAgICAgKGZpZWxkKS5lbmRzV2l0aCgnX2FybGFzX19jb2xvcicpID8gKGZpZWxkKS5zbGljZSgwLCAtMTMpIDogZmllbGQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG5cbiAgcHVibGljIHN0YXRpYyBzZXRNYXRjaENvbG9yTGVnZW5kKGNvbG9yTGVnZW5kOiBMZWdlbmQsIGNvbG9yRXhwcmVzc2lvbjogYW55W10sIGxlZ2VuZERhdGE6IE1hcDxzdHJpbmcsIExlZ2VuZERhdGE+LFxuICAgIGZpbHRlciwgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7XG4gICAgLyoqIGNvbG9yID0gW1wibWF0Y2hcIiwgW1wiZ2V0XCIsIFwiZmllbGRcIl0sIC4uLi4gXSoqL1xuICAgIGNvbG9yTGVnZW5kLnR5cGUgPSBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0UubWFudWFsO1xuICAgIGNvbnN0IGNvbG9yc0xlbmd0aCA9IGNvbG9yRXhwcmVzc2lvbi5sZW5ndGg7XG4gICAgbGV0IGhhc0RlZmF1bHRDb2xvciA9IGZhbHNlO1xuICAgIGlmIChjb2xvcnNMZW5ndGggJSAyICE9PSAwKSB7XG4gICAgICBoYXNEZWZhdWx0Q29sb3IgPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBmaWVsZCA9IGNvbG9yRXhwcmVzc2lvblsxXS5sZW5ndGggPT09IDIgPyBjb2xvckV4cHJlc3Npb25bMV1bMV0gOiAnJztcbiAgICBjb2xvckxlZ2VuZC50aXRsZSA9IGZpZWxkO1xuICAgIGNvbG9yTGVnZW5kLm1hbnVhbFZhbHVlcyA9IG5ldyBNYXAoKTtcbiAgICBsZXQga2V5c1RvQ29sb3JzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xuICAgIGlmIChsZWdlbmREYXRhPy5nZXQoZmllbGQgKyAnX2NvbG9yJykpIHtcbiAgICAgIC8vIElmIHRoZXJlIGlzIGEgbGVnZW5kRGF0YSwgdXNlIG9ubHkgdGhlIGNvbG9ycyBpbiB0aGUga2V5c1RvQ29sb3JzXG4gICAgICBrZXlzVG9Db2xvcnMgPSBsZWdlbmREYXRhLmdldChmaWVsZCArICdfY29sb3InKS5rZXlzQ29sb3JzTWFwO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBJZiBubyBsZWdlbmREYXRhIGZvciB0aGlzIGZpZWxkLCB1c2UgYWxsIHRoZSBjb2xvcnMgb2YgY29sb3JFeHByZXNzaW9uXG4gICAgICBrZXlzVG9Db2xvcnMgPSBuZXcgTWFwKCk7XG4gICAgICBmb3IgKGxldCBpID0gMjsgaSA8IGNvbG9yRXhwcmVzc2lvbi5sZW5ndGg7IGkgKz0gMikge1xuICAgICAgICBpZiAoaGFzRGVmYXVsdENvbG9yICYmIGkgPT09IGNvbG9yc0xlbmd0aCAtIDMpIHtcbiAgICAgICAgICBrZXlzVG9Db2xvcnMuc2V0KGNvbG9yRXhwcmVzc2lvbltpXSArICcnLCBjb2xvckV4cHJlc3Npb25baSArIDFdKTtcbiAgICAgICAgICBrZXlzVG9Db2xvcnMuc2V0KE9USEVSLCBjb2xvckV4cHJlc3Npb25baSArIDJdKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBrZXlzVG9Db2xvcnMuc2V0KGNvbG9yRXhwcmVzc2lvbltpXSArICcnLCBjb2xvckV4cHJlc3Npb25baSArIDFdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMjsgaSA8IGNvbG9yRXhwcmVzc2lvbi5sZW5ndGg7IGkgKz0gMikge1xuICAgICAgaWYgKGhhc0RlZmF1bHRDb2xvciAmJiBpID09PSBjb2xvcnNMZW5ndGggLSAzKSB7XG4gICAgICAgIGlmIChrZXlzVG9Db2xvcnMuaGFzKGNvbG9yRXhwcmVzc2lvbltpXSArICcnKSkge1xuICAgICAgICAgIGNvbG9yTGVnZW5kLm1hbnVhbFZhbHVlcy5zZXQodHJhbnNsYXRlID8gdHJhbnNsYXRlLmluc3RhbnQoY29sb3JFeHByZXNzaW9uW2ldICsgJycpIDogY29sb3JFeHByZXNzaW9uW2ldLFxuICAgICAgICAgICAgY29sb3JFeHByZXNzaW9uW2kgKyAxXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29sb3JMZWdlbmQubWFudWFsVmFsdWVzLnNldCh0cmFuc2xhdGUgPyB0cmFuc2xhdGUuaW5zdGFudChPVEhFUikgOiBPVEhFUiwgY29sb3JFeHByZXNzaW9uW2kgKyAyXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfSBlbHNlIGlmIChrZXlzVG9Db2xvcnMuaGFzKGNvbG9yRXhwcmVzc2lvbltpXSArICcnKSkge1xuICAgICAgICBjb2xvckxlZ2VuZC5tYW51YWxWYWx1ZXMuc2V0KHRyYW5zbGF0ZSA/IHRyYW5zbGF0ZS5pbnN0YW50KGNvbG9yRXhwcmVzc2lvbltpXSArICcnKSA6IGNvbG9yRXhwcmVzc2lvbltpXSxcbiAgICAgICAgICBjb2xvckV4cHJlc3Npb25baSArIDFdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZmlsdGVyKSB7XG4gICAgICBMZWdlbmRTZXJ2aWNlLmZpbHRlckxlZ2VuZChjb2xvckxlZ2VuZC5tYW51YWxWYWx1ZXMsIGZpbHRlciwgZmllbGQpO1xuICAgIH1cbiAgfVxuXG5cbiAgcHVibGljIHN0YXRpYyBzZXRJbnRlcnBvbGF0ZWRDb2xvckxlZ2VuZChjb2xvckxlZ2VuZDogTGVnZW5kLCBjb2xvckV4cHJlc3Npb246IGFueVtdLFxuICAgIGxlZ2VuZERhdGE6IE1hcDxzdHJpbmcsIExlZ2VuZERhdGE+LFxuICAgIHZpc2libGVNb2RlOiBib29sZWFuKSB7XG4gICAgY29sb3JMZWdlbmQudHlwZSA9IFBST1BFUlRZX1NFTEVDVE9SX1NPVVJDRS5pbnRlcnBvbGF0ZWQ7XG4gICAgLyoqIGNvbG9yID0gW1wiaW50ZXJwbGF0ZVwiLCBbJ2xpbmVhciddLCBbXCJnZXRcIiwgXCJmaWVsZFwiXSwgMCwgMS4uLiBdKiovXG4gICAgLy8gdG9kbyB0aHJvdyBleGNlcHRpb24gaWYgaW50ZXJwb2xhdGlvbiBpcyBub3QgbGluZWFyXG4gICAgY29uc3QgZmllbGQgPSBjb2xvckV4cHJlc3Npb25bMl0ubGVuZ3RoID09PSAyID8gY29sb3JFeHByZXNzaW9uWzJdWzFdIDogSEVBVE1BUF9ERU5TSVRZO1xuICAgIGNvbG9yTGVnZW5kLnRpdGxlID0gZmllbGQ7XG4gICAgY29sb3JMZWdlbmQuaW50ZXJwb2xhdGVkVmFsdWVzID0gW107XG4gICAgY29uc3QgcGFsZXR0ZSA9IFtdO1xuICAgIGNvbnN0IGNvbG9ycyA9IGNvbG9yRXhwcmVzc2lvbi5zbGljZSgzKTtcbiAgICBjb2xvcnMuZm9yRWFjaCgoYywgaSkgPT4ge1xuICAgICAgaWYgKGkgJSAyID09PSAwKSB7XG4gICAgICAgIHBhbGV0dGUucHVzaCh7XG4gICAgICAgICAgcHJvcG9ydGlvbjogYyxcbiAgICAgICAgICB2YWx1ZTogY29sb3JzW2kgKyAxXVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBtaW5pbXVtID0gcGFsZXR0ZVswXS5wcm9wb3J0aW9uO1xuICAgIGNvbnN0IG1heGltdW0gPSBwYWxldHRlLnNsaWNlKC0xKVswXS5wcm9wb3J0aW9uO1xuICAgIHBhbGV0dGUuZm9yRWFjaChjID0+IGNvbG9yTGVnZW5kLmludGVycG9sYXRlZFZhbHVlcy5wdXNoKGMudmFsdWUpKTtcbiAgICBjb25zdCBjb2xvclZhbHVlcyA9IGNvbG9yRXhwcmVzc2lvbi5maWx0ZXIoKGMsIGkpID0+IGkgPiAyICYmIGkgJSAyICE9PSAwKTtcbiAgICBpZiAobGVnZW5kRGF0YT8uZ2V0KGZpZWxkKSAmJiBmaWVsZCAhPT0gJ2NvdW50Jykge1xuICAgICAgY29sb3JMZWdlbmQubWluVmFsdWUgPSBsZWdlbmREYXRhLmdldChmaWVsZCkubWluVmFsdWU7XG4gICAgICBjb2xvckxlZ2VuZC5tYXhWYWx1ZSA9IGxlZ2VuZERhdGEuZ2V0KGZpZWxkKS5tYXhWYWx1ZTtcbiAgICAgIC8vIEZvciBoZWF0bWFwcywgdGhlIGNvdW50IGlzIHVzZWQgdG8gZmV0Y2ggZGF0YSwgc28gd2UgdXNlIGl0IGZvciB0aGUgbGVnZW5kXG4gICAgfSBlbHNlIGlmIChmaWVsZCA9PT0gSEVBVE1BUF9ERU5TSVRZICYmIGxlZ2VuZERhdGE/LmdldCgnY291bnQnKSkge1xuICAgICAgY29sb3JMZWdlbmQubWluVmFsdWUgPSBsZWdlbmREYXRhLmdldCgnY291bnQnKS5taW5WYWx1ZTtcbiAgICAgIGNvbG9yTGVnZW5kLm1heFZhbHVlID0gbGVnZW5kRGF0YS5nZXQoJ2NvdW50JykubWF4VmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbG9yTGVnZW5kLm1pblZhbHVlID0gY29sb3JWYWx1ZXNbMF0gKyAnJztcbiAgICAgIGNvbG9yTGVnZW5kLm1heFZhbHVlID0gY29sb3JWYWx1ZXNbY29sb3JWYWx1ZXMubGVuZ3RoIC0gMV0gKyAnJztcbiAgICB9XG4gICAgaWYgKCF2aXNpYmxlTW9kZSkge1xuICAgICAgLyoqIGFwcGx5IGdyZXlzY2FsZSBiZWNhdXNlIHRoZSBsYXllciBpcyBub3QgdmlzaWJsZSAqL1xuICAgICAgY29sb3JMZWdlbmQuaW50ZXJwb2xhdGVkVmFsdWVzID0gY29sb3JMZWdlbmQuaW50ZXJwb2xhdGVkVmFsdWVzXG4gICAgICAgIC5tYXAoKGMpID0+IHRpbnljb2xvcihjLnRvU3RyaW5nKCkpLmdyZXlzY2FsZSgpLmxpZ2h0ZW4oMjApLnRvSGV4U3RyaW5nKCkpO1xuICAgICAgcGFsZXR0ZS5mb3JFYWNoKHAgPT4ge1xuICAgICAgICBwLnZhbHVlID0gdGlueWNvbG9yKHAudmFsdWUudG9TdHJpbmcoKSkuZ3JleXNjYWxlKCkubGlnaHRlbigyMCkudG9IZXhTdHJpbmcoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcGFsZXR0ZS5tYXAoYyA9PiBjLnZhbHVlICsgJyAnICsgKDEwMCAqIChjLnByb3BvcnRpb24gLSBtaW5pbXVtKSAvIChtYXhpbXVtIC0gbWluaW11bSkpICsgJyUnKS5qb2luKCcsJyk7XG5cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZmlsdGVyTGVnZW5kKGNvbG9yTGVnZW5kVmFsdWVzOiBNYXA8c3RyaW5nLCBzdHJpbmcgfCBudW1iZXI+LCBmaWx0ZXI6IGFueVtdLCBmaWVsZDogc3RyaW5nKSB7XG4gICAgZmlsdGVyLmZvckVhY2goKGYsIGlkeCkgPT4ge1xuICAgICAgaWYgKGlkeCAhPT0gMCAmJiBpZHggIT09IGZpbHRlci5sZW5ndGggLSAxKSB7XG4gICAgICAgIHN3aXRjaCAoZlswXSkge1xuICAgICAgICAgIGNhc2UgSU46IHtcbiAgICAgICAgICAgIGlmIChmWzFdWzFdID09PSBmaWVsZCkge1xuICAgICAgICAgICAgICBjb25zdCB2YWx1ZXNUb0tlZXA6IEFycmF5PHN0cmluZz4gPSBmWzJdWzFdO1xuICAgICAgICAgICAgICBjb2xvckxlZ2VuZFZhbHVlcy5mb3JFYWNoKCh2YWwsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghKHZhbHVlc1RvS2VlcC5pbmNsdWRlcyhrZXkpKSkge1xuICAgICAgICAgICAgICAgICAgY29sb3JMZWdlbmRWYWx1ZXMuZGVsZXRlKGtleSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlIE5PVF9JTjoge1xuICAgICAgICAgICAgaWYgKGZbMV1bMF0gPT09IElOICYmIGZbMV1bMV1bMV0gPT09IGZpZWxkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHZhbHVlc1RvRXhjbHVkZTogQXJyYXk8c3RyaW5nPiA9IGZbMV1bMl1bMV07XG4gICAgICAgICAgICAgIHZhbHVlc1RvRXhjbHVkZS5mb3JFYWNoKHZhbHVlID0+IHtcbiAgICAgICAgICAgICAgICBjb2xvckxlZ2VuZFZhbHVlcy5kZWxldGUodmFsdWUpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBidWlsZENvbG9yTGVnZW5kKGNvbG9yRXhwcmVzc2lvbjogc3RyaW5nIHwgYW55LCB2aXNpYmxlTW9kZTogYm9vbGVhbiwgbGVnZW5kRGF0YTogTWFwPHN0cmluZywgTGVnZW5kRGF0YT4sXG4gICAgZmlsdGVyPzogYW55LCB0cmFuc2xhdGU/OiBUcmFuc2xhdGVTZXJ2aWNlKTogW0xlZ2VuZCwgc3RyaW5nXSB7XG4gICAgY29uc3QgY29sb3JMZWdlbmQ6IExlZ2VuZCA9IHsgdmlzaWJsZTogdHJ1ZSB9O1xuICAgIGxldCBjb2xvclBhbGV0dGUgPSAnJztcbiAgICBpZiAodHlwZW9mIGNvbG9yRXhwcmVzc2lvbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbG9yTGVnZW5kLnR5cGUgPSBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0UuZml4O1xuICAgICAgY29sb3JMZWdlbmQuZml4VmFsdWUgPSBjb2xvckV4cHJlc3Npb247XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGNvbG9yRXhwcmVzc2lvbikpIHtcbiAgICAgIGlmIChjb2xvckV4cHJlc3Npb24ubGVuZ3RoID09PSAyKSB7XG4gICAgICAgIC8qKiBjb2xvciA9IFtcImdldFwiLCBcImZpZWxkXCJdICA9PT4gR2VuZXJhdGVkIG9yIFByb3ZpZGVkICovXG4gICAgICAgIGNvbnN0IGZpZWxkID0gY29sb3JFeHByZXNzaW9uWzFdO1xuICAgICAgICBjb2xvckxlZ2VuZC50aXRsZSA9IGZpZWxkO1xuICAgICAgICBMZWdlbmRTZXJ2aWNlLnNldFByb3ZpZGVkQ29sb3JMZWdlbmQoY29sb3JMZWdlbmQsIGZpZWxkLCBsZWdlbmREYXRhLCBmaWx0ZXIsIHRyYW5zbGF0ZSk7XG4gICAgICB9IGVsc2UgaWYgKGNvbG9yRXhwcmVzc2lvbi5sZW5ndGggPj0gMykge1xuICAgICAgICBpZiAoY29sb3JFeHByZXNzaW9uWzBdID09PSBNQVRDSCkge1xuICAgICAgICAgIExlZ2VuZFNlcnZpY2Uuc2V0TWF0Y2hDb2xvckxlZ2VuZChjb2xvckxlZ2VuZCwgY29sb3JFeHByZXNzaW9uLCBsZWdlbmREYXRhLCBmaWx0ZXIsIHRyYW5zbGF0ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoY29sb3JFeHByZXNzaW9uWzBdID09PSBJTlRFUlBPTEFURSkge1xuICAgICAgICAgIGNvbG9yUGFsZXR0ZSA9IExlZ2VuZFNlcnZpY2Uuc2V0SW50ZXJwb2xhdGVkQ29sb3JMZWdlbmQoY29sb3JMZWdlbmQsIGNvbG9yRXhwcmVzc2lvbiwgbGVnZW5kRGF0YSwgdmlzaWJsZU1vZGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29sb3JMZWdlbmQudmlzaWJsZSA9IHZpc2libGVNb2RlO1xuICAgIHJldHVybiBbY29sb3JMZWdlbmQsIGNvbG9yUGFsZXR0ZV07XG4gIH07XG5cbiAgcHVibGljIHN0YXRpYyBidWlsZFJhZGl1c0xlZ2VuZChyYWRpdXNFeHByZXNzaW9uOiBzdHJpbmcgfCBhbnksIGxlZ2VuZERhdGE6IE1hcDxzdHJpbmcsIExlZ2VuZERhdGE+KTogTGVnZW5kIHtcbiAgICBjb25zdCByYWRpdXNMZWdlbmQ6IExlZ2VuZCA9IHt9O1xuICAgIGNvbnN0IGNpcmNsZVJhZGl1c0V2b2x1dGlvbjogQXJyYXk8SGlzdG9ncmFtRGF0YT4gPSBuZXcgQXJyYXkoKTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShyYWRpdXNFeHByZXNzaW9uKSkge1xuICAgICAgaWYgKHJhZGl1c0V4cHJlc3Npb24ubGVuZ3RoID49IDMpIHtcbiAgICAgICAgLy8gRmlsdGVyIG91dCB0aGUgem9vbS1kZXBlbmRlbnQgcmFkaXVzIGxheWVycyAoY2lyY2xlLWhlYXRtYXApXG4gICAgICAgIGlmIChyYWRpdXNFeHByZXNzaW9uWzBdID09PSBJTlRFUlBPTEFURSAmJiByYWRpdXNFeHByZXNzaW9uWzJdLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICBjb25zdCBmaWVsZCA9IHJhZGl1c0V4cHJlc3Npb25bMl1bMV07XG4gICAgICAgICAgcmFkaXVzRXhwcmVzc2lvbi5maWx0ZXIoKHcsIGkpID0+IGkgPj0gMykuZm9yRWFjaCgodywgaSkgPT4ge1xuICAgICAgICAgICAgaWYgKGkgJSAyID09PSAwKSB7XG4gICAgICAgICAgICAgIGNpcmNsZVJhZGl1c0V2b2x1dGlvbi5wdXNoKHsga2V5OiB3LCB2YWx1ZTogcmFkaXVzRXhwcmVzc2lvbltpICsgMSArIDNdIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJhZGl1c0xlZ2VuZC50aXRsZSA9IGZpZWxkO1xuICAgICAgICAgIGlmIChsZWdlbmREYXRhPy5nZXQoZmllbGQpKSB7XG4gICAgICAgICAgICByYWRpdXNMZWdlbmQubWluVmFsdWUgPSBsZWdlbmREYXRhLmdldChmaWVsZCkubWluVmFsdWU7XG4gICAgICAgICAgICByYWRpdXNMZWdlbmQubWF4VmFsdWUgPSBsZWdlbmREYXRhLmdldChmaWVsZCkubWF4VmFsdWU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJhZGl1c0xlZ2VuZC5taW5WYWx1ZSA9IGNpcmNsZVJhZGl1c0V2b2x1dGlvblswXS5rZXkgKyAnJztcbiAgICAgICAgICAgIHJhZGl1c0xlZ2VuZC5tYXhWYWx1ZSA9IGNpcmNsZVJhZGl1c0V2b2x1dGlvbltjaXJjbGVSYWRpdXNFdm9sdXRpb24ubGVuZ3RoIC0gMV0ua2V5ICsgJyc7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJhZGl1c0xlZ2VuZC50eXBlID0gUFJPUEVSVFlfU0VMRUNUT1JfU09VUkNFLmludGVycG9sYXRlZDtcbiAgICAgICAgICBjb25zdCBtYXhDaXJjbGVSYWRpdXMgPSBnZXRNYXgoY2lyY2xlUmFkaXVzRXZvbHV0aW9uKTtcbiAgICAgICAgICBpZiAobWF4Q2lyY2xlUmFkaXVzID4gTUFYX0NJUkxFX1JBRElVUykge1xuICAgICAgICAgICAgY2lyY2xlUmFkaXVzRXZvbHV0aW9uLmZvckVhY2gobHcgPT4gbHcudmFsdWUgPSBsdy52YWx1ZSAqIE1BWF9DSVJMRV9SQURJVVMgLyBtYXhDaXJjbGVSYWRpdXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByYWRpdXNMZWdlbmQuaGlzdG9ncmFtID0gY2lyY2xlUmFkaXVzRXZvbHV0aW9uO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByYWRpdXNMZWdlbmQ7XG5cbiAgfTtcblxuICBwcm90ZWN0ZWQgc3RhdGljIGJ1aWxkV2lkdGhMZWdlbmQobGluZVdpZHRoOiBudW1iZXIgfCBhbnksXG4gICAgbGVnZW5kRGF0YTogTWFwPHN0cmluZywgTGVnZW5kRGF0YT4pOiBMZWdlbmQge1xuICAgIC8qKiBpZiB0aGUgbGluZSB3aWR0aCBpcyBmaXggdGhlbiBpdCBpcyBub3QgYWRkZWQgdG8gdGhlIGxlZ2VuZCovXG4gICAgY29uc3Qgd2lkdGhMZWdlbmQ6IExlZ2VuZCA9IHt9O1xuICAgIGlmIChBcnJheS5pc0FycmF5KGxpbmVXaWR0aCkpIHtcbiAgICAgIGlmIChsaW5lV2lkdGgubGVuZ3RoID49IDMpIHtcbiAgICAgICAgaWYgKGxpbmVXaWR0aFswXSA9PT0gSU5URVJQT0xBVEUpIHtcbiAgICAgICAgICBjb25zdCBmaWVsZCA9IGxpbmVXaWR0aFsyXVsxXTtcbiAgICAgICAgICB3aWR0aExlZ2VuZC50aXRsZSA9IGZpZWxkO1xuICAgICAgICAgIGlmIChsZWdlbmREYXRhPy5nZXQoZmllbGQpKSB7XG4gICAgICAgICAgICB3aWR0aExlZ2VuZC5taW5WYWx1ZSA9IGxlZ2VuZERhdGEuZ2V0KGZpZWxkKS5taW5WYWx1ZTtcbiAgICAgICAgICAgIHdpZHRoTGVnZW5kLm1heFZhbHVlID0gbGVnZW5kRGF0YS5nZXQoZmllbGQpLm1heFZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICB3aWR0aExlZ2VuZC50eXBlID0gUFJPUEVSVFlfU0VMRUNUT1JfU09VUkNFLmludGVycG9sYXRlZDtcbiAgICAgICAgICBjb25zdCBsaW5lV2lkdGhFdm9sdXRpb246IEFycmF5PEhpc3RvZ3JhbURhdGE+ID0gbmV3IEFycmF5KCk7XG4gICAgICAgICAgbGluZVdpZHRoLmZpbHRlcigodywgaSkgPT4gaSA+PSAzKS5mb3JFYWNoKCh3LCBpKSA9PiB7XG4gICAgICAgICAgICBpZiAoaSAlIDIgPT09IDApIHtcbiAgICAgICAgICAgICAgbGluZVdpZHRoRXZvbHV0aW9uLnB1c2goeyBrZXk6IHcsIHZhbHVlOiBsaW5lV2lkdGhbaSArIDEgKyAzXSB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCBtYXhMaW5lV2lkdGggPSBnZXRNYXgobGluZVdpZHRoRXZvbHV0aW9uKTtcbiAgICAgICAgICBpZiAobWF4TGluZVdpZHRoID4gTUFYX0xJTkVfV0lEVEgpIHtcbiAgICAgICAgICAgIGxpbmVXaWR0aEV2b2x1dGlvbi5mb3JFYWNoKGx3ID0+IGx3LnZhbHVlID0gbHcudmFsdWUgKiBNQVhfTElORV9XSURUSCAvIG1heExpbmVXaWR0aCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHdpZHRoTGVnZW5kLmhpc3RvZ3JhbSA9IGxpbmVXaWR0aEV2b2x1dGlvbjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gd2lkdGhMZWdlbmQ7XG4gIH1cblxufVxuIl19