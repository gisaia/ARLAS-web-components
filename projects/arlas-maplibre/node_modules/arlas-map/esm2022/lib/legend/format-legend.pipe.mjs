/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Pipe } from '@angular/core';
import { marker } from '@colsen1991/ngx-translate-extract-marker';
import { CollectionService } from 'arlas-web-components';
import * as i0 from "@angular/core";
import * as i1 from "arlas-web-components";
export class FormatLegendPipe {
    constructor(collectionService) {
        this.collectionService = collectionService;
        this.metrics = [
            'avg',
            'sum',
            'min',
            'max',
            'cardinality',
            'count'
        ];
    }
    transform(field) {
        let params = {
            translateKey: this.collectionService.getDisplayFieldName(field),
            format: 'original'
        };
        if (!field) {
            return null;
        }
        const parts = field.split(':');
        // Regular normalized
        const containsNormalizedPartOrMetric = parts.length === 2
            // Normalized by key
            || parts.length === 3
            // Metric
            || (parts.length === 1 && this.containsMetrics(parts[0]));
        if (containsNormalizedPartOrMetric) {
            const valueSplit = parts[0].split('_');
            if (valueSplit.length === 0) {
                return params;
            }
            const hasExtraEmptyValue = valueSplit[valueSplit.length - 1] === '';
            if (hasExtraEmptyValue) {
                valueSplit.splice(valueSplit.length - 1, 1);
            }
            const metric = this.getMetric(valueSplit);
            const field = this.getField(valueSplit);
            const normalized = parts[1] ?? '';
            const normalizedKey = parts[2] ?? '';
            params = this.buildInterpolatedParams(params, metric, field, normalized, normalizedKey);
        }
        else if (parts[0].endsWith('_arlas__color')) {
            params.translateKey = this.collectionService.getDisplayFieldName(params.translateKey.replace('_arlas__color', ''));
        }
        return params;
    }
    buildInterpolatedParams(params, metric, field, normalized, normalizedKey) {
        const legendParams = {
            ...params,
            field: this.collectionService.getDisplayFieldName(field),
            normalized: '',
            metric,
        };
        if (!metric) {
            legendParams.format = 'noMetric';
            legendParams.translateKey = marker('legend without metric');
        }
        else if (field && normalized) {
            legendParams.format = 'full';
            legendParams.translateKey = marker('legend');
        }
        else if (field) {
            legendParams.format = 'metricField';
            legendParams.translateKey = marker('legend without normalized');
        }
        else if (normalized) {
            legendParams.format = 'metricNormalised';
            legendParams.translateKey = marker('legend without field');
        }
        if (normalized) {
            if (normalizedKey) {
                legendParams.normalized = marker('normalized by key');
                legendParams.normalizedKey = normalizedKey;
            }
            else {
                legendParams.normalized = marker('normalized');
            }
        }
        return legendParams;
    }
    getMetric(valueSplit) {
        if (this.isMetrics(valueSplit[valueSplit.length - 1])) {
            return valueSplit[valueSplit.length - 1];
        }
    }
    getField(valueSplit) {
        // If last split is a metric, then exclude it
        if (this.isMetrics(valueSplit[valueSplit.length - 1])) {
            return valueSplit.slice(0, valueSplit.length - 1).join('_');
        }
        return valueSplit.join('_');
    }
    isMetrics(metrics) {
        return this.metrics.includes(metrics);
    }
    containsMetrics(value) {
        for (const metric of this.metrics) {
            if (value.includes(metric)) {
                return true;
            }
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: FormatLegendPipe, deps: [{ token: i1.CollectionService }], target: i0.ɵɵFactoryTarget.Pipe }); }
    static { this.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "14.0.0", version: "18.2.13", ngImport: i0, type: FormatLegendPipe, name: "formatLegend" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: FormatLegendPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'formatLegend'
                }]
        }], ctorParameters: () => [{ type: i1.CollectionService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LWxlZ2VuZC5waXBlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvbGVnZW5kL2Zvcm1hdC1sZWdlbmQucGlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFDSCxPQUFPLEVBQUUsSUFBSSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDbEUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7OztBQWlDekQsTUFBTSxPQUFPLGdCQUFnQjtJQUUzQixZQUFvQyxpQkFBb0M7UUFBcEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUV2RCxZQUFPLEdBQWE7WUFDbkMsS0FBSztZQUNMLEtBQUs7WUFDTCxLQUFLO1lBQ0wsS0FBSztZQUNMLGFBQWE7WUFDYixPQUFPO1NBQ1IsQ0FBQztJQVJGLENBQUM7SUFVTSxTQUFTLENBQUMsS0FBYTtRQUM1QixJQUFJLE1BQU0sR0FBdUI7WUFDL0IsWUFBWSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUM7WUFDL0QsTUFBTSxFQUFFLFVBQVU7U0FDbkIsQ0FBQztRQUVGLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IscUJBQXFCO1FBQ3JCLE1BQU0sOEJBQThCLEdBQUcsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQ3ZELG9CQUFvQjtlQUNqQixLQUFLLENBQUMsTUFBTSxLQUFLLENBQUM7WUFDckIsU0FBUztlQUNOLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLElB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VSxnQkFBZ0I7NkdBQWhCLGdCQUFnQjs7NEZBQWhCLGdCQUFnQjtrQkFINUIsSUFBSTttQkFBQztvQkFDSixJQUFJLEVBQUUsY0FBYztpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTGljZW5zZWQgdG8gR2lzYcOvYSB1bmRlciBvbmUgb3IgbW9yZSBjb250cmlidXRvclxuICogbGljZW5zZSBhZ3JlZW1lbnRzLiBTZWUgdGhlIE5PVElDRS50eHQgZmlsZSBkaXN0cmlidXRlZCB3aXRoXG4gKiB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGNvcHlyaWdodFxuICogb3duZXJzaGlwLiBHaXNhw69hIGxpY2Vuc2VzIHRoaXMgZmlsZSB0byB5b3UgdW5kZXJcbiAqIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7IHlvdSBtYXlcbiAqIG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsXG4gKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhblxuICogXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTllcbiAqIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZVxuICogc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9uc1xuICogdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cbmltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG1hcmtlciB9IGZyb20gJ0Bjb2xzZW4xOTkxL25neC10cmFuc2xhdGUtZXh0cmFjdC1tYXJrZXInO1xuaW1wb3J0IHsgQ29sbGVjdGlvblNlcnZpY2UgfSBmcm9tICdhcmxhcy13ZWItY29tcG9uZW50cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGVnZW5kUGFyYW1zUmVzdWx0IHtcbiAgdHJhbnNsYXRlS2V5OiBzdHJpbmc7XG4gIGZpZWxkPzogc3RyaW5nO1xuICBub3JtYWxpemVkPzogc3RyaW5nO1xuICBub3JtYWxpemVkS2V5Pzogc3RyaW5nO1xuICBtZXRyaWM/OiBzdHJpbmc7XG4gIGZvcm1hdDogUGFyYW1zUmVzdWx0VHlwZTtcbn1cblxuLyoqXG4gKiBmdWxsIDpcbiAqICByZXR1cm4gYWxsIGludGVycG9sYXRlZCB2YWx1ZXMgdG8gY29uc3RydWN0IGEgdGl0bGUgbGVnZW5kXG4gKiAgZXg6IEF2ZXJhZ2Ugb2YgYm9hdHMgKG5vcm1hbGl6ZWQpXG4gKiBtZXRyaWNGaWVsZCA6XG4gKiAgcmV0dXJuIG1ldHJpYyBhbmQgZmllbGQgaW50ZXJwb2xhdGVkIHZhbHVlcy5cbiAqICBleDogQXZlcmFnZSBvZiBib2F0c1xuICogbWV0cmljTm9ybWFsaXNlZCA6XG4gKiAgIHJldHVybiBtZXRyaWMgYW5kIG5vcm1hbGl6ZWQgaW50ZXJwb2xhdGVkIHZhbHVlcy5cbiAqICAgZXg6IGNvdW50IChub3JtYWxpemVkKVxuICogbm9NZXRyaWMgOlxuICogICByZXR1cm4gZmllbGQgYW5kIG5vcm1hbGl6ZWQgaW50ZXJwb2xhdGVkIHZhbHVlcy5cbiAqICAgZXg6IEJvYXQgdmlzaWJpbGl0eSAobm9ybWFsaXplZClcbiAqIG9yaWdpbmFsXG4gKiAgIHJldHVybiB0aGUgb3JpZ2luYWwga2V5IHRvIGJlIHRyYW5zbGF0ZWQuIFRoaXMgY2FzZSBhcHBlYXIgb25seSBpZiB3ZSBmYWlsXG4gKiAgIHRvIHBhcnNlIG9mIGlmIHdlIGhhdmUgYW4gZXJyb3IuXG4gKi9cbmV4cG9ydCB0eXBlICBQYXJhbXNSZXN1bHRUeXBlID0gJ2Z1bGwnIHwgJ21ldHJpY0ZpZWxkJyB8ICdtZXRyaWNOb3JtYWxpc2VkJyB8ICdub01ldHJpYycgfCAnb3JpZ2luYWwnO1xuXG5AUGlwZSh7XG4gIG5hbWU6ICdmb3JtYXRMZWdlbmQnXG59KVxuZXhwb3J0IGNsYXNzIEZvcm1hdExlZ2VuZFBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcblxuICBwdWJsaWMgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjb2xsZWN0aW9uU2VydmljZTogQ29sbGVjdGlvblNlcnZpY2UpIHtcbiAgfVxuICBwcml2YXRlIHJlYWRvbmx5IG1ldHJpY3M6IHN0cmluZ1tdID0gW1xuICAgICdhdmcnLFxuICAgICdzdW0nLFxuICAgICdtaW4nLFxuICAgICdtYXgnLFxuICAgICdjYXJkaW5hbGl0eScsXG4gICAgJ2NvdW50J1xuICBdO1xuXG4gIHB1YmxpYyB0cmFuc2Zvcm0oZmllbGQ6IHN0cmluZyk6IExlZ2VuZFBhcmFtc1Jlc3VsdCB8IG51bGwge1xuICAgIGxldCBwYXJhbXM6IExlZ2VuZFBhcmFtc1Jlc3VsdCA9IHtcbiAgICAgIHRyYW5zbGF0ZUtleTogdGhpcy5jb2xsZWN0aW9uU2VydmljZS5nZXREaXNwbGF5RmllbGROYW1lKGZpZWxkKSxcbiAgICAgIGZvcm1hdDogJ29yaWdpbmFsJ1xuICAgIH07XG5cbiAgICBpZiAoIWZpZWxkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJ0cyA9IGZpZWxkLnNwbGl0KCc6Jyk7XG4gICAgLy8gUmVndWxhciBub3JtYWxpemVkXG4gICAgY29uc3QgY29udGFpbnNOb3JtYWxpemVkUGFydE9yTWV0cmljID0gcGFydHMubGVuZ3RoID09PSAyXG4gICAgICAvLyBOb3JtYWxpemVkIGJ5IGtleVxuICAgICAgfHwgcGFydHMubGVuZ3RoID09PSAzXG4gICAgICAvLyBNZXRyaWNcbiAgICAgIHx8IChwYXJ0cy5sZW5ndGggPT09IDEgJiYgdGhpcy5jb250YWluc01ldHJpY3MocGFydHNbMF0pKTtcblxuICAgIGlmIChjb250YWluc05vcm1hbGl6ZWRQYXJ0T3JNZXRyaWMpIHtcbiAgICAgIGNvbnN0IHZhbHVlU3BsaXQgPSBwYXJ0c1swXS5zcGxpdCgnXycpO1xuICAgICAgaWYgKHZhbHVlU3BsaXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBwYXJhbXM7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGhhc0V4dHJhRW1wdHlWYWx1ZSA9IHZhbHVlU3BsaXRbdmFsdWVTcGxpdC5sZW5ndGggLSAxXSA9PT0gJyc7XG4gICAgICBpZiAoaGFzRXh0cmFFbXB0eVZhbHVlKSB7XG4gICAgICAgIHZhbHVlU3BsaXQuc3BsaWNlKHZhbHVlU3BsaXQubGVuZ3RoIC0gMSwgMSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1ldHJpYyA9IHRoaXMuZ2V0TWV0cmljKHZhbHVlU3BsaXQpO1xuICAgICAgY29uc3QgZmllbGQgPSB0aGlzLmdldEZpZWxkKHZhbHVlU3BsaXQpO1xuICAgICAgY29uc3Qgbm9ybWFsaXplZCA9IHBhcnRzWzFdID8/ICcnO1xuICAgICAgY29uc3Qgbm9ybWFsaXplZEtleSA9ICBwYXJ0c1syXSA/PyAnJztcbiAgICAgIHBhcmFtcyA9IHRoaXMuYnVpbGRJbnRlcnBvbGF0ZWRQYXJhbXMocGFyYW1zLCBtZXRyaWMsIGZpZWxkLCBub3JtYWxpemVkLCBub3JtYWxpemVkS2V5KTtcbiAgICB9IGVsc2UgaWYgKHBhcnRzWzBdLmVuZHNXaXRoKCdfYXJsYXNfX2NvbG9yJykpe1xuICAgICAgcGFyYW1zLnRyYW5zbGF0ZUtleSA9IHRoaXMuY29sbGVjdGlvblNlcnZpY2UuZ2V0RGlzcGxheUZpZWxkTmFtZShwYXJhbXMudHJhbnNsYXRlS2V5LnJlcGxhY2UoJ19hcmxhc19fY29sb3InLCAnJykpO1xuICAgIH1cblxuICAgIHJldHVybiBwYXJhbXM7XG4gIH1cblxuICBwdWJsaWMgYnVpbGRJbnRlcnBvbGF0ZWRQYXJhbXMocGFyYW1zOiBMZWdlbmRQYXJhbXNSZXN1bHQsIG1ldHJpYzogc3RyaW5nLCBmaWVsZDogc3RyaW5nLFxuICAgICAgbm9ybWFsaXplZDogc3RyaW5nLCBub3JtYWxpemVkS2V5OiBzdHJpbmcpOiBMZWdlbmRQYXJhbXNSZXN1bHQge1xuICAgIGNvbnN0IGxlZ2VuZFBhcmFtczogTGVnZW5kUGFyYW1zUmVzdWx0ID0ge1xuICAgICAgLi4ucGFyYW1zLFxuICAgICAgZmllbGQ6IHRoaXMuY29sbGVjdGlvblNlcnZpY2UuZ2V0RGlzcGxheUZpZWxkTmFtZShmaWVsZCksXG4gICAgICBub3JtYWxpemVkOiAnJyxcbiAgICAgIG1ldHJpYyxcbiAgICB9O1xuXG4gICAgaWYgKCFtZXRyaWMpIHtcbiAgICAgIGxlZ2VuZFBhcmFtcy5mb3JtYXQgPSAnbm9NZXRyaWMnO1xuICAgICAgbGVnZW5kUGFyYW1zLnRyYW5zbGF0ZUtleSA9IG1hcmtlcignbGVnZW5kIHdpdGhvdXQgbWV0cmljJyk7XG4gICAgfSBlbHNlIGlmIChmaWVsZCAmJiBub3JtYWxpemVkKSB7XG4gICAgICBsZWdlbmRQYXJhbXMuZm9ybWF0ID0gJ2Z1bGwnO1xuICAgICAgbGVnZW5kUGFyYW1zLnRyYW5zbGF0ZUtleSA9IG1hcmtlcignbGVnZW5kJyk7XG4gICAgfSBlbHNlIGlmIChmaWVsZCkge1xuICAgICAgbGVnZW5kUGFyYW1zLmZvcm1hdCA9ICdtZXRyaWNGaWVsZCc7XG4gICAgICBsZWdlbmRQYXJhbXMudHJhbnNsYXRlS2V5ID0gIG1hcmtlcignbGVnZW5kIHdpdGhvdXQgbm9ybWFsaXplZCcpO1xuICAgIH0gZWxzZSBpZiAobm9ybWFsaXplZCkge1xuICAgICAgbGVnZW5kUGFyYW1zLmZvcm1hdCA9ICdtZXRyaWNOb3JtYWxpc2VkJztcbiAgICAgIGxlZ2VuZFBhcmFtcy50cmFuc2xhdGVLZXkgPSAgbWFya2VyKCdsZWdlbmQgd2l0aG91dCBmaWVsZCcpO1xuICAgIH1cblxuICAgIGlmIChub3JtYWxpemVkKSB7XG4gICAgICBpZiAobm9ybWFsaXplZEtleSkge1xuICAgICAgICBsZWdlbmRQYXJhbXMubm9ybWFsaXplZCA9IG1hcmtlcignbm9ybWFsaXplZCBieSBrZXknKTtcbiAgICAgICAgbGVnZW5kUGFyYW1zLm5vcm1hbGl6ZWRLZXkgPSBub3JtYWxpemVkS2V5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGVnZW5kUGFyYW1zLm5vcm1hbGl6ZWQgPSBtYXJrZXIoJ25vcm1hbGl6ZWQnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbGVnZW5kUGFyYW1zO1xuICB9XG5cbiAgcHVibGljIGdldE1ldHJpYyh2YWx1ZVNwbGl0OiBzdHJpbmdbXSkge1xuICAgIGlmICh0aGlzLmlzTWV0cmljcyh2YWx1ZVNwbGl0W3ZhbHVlU3BsaXQubGVuZ3RoIC0gMV0pKSB7XG4gICAgICByZXR1cm4gdmFsdWVTcGxpdFt2YWx1ZVNwbGl0Lmxlbmd0aCAtIDFdO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRGaWVsZCh2YWx1ZVNwbGl0OiBzdHJpbmdbXSkge1xuICAgIC8vIElmIGxhc3Qgc3BsaXQgaXMgYSBtZXRyaWMsIHRoZW4gZXhjbHVkZSBpdFxuICAgIGlmICh0aGlzLmlzTWV0cmljcyh2YWx1ZVNwbGl0W3ZhbHVlU3BsaXQubGVuZ3RoIC0gMV0pKSB7XG4gICAgICByZXR1cm4gdmFsdWVTcGxpdC5zbGljZSgwLCB2YWx1ZVNwbGl0Lmxlbmd0aCAtIDEpLmpvaW4oJ18nKTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlU3BsaXQuam9pbignXycpO1xuICB9XG5cbiAgcHVibGljIGlzTWV0cmljcyhtZXRyaWNzOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5tZXRyaWNzLmluY2x1ZGVzKG1ldHJpY3MpO1xuICB9XG5cbiAgcHVibGljIGNvbnRhaW5zTWV0cmljcyh2YWx1ZTogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCBtZXRyaWMgb2YgdGhpcy5tZXRyaWNzKSB7XG4gICAgICBpZiAodmFsdWUuaW5jbHVkZXMobWV0cmljKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxufVxuIl19