/*
 * Licensed to Gisaïa under one or more contributor
 * license agreements. See the NOTICE.txt file distributed with
 * this work for additional information regarding copyright
 * ownership. Gisaïa licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
import { Component, computed, Input, Output, signal, ViewChild } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { ArlasColorService } from 'arlas-web-components';
import { scaleLinear } from 'd3-scale';
import { select } from 'd3-selection';
import { area, curveLinear, line } from 'd3-shape';
import { Subject, takeUntil } from 'rxjs';
import { ARLAS_ID, FILLSTROKE_LAYER_PREFIX, HOVER_LAYER_PREFIX, SELECT_LAYER_PREFIX } from '../map/model/layers';
import { PROPERTY_SELECTOR_SOURCE } from './legend.config';
import { LegendService } from './legend.service';
import { MAX_LINE_WIDTH } from './legend.tools';
import * as i0 from "@angular/core";
import * as i1 from "@ngx-translate/core";
import * as i2 from "arlas-web-components";
import * as i3 from "./legend.service";
import * as i4 from "@angular/material/icon";
import * as i5 from "@angular/material/menu";
import * as i6 from "@angular/material/tooltip";
import * as i7 from "./legend-icon/layer-icon.component";
import * as i8 from "./legend-item/legend-item.component";
import * as i9 from "@colsen1991/ngx-translate-extract-marker/extras";
import * as i10 from "./layer-name.pipe";
export class LegendComponent {
    constructor(translate, colorService, legendService) {
        this.translate = translate;
        this.colorService = colorService;
        this.legendService = legendService;
        /**
         * @Input : Angular
         * @description Subject of [collection, [field, legendData]] map. The map subscribes to it to keep
         * the legend updated with the data displayed on the map.
         */
        this.legendUpdater = new Subject();
        /**
         * @Input : Angular
         * @description Subject of [field, boolean] map. The map subscribes to it to keep
         * the legend updated with the visibility of the layer.
         */
        this.visibilityUpdater = new Subject();
        /**
         * @Output : Angular
         * @description Notifies the parent component that this layer is visible or not
         */
        this.visibilityStatus = new Subject();
        /**
         * @Output : Angular
         * @description Notifies the parent component that the user wants to download the layer
         */
        this.downloadSourceEmitter = new Subject();
        this.colorLegend = signal({});
        this.hasColorLegend = computed(() => this.colorLegend().type !== undefined && this.colorLegend().type !== 'Fix');
        this.strokeColorLegend = signal({});
        this.hasStrokeLegend = computed(() => this.strokeColorLegend().type !== undefined && this.strokeColorLegend().type !== 'Fix');
        this.widthLegend = signal({});
        this.hasWidthLegend = computed(() => this.widthLegend().type !== undefined && this.widthLegend().type !== 'Fix');
        this.radiusLegend = signal({});
        this.hasRadiusLegend = computed(() => this.radiusLegend().type !== undefined && this.radiusLegend().type !== 'Fix');
        this.displayLegendDetailToggle = computed(() => this.hasColorLegend() || this.hasStrokeLegend() || this.hasWidthLegend() || this.hasRadiusLegend());
        this.detail = false;
        this.visibleMode = false;
        this.PROPERTY_SELECTOR_SOURCE = PROPERTY_SELECTOR_SOURCE;
        this.legendData = new Map();
        this.colorPalette = '';
        this.strokeColorPalette = '';
        this.MAX_CIRLE_RADIUS = 7;
        this.LEGEND_WIDTH = 210;
        this._onDestroy$ = new Subject();
    }
    ngOnInit() {
        this.legendUpdater
            .pipe(takeUntil(this._onDestroy$))
            .subscribe(legendDataPerCollection => {
            this.legendData = legendDataPerCollection.get(this.collection);
            if (this.layer) {
                this.drawLegends(this.visibleMode);
            }
        });
        this.visibilityUpdater
            .pipe(takeUntil(this._onDestroy$))
            .subscribe(visibilityUpdater => {
            /** check legend visibility according to Data source status (mapcontirbutor) */
            if (this.layer) {
                /** if the visibility updater contains the layer we pick the visibility status otherwise we keep it unchaged */
                this.visibleMode = visibilityUpdater.get(this.layer.id) !== undefined ? visibilityUpdater.get(this.layer.id) : this.visibleMode;
            }
            else {
                this.visibleMode = false;
            }
            /** check legend visibility according to VisibilityRules */
            if (this.visibleMode && this.layer && !!this.layer.minzoom && !!this.layer.maxzoom) {
                this.visibleMode = (this.zoom <= this.layer.maxzoom && this.zoom >= this.layer.minzoom);
            }
            /** check legend visibility according to legend enabled or not */
            if (!this.enabled) {
                this.visibleMode = false;
            }
            if (!this.visibleMode) {
                this.detail = this.visibleMode;
            }
            /** check legend visibility for external layers that are not set by config nor map contributors */
            if (this.layer && !this.layer.id.startsWith(ARLAS_ID) &&
                !this.layer.id.startsWith(FILLSTROKE_LAYER_PREFIX) && !this.layer.id.startsWith(HOVER_LAYER_PREFIX)
                && !this.layer.id.startsWith(SELECT_LAYER_PREFIX)) {
                this.visibleMode = this.enabled;
                if (!!this.layer.metadata && this.layer.metadata.showLegend === false) {
                    this.visibleMode = false;
                }
            }
            if (this.layer) {
                this.drawLegends(this.visibleMode);
            }
            this.visibilityStatus.next(this.visibleMode);
        });
    }
    ngAfterViewInit() {
        if (this.layer) {
            this.drawLegends(this.visibleMode);
        }
    }
    ngOnChanges(changes) {
        if (changes['layer'] !== undefined) {
            if (this.layer) {
                this.drawLegends(this.visibleMode);
            }
        }
    }
    ngOnDestroy() {
        this._onDestroy$.next(true);
        this._onDestroy$.complete();
    }
    downloadLayerSource(layer, downloadType) {
        const download = {
            layer,
            downloadType
        };
        this.downloadSourceEmitter.next(download);
    }
    showDetail(event) {
        this.detail = !this.detail;
        event.stopPropagation();
    }
    /** Parses the `paint` attribute of a layer and draws the legend elements such as
     * - color palette
     * - line width evolution
     * - circle radius evolution
     */
    drawLegends(visibileMode) {
        const type = this.layer.type;
        const paint = this.layer.paint;
        switch (type) {
            case 'circle': {
                const circleLegend = this.legendService.getCircleLegend(paint, visibileMode, this.legendData, this.layer);
                this.colorLegend.set(circleLegend.color);
                // For circle-heatmap layer the stroke can't be configured, so hide it
                if (this.layer.metadata?.hiddenProps?.geomType !== 'circle-heatmap') {
                    this.strokeColorLegend.set(circleLegend.strokeColor);
                }
                this.colorPalette = circleLegend.colorPalette;
                this.strokeColorPalette = circleLegend.strokeColorPalette;
                this.radiusLegend.set(circleLegend.radius);
                if (this.circleRadiusLegend?.interpolatedElement) {
                    const circleRadiusEvolution = circleLegend.radius.histogram;
                    drawCircleSupportLine(this.circleRadiusLegend.interpolatedElement.nativeElement, circleRadiusEvolution, this.colorLegend(), this.LEGEND_WIDTH, Math.min(this.MAX_CIRLE_RADIUS, getMax(circleRadiusEvolution)) * 2);
                }
                break;
            }
            case 'line': {
                const lineLegend = this.legendService.getLineLegend(paint, visibileMode, this.legendData, this.layer);
                this.lineDasharray = lineLegend.dashes;
                this.colorLegend.set(lineLegend.color);
                this.colorPalette = lineLegend.colorPalette;
                this.widthLegend.set(lineLegend.width);
                if (this.lineWidthLegend?.interpolatedElement) {
                    const lineWidthEvolution = lineLegend.width.histogram;
                    drawLineWidth(this.lineWidthLegend.interpolatedElement.nativeElement, lineWidthEvolution, this.colorLegend(), this.LEGEND_WIDTH, MAX_LINE_WIDTH);
                }
                break;
            }
            case 'fill': {
                const fillLegend = this.legendService.getFillLegend(paint, visibileMode, this.legendData, this.layer);
                this.colorLegend.set(fillLegend.color);
                this.colorPalette = fillLegend.colorPalette;
                this.strokeColorLegend.set(fillLegend?.strokeColor);
                this.strokeColorPalette = fillLegend?.strokeColorPalette;
                break;
            }
            case 'heatmap': {
                const heatmapLegend = this.legendService.getHeatmapLegend(paint, visibileMode, this.legendData, this.layer);
                this.colorLegend.set(heatmapLegend.color);
                this.colorPalette = heatmapLegend.colorPalette;
                this.radiusLegend.set(heatmapLegend.radius);
                if (this.circleRadiusLegend?.interpolatedElement) {
                    const heatmapRadiusEvolution = heatmapLegend.radius.histogram;
                    drawCircleSupportLine(this.circleRadiusLegend.interpolatedElement.nativeElement, heatmapRadiusEvolution, this.colorLegend(), this.LEGEND_WIDTH, Math.min(this.MAX_CIRLE_RADIUS, getMax(heatmapRadiusEvolution)) * 2);
                }
                break;
            }
            case 'symbol': {
                const symbolLegend = this.legendService.getLabelLegend(paint, visibileMode, this.legendData, this.layer);
                this.colorLegend.set(symbolLegend.color);
                this.colorPalette = symbolLegend.colorPalette;
                this.widthLegend.set(symbolLegend.size);
                if (!!this.lineWidthLegend && !!this.lineWidthLegend.interpolatedElement) {
                    const lineWidthEvolution = symbolLegend.size.histogram;
                    drawLineWidth(this.lineWidthLegend.interpolatedElement.nativeElement, lineWidthEvolution, this.colorLegend(), this.LEGEND_WIDTH, MAX_LINE_WIDTH);
                }
                break;
            }
        }
        if (!this.colorLegend().fixValue) {
            this.colorLegend().fixValue = visibileMode ? '#444' : '#d3d3d3';
        }
        const layer = { ...this.layer };
        this.layer = null;
        this.layer = { ...layer };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: LegendComponent, deps: [{ token: i1.TranslateService }, { token: i2.ArlasColorService }, { token: i3.LegendService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "18.2.13", type: LegendComponent, selector: "arlas-legend", inputs: { layer: "layer", collection: "collection", zoom: "zoom", enabled: "enabled", legendUpdater: "legendUpdater", visibilityUpdater: "visibilityUpdater" }, outputs: { visibilityStatus: "visibilityStatus", downloadSourceEmitter: "downloadSourceEmitter" }, viewQueries: [{ propertyName: "lineWidthLegend", first: true, predicate: ["width_legend"], descendants: true }, { propertyName: "circleRadiusLegend", first: true, predicate: ["radius_legend"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "\n<div class=\"layer_wrapper\">\n    <div class=collection_color [matTooltip]=\"'Collection:' | translate: {collection: (collection | getCollectionDisplayName)}\"\n      [style.backgroundColor]=\"!!collection ? (collection | getColor) : 'transparent'\"></div>\n    <div class=\"layer_container\" >\n      <div class=\"layer_icon_container\">\n        <div class=\"layer_icon\" >\n          <arlas-layer-icon [layer]=\"layer\" [colorLegend]=\"colorLegend()\" [strokeColorLegend]=\"strokeColorLegend()\"\n            [lineDasharray]=\"lineDasharray\" [widthLegend]=\"widthLegend()\" [radiusLegend]=\"radiusLegend()\"></arlas-layer-icon>\n        </div>\n        <div class=\"layer_name\" [style.color]=\"visibleMode ? '#444': '#d3d3d3'\">\n          {{layer?.id | layerIdToName | translate}}\n        </div>\n      </div>\n      <div class=\"layer_detail\">\n        <div class=\"download_button\">\n          <mat-icon class=\"download_icon\" [matMenuTriggerFor]=\"menu\" [matTooltip]=\"'Download the layer\\'s data' | translate\">file_download</mat-icon>\n          <mat-menu #menu=\"matMenu\">\n            <button mat-menu-item (click)=\"downloadLayerSource(layer, 'csv')\">\n              {{'CSV' | translate}}\n            </button>\n            <button mat-menu-item (click)=\"downloadLayerSource(layer, 'geojson')\">\n              {{'GeoJson' | translate}}\n            </button>\n          </mat-menu>\n        </div>\n\n        @if (displayLegendDetailToggle()) {\n          <div class=\"detail_button\" (click)=\"showDetail($event)\" (keyDown)=\"showDetail($event)\">\n            <mat-icon class=\"detail_icon\">{{ detail ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>\n          </div>\n        }\n      </div>\n    </div>\n\n    <div [hidden]=\"!detail\" class=\"legend-wrapper\">\n      <arlas-legend-item [hidden]=\"!hasColorLegend()\" [legend]=\"colorLegend()\" [layer]=\"layer\"\n        [title]=\"'Fill:' | marker\" [colorPalette]=\"colorPalette\"></arlas-legend-item>\n\n      <arlas-legend-item [hidden]=\"!hasStrokeLegend()\" [legend]=\"strokeColorLegend()\" [layer]=\"layer\"\n        [title]=\"'Stroke:' | marker\" [colorPalette]=\"colorPalette\"></arlas-legend-item>\n\n      <arlas-legend-item [hidden]=\"!hasWidthLegend()\" #width_legend [legend]=\"widthLegend()\" [layer]=\"layer\"\n        [title]=\"'Width:' | marker\"></arlas-legend-item>\n\n      <arlas-legend-item [hidden]=\"!hasRadiusLegend()\" #radius_legend [legend]=\"radiusLegend()\" [layer]=\"layer\"\n        [title]=\"'Radius:' | marker\"></arlas-legend-item>\n    </div>\n  </div>\n", styles: ["@charset \"UTF-8\";.layer_name{font-size:14px}.layer_wrapper{border-top:.4px #eaeaea solid}.collection_color{width:4px;background-color:transparent;height:100%;position:absolute;cursor:pointer;z-index:1000}.layer_container{display:flex;position:relative;justify-content:space-between;padding-left:15px;padding-top:2.5px;padding-bottom:2.5px}.layer_icon_container{display:flex;padding-left:5px}.layer_detail{display:flex}.detail_button,.download_button{background-color:#fff;height:20px;width:20px;cursor:pointer}.detail_icon,.download_icon{color:#555;font-size:16px;width:20px;height:20px;display:flex;align-items:center;justify-content:center}.layer_icon{margin-right:5px;display:flex}.legend-wrapper{width:210px;padding-left:10px}\n"], dependencies: [{ kind: "component", type: i4.MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }, { kind: "component", type: i5.MatMenu, selector: "mat-menu", inputs: ["backdropClass", "aria-label", "aria-labelledby", "aria-describedby", "xPosition", "yPosition", "overlapTrigger", "hasBackdrop", "class", "classList"], outputs: ["closed", "close"], exportAs: ["matMenu"] }, { kind: "component", type: i5.MatMenuItem, selector: "[mat-menu-item]", inputs: ["role", "disabled", "disableRipple"], exportAs: ["matMenuItem"] }, { kind: "directive", type: i5.MatMenuTrigger, selector: "[mat-menu-trigger-for], [matMenuTriggerFor]", inputs: ["mat-menu-trigger-for", "matMenuTriggerFor", "matMenuTriggerData", "matMenuTriggerRestoreFocus"], outputs: ["menuOpened", "onMenuOpen", "menuClosed", "onMenuClose"], exportAs: ["matMenuTrigger"] }, { kind: "directive", type: i6.MatTooltip, selector: "[matTooltip]", inputs: ["matTooltipPosition", "matTooltipPositionAtOrigin", "matTooltipDisabled", "matTooltipShowDelay", "matTooltipHideDelay", "matTooltipTouchGestures", "matTooltip", "matTooltipClass"], exportAs: ["matTooltip"] }, { kind: "component", type: i7.LayerIconComponent, selector: "arlas-layer-icon", inputs: ["layer", "colorLegend", "strokeColorLegend", "widthLegend", "radiusLegend", "lineDasharray"] }, { kind: "component", type: i8.LegendItemComponent, selector: "arlas-legend-item", inputs: ["legend", "title", "layer", "colorPalette"] }, { kind: "pipe", type: i1.TranslatePipe, name: "translate" }, { kind: "pipe", type: i2.GetCollectionDisplayNamePipe, name: "getCollectionDisplayName" }, { kind: "pipe", type: i2.GetColorPipe, name: "getColor" }, { kind: "pipe", type: i9.MarkerPipe, name: "marker" }, { kind: "pipe", type: i10.LayerIdToName, name: "layerIdToName" }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.13", ngImport: i0, type: LegendComponent, decorators: [{
            type: Component,
            args: [{ selector: 'arlas-legend', template: "\n<div class=\"layer_wrapper\">\n    <div class=collection_color [matTooltip]=\"'Collection:' | translate: {collection: (collection | getCollectionDisplayName)}\"\n      [style.backgroundColor]=\"!!collection ? (collection | getColor) : 'transparent'\"></div>\n    <div class=\"layer_container\" >\n      <div class=\"layer_icon_container\">\n        <div class=\"layer_icon\" >\n          <arlas-layer-icon [layer]=\"layer\" [colorLegend]=\"colorLegend()\" [strokeColorLegend]=\"strokeColorLegend()\"\n            [lineDasharray]=\"lineDasharray\" [widthLegend]=\"widthLegend()\" [radiusLegend]=\"radiusLegend()\"></arlas-layer-icon>\n        </div>\n        <div class=\"layer_name\" [style.color]=\"visibleMode ? '#444': '#d3d3d3'\">\n          {{layer?.id | layerIdToName | translate}}\n        </div>\n      </div>\n      <div class=\"layer_detail\">\n        <div class=\"download_button\">\n          <mat-icon class=\"download_icon\" [matMenuTriggerFor]=\"menu\" [matTooltip]=\"'Download the layer\\'s data' | translate\">file_download</mat-icon>\n          <mat-menu #menu=\"matMenu\">\n            <button mat-menu-item (click)=\"downloadLayerSource(layer, 'csv')\">\n              {{'CSV' | translate}}\n            </button>\n            <button mat-menu-item (click)=\"downloadLayerSource(layer, 'geojson')\">\n              {{'GeoJson' | translate}}\n            </button>\n          </mat-menu>\n        </div>\n\n        @if (displayLegendDetailToggle()) {\n          <div class=\"detail_button\" (click)=\"showDetail($event)\" (keyDown)=\"showDetail($event)\">\n            <mat-icon class=\"detail_icon\">{{ detail ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}</mat-icon>\n          </div>\n        }\n      </div>\n    </div>\n\n    <div [hidden]=\"!detail\" class=\"legend-wrapper\">\n      <arlas-legend-item [hidden]=\"!hasColorLegend()\" [legend]=\"colorLegend()\" [layer]=\"layer\"\n        [title]=\"'Fill:' | marker\" [colorPalette]=\"colorPalette\"></arlas-legend-item>\n\n      <arlas-legend-item [hidden]=\"!hasStrokeLegend()\" [legend]=\"strokeColorLegend()\" [layer]=\"layer\"\n        [title]=\"'Stroke:' | marker\" [colorPalette]=\"colorPalette\"></arlas-legend-item>\n\n      <arlas-legend-item [hidden]=\"!hasWidthLegend()\" #width_legend [legend]=\"widthLegend()\" [layer]=\"layer\"\n        [title]=\"'Width:' | marker\"></arlas-legend-item>\n\n      <arlas-legend-item [hidden]=\"!hasRadiusLegend()\" #radius_legend [legend]=\"radiusLegend()\" [layer]=\"layer\"\n        [title]=\"'Radius:' | marker\"></arlas-legend-item>\n    </div>\n  </div>\n", styles: ["@charset \"UTF-8\";.layer_name{font-size:14px}.layer_wrapper{border-top:.4px #eaeaea solid}.collection_color{width:4px;background-color:transparent;height:100%;position:absolute;cursor:pointer;z-index:1000}.layer_container{display:flex;position:relative;justify-content:space-between;padding-left:15px;padding-top:2.5px;padding-bottom:2.5px}.layer_icon_container{display:flex;padding-left:5px}.layer_detail{display:flex}.detail_button,.download_button{background-color:#fff;height:20px;width:20px;cursor:pointer}.detail_icon,.download_icon{color:#555;font-size:16px;width:20px;height:20px;display:flex;align-items:center;justify-content:center}.layer_icon{margin-right:5px;display:flex}.legend-wrapper{width:210px;padding-left:10px}\n"] }]
        }], ctorParameters: () => [{ type: i1.TranslateService }, { type: i2.ArlasColorService }, { type: i3.LegendService }], propDecorators: { layer: [{
                type: Input
            }], collection: [{
                type: Input
            }], zoom: [{
                type: Input
            }], enabled: [{
                type: Input
            }], legendUpdater: [{
                type: Input
            }], visibilityUpdater: [{
                type: Input
            }], visibilityStatus: [{
                type: Output
            }], downloadSourceEmitter: [{
                type: Output
            }], lineWidthLegend: [{
                type: ViewChild,
                args: ['width_legend', { static: false }]
            }], circleRadiusLegend: [{
                type: ViewChild,
                args: ['radius_legend', { static: false }]
            }] } });
/**
 * draws the line width legend
 * @param svgNode SVG element on which we append the line using d3.
 * @param lineWidths List of {key, linewidth}
 * @param cLegend Color legend, to give the drawn legend lines the same color on the map
 * @param legendWidth The width that the svg will take to draw the legend
 * @param legendHeight The height that the svg will take to draw the legend
 */
export function drawLineWidth(svgNode, lineWidths, cLegend, legendWidth, legendHeight) {
    const maxHeight = getMax(lineWidths);
    const xDomain = (scaleLinear()).range([0, legendWidth]);
    const xDomainExtent = [lineWidths[0].key, lineWidths[lineWidths.length - 1].key];
    xDomain.domain(xDomainExtent);
    const yDomain = scaleLinear().range([maxHeight, 0]);
    yDomain.domain([0, maxHeight]);
    const svg = select(svgNode).attr('width', legendWidth).attr('height', legendHeight);
    svg.selectAll('g').remove();
    const context = svg.append('g').attr('class', 'context');
    const ar = area()
        .curve(curveLinear)
        .x((d) => xDomain(d.key))
        .y0(maxHeight)
        .y1((d) => yDomain(d.value));
    const widthLineColor = getMiddleColor(cLegend);
    context.append('path')
        .datum(lineWidths)
        .style('fill', widthLineColor)
        .style('fill-opacity', 0.6)
        .style('stroke', widthLineColor)
        .style('stroke-opacity', 0.6)
        .style('stroke-width', 0.5)
        .attr('d', ar);
}
export function getMiddleColor(colorLegend) {
    let color = '';
    if (colorLegend.type === PROPERTY_SELECTOR_SOURCE.fix) {
        color = colorLegend.fixValue;
    }
    else if (colorLegend.type === PROPERTY_SELECTOR_SOURCE.interpolated) {
        const iv = colorLegend.interpolatedValues;
        if (iv.length === 1 || iv.length === 2) {
            color = iv[0];
        }
        else if (iv.length >= 3) {
            color = iv[Math.trunc(iv.length / 2)];
        }
    }
    else if (colorLegend.type === PROPERTY_SELECTOR_SOURCE.manual || colorLegend.type === PROPERTY_SELECTOR_SOURCE.generated
        || colorLegend.type === PROPERTY_SELECTOR_SOURCE.provided) {
        const iv = colorLegend.manualValues;
        if (iv) {
            if (iv.size === 1) {
                color = iv.keys().next().value;
            }
            else if (iv.size >= 2) {
                color = Array.from(iv.values())[Math.trunc(Array.from(iv.keys()).length / 2)];
            }
        }
    }
    return color;
}
/**
 * draws the circle radius legend
 * @param svgNode SVG element on which we append the circles using d3.
 * @param circlesRadiuses List of {key, circleradius}
 * @param cLegend Color legend, to give the drawn legend circles the same color on the map
 * @param legendWidth The width that the svg will take to draw the legend
 * @param legendHeight The height that the svg will take to draw the legend
 */
export function drawCircleSupportLine(svgNode, circlesRadiuses, cLegend, legendWidth, legendHeight) {
    const circleDiameters = [];
    circlesRadiuses.forEach(cr => circleDiameters.push({ key: cr.key, value: cr.value * 2 }));
    const maxHeight = getMax(circleDiameters);
    const firstRadius = circlesRadiuses[0].value;
    const lastRadius = circlesRadiuses[circlesRadiuses.length - 1].value;
    const xDomain = (scaleLinear()).range([0, legendWidth - firstRadius - lastRadius]);
    const xDomainExtent = [circleDiameters[0].key, circleDiameters[circleDiameters.length - 1].key];
    xDomain.domain(xDomainExtent);
    const yDomain = scaleLinear().range([maxHeight, 0]);
    yDomain.domain([0, maxHeight]);
    const svg = select(svgNode).attr('width', legendWidth).attr('height', legendHeight);
    svg.selectAll('g').remove();
    const context = svg.append('g').attr('class', 'context');
    const l = line()
        .x((d) => xDomain(d.key))
        .y((d) => yDomain(d.value));
    context.append('path')
        .datum(circleDiameters)
        .attr('fill', 'none')
        .attr('stroke', '#eaeaea')
        .attr('stroke-width', 0.8)
        .attr('transform', 'translate(' + firstRadius + ', 0)')
        .attr('d', l);
    context.append('g').append('line')
        .attr('x1', 0).attr('y1', maxHeight)
        .attr('x2', legendWidth - firstRadius - lastRadius).attr('y2', maxHeight)
        .attr('cx', 2).attr('cy', 2).attr('fill', 'none')
        .attr('stroke', '#eaeaea')
        .attr('stroke-width', 0.8)
        .attr('transform', 'translate(' + firstRadius + ', 0)');
    const circles = [circlesRadiuses[0], circlesRadiuses[circlesRadiuses.length - 1]];
    const circleColor = getMiddleColor(cLegend);
    context.append('g')
        .selectAll('dot').data(circles).enter().append('circle')
        .attr('r', (d) => d.value)
        .attr('cx', (d) => xDomain(d.key))
        .attr('cy', (d) => maxHeight - d.value)
        .attr('transform', 'translate(' + firstRadius + ', 0)')
        .style('fill', circleColor)
        .style('fill-opacity', 0.6)
        .style('stroke', circleColor)
        .style('stroke-width', 0.5);
}
export function getMax(data) {
    return Math.max(...data.map(hd => +hd.value));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVnZW5kLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FybGFzLW1hcC9zcmMvbGliL2xlZ2VuZC9sZWdlbmQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYXJsYXMtbWFwL3NyYy9saWIvbGVnZW5kL2xlZ2VuZC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFFSCxPQUFPLEVBQ1UsU0FBUyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQXFCLE1BQU0sRUFBRSxNQUFNLEVBQWlCLFNBQVMsRUFDdkcsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBZSxNQUFNLFVBQVUsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsUUFBUSxFQUFrQix1QkFBdUIsRUFBRSxrQkFBa0IsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pJLE9BQU8sRUFBc0Isd0JBQXdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7Ozs7QUFRaEQsTUFBTSxPQUFPLGVBQWU7SUE4RTFCLFlBQ1MsU0FB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QyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNoRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIExpY2Vuc2VkIHRvIEdpc2HDr2EgdW5kZXIgb25lIG9yIG1vcmUgY29udHJpYnV0b3JcbiAqIGxpY2Vuc2UgYWdyZWVtZW50cy4gU2VlIHRoZSBOT1RJQ0UudHh0IGZpbGUgZGlzdHJpYnV0ZWQgd2l0aFxuICogdGhpcyB3b3JrIGZvciBhZGRpdGlvbmFsIGluZm9ybWF0aW9uIHJlZ2FyZGluZyBjb3B5cmlnaHRcbiAqIG93bmVyc2hpcC4gR2lzYcOvYSBsaWNlbnNlcyB0aGlzIGZpbGUgdG8geW91IHVuZGVyXG4gKiB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5XG4gKiBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLFxuICogc29mdHdhcmUgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW5cbiAqIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZXG4gKiBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGVcbiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnNcbiAqIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgY29tcHV0ZWQsIElucHV0LCBPbkNoYW5nZXMsIE9uSW5pdCwgT3V0cHV0LCBzaWduYWwsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZCwgV3JpdGFibGVTaWduYWxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBIaXN0b2dyYW1EYXRhIH0gZnJvbSAnYXJsYXMtZDMvaGlzdG9ncmFtcy91dGlscy9IaXN0b2dyYW1VdGlscyc7XG5pbXBvcnQgeyBBcmxhc0NvbG9yU2VydmljZSB9IGZyb20gJ2FybGFzLXdlYi1jb21wb25lbnRzJztcbmltcG9ydCB7IHNjYWxlTGluZWFyLCBTY2FsZUxpbmVhciB9IGZyb20gJ2QzLXNjYWxlJztcbmltcG9ydCB7IHNlbGVjdCB9IGZyb20gJ2QzLXNlbGVjdGlvbic7XG5pbXBvcnQgeyBhcmVhLCBjdXJ2ZUxpbmVhciwgbGluZSB9IGZyb20gJ2QzLXNoYXBlJztcbmltcG9ydCB7IFN1YmplY3QsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQVJMQVNfSUQsIEFybGFzRGF0YUxheWVyLCBGSUxMU1RST0tFX0xBWUVSX1BSRUZJWCwgSE9WRVJfTEFZRVJfUFJFRklYLCBTRUxFQ1RfTEFZRVJfUFJFRklYIH0gZnJvbSAnLi4vbWFwL21vZGVsL2xheWVycyc7XG5pbXBvcnQgeyBMZWdlbmQsIExlZ2VuZERhdGEsIFBST1BFUlRZX1NFTEVDVE9SX1NPVVJDRSB9IGZyb20gJy4vbGVnZW5kLmNvbmZpZyc7XG5pbXBvcnQgeyBMZWdlbmRTZXJ2aWNlIH0gZnJvbSAnLi9sZWdlbmQuc2VydmljZSc7XG5pbXBvcnQgeyBNQVhfTElORV9XSURUSCB9IGZyb20gJy4vbGVnZW5kLnRvb2xzJztcblxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdhcmxhcy1sZWdlbmQnLFxuICB0ZW1wbGF0ZVVybDogJy4vbGVnZW5kLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbGVnZW5kLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTGVnZW5kQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMge1xuICAvKipcbiAgICogQElucHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gTGF5ZXIgb2JqZWN0XG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgbGF5ZXI6IEFybGFzRGF0YUxheWVyO1xuICAvKipcbiAgICogQElucHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gQ29sbGVjdGlvbiBvZiB0aGUgbGF5ZXJcbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBjb2xsZWN0aW9uOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBASW5wdXQgOiBBbmd1bGFyXG4gICAqIEBkZXNjcmlwdGlvbiBDdXJyZW50IHpvb20gbGV2ZWwgb2YgdGhlIG1hcFxuICAgKi9cbiAgQElucHV0KCkgcHVibGljIHpvb206IG51bWJlcjtcbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIFdoZXRoZXIgdGhlIGxheWVyIGlzIGVuYWJsZWQuXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgZW5hYmxlZDogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIFN1YmplY3Qgb2YgW2NvbGxlY3Rpb24sIFtmaWVsZCwgbGVnZW5kRGF0YV1dIG1hcC4gVGhlIG1hcCBzdWJzY3JpYmVzIHRvIGl0IHRvIGtlZXBcbiAgICogdGhlIGxlZ2VuZCB1cGRhdGVkIHdpdGggdGhlIGRhdGEgZGlzcGxheWVkIG9uIHRoZSBtYXAuXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgbGVnZW5kVXBkYXRlcjogU3ViamVjdDxNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBMZWdlbmREYXRhPj4+ID0gbmV3IFN1YmplY3QoKTtcbiAgLyoqXG4gICAqIEBJbnB1dCA6IEFuZ3VsYXJcbiAgICogQGRlc2NyaXB0aW9uIFN1YmplY3Qgb2YgW2ZpZWxkLCBib29sZWFuXSBtYXAuIFRoZSBtYXAgc3Vic2NyaWJlcyB0byBpdCB0byBrZWVwXG4gICAqIHRoZSBsZWdlbmQgdXBkYXRlZCB3aXRoIHRoZSB2aXNpYmlsaXR5IG9mIHRoZSBsYXllci5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyB2aXNpYmlsaXR5VXBkYXRlcjogU3ViamVjdDxNYXA8c3RyaW5nLCBib29sZWFuPj4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIC8qKlxuICAgKiBAT3V0cHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gTm90aWZpZXMgdGhlIHBhcmVudCBjb21wb25lbnQgdGhhdCB0aGlzIGxheWVyIGlzIHZpc2libGUgb3Igbm90XG4gICAqL1xuICBAT3V0cHV0KCkgcHVibGljIHZpc2liaWxpdHlTdGF0dXM6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIC8qKlxuICAgKiBAT3V0cHV0IDogQW5ndWxhclxuICAgKiBAZGVzY3JpcHRpb24gTm90aWZpZXMgdGhlIHBhcmVudCBjb21wb25lbnQgdGhhdCB0aGUgdXNlciB3YW50cyB0byBkb3dubG9hZCB0aGUgbGF5ZXJcbiAgICovXG4gIEBPdXRwdXQoKSBwdWJsaWMgZG93bmxvYWRTb3VyY2VFbWl0dGVyOiBTdWJqZWN0PHsgbGF5ZXI6IGFueTsgZG93bmxvYWRUeXBlOiBzdHJpbmc7IH0+ID0gbmV3IFN1YmplY3QoKTtcblxuICBAVmlld0NoaWxkKCd3aWR0aF9sZWdlbmQnLCB7IHN0YXRpYzogZmFsc2UgfSkgcHVibGljIGxpbmVXaWR0aExlZ2VuZDogYW55O1xuICBAVmlld0NoaWxkKCdyYWRpdXNfbGVnZW5kJywgeyBzdGF0aWM6IGZhbHNlIH0pIHB1YmxpYyBjaXJjbGVSYWRpdXNMZWdlbmQ6IGFueTtcblxuICBwdWJsaWMgbGluZURhc2hhcnJheTogQXJyYXk8bnVtYmVyPjtcblxuICBwdWJsaWMgY29sb3JMZWdlbmQ6IFdyaXRhYmxlU2lnbmFsPExlZ2VuZD4gPSBzaWduYWwoe30pO1xuICBwdWJsaWMgaGFzQ29sb3JMZWdlbmQgPSBjb21wdXRlZCgoKSA9PiB0aGlzLmNvbG9yTGVnZW5kKCkudHlwZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuY29sb3JMZWdlbmQoKS50eXBlICE9PSAnRml4Jyk7XG5cbiAgcHVibGljIHN0cm9rZUNvbG9yTGVnZW5kOiBXcml0YWJsZVNpZ25hbDxMZWdlbmQ+ID0gc2lnbmFsKHt9KTtcbiAgcHVibGljIGhhc1N0cm9rZUxlZ2VuZCA9IGNvbXB1dGVkKCgpID0+IHRoaXMuc3Ryb2tlQ29sb3JMZWdlbmQoKS50eXBlICE9PSB1bmRlZmluZWQgJiYgdGhpcy5zdHJva2VDb2xvckxlZ2VuZCgpLnR5cGUgIT09ICdGaXgnKTtcblxuICBwdWJsaWMgd2lkdGhMZWdlbmQ6IFdyaXRhYmxlU2lnbmFsPExlZ2VuZD4gPSBzaWduYWwoe30pO1xuICBwdWJsaWMgaGFzV2lkdGhMZWdlbmQgPSBjb21wdXRlZCgoKSA9PiB0aGlzLndpZHRoTGVnZW5kKCkudHlwZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMud2lkdGhMZWdlbmQoKS50eXBlICE9PSAnRml4Jyk7XG5cbiAgcHVibGljIHJhZGl1c0xlZ2VuZDogV3JpdGFibGVTaWduYWw8TGVnZW5kPiA9IHNpZ25hbCh7fSk7XG4gIHB1YmxpYyBoYXNSYWRpdXNMZWdlbmQgPSBjb21wdXRlZCgoKSA9PiB0aGlzLnJhZGl1c0xlZ2VuZCgpLnR5cGUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLnJhZGl1c0xlZ2VuZCgpLnR5cGUgIT09ICdGaXgnKTtcblxuICBwdWJsaWMgZGlzcGxheUxlZ2VuZERldGFpbFRvZ2dsZSA9IGNvbXB1dGVkKCgpID0+XG4gICAgdGhpcy5oYXNDb2xvckxlZ2VuZCgpIHx8IHRoaXMuaGFzU3Ryb2tlTGVnZW5kKCkgfHwgdGhpcy5oYXNXaWR0aExlZ2VuZCgpIHx8IHRoaXMuaGFzUmFkaXVzTGVnZW5kKCkpO1xuXG4gIHB1YmxpYyBkZXRhaWwgPSBmYWxzZTtcbiAgcHVibGljIHZpc2libGVNb2RlID0gZmFsc2U7XG4gIHB1YmxpYyBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0UgPSBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0U7XG5cbiAgcHJpdmF0ZSBsZWdlbmREYXRhOiBNYXA8c3RyaW5nLCBMZWdlbmREYXRhPiA9IG5ldyBNYXAoKTtcbiAgcHVibGljIGNvbG9yUGFsZXR0ZSA9ICcnO1xuICBwdWJsaWMgc3Ryb2tlQ29sb3JQYWxldHRlID0gJyc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBNQVhfQ0lSTEVfUkFESVVTID0gNztcbiAgcHJpdmF0ZSByZWFkb25seSBMRUdFTkRfV0lEVEggPSAyMTA7XG4gIHByaXZhdGUgcmVhZG9ubHkgX29uRGVzdHJveSQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICAgIHB1YmxpYyBjb2xvclNlcnZpY2U6IEFybGFzQ29sb3JTZXJ2aWNlLFxuICAgIHB1YmxpYyBsZWdlbmRTZXJ2aWNlOiBMZWdlbmRTZXJ2aWNlXG4gICkgeyB9XG5cbiAgcHVibGljIG5nT25Jbml0KCkge1xuICAgIHRoaXMubGVnZW5kVXBkYXRlclxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuX29uRGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZShsZWdlbmREYXRhUGVyQ29sbGVjdGlvbiA9PiB7XG5cbiAgICAgICAgdGhpcy5sZWdlbmREYXRhID0gbGVnZW5kRGF0YVBlckNvbGxlY3Rpb24uZ2V0KHRoaXMuY29sbGVjdGlvbik7XG4gICAgICAgIGlmICh0aGlzLmxheWVyKSB7XG4gICAgICAgICAgdGhpcy5kcmF3TGVnZW5kcyh0aGlzLnZpc2libGVNb2RlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgdGhpcy52aXNpYmlsaXR5VXBkYXRlclxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuX29uRGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZSh2aXNpYmlsaXR5VXBkYXRlciA9PiB7XG4gICAgICAgIC8qKiBjaGVjayBsZWdlbmQgdmlzaWJpbGl0eSBhY2NvcmRpbmcgdG8gRGF0YSBzb3VyY2Ugc3RhdHVzIChtYXBjb250aXJidXRvcikgKi9cbiAgICAgICAgaWYgKHRoaXMubGF5ZXIpIHtcbiAgICAgICAgICAvKiogaWYgdGhlIHZpc2liaWxpdHkgdXBkYXRlciBjb250YWlucyB0aGUgbGF5ZXIgd2UgcGljayB0aGUgdmlzaWJpbGl0eSBzdGF0dXMgb3RoZXJ3aXNlIHdlIGtlZXAgaXQgdW5jaGFnZWQgKi9cbiAgICAgICAgICB0aGlzLnZpc2libGVNb2RlID0gdmlzaWJpbGl0eVVwZGF0ZXIuZ2V0KHRoaXMubGF5ZXIuaWQpICE9PSB1bmRlZmluZWQgPyB2aXNpYmlsaXR5VXBkYXRlci5nZXQodGhpcy5sYXllci5pZCkgOiB0aGlzLnZpc2libGVNb2RlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudmlzaWJsZU1vZGUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICAvKiogY2hlY2sgbGVnZW5kIHZpc2liaWxpdHkgYWNjb3JkaW5nIHRvIFZpc2liaWxpdHlSdWxlcyAqL1xuICAgICAgICBpZiAodGhpcy52aXNpYmxlTW9kZSAmJiB0aGlzLmxheWVyICYmICEhdGhpcy5sYXllci5taW56b29tICYmICEhdGhpcy5sYXllci5tYXh6b29tKSB7XG4gICAgICAgICAgdGhpcy52aXNpYmxlTW9kZSA9ICh0aGlzLnpvb20gPD0gdGhpcy5sYXllci5tYXh6b29tICYmIHRoaXMuem9vbSA+PSB0aGlzLmxheWVyLm1pbnpvb20pO1xuICAgICAgICB9XG4gICAgICAgIC8qKiBjaGVjayBsZWdlbmQgdmlzaWJpbGl0eSBhY2NvcmRpbmcgdG8gbGVnZW5kIGVuYWJsZWQgb3Igbm90ICovXG4gICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7XG4gICAgICAgICAgdGhpcy52aXNpYmxlTW9kZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy52aXNpYmxlTW9kZSkge1xuICAgICAgICAgIHRoaXMuZGV0YWlsID0gdGhpcy52aXNpYmxlTW9kZTtcbiAgICAgICAgfVxuICAgICAgICAvKiogY2hlY2sgbGVnZW5kIHZpc2liaWxpdHkgZm9yIGV4dGVybmFsIGxheWVycyB0aGF0IGFyZSBub3Qgc2V0IGJ5IGNvbmZpZyBub3IgbWFwIGNvbnRyaWJ1dG9ycyAqL1xuICAgICAgICBpZiAodGhpcy5sYXllciAmJiAhdGhpcy5sYXllci5pZC5zdGFydHNXaXRoKEFSTEFTX0lEKSAmJlxuICAgICAgICAgICF0aGlzLmxheWVyLmlkLnN0YXJ0c1dpdGgoRklMTFNUUk9LRV9MQVlFUl9QUkVGSVgpICYmICF0aGlzLmxheWVyLmlkLnN0YXJ0c1dpdGgoSE9WRVJfTEFZRVJfUFJFRklYKVxuICAgICAgICAgICYmICF0aGlzLmxheWVyLmlkLnN0YXJ0c1dpdGgoU0VMRUNUX0xBWUVSX1BSRUZJWCkpIHtcbiAgICAgICAgICB0aGlzLnZpc2libGVNb2RlID0gdGhpcy5lbmFibGVkO1xuICAgICAgICAgIGlmICghIXRoaXMubGF5ZXIubWV0YWRhdGEgJiYgdGhpcy5sYXllci5tZXRhZGF0YS5zaG93TGVnZW5kID09PSBmYWxzZSkge1xuICAgICAgICAgICAgdGhpcy52aXNpYmxlTW9kZSA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5sYXllcikge1xuICAgICAgICAgIHRoaXMuZHJhd0xlZ2VuZHModGhpcy52aXNpYmxlTW9kZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy52aXNpYmlsaXR5U3RhdHVzLm5leHQodGhpcy52aXNpYmxlTW9kZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgaWYgKHRoaXMubGF5ZXIpIHtcbiAgICAgIHRoaXMuZHJhd0xlZ2VuZHModGhpcy52aXNpYmxlTW9kZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlc1snbGF5ZXInXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAodGhpcy5sYXllcikge1xuICAgICAgICB0aGlzLmRyYXdMZWdlbmRzKHRoaXMudmlzaWJsZU1vZGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLl9vbkRlc3Ryb3kkLm5leHQodHJ1ZSk7XG4gICAgdGhpcy5fb25EZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHVibGljIGRvd25sb2FkTGF5ZXJTb3VyY2UobGF5ZXI6IGFueSwgZG93bmxvYWRUeXBlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCBkb3dubG9hZCA9IHtcbiAgICAgIGxheWVyLFxuICAgICAgZG93bmxvYWRUeXBlXG4gICAgfTtcbiAgICB0aGlzLmRvd25sb2FkU291cmNlRW1pdHRlci5uZXh0KGRvd25sb2FkKTtcbiAgfVxuXG4gIHB1YmxpYyBzaG93RGV0YWlsKGV2ZW50OiBFdmVudCkge1xuICAgIHRoaXMuZGV0YWlsID0gIXRoaXMuZGV0YWlsO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICB9XG5cbiAgLyoqIFBhcnNlcyB0aGUgYHBhaW50YCBhdHRyaWJ1dGUgb2YgYSBsYXllciBhbmQgZHJhd3MgdGhlIGxlZ2VuZCBlbGVtZW50cyBzdWNoIGFzXG4gICAqIC0gY29sb3IgcGFsZXR0ZVxuICAgKiAtIGxpbmUgd2lkdGggZXZvbHV0aW9uXG4gICAqIC0gY2lyY2xlIHJhZGl1cyBldm9sdXRpb25cbiAgICovXG4gIHByaXZhdGUgZHJhd0xlZ2VuZHModmlzaWJpbGVNb2RlOiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3QgdHlwZSA9IHRoaXMubGF5ZXIudHlwZTtcbiAgICBjb25zdCBwYWludCA9IHRoaXMubGF5ZXIucGFpbnQ7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlICdjaXJjbGUnOiB7XG4gICAgICAgIGNvbnN0IGNpcmNsZUxlZ2VuZCA9IHRoaXMubGVnZW5kU2VydmljZS5nZXRDaXJjbGVMZWdlbmQocGFpbnQsIHZpc2liaWxlTW9kZSwgdGhpcy5sZWdlbmREYXRhLCB0aGlzLmxheWVyKTtcbiAgICAgICAgdGhpcy5jb2xvckxlZ2VuZC5zZXQoY2lyY2xlTGVnZW5kLmNvbG9yKTtcblxuICAgICAgICAvLyBGb3IgY2lyY2xlLWhlYXRtYXAgbGF5ZXIgdGhlIHN0cm9rZSBjYW4ndCBiZSBjb25maWd1cmVkLCBzbyBoaWRlIGl0XG4gICAgICAgIGlmICh0aGlzLmxheWVyLm1ldGFkYXRhPy5oaWRkZW5Qcm9wcz8uZ2VvbVR5cGUgIT09ICdjaXJjbGUtaGVhdG1hcCcpIHtcbiAgICAgICAgICB0aGlzLnN0cm9rZUNvbG9yTGVnZW5kLnNldChjaXJjbGVMZWdlbmQuc3Ryb2tlQ29sb3IpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29sb3JQYWxldHRlID0gY2lyY2xlTGVnZW5kLmNvbG9yUGFsZXR0ZTtcbiAgICAgICAgdGhpcy5zdHJva2VDb2xvclBhbGV0dGUgPSBjaXJjbGVMZWdlbmQuc3Ryb2tlQ29sb3JQYWxldHRlO1xuICAgICAgICB0aGlzLnJhZGl1c0xlZ2VuZC5zZXQoY2lyY2xlTGVnZW5kLnJhZGl1cyk7XG4gICAgICAgIGlmICh0aGlzLmNpcmNsZVJhZGl1c0xlZ2VuZD8uaW50ZXJwb2xhdGVkRWxlbWVudCkge1xuICAgICAgICAgIGNvbnN0IGNpcmNsZVJhZGl1c0V2b2x1dGlvbiA9IGNpcmNsZUxlZ2VuZC5yYWRpdXMuaGlzdG9ncmFtO1xuICAgICAgICAgIGRyYXdDaXJjbGVTdXBwb3J0TGluZSh0aGlzLmNpcmNsZVJhZGl1c0xlZ2VuZC5pbnRlcnBvbGF0ZWRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsIGNpcmNsZVJhZGl1c0V2b2x1dGlvbiwgdGhpcy5jb2xvckxlZ2VuZCgpLFxuICAgICAgICAgICAgdGhpcy5MRUdFTkRfV0lEVEgsIE1hdGgubWluKHRoaXMuTUFYX0NJUkxFX1JBRElVUywgZ2V0TWF4KGNpcmNsZVJhZGl1c0V2b2x1dGlvbikpICogMik7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdsaW5lJzoge1xuICAgICAgICBjb25zdCBsaW5lTGVnZW5kID0gdGhpcy5sZWdlbmRTZXJ2aWNlLmdldExpbmVMZWdlbmQocGFpbnQsIHZpc2liaWxlTW9kZSwgdGhpcy5sZWdlbmREYXRhLCB0aGlzLmxheWVyKTtcbiAgICAgICAgdGhpcy5saW5lRGFzaGFycmF5ID0gbGluZUxlZ2VuZC5kYXNoZXM7XG4gICAgICAgIHRoaXMuY29sb3JMZWdlbmQuc2V0KGxpbmVMZWdlbmQuY29sb3IpO1xuICAgICAgICB0aGlzLmNvbG9yUGFsZXR0ZSA9IGxpbmVMZWdlbmQuY29sb3JQYWxldHRlO1xuICAgICAgICB0aGlzLndpZHRoTGVnZW5kLnNldChsaW5lTGVnZW5kLndpZHRoKTtcbiAgICAgICAgaWYgKHRoaXMubGluZVdpZHRoTGVnZW5kPy5pbnRlcnBvbGF0ZWRFbGVtZW50KSB7XG4gICAgICAgICAgY29uc3QgbGluZVdpZHRoRXZvbHV0aW9uID0gbGluZUxlZ2VuZC53aWR0aC5oaXN0b2dyYW07XG4gICAgICAgICAgZHJhd0xpbmVXaWR0aCh0aGlzLmxpbmVXaWR0aExlZ2VuZC5pbnRlcnBvbGF0ZWRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsIGxpbmVXaWR0aEV2b2x1dGlvbiwgdGhpcy5jb2xvckxlZ2VuZCgpLFxuICAgICAgICAgICAgdGhpcy5MRUdFTkRfV0lEVEgsIE1BWF9MSU5FX1dJRFRIKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgJ2ZpbGwnOiB7XG4gICAgICAgIGNvbnN0IGZpbGxMZWdlbmQgPSB0aGlzLmxlZ2VuZFNlcnZpY2UuZ2V0RmlsbExlZ2VuZChwYWludCwgdmlzaWJpbGVNb2RlLCB0aGlzLmxlZ2VuZERhdGEsIHRoaXMubGF5ZXIpO1xuICAgICAgICB0aGlzLmNvbG9yTGVnZW5kLnNldChmaWxsTGVnZW5kLmNvbG9yKTtcbiAgICAgICAgdGhpcy5jb2xvclBhbGV0dGUgPSBmaWxsTGVnZW5kLmNvbG9yUGFsZXR0ZTtcbiAgICAgICAgdGhpcy5zdHJva2VDb2xvckxlZ2VuZC5zZXQoZmlsbExlZ2VuZD8uc3Ryb2tlQ29sb3IpO1xuICAgICAgICB0aGlzLnN0cm9rZUNvbG9yUGFsZXR0ZSA9IGZpbGxMZWdlbmQ/LnN0cm9rZUNvbG9yUGFsZXR0ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdoZWF0bWFwJzoge1xuICAgICAgICBjb25zdCBoZWF0bWFwTGVnZW5kID0gdGhpcy5sZWdlbmRTZXJ2aWNlLmdldEhlYXRtYXBMZWdlbmQocGFpbnQsIHZpc2liaWxlTW9kZSwgdGhpcy5sZWdlbmREYXRhLCB0aGlzLmxheWVyKTtcblxuICAgICAgICB0aGlzLmNvbG9yTGVnZW5kLnNldChoZWF0bWFwTGVnZW5kLmNvbG9yKTtcbiAgICAgICAgdGhpcy5jb2xvclBhbGV0dGUgPSBoZWF0bWFwTGVnZW5kLmNvbG9yUGFsZXR0ZTtcbiAgICAgICAgdGhpcy5yYWRpdXNMZWdlbmQuc2V0KGhlYXRtYXBMZWdlbmQucmFkaXVzKTtcbiAgICAgICAgaWYgKHRoaXMuY2lyY2xlUmFkaXVzTGVnZW5kPy5pbnRlcnBvbGF0ZWRFbGVtZW50KSB7XG4gICAgICAgICAgY29uc3QgaGVhdG1hcFJhZGl1c0V2b2x1dGlvbiA9IGhlYXRtYXBMZWdlbmQucmFkaXVzLmhpc3RvZ3JhbTtcbiAgICAgICAgICBkcmF3Q2lyY2xlU3VwcG9ydExpbmUodGhpcy5jaXJjbGVSYWRpdXNMZWdlbmQuaW50ZXJwb2xhdGVkRWxlbWVudC5uYXRpdmVFbGVtZW50LCBoZWF0bWFwUmFkaXVzRXZvbHV0aW9uLCB0aGlzLmNvbG9yTGVnZW5kKCksXG4gICAgICAgICAgICB0aGlzLkxFR0VORF9XSURUSCwgTWF0aC5taW4odGhpcy5NQVhfQ0lSTEVfUkFESVVTLCBnZXRNYXgoaGVhdG1hcFJhZGl1c0V2b2x1dGlvbikpICogMik7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlICdzeW1ib2wnOiB7XG4gICAgICAgIGNvbnN0IHN5bWJvbExlZ2VuZCA9IHRoaXMubGVnZW5kU2VydmljZS5nZXRMYWJlbExlZ2VuZChwYWludCwgdmlzaWJpbGVNb2RlLCB0aGlzLmxlZ2VuZERhdGEsIHRoaXMubGF5ZXIpO1xuICAgICAgICB0aGlzLmNvbG9yTGVnZW5kLnNldChzeW1ib2xMZWdlbmQuY29sb3IpO1xuICAgICAgICB0aGlzLmNvbG9yUGFsZXR0ZSA9IHN5bWJvbExlZ2VuZC5jb2xvclBhbGV0dGU7XG4gICAgICAgIHRoaXMud2lkdGhMZWdlbmQuc2V0KHN5bWJvbExlZ2VuZC5zaXplKTtcbiAgICAgICAgaWYgKCEhdGhpcy5saW5lV2lkdGhMZWdlbmQgJiYgISF0aGlzLmxpbmVXaWR0aExlZ2VuZC5pbnRlcnBvbGF0ZWRFbGVtZW50KSB7XG4gICAgICAgICAgY29uc3QgbGluZVdpZHRoRXZvbHV0aW9uID0gc3ltYm9sTGVnZW5kLnNpemUuaGlzdG9ncmFtO1xuICAgICAgICAgIGRyYXdMaW5lV2lkdGgodGhpcy5saW5lV2lkdGhMZWdlbmQuaW50ZXJwb2xhdGVkRWxlbWVudC5uYXRpdmVFbGVtZW50LCBsaW5lV2lkdGhFdm9sdXRpb24sIHRoaXMuY29sb3JMZWdlbmQoKSxcbiAgICAgICAgICAgIHRoaXMuTEVHRU5EX1dJRFRILCBNQVhfTElORV9XSURUSCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghdGhpcy5jb2xvckxlZ2VuZCgpLmZpeFZhbHVlKSB7XG4gICAgICB0aGlzLmNvbG9yTGVnZW5kKCkuZml4VmFsdWUgPSB2aXNpYmlsZU1vZGUgPyAnIzQ0NCcgOiAnI2QzZDNkMyc7XG4gICAgfVxuICAgIGNvbnN0IGxheWVyID0geyAuLi50aGlzLmxheWVyIH07XG4gICAgdGhpcy5sYXllciA9IG51bGw7XG4gICAgdGhpcy5sYXllciA9IHsgLi4ubGF5ZXIgfTtcbiAgfVxuXG5cbn1cblxuLyoqXG4gKiBkcmF3cyB0aGUgbGluZSB3aWR0aCBsZWdlbmRcbiAqIEBwYXJhbSBzdmdOb2RlIFNWRyBlbGVtZW50IG9uIHdoaWNoIHdlIGFwcGVuZCB0aGUgbGluZSB1c2luZyBkMy5cbiAqIEBwYXJhbSBsaW5lV2lkdGhzIExpc3Qgb2Yge2tleSwgbGluZXdpZHRofVxuICogQHBhcmFtIGNMZWdlbmQgQ29sb3IgbGVnZW5kLCB0byBnaXZlIHRoZSBkcmF3biBsZWdlbmQgbGluZXMgdGhlIHNhbWUgY29sb3Igb24gdGhlIG1hcFxuICogQHBhcmFtIGxlZ2VuZFdpZHRoIFRoZSB3aWR0aCB0aGF0IHRoZSBzdmcgd2lsbCB0YWtlIHRvIGRyYXcgdGhlIGxlZ2VuZFxuICogQHBhcmFtIGxlZ2VuZEhlaWdodCBUaGUgaGVpZ2h0IHRoYXQgdGhlIHN2ZyB3aWxsIHRha2UgdG8gZHJhdyB0aGUgbGVnZW5kXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBkcmF3TGluZVdpZHRoKHN2Z05vZGU6IFNWR0VsZW1lbnQsIGxpbmVXaWR0aHM6IEFycmF5PEhpc3RvZ3JhbURhdGE+LFxuICBjTGVnZW5kOiBMZWdlbmQsIGxlZ2VuZFdpZHRoOiBudW1iZXIsIGxlZ2VuZEhlaWdodDogbnVtYmVyKSB7XG4gIGNvbnN0IG1heEhlaWdodCA9IGdldE1heChsaW5lV2lkdGhzKTtcbiAgY29uc3QgeERvbWFpbjogYW55ID0gKHNjYWxlTGluZWFyKCkpLnJhbmdlKFswLCBsZWdlbmRXaWR0aF0pO1xuICBjb25zdCB4RG9tYWluRXh0ZW50ID0gW2xpbmVXaWR0aHNbMF0ua2V5LCBsaW5lV2lkdGhzW2xpbmVXaWR0aHMubGVuZ3RoIC0gMV0ua2V5XTtcbiAgeERvbWFpbi5kb21haW4oeERvbWFpbkV4dGVudCk7XG4gIGNvbnN0IHlEb21haW46IFNjYWxlTGluZWFyPG51bWJlciwgbnVtYmVyPiA9IHNjYWxlTGluZWFyKCkucmFuZ2UoW21heEhlaWdodCwgMF0pO1xuICB5RG9tYWluLmRvbWFpbihbMCwgbWF4SGVpZ2h0XSk7XG4gIGNvbnN0IHN2ZyA9IHNlbGVjdChzdmdOb2RlKS5hdHRyKCd3aWR0aCcsIGxlZ2VuZFdpZHRoKS5hdHRyKCdoZWlnaHQnLCBsZWdlbmRIZWlnaHQpO1xuICBzdmcuc2VsZWN0QWxsKCdnJykucmVtb3ZlKCk7XG4gIGNvbnN0IGNvbnRleHQgPSBzdmcuYXBwZW5kKCdnJykuYXR0cignY2xhc3MnLCAnY29udGV4dCcpO1xuICBjb25zdCBhciA9IGFyZWEoKVxuICAgIC5jdXJ2ZShjdXJ2ZUxpbmVhcilcbiAgICAueCgoZDogYW55KSA9PiB4RG9tYWluKGQua2V5KSlcbiAgICAueTAobWF4SGVpZ2h0KVxuICAgIC55MSgoZDogYW55KSA9PiB5RG9tYWluKGQudmFsdWUpKTtcblxuICBjb25zdCB3aWR0aExpbmVDb2xvciA9IGdldE1pZGRsZUNvbG9yKGNMZWdlbmQpO1xuICBjb250ZXh0LmFwcGVuZCgncGF0aCcpXG4gICAgLmRhdHVtKGxpbmVXaWR0aHMpXG4gICAgLnN0eWxlKCdmaWxsJywgd2lkdGhMaW5lQ29sb3IpXG4gICAgLnN0eWxlKCdmaWxsLW9wYWNpdHknLCAwLjYpXG4gICAgLnN0eWxlKCdzdHJva2UnLCB3aWR0aExpbmVDb2xvcilcbiAgICAuc3R5bGUoJ3N0cm9rZS1vcGFjaXR5JywgMC42KVxuICAgIC5zdHlsZSgnc3Ryb2tlLXdpZHRoJywgMC41KVxuICAgIC5hdHRyKCdkJywgPGFueT5hcik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNaWRkbGVDb2xvcihjb2xvckxlZ2VuZDogTGVnZW5kKTogc3RyaW5nIHtcbiAgbGV0IGNvbG9yID0gJyc7XG4gIGlmIChjb2xvckxlZ2VuZC50eXBlID09PSBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0UuZml4KSB7XG4gICAgY29sb3IgPSBjb2xvckxlZ2VuZC5maXhWYWx1ZSBhcyBzdHJpbmc7XG4gIH0gZWxzZSBpZiAoY29sb3JMZWdlbmQudHlwZSA9PT0gUFJPUEVSVFlfU0VMRUNUT1JfU09VUkNFLmludGVycG9sYXRlZCkge1xuICAgIGNvbnN0IGl2ID0gY29sb3JMZWdlbmQuaW50ZXJwb2xhdGVkVmFsdWVzIGFzIEFycmF5PHN0cmluZz47XG4gICAgaWYgKGl2Lmxlbmd0aCA9PT0gMSB8fCBpdi5sZW5ndGggPT09IDIpIHtcbiAgICAgIGNvbG9yID0gaXZbMF07XG4gICAgfSBlbHNlIGlmIChpdi5sZW5ndGggPj0gMykge1xuICAgICAgY29sb3IgPSBpdltNYXRoLnRydW5jKGl2Lmxlbmd0aCAvIDIpXTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoY29sb3JMZWdlbmQudHlwZSA9PT0gUFJPUEVSVFlfU0VMRUNUT1JfU09VUkNFLm1hbnVhbCB8fCBjb2xvckxlZ2VuZC50eXBlID09PSBQUk9QRVJUWV9TRUxFQ1RPUl9TT1VSQ0UuZ2VuZXJhdGVkXG4gICAgfHwgY29sb3JMZWdlbmQudHlwZSA9PT0gUFJPUEVSVFlfU0VMRUNUT1JfU09VUkNFLnByb3ZpZGVkKSB7XG4gICAgY29uc3QgaXYgPSBjb2xvckxlZ2VuZC5tYW51YWxWYWx1ZXMgYXMgTWFwPHN0cmluZywgc3RyaW5nPjtcbiAgICBpZiAoaXYpIHtcbiAgICAgIGlmIChpdi5zaXplID09PSAxKSB7XG4gICAgICAgIGNvbG9yID0gaXYua2V5cygpLm5leHQoKS52YWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAoaXYuc2l6ZSA+PSAyKSB7XG4gICAgICAgIGNvbG9yID0gQXJyYXkuZnJvbShpdi52YWx1ZXMoKSlbTWF0aC50cnVuYyhBcnJheS5mcm9tKGl2LmtleXMoKSkubGVuZ3RoIC8gMildO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gY29sb3I7XG59XG4vKipcbiAqIGRyYXdzIHRoZSBjaXJjbGUgcmFkaXVzIGxlZ2VuZFxuICogQHBhcmFtIHN2Z05vZGUgU1ZHIGVsZW1lbnQgb24gd2hpY2ggd2UgYXBwZW5kIHRoZSBjaXJjbGVzIHVzaW5nIGQzLlxuICogQHBhcmFtIGNpcmNsZXNSYWRpdXNlcyBMaXN0IG9mIHtrZXksIGNpcmNsZXJhZGl1c31cbiAqIEBwYXJhbSBjTGVnZW5kIENvbG9yIGxlZ2VuZCwgdG8gZ2l2ZSB0aGUgZHJhd24gbGVnZW5kIGNpcmNsZXMgdGhlIHNhbWUgY29sb3Igb24gdGhlIG1hcFxuICogQHBhcmFtIGxlZ2VuZFdpZHRoIFRoZSB3aWR0aCB0aGF0IHRoZSBzdmcgd2lsbCB0YWtlIHRvIGRyYXcgdGhlIGxlZ2VuZFxuICogQHBhcmFtIGxlZ2VuZEhlaWdodCBUaGUgaGVpZ2h0IHRoYXQgdGhlIHN2ZyB3aWxsIHRha2UgdG8gZHJhdyB0aGUgbGVnZW5kXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBkcmF3Q2lyY2xlU3VwcG9ydExpbmUoc3ZnTm9kZTogU1ZHRWxlbWVudCwgY2lyY2xlc1JhZGl1c2VzOiBBcnJheTxIaXN0b2dyYW1EYXRhPixcbiAgY0xlZ2VuZDogTGVnZW5kLCBsZWdlbmRXaWR0aDogbnVtYmVyLCBsZWdlbmRIZWlnaHQ6IG51bWJlcikge1xuICBjb25zdCBjaXJjbGVEaWFtZXRlcnMgPSBbXTtcbiAgY2lyY2xlc1JhZGl1c2VzLmZvckVhY2goY3IgPT4gY2lyY2xlRGlhbWV0ZXJzLnB1c2goeyBrZXk6IGNyLmtleSwgdmFsdWU6IGNyLnZhbHVlICogMiB9KSk7XG4gIGNvbnN0IG1heEhlaWdodCA9IGdldE1heChjaXJjbGVEaWFtZXRlcnMpO1xuICBjb25zdCBmaXJzdFJhZGl1cyA9IGNpcmNsZXNSYWRpdXNlc1swXS52YWx1ZTtcbiAgY29uc3QgbGFzdFJhZGl1cyA9IGNpcmNsZXNSYWRpdXNlc1tjaXJjbGVzUmFkaXVzZXMubGVuZ3RoIC0gMV0udmFsdWU7XG4gIGNvbnN0IHhEb21haW46IGFueSA9IChzY2FsZUxpbmVhcigpKS5yYW5nZShbMCwgbGVnZW5kV2lkdGggLSBmaXJzdFJhZGl1cyAtIGxhc3RSYWRpdXNdKTtcbiAgY29uc3QgeERvbWFpbkV4dGVudCA9IFtjaXJjbGVEaWFtZXRlcnNbMF0ua2V5LCBjaXJjbGVEaWFtZXRlcnNbY2lyY2xlRGlhbWV0ZXJzLmxlbmd0aCAtIDFdLmtleV07XG4gIHhEb21haW4uZG9tYWluKHhEb21haW5FeHRlbnQpO1xuICBjb25zdCB5RG9tYWluOiBTY2FsZUxpbmVhcjxudW1iZXIsIG51bWJlcj4gPSBzY2FsZUxpbmVhcigpLnJhbmdlKFttYXhIZWlnaHQsIDBdKTtcbiAgeURvbWFpbi5kb21haW4oWzAsIG1heEhlaWdodF0pO1xuICBjb25zdCBzdmcgPSBzZWxlY3Qoc3ZnTm9kZSkuYXR0cignd2lkdGgnLCBsZWdlbmRXaWR0aCkuYXR0cignaGVpZ2h0JywgbGVnZW5kSGVpZ2h0KTtcbiAgc3ZnLnNlbGVjdEFsbCgnZycpLnJlbW92ZSgpO1xuICBjb25zdCBjb250ZXh0ID0gc3ZnLmFwcGVuZCgnZycpLmF0dHIoJ2NsYXNzJywgJ2NvbnRleHQnKTtcbiAgY29uc3QgbCA9IGxpbmUoKVxuICAgIC54KChkOiBhbnkpID0+IHhEb21haW4oZC5rZXkpKVxuICAgIC55KChkOiBhbnkpID0+IHlEb21haW4oZC52YWx1ZSkpO1xuICBjb250ZXh0LmFwcGVuZCgncGF0aCcpXG4gICAgLmRhdHVtKGNpcmNsZURpYW1ldGVycylcbiAgICAuYXR0cignZmlsbCcsICdub25lJylcbiAgICAuYXR0cignc3Ryb2tlJywgJyNlYWVhZWEnKVxuICAgIC5hdHRyKCdzdHJva2Utd2lkdGgnLCAwLjgpXG4gICAgLmF0dHIoJ3RyYW5zZm9ybScsICd0cmFuc2xhdGUoJyArIGZpcnN0UmFkaXVzICsgJywgMCknKVxuICAgIC5hdHRyKCdkJywgPGFueT5sKTtcbiAgY29udGV4dC5hcHBlbmQoJ2cnKS5hcHBlbmQoJ2xpbmUnKVxuICAgIC5hdHRyKCd4MScsIDApLmF0dHIoJ3kxJywgbWF4SGVpZ2h0KVxuICAgIC5hdHRyKCd4MicsIGxlZ2VuZFdpZHRoIC0gZmlyc3RSYWRpdXMgLSBsYXN0UmFkaXVzKS5hdHRyKCd5MicsIG1heEhlaWdodClcbiAgICAuYXR0cignY3gnLCAyKS5hdHRyKCdjeScsIDIpLmF0dHIoJ2ZpbGwnLCAnbm9uZScpXG4gICAgLmF0dHIoJ3N0cm9rZScsICcjZWFlYWVhJylcbiAgICAuYXR0cignc3Ryb2tlLXdpZHRoJywgMC44KVxuICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyBmaXJzdFJhZGl1cyArICcsIDApJyk7XG4gIGNvbnN0IGNpcmNsZXMgPSBbY2lyY2xlc1JhZGl1c2VzWzBdLCBjaXJjbGVzUmFkaXVzZXNbY2lyY2xlc1JhZGl1c2VzLmxlbmd0aCAtIDFdXTtcbiAgY29uc3QgY2lyY2xlQ29sb3IgPSBnZXRNaWRkbGVDb2xvcihjTGVnZW5kKTtcbiAgY29udGV4dC5hcHBlbmQoJ2cnKVxuICAgIC5zZWxlY3RBbGwoJ2RvdCcpLmRhdGEoY2lyY2xlcykuZW50ZXIoKS5hcHBlbmQoJ2NpcmNsZScpXG4gICAgLmF0dHIoJ3InLCAoZCkgPT4gZC52YWx1ZSlcbiAgICAuYXR0cignY3gnLCAoZCkgPT4geERvbWFpbihkLmtleSkpXG4gICAgLmF0dHIoJ2N5JywgKGQpID0+IG1heEhlaWdodCAtIGQudmFsdWUpXG4gICAgLmF0dHIoJ3RyYW5zZm9ybScsICd0cmFuc2xhdGUoJyArIGZpcnN0UmFkaXVzICsgJywgMCknKVxuICAgIC5zdHlsZSgnZmlsbCcsIGNpcmNsZUNvbG9yKVxuICAgIC5zdHlsZSgnZmlsbC1vcGFjaXR5JywgMC42KVxuICAgIC5zdHlsZSgnc3Ryb2tlJywgY2lyY2xlQ29sb3IpXG4gICAgLnN0eWxlKCdzdHJva2Utd2lkdGgnLCAwLjUpO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNYXgoZGF0YTogQXJyYXk8SGlzdG9ncmFtRGF0YT4pOiBudW1iZXIge1xuICByZXR1cm4gTWF0aC5tYXgoLi4uZGF0YS5tYXAoaGQgPT4gK2hkLnZhbHVlKSk7XG59XG4iLCJcbjxkaXYgY2xhc3M9XCJsYXllcl93cmFwcGVyXCI+XG4gICAgPGRpdiBjbGFzcz1jb2xsZWN0aW9uX2NvbG9yIFttYXRUb29sdGlwXT1cIidDb2xsZWN0aW9uOicgfCB0cmFuc2xhdGU6IHtjb2xsZWN0aW9uOiAoY29sbGVjdGlvbiB8IGdldENvbGxlY3Rpb25EaXNwbGF5TmFtZSl9XCJcbiAgICAgIFtzdHlsZS5iYWNrZ3JvdW5kQ29sb3JdPVwiISFjb2xsZWN0aW9uID8gKGNvbGxlY3Rpb24gfCBnZXRDb2xvcikgOiAndHJhbnNwYXJlbnQnXCI+PC9kaXY+XG4gICAgPGRpdiBjbGFzcz1cImxheWVyX2NvbnRhaW5lclwiID5cbiAgICAgIDxkaXYgY2xhc3M9XCJsYXllcl9pY29uX2NvbnRhaW5lclwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwibGF5ZXJfaWNvblwiID5cbiAgICAgICAgICA8YXJsYXMtbGF5ZXItaWNvbiBbbGF5ZXJdPVwibGF5ZXJcIiBbY29sb3JMZWdlbmRdPVwiY29sb3JMZWdlbmQoKVwiIFtzdHJva2VDb2xvckxlZ2VuZF09XCJzdHJva2VDb2xvckxlZ2VuZCgpXCJcbiAgICAgICAgICAgIFtsaW5lRGFzaGFycmF5XT1cImxpbmVEYXNoYXJyYXlcIiBbd2lkdGhMZWdlbmRdPVwid2lkdGhMZWdlbmQoKVwiIFtyYWRpdXNMZWdlbmRdPVwicmFkaXVzTGVnZW5kKClcIj48L2FybGFzLWxheWVyLWljb24+XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IGNsYXNzPVwibGF5ZXJfbmFtZVwiIFtzdHlsZS5jb2xvcl09XCJ2aXNpYmxlTW9kZSA/ICcjNDQ0JzogJyNkM2QzZDMnXCI+XG4gICAgICAgICAge3tsYXllcj8uaWQgfCBsYXllcklkVG9OYW1lIHwgdHJhbnNsYXRlfX1cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxkaXYgY2xhc3M9XCJsYXllcl9kZXRhaWxcIj5cbiAgICAgICAgPGRpdiBjbGFzcz1cImRvd25sb2FkX2J1dHRvblwiPlxuICAgICAgICAgIDxtYXQtaWNvbiBjbGFzcz1cImRvd25sb2FkX2ljb25cIiBbbWF0TWVudVRyaWdnZXJGb3JdPVwibWVudVwiIFttYXRUb29sdGlwXT1cIidEb3dubG9hZCB0aGUgbGF5ZXJcXCdzIGRhdGEnIHwgdHJhbnNsYXRlXCI+ZmlsZV9kb3dubG9hZDwvbWF0LWljb24+XG4gICAgICAgICAgPG1hdC1tZW51ICNtZW51PVwibWF0TWVudVwiPlxuICAgICAgICAgICAgPGJ1dHRvbiBtYXQtbWVudS1pdGVtIChjbGljayk9XCJkb3dubG9hZExheWVyU291cmNlKGxheWVyLCAnY3N2JylcIj5cbiAgICAgICAgICAgICAge3snQ1NWJyB8IHRyYW5zbGF0ZX19XG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgIDxidXR0b24gbWF0LW1lbnUtaXRlbSAoY2xpY2spPVwiZG93bmxvYWRMYXllclNvdXJjZShsYXllciwgJ2dlb2pzb24nKVwiPlxuICAgICAgICAgICAgICB7eydHZW9Kc29uJyB8IHRyYW5zbGF0ZX19XG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8L21hdC1tZW51PlxuICAgICAgICA8L2Rpdj5cblxuICAgICAgICBAaWYgKGRpc3BsYXlMZWdlbmREZXRhaWxUb2dnbGUoKSkge1xuICAgICAgICAgIDxkaXYgY2xhc3M9XCJkZXRhaWxfYnV0dG9uXCIgKGNsaWNrKT1cInNob3dEZXRhaWwoJGV2ZW50KVwiIChrZXlEb3duKT1cInNob3dEZXRhaWwoJGV2ZW50KVwiPlxuICAgICAgICAgICAgPG1hdC1pY29uIGNsYXNzPVwiZGV0YWlsX2ljb25cIj57eyBkZXRhaWwgPyAna2V5Ym9hcmRfYXJyb3dfdXAnIDogJ2tleWJvYXJkX2Fycm93X2Rvd24nIH19PC9tYXQtaWNvbj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgfVxuICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG5cbiAgICA8ZGl2IFtoaWRkZW5dPVwiIWRldGFpbFwiIGNsYXNzPVwibGVnZW5kLXdyYXBwZXJcIj5cbiAgICAgIDxhcmxhcy1sZWdlbmQtaXRlbSBbaGlkZGVuXT1cIiFoYXNDb2xvckxlZ2VuZCgpXCIgW2xlZ2VuZF09XCJjb2xvckxlZ2VuZCgpXCIgW2xheWVyXT1cImxheWVyXCJcbiAgICAgICAgW3RpdGxlXT1cIidGaWxsOicgfCBtYXJrZXJcIiBbY29sb3JQYWxldHRlXT1cImNvbG9yUGFsZXR0ZVwiPjwvYXJsYXMtbGVnZW5kLWl0ZW0+XG5cbiAgICAgIDxhcmxhcy1sZWdlbmQtaXRlbSBbaGlkZGVuXT1cIiFoYXNTdHJva2VMZWdlbmQoKVwiIFtsZWdlbmRdPVwic3Ryb2tlQ29sb3JMZWdlbmQoKVwiIFtsYXllcl09XCJsYXllclwiXG4gICAgICAgIFt0aXRsZV09XCInU3Ryb2tlOicgfCBtYXJrZXJcIiBbY29sb3JQYWxldHRlXT1cImNvbG9yUGFsZXR0ZVwiPjwvYXJsYXMtbGVnZW5kLWl0ZW0+XG5cbiAgICAgIDxhcmxhcy1sZWdlbmQtaXRlbSBbaGlkZGVuXT1cIiFoYXNXaWR0aExlZ2VuZCgpXCIgI3dpZHRoX2xlZ2VuZCBbbGVnZW5kXT1cIndpZHRoTGVnZW5kKClcIiBbbGF5ZXJdPVwibGF5ZXJcIlxuICAgICAgICBbdGl0bGVdPVwiJ1dpZHRoOicgfCBtYXJrZXJcIj48L2FybGFzLWxlZ2VuZC1pdGVtPlxuXG4gICAgICA8YXJsYXMtbGVnZW5kLWl0ZW0gW2hpZGRlbl09XCIhaGFzUmFkaXVzTGVnZW5kKClcIiAjcmFkaXVzX2xlZ2VuZCBbbGVnZW5kXT1cInJhZGl1c0xlZ2VuZCgpXCIgW2xheWVyXT1cImxheWVyXCJcbiAgICAgICAgW3RpdGxlXT1cIidSYWRpdXM6JyB8IG1hcmtlclwiPjwvYXJsYXMtbGVnZW5kLWl0ZW0+XG4gICAgPC9kaXY+XG4gIDwvZGl2PlxuIl19